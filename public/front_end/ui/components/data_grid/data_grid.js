import*as e from"../../../core/host/host.js";import*as t from"../../../core/platform/platform.js";import*as s from"../../legacy/legacy.js";import*as i from"../../lit-html/lit-html.js";import*as o from"../helpers/helpers.js";import*as r from"../render_coordinator/render_coordinator.js";import*as n from"../icon_button/icon_button.js";import*as l from"../../../core/i18n/i18n.js";const a=new CSSStyleSheet;a.replaceSync(':host{height:100%;display:block;position:relative}.wrapping-container{overflow-y:auto;height:100%}.wrapping-container::-webkit-scrollbar{display:none}table{border-spacing:0;width:100%;height:100%;table-layout:fixed}tr{outline:0}thead tr{height:27px}tbody tr{background-color:var(--override-data-grid-row-background-color,--color-background)}tbody tr.selected{background-color:var(--color-background-elevation-1)}td,th{padding:1px 4px;border-left:1px solid var(--color-details-hairline);color:var(--color-text-primary);line-height:var(--table-row-height);height:var(--table-row-height);user-select:text;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}th{font-weight:400;text-align:left;border-bottom:1px solid var(--color-details-hairline);position:sticky;top:0;z-index:2;background-color:var(--color-background-elevation-1)}td:focus,th:focus{outline:var(--color-primary) auto 1px}.cell-resize-handle{top:0;height:100%;z-index:3;width:20px;cursor:col-resize;position:absolute}td.firstVisibleColumn,th.firstVisibleColumn{border-left:none}.hidden{display:none}.filler-row td{height:100%;pointer-events:none;padding:0}.filler-row.empty-table td{padding:1px}[aria-sort]:hover{cursor:pointer}[aria-sort=descending]::after{content:"";width:0;border-left:.4em solid transparent;border-right:.4em solid transparent;border-top:.4em solid var(--color-text-secondary);position:absolute;right:.5em;top:.85em}[aria-sort=ascending]::after{content:"";width:0;border-bottom:.4em solid var(--color-text-secondary);border-left:.4em solid transparent;border-right:.4em solid transparent;position:absolute;right:.5em;top:.7em}\n/*# sourceURL=dataGrid.css */\n');class c extends Event{static eventName="columnheaderclick";data;constructor(e,t){super(c.eventName),this.data={column:e,columnIndex:t}}}class d extends Event{static eventName="contextmenucolumnsortclick";data;constructor(e){super(d.eventName),this.data={column:e}}}class h extends Event{static eventName="contextmenuheaderresetclick";constructor(){super(h.eventName)}}class u extends Event{static eventName="newuserfiltertext";data;constructor(e){super(u.eventName,{composed:!0}),this.data={filterText:e}}}class m extends Event{static eventName="cellfocused";data;constructor(e,t){super(m.eventName,{composed:!0}),this.data={cell:e,row:t}}}var p=Object.freeze({__proto__:null,ColumnHeaderClickEvent:c,ContextMenuColumnSortClickEvent:d,ContextMenuHeaderResetClickEvent:h,NewUserFilterTextEvent:u,BodyCellFocusedEvent:m});function f(e,t){const s=!t.visible,i=e.data.columns.map((e=>(e===t&&(e.visible=s),e)));e.data={...e.data,columns:i}}function w(e,t){const{columns:s}=e.data;for(const i of s)i.hideable&&t.defaultSection().appendCheckboxItem(i.title,(()=>{f(e,i)}),i.visible)}function g(e,t){const s=e.data.columns.filter((e=>!0===e.sortable));if(s.length>0)for(const i of s)t.defaultSection().appendItem(i.title,(()=>{e.dispatchEvent(new d(i))}))}const b=e=>i.html`${e}`;var C=Object.freeze({__proto__:null,primitiveRenderer:b,codeBlockRenderer:e=>{if(!e)return i.nothing;const t=String(e);return i.html`<code>${t}</code>`}});function v(e){return JSON.stringify(e.map((e=>e.value instanceof n.Icon.Icon?null:e.value))).toLowerCase()}function x(e,t){const s=e.cells.find((e=>e.columnId===t));if(void 0===s)throw new Error(`Found a row that was missing an entry for column ${t}.`);return s}function R(e){return e.renderer?e.renderer(e.value):b(e.value)}function S(e,t){const s=e.filter((e=>e.visible)).reduce(((e,t)=>e+t.widthWeighting),0),i=e.find((e=>e.id===t));if(!i)throw new Error(`Could not find column with ID ${t}`);if(i.widthWeighting<1)throw new Error(`Error with column ${t}: width weightings must be >= 1.`);return i.visible?Math.round(i.widthWeighting/s*100):0}function y(e){const{key:s,currentFocusedCell:i,columns:o,rows:r}=e,[n,l]=i;switch(s){case"ArrowLeft":{if(n===o.findIndex((e=>e.visible)))return[n,l];let e=n;for(let t=e-1;t>=0;t--){if(o[t].visible){e=t;break}}return[e,l]}case"ArrowRight":{let e=n;for(let t=e+1;t<o.length;t++){if(o[t].visible){e=t;break}}return[e,l]}case"ArrowUp":{const e=o.some((e=>!0===e.sortable))?0:1;if(l===e)return[n,l];let t=l;for(let s=l-1;s>=e;s--){if(0===s){t=0;break}if(!r[s-1].hidden){t=s;break}}return[n,t]}case"ArrowDown":{if(0===l){const e=r.findIndex((e=>!e.hidden));return e>-1?[n,e+1]:[n,l]}let e=l;for(let t=e+1;t<r.length+1;t++){if(!r[t-1].hidden){e=t;break}}return[n,e]}default:return t.assertNever(s,`Unknown arrow key: ${s}`)}}const M=e=>{const{columns:t,rows:s}=e,i=t.some((e=>!0===e.sortable))?0:s.findIndex((e=>!e.hidden))+1;return[t.findIndex((e=>e.visible)),i]};var I=Object.freeze({__proto__:null,getStringifiedCellValues:v,getRowEntryForColumnId:x,renderCellValue:R,calculateColumnWidthPercentageFromWeighting:S,handleArrowKeyNavigation:y,calculateFirstFocusableCell:M});const $=r.RenderCoordinator.RenderCoordinator.instance(),O={sortBy:"Sort By",resetColumns:"Reset Columns",headerOptions:"Header Options"},F=l.i18n.registerUIStrings("ui/components/data_grid/DataGrid.ts",O),z=l.i18n.getLocalizedString.bind(void 0,F),D=new Set([" ","Enter"]);class H extends HTMLElement{static litTagName=i.literal`devtools-data-grid`;#e=this.attachShadow({mode:"open"});#t=[];#s=[];#i=null;#o=!1;#r="NOT_SCROLLED";#n=void 0;#l=null;#a=new WeakMap;#c=new ResizeObserver((()=>{this.alignScrollHandlers()}));#d=this.onResizePointerUp.bind(this);#h=this.onResizePointerMove.bind(this);#u=this.onResizePointerDown.bind(this);#m=[0,1];#p=null;#f=!1;#w=!1;#g=!1;connectedCallback(){this.#e.adoptedStyleSheets=[a],o.SetCSSProperty.set(this,"--table-row-height","18px")}get data(){return{columns:this.#t,rows:this.#s,activeSort:this.#i,contextMenus:this.#n}}set data(e){if(this.#t=e.columns,this.#s=e.rows,this.#s.forEach(((e,t)=>{this.#a.set(e,t)})),this.#i=e.activeSort,this.#n=e.contextMenus,this.#f||(this.#m=M({columns:this.#t,rows:this.#s})),this.#f&&this.userHasCellFocused()){const[e,t]=this.tabbableCell(),s=e>this.#t.length,i=t>this.#s.length;(s||i)&&(this.#p=[s?this.#t.length:e,i?this.#s.length:t])}this.render()}shouldAutoScrollToBottom(){return"SCROLLED_TO_BOTTOM"===this.#r||!this.#w&&"MANUAL_SCROLL_NOT_BOTTOM"!==this.#r}scrollToBottomIfRequired(){!1!==this.#f&&this.shouldAutoScrollToBottom()&&$.read((()=>{const e=this.#e.querySelector(".wrapping-container");if(!e)return;const t=e.scrollHeight;$.scroll((()=>{e.scrollTo(0,t)}))}))}engageResizeObserver(){this.#f||this.#c.observe(this.#e.host)}userHasCellFocused(){return null!==this.#p}getTableElementForCellUserHasFocused(){if(!this.#p)return null;const[e,t]=this.#p;return this.#e.querySelector(`[data-row-index="${t}"][data-col-index="${e}"]`)}async focusTableCellInDOM(e){await $.write((()=>{e.focus()}))}focusCellIfRequired([e,t]){if(this.#w=!0,this.#p&&this.#p[0]===e&&this.#p[1]===t)return;this.#p=[e,t],this.render();const s=this.getTableElementForCellUserHasFocused();s&&this.focusTableCellInDOM(s)}onTableKeyDown(e){const s=e.key;if(!this.#p)return;if(D.has(s)){const[e,t]=this.#p,s=this.#t[e];0===t&&s&&s.sortable&&this.onColumnHeaderClick(s,e)}if(!t.KeyboardUtilities.keyIsArrowKey(s))return;const i=y({key:s,currentFocusedCell:this.#p,columns:this.#t,rows:this.#s});e.preventDefault(),this.focusCellIfRequired(i)}onColumnHeaderClick(e,t){this.dispatchEvent(new c(e,t))}ariaSortForHeader(e){return!e.sortable||this.#i&&this.#i.columnId===e.id?this.#i&&this.#i.columnId===e.id?"ASC"===this.#i.direction?"ascending":"descending":void 0:"none"}renderEmptyFillerRow(e){const t=this.#t.map(((e,t)=>{if(!e.visible)return i.nothing;const s=i.Directives.classMap({firstVisibleColumn:0===t});return i.html`<td tabindex="-1" class="${s}" data-filler-row-column-index="${t}">`})),s=i.Directives.classMap({"filler-row":!0,"padding-row":!0,"empty-table":0===e});return i.html`<tr tabindex="-1" class="${s}">${t}`}cleanUpAfterResizeColumnComplete(){this.#l&&(this.#l.documentForCursorChange.body.style.cursor=this.#l.cursorToRestore,this.#l=null,this.alignScrollHandlers())}onResizePointerDown(t){if(1!==t.buttons||e.Platform.isMac()&&t.ctrlKey)return;t.preventDefault();const s=t.target;if(!s)return;const i=s.dataset.columnIndex;if(!i)return;const o=globalThis.parseInt(i,10),r=this.#t.findIndex(((e,t)=>t>o&&!0===e.visible)),n=this.#e.querySelector(`td[data-filler-row-column-index="${o}"]`),l=this.#e.querySelector(`td[data-filler-row-column-index="${r}"]`);if(!n||!l)return;const a=this.#e.querySelector(`col[data-col-column-index="${o}"]`),c=this.#e.querySelector(`col[data-col-column-index="${r}"]`);if(!a||!c)return;const d=t.target.ownerDocument;d&&(this.#l={leftCellCol:a,rightCellCol:c,leftCellColInitialPercentageWidth:globalThis.parseInt(a.style.width,10),rightCellColInitialPercentageWidth:globalThis.parseInt(c.style.width,10),initialLeftCellWidth:n.clientWidth,initialRightCellWidth:l.clientWidth,initialMouseX:t.x,documentForCursorChange:d,cursorToRestore:s.style.cursor},d.body.style.cursor="col-resize",s.setPointerCapture(t.pointerId),s.addEventListener("pointermove",this.#h))}onResizePointerMove(e){if(e.preventDefault(),!this.#l)return;const s=this.#l.leftCellColInitialPercentageWidth+this.#l.rightCellColInitialPercentageWidth-10,i=e.x-this.#l.initialMouseX,o=Math.abs(i)/(this.#l.initialLeftCellWidth+this.#l.initialRightCellWidth)*100;let r,n;i>0?(r=t.NumberUtilities.clamp(this.#l.leftCellColInitialPercentageWidth+o,10,s),n=t.NumberUtilities.clamp(this.#l.rightCellColInitialPercentageWidth-o,10,s)):i<0&&(r=t.NumberUtilities.clamp(this.#l.leftCellColInitialPercentageWidth-o,10,s),n=t.NumberUtilities.clamp(this.#l.rightCellColInitialPercentageWidth+o,10,s)),r&&n&&(this.#l.leftCellCol.style.width=r.toFixed(2)+"%",this.#l.rightCellCol.style.width=n.toFixed(2)+"%")}onResizePointerUp(e){e.preventDefault();const t=e.target;t&&(t.releasePointerCapture(e.pointerId),t.removeEventListener("pointermove",this.#h),this.cleanUpAfterResizeColumnComplete())}renderResizeForCell(e,t){const[s]=t;return s!==this.getIndexOfLastVisibleColumn()&&e.visible?i.html`<span class="cell-resize-handle" @pointerdown="${this.#u}" @pointerup="${this.#d}" data-column-index="${s}"></span>`:i.nothing}getIndexOfLastVisibleColumn(){let e=this.#t.length-1;for(;e>-1;e--){if(this.#t[e].visible)break}return e}onHeaderContextMenu(e){if(2!==e.button)return;const t=new s.ContextMenu.ContextMenu(e);w(this,t);g(this,t.defaultSection().appendSubMenuItem(z(O.sortBy))),t.defaultSection().appendItem(z(O.resetColumns),(()=>{this.dispatchEvent(new h)})),this.#n&&this.#n.headerRow&&this.#n.headerRow(t,this.#t),t.show()}onBodyRowContextMenu(e){if(2!==e.button)return;if(!(e.target&&e.target instanceof HTMLElement))return;const t=e.target.dataset.rowIndex;if(!t)return;const i=parseInt(t,10),o=this.#s[i-1],r=new s.ContextMenu.ContextMenu(e);g(this,r.defaultSection().appendSubMenuItem(z(O.sortBy)));const n=r.defaultSection().appendSubMenuItem(z(O.headerOptions));w(this,n),n.defaultSection().appendItem(z(O.resetColumns),(()=>{this.dispatchEvent(new h)})),this.#n&&this.#n.bodyRow&&this.#n.bodyRow(r,this.#t,o),r.show()}onScroll(e){const t=e.target;if(!t)return;const s=Math.round(t.scrollTop+t.clientHeight)===Math.round(t.scrollHeight);this.#r=s?"SCROLLED_TO_BOTTOM":"MANUAL_SCROLL_NOT_BOTTOM",this.render()}alignScrollHandlers(){return $.read((()=>{const e=this.#e.querySelectorAll("th:not(.hidden)"),t=this.#e.querySelectorAll(".cell-resize-handle");this.#e.querySelector("table")&&e.forEach((async(e,s)=>{const i=e.clientWidth,o=e.offsetLeft;if(t[s]){const e=t[s].clientWidth;$.write((()=>{t[s].style.left=o+i-e+"px"}))}}))}))}calculateTopAndBottomRowIndexes(){return $.read((()=>{const e=this.#e.querySelector(".wrapping-container");let t=0,s=window.innerHeight;e&&(t=e.scrollTop,s=e.clientHeight);let i=Math.floor((t-180)/18),o=Math.ceil((t+s+180)/18);return i=Math.max(0,i),o=Math.min(this.#s.filter((e=>!e.hidden)).length,o),{topVisibleRow:i,bottomVisibleRow:o}}))}onFocusOut(){this.#w=!1}tabbableCell(){return this.#p||this.#m}async render(){if(this.#o)return void(this.#g=!0);this.#o=!0;const{topVisibleRow:e,bottomVisibleRow:t}=await this.calculateTopAndBottomRowIndexes(),s=this.#s.filter((e=>!e.hidden)),o=s.filter(((s,i)=>i>=e&&i<=t)),r=this.#t.findIndex((e=>e.visible)),n=this.#t.some((e=>!0===e.sortable));await $.write((()=>{i.render(i.html` ${this.#t.map(((e,t)=>this.renderResizeForCell(e,[t,0])))} <div class="wrapping-container" @scroll="${this.onScroll}" @focusout="${this.onFocusOut}"> <table aria-rowcount="${this.#s.length}" aria-colcount="${this.#t.length}" @keydown="${this.onTableKeyDown}"> <colgroup> ${this.#t.map(((e,t)=>{const s=`width: ${S(this.#t,e.id)}%`;return e.visible?i.html`<col style="${s}" data-col-column-index="${t}">`:i.nothing}))} </colgroup> <thead> <tr @contextmenu="${this.onHeaderContextMenu}"> ${this.#t.map(((e,t)=>{const s=i.Directives.classMap({hidden:!e.visible,firstVisibleColumn:t===r}),o=this.tabbableCell(),l=n&&t===o[0]&&0===o[1];return i.html`<th class="${s}" style="${i.Directives.ifDefined(e.styles?i.Directives.styleMap(e.styles):void 0)}" data-grid-header-cell="${e.id}" @focus="${()=>{this.focusCellIfRequired([t,0])}}" @click="${()=>{this.onColumnHeaderClick(e,t)}}" title="${e.title}" aria-sort="${i.Directives.ifDefined(this.ariaSortForHeader(e))}" aria-colindex="${t+1}" data-row-index="0" data-col-index="${t}" tabindex="${i.Directives.ifDefined(n?l?"0":"-1":void 0)}">${e.titleElement||e.title}`}))} </tr> </thead> <tbody> <tr class="filler-row-top padding-row" style="${i.Directives.styleMap({height:18*e+"px"})}"></tr> ${i.Directives.repeat(o,(e=>this.#a.get(e)),(e=>{const t=this.#a.get(e);if(void 0===t)throw new Error("Trying to render a row that has no index in the rowIndexMap");const s=this.tabbableCell(),o=t+1,n=!!this.#p&&o===this.#p[1],l=i.Directives.classMap({selected:n,hidden:!0===e.hidden});return i.html` <tr aria-rowindex="${t+1}" class="${l}" style="${i.Directives.ifDefined(e.styles?i.Directives.styleMap(e.styles):void 0)}" @contextmenu="${this.onBodyRowContextMenu}">${this.#t.map(((t,n)=>{const l=x(e,t.id),a=i.Directives.classMap({hidden:!t.visible,firstVisibleColumn:n===r}),c=n===s[0]&&o===s[1],d=t.visible?R(l):null;return i.html`<td class="${a}" style="${i.Directives.ifDefined(t.styles?i.Directives.styleMap(t.styles):void 0)}" tabindex="${c?"0":"-1"}" aria-colindex="${n+1}" title="${l.title||String(l.value).substr(0,20)}" data-row-index="${o}" data-col-index="${n}" data-grid-value-cell-for-column="${t.id}" @focus="${()=>{this.focusCellIfRequired([n,o]),this.dispatchEvent(new m(l,e))}}">${d}`}))} `}))} ${this.renderEmptyFillerRow(o.length)} <tr class="filler-row-bottom padding-row" style="${i.Directives.styleMap({height:18*Math.max(0,s.length-t)+"px"})}"></tr> </tbody> </table> </div> `,this.#e,{host:this})}));const l=this.tabbableCell()[1],a=this.getTableElementForCellUserHasFocused();this.#w&&l>0&&a&&this.focusTableCellInDOM(a),this.scrollToBottomIfRequired(),this.engageResizeObserver(),this.#f&&this.alignScrollHandlers(),this.#o=!1,this.#f=!0,this.#g&&(this.#g=!1,this.render())}}o.CustomElements.defineComponent("devtools-data-grid",H);var T=Object.freeze({__proto__:null,DataGrid:H});const k=new CSSStyleSheet;k.replaceSync(":host{display:block;height:100%;overflow:hidden}\n/*# sourceURL=dataGridController.css */\n");class E extends HTMLElement{static litTagName=i.literal`devtools-data-grid-controller`;#e=this.attachShadow({mode:"open"});#f=!1;#t=[];#s=[];#n=void 0;#b=[];#C=[];#i=null;#v=[];connectedCallback(){this.#e.adoptedStyleSheets=[k]}get data(){return{columns:this.#b,rows:this.#C,filters:this.#v,contextMenus:this.#n}}set data(e){this.#b=e.columns,this.#C=e.rows,this.#n=e.contextMenus,this.#v=e.filters||[],this.#n=e.contextMenus,this.#t=[...this.#b],this.#s=this.cloneAndFilterRows(e.rows,this.#v),!this.#f&&e.initialSort&&(this.#i=e.initialSort),this.#i&&this.sortRows(this.#i),this.render()}testRowWithFilter(e,t){let s=!1;const{key:i,text:o,negative:r,regex:n}=t;let l;return l=v(i?[x(e,i)]:e.cells),n?s=n.test(l):o&&(s=l.includes(o.toLowerCase())),r?!s:s}cloneAndFilterRows(e,t){return 0===t.length?[...e]:e.map((e=>{let s=!0;for(const i of t){if(!this.testRowWithFilter(e,i)){s=!1;break}}return{...e,hidden:!s}}))}sortRows(e){const{columnId:t,direction:s}=e;this.#s.sort(((e,i)=>{const o=x(e,t),r=x(i,t),n="number"==typeof o.value?o.value:String(o.value).toUpperCase(),l="number"==typeof r.value?r.value:String(r.value).toUpperCase();return n<l?"ASC"===s?-1:1:n>l?"ASC"===s?1:-1:0})),this.render()}onColumnHeaderClick(e){const{column:t}=e.data;this.applySortOnColumn(t)}applySortOnColumn(e){if(this.#i&&this.#i.columnId===e.id){const{columnId:e,direction:t}=this.#i;this.#i="DESC"===t?null:{columnId:e,direction:"DESC"}}else this.#i={columnId:e.id,direction:"ASC"};this.#i?this.sortRows(this.#i):(this.#s=this.cloneAndFilterRows(this.#C,this.#v),this.render())}onContextMenuColumnSortClick(e){this.applySortOnColumn(e.data.column)}onContextMenuHeaderResetClick(){this.#i=null,this.#s=[...this.#C],this.render()}render(){i.render(i.html` <${H.litTagName} .data="${{columns:this.#t,rows:this.#s,activeSort:this.#i,contextMenus:this.#n}}" @columnheaderclick="${this.onColumnHeaderClick}" @contextmenucolumnsortclick="${this.onContextMenuColumnSortClick}" @contextmenuheaderresetclick="${this.onContextMenuHeaderResetClick}"></${H.litTagName}> `,this.#e,{host:this}),this.#f=!0}}o.CustomElements.defineComponent("devtools-data-grid-controller",E);var U=Object.freeze({__proto__:null,DataGridController:E});class _ extends s.Widget.VBox{dataGrid;constructor(e){super(!0,!0),this.dataGrid=new E,this.dataGrid.data=e,this.contentElement.appendChild(this.dataGrid)}data(){return this.dataGrid.data}update(e){this.dataGrid.data=e}}var L=Object.freeze({__proto__:null,DataGridControllerIntegrator:_});export{T as DataGrid,U as DataGridController,L as DataGridControllerIntegrator,p as DataGridEvents,C as DataGridRenderers,I as DataGridUtils};
