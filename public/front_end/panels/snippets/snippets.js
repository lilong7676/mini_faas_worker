import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as n from"../../core/platform/platform.js";import*as i from"../../core/sdk/sdk.js";import*as s from"../../models/persistence/persistence.js";import*as o from"../../ui/legacy/legacy.js";import*as r from"../../models/workspace/workspace.js";import*as p from"../../ui/legacy/components/quick_open/quick_open.js";const c={scriptSnippet:"Script snippet #{PH1}",linkedTo:"Linked to {PH1}"},a=t.i18n.registerUIStrings("panels/snippets/ScriptSnippetFileSystem.ts",c),l=t.i18n.getLocalizedString.bind(void 0,a);function u(e){return escape(e)}function d(e){return unescape(e)}class g extends s.PlatformFileSystem.PlatformFileSystem{lastSnippetIdentifierSetting;snippetsSetting;constructor(){super("snippet://","snippets"),this.lastSnippetIdentifierSetting=e.Settings.Settings.instance().createSetting("scriptSnippets_lastIdentifier",0),this.snippetsSetting=e.Settings.Settings.instance().createSetting("scriptSnippets",[])}initialFilePaths(){return this.snippetsSetting.get().map((e=>u(e.name)))}async createFile(e,t){const n=this.lastSnippetIdentifierSetting.get()+1;this.lastSnippetIdentifierSetting.set(n);const i=l(c.scriptSnippet,{PH1:n}),s=this.snippetsSetting.get();return s.push({name:i,content:""}),this.snippetsSetting.set(s),u(i)}async deleteFile(e){const t=d(e.substring(1)),n=this.snippetsSetting.get(),i=n.filter((e=>e.name!==t));return n.length!==i.length&&(this.snippetsSetting.set(i),!0)}async requestFileContent(e){const t=d(e.substring(1)),n=this.snippetsSetting.get().find((e=>e.name===t));return n?{content:n.content,isEncoded:!1}:{content:null,isEncoded:!1,error:`A snippet with name '${t}' was not found`}}async setFileContent(e,t,n){const i=d(e.substring(1)),s=this.snippetsSetting.get(),o=s.find((e=>e.name===i));return!!o&&(o.content=t,this.snippetsSetting.set(s),!0)}renameFile(e,t,n){const i=d(e.substring(1)),s=this.snippetsSetting.get(),o=s.find((e=>e.name===i));t=t.trim(),o&&0!==t.length&&!s.find((e=>e.name===t))?(o.name=t,this.snippetsSetting.set(s),n(!0,t)):n(!1)}async searchInPath(e,t){const i=new RegExp(n.StringUtilities.escapeForRegExp(e),"i");return this.snippetsSetting.get().filter((e=>e.content.match(i))).map((e=>`snippet:///${u(e.name)}`))}mimeFromPath(e){return"text/javascript"}contentType(t){return e.ResourceType.resourceTypes.Script}tooltipForURL(e){return l(c.linkedTo,{PH1:d(e.substring(this.path().length))})}supportsAutomapping(){return!0}}async function m(t){if(!t.url().startsWith("snippet://"))return;const n=o.Context.Context.instance().flavor(i.RuntimeModel.ExecutionContext);if(!n)return;const s=n.runtimeModel;await t.requestContent(),t.commitWorkingCopy();const r=t.workingCopy();e.Console.Console.instance().show();const p=t.url(),c=await n.evaluate({expression:`${r}\n//# sourceURL=${p}`,objectGroup:"console",silent:!1,includeCommandLineAPI:!0,returnByValue:!1,generatePreview:!0,replMode:!0},!1,!0);if("exceptionDetails"in c&&c.exceptionDetails)return void i.ConsoleModel.ConsoleModel.instance().addMessage(i.ConsoleModel.ConsoleMessage.fromException(s,c.exceptionDetails,void 0,void 0,p));if(!("object"in c)||!c.object)return;const a=n.debuggerModel.scriptsForSourceURL(p);if(a.length<1)return;const l=a[a.length-1].scriptId,u={type:i.ConsoleModel.FrontendMessageType.Result,url:p,parameters:[c.object],executionContextId:n.id,scriptId:l};i.ConsoleModel.ConsoleModel.instance().addMessage(new i.ConsoleModel.ConsoleMessage(s,"javascript","info","",u))}function S(){const e=r.Workspace.WorkspaceImpl.instance().projectsForType(r.Workspace.projectTypes.FileSystem).find((e=>"snippets"===s.FileSystemWorkspaceBinding.FileSystemWorkspaceBinding.fileSystemType(e)));if(!e)throw new Error("Unable to find workspace project for the snippets file system");return e}var f=Object.freeze({__proto__:null,SnippetFileSystem:g,evaluateScriptSnippet:m,isSnippetsUISourceCode:function(e){return e.url().startsWith("snippet://")},isSnippetsProject:function(e){return e.type()===r.Workspace.projectTypes.FileSystem&&"snippets"===s.FileSystemWorkspaceBinding.FileSystemWorkspaceBinding.fileSystemType(e)},findSnippetsProject:S});const h={noSnippetsFound:"No snippets found.",run:"Run",snippet:"Snippet"},y=t.i18n.registerUIStrings("panels/snippets/SnippetsQuickOpen.ts",h),F=t.i18n.getLocalizedString.bind(void 0,y),C=t.i18n.getLazilyComputedLocalizedString.bind(void 0,y);let k;class j extends p.FilteredListWidget.Provider{snippets;constructor(){super(),this.snippets=[]}static instance(e={forceNew:null}){const{forceNew:t}=e;return k&&!t||(k=new j),k}selectItem(e,t){null!==e&&m(this.snippets[e])}notFoundText(e){return F(h.noSnippetsFound)}attach(){this.snippets=S().uiSourceCodes()}detach(){this.snippets=[]}itemCount(){return this.snippets.length}itemKeyAt(e){return this.snippets[e].name()}renderItem(e,t,n,i){n.textContent=unescape(this.snippets[e].name()),n.classList.add("monospace"),p.FilteredListWidget.FilteredListWidget.highlightRanges(n,t,!0)}}p.FilteredListWidget.registerProvider({prefix:"!",iconName:"ic_command_run_snippet",provider:()=>Promise.resolve(j.instance()),titlePrefix:C(h.run),titleSuggestion:C(h.snippet)});var x=Object.freeze({__proto__:null,SnippetsQuickOpen:j});export{f as ScriptSnippetFileSystem,x as SnippetsQuickOpen};
