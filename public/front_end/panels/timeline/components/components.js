import*as t from"../../../core/host/host.js";import*as e from"../../../core/i18n/i18n.js";import*as i from"../../../ui/components/helpers/helpers.js";import*as s from"../../../ui/components/render_coordinator/render_coordinator.js";import*as n from"../../../ui/lit-html/lit-html.js";class o{context;timeline;theme;constructor(t){this.timeline=t,this.context=t.getContext();const e=getComputedStyle(document.documentElement);this.theme={good:e.getPropertyValue("--lighthouse-green"),medium:e.getPropertyValue("--lighthouse-orange"),bad:e.getPropertyValue("--lighthouse-red"),frame:e.getPropertyValue("--color-primary"),textPrimary:e.getPropertyValue("--color-text-primary"),textSecondary:e.getPropertyValue("--color-text-secondary"),background:e.getPropertyValue("--color-background"),background50:e.getPropertyValue("--color-background-opacity-50"),timeboxColor:e.getPropertyValue("--color-primary-variant")}}tX(t){return this.timeline.tX(t)}tD(t){return this.timeline.tD(t)}renderLaneLabel(e){const i=e.toLocaleUpperCase();this.context.save(),this.context.font="9px "+t.Platform.fontFamily();const s=this.context.measureText(i),n=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent;this.context.fillStyle=this.theme.background50,this.context.fillRect(0,1,s.width+12,n+6),this.context.fillStyle=this.theme.textSecondary,this.context.fillText(i,6,n+4),this.context.restore()}render(){}}class a extends o{markers=[];selectedMarker=null;hoverMarker=null;labelMetrics;label;getMarkerType;getMarkerOverlay;constructor(t,e,i,s){super(t),this.context=t.getContext(),this.label=e,this.getMarkerType=i,this.getMarkerOverlay=s,this.labelMetrics=this.measureLabel(this.label)}handlePointerMove(t){const e=this.hoverMarker;this.hoverMarker=null===t?null:this.markers.find((e=>{const i=this.tX(e.timestamp);return i-5<=t&&t<=i+e.widthIncludingLabel}))||null,e!==this.hoverMarker&&(this.hoverMarker&&this.getMarkerOverlay?this.timeline.showOverlay(this.getMarkerOverlay(this.hoverMarker)):this.timeline.hideOverlay())}handleClick(t){this.selectedMarker=this.hoverMarker}setEvents(t){this.hoverMarker=null,this.selectedMarker=null,this.markers=t.map((t=>this.getMarker(t)))}measureLabel(e){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const i=this.context.measureText(e);return this.context.restore(),i}measureTimestamp(e){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const i=this.context.measureText(e);return this.context.restore(),i}getMarker(t){const i=this.getMarkerType(t),s=this.timeline.getTimeSinceLastMainFrameNavigation(t.timestamp),n=e.TimeUtilities.preciseMillisToString(s,1),o=this.measureTimestamp(n),a=15+this.labelMetrics.width+5,r=a+5+o.width;return{timestamp:t.timestamp,timestampLabel:n,type:i,timestampMetrics:o,widthIncludingLabel:a,widthIncludingTimestamp:r}}renderLabel(e,i,s){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const n=s.actualBoundingBoxAscent-s.actualBoundingBoxDescent;this.context.fillStyle=this.theme.textPrimary,this.context.fillText(i,this.tX(e)+.5*this.timeline.getLineHeight(),.5*this.timeline.getLineHeight()+.5*n),this.context.restore()}renderTimestamp(e,i,s,n){this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const o=n.actualBoundingBoxAscent-n.actualBoundingBoxDescent;this.context.fillStyle=this.theme.textSecondary,this.context.fillText(s,this.tX(e)+.5*this.timeline.getLineHeight()+i+5,.5*this.timeline.getLineHeight()+.5*o),this.context.restore()}renderGoodMarkerSymbol(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.good,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.good,this.context.arc(this.tX(t),.5*this.timeline.getLineHeight(),5,0,2*Math.PI),this.context.fill(),this.context.restore()}renderMediumMarkerSymbol(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.medium,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.medium,this.context.rect(this.tX(t)-5,.5*this.timeline.getLineHeight()-5,10,10),this.context.fill(),this.context.restore()}renderBadMarkerSymbol(t){this.context.save(),this.context.beginPath(),this.context.strokeStyle=this.theme.bad,this.context.moveTo(this.tX(t),2),this.context.lineTo(this.tX(t),5),this.context.moveTo(this.tX(t),19),this.context.lineTo(this.tX(t),22),this.context.stroke(),this.context.beginPath(),this.context.fillStyle=this.theme.bad,this.context.translate(this.tX(t),.5*this.timeline.getLineHeight()),this.context.rotate(45*Math.PI/180),this.context.rect(-4,-4,8,8),this.context.rotate(-45*Math.PI/180),this.context.translate(-this.tX(t),-.5*this.timeline.getLineHeight()),this.context.fill(),this.context.restore()}renderMarker(t,e,i,s){const n=t.timestampLabel,o=this.labelMetrics,a=t.timestampMetrics,r=e,h=i||e,l=t.widthIncludingLabel,c=h?t.widthIncludingTimestamp:l,d=s?this.tD(s.timestamp-t.timestamp):null,m=h||null!==d&&d>l+5;if(h){this.context.save();const e=this.tX(t.timestamp)-5-5,i=1,s=c+10,n=this.timeline.getLineHeight()-2;this.context.fillStyle=this.theme.background,this.context.fillRect(e,i,s,n),r&&(this.context.strokeStyle=this.theme.frame,this.context.lineWidth=2,this.context.strokeRect(e,i,s,n),this.context.lineWidth=1),this.context.restore()}m&&(o&&this.renderLabel(t.timestamp,this.label,o),h&&this.renderTimestamp(t.timestamp,o?o.width:0,n,a)),"Good"===t.type?this.renderGoodMarkerSymbol(t.timestamp):"Medium"===t.type?this.renderMediumMarkerSymbol(t.timestamp):this.renderBadMarkerSymbol(t.timestamp)}render(){for(let t=0;t<this.markers.length;t++){const e=this.markers[t];e!==this.selectedMarker&&e!==this.hoverMarker&&this.renderMarker(e,!1,!1,t<this.markers.length-1?this.markers[t+1]:null)}this.hoverMarker&&this.hoverMarker!==this.selectedMarker&&this.renderMarker(this.hoverMarker,!1,!0,null),this.selectedMarker&&this.renderMarker(this.selectedMarker,!0,!1,null)}}class r extends o{longTaskPattern;boxes=[];label;hoverBox=-1;selectedBox=-1;getTimeboxOverlay;constructor(t,e,i){super(t),this.label=e;const s=document.createElement("canvas"),n=s.getContext("2d");x(n,CanvasRenderingContext2D);const o=17;s.width=o,s.height=o,n.translate(8.5,8.5),n.rotate(.25*Math.PI),n.translate(-8.5,-8.5),n.fillStyle="#000";for(let t=-17;t<34;t+=3)n.fillRect(t,-17,1,51);const a=this.context.createPattern(s,"repeat");x(a,CanvasPattern),this.longTaskPattern=a,this.getTimeboxOverlay=i}handlePointerMove(t){const e=this.hoverBox;this.hoverBox=null===t?-1:this.boxes.findIndex((e=>{const i=this.tX(e.start),s=this.tX(e.start+e.duration);return i<=t&&t<=s})),e!==this.hoverBox&&(-1!==this.hoverBox&&this.getTimeboxOverlay?this.timeline.showOverlay(this.getTimeboxOverlay(this.boxes[this.hoverBox])):this.timeline.hideOverlay())}handleClick(t){this.selectedBox=this.hoverBox}setTimeboxes(t){this.selectedBox=-1,this.hoverBox=-1,this.boxes=t}renderTimebox(t,e){this.context.save(),this.context.beginPath(),this.context.fillStyle=this.theme.timeboxColor,this.context.moveTo(this.tX(t.start)+2,2),this.context.lineTo(this.tX(t.start+t.duration)-2,2),this.context.quadraticCurveTo(this.tX(t.start+t.duration),2,this.tX(t.start+t.duration),4),this.context.lineTo(this.tX(t.start+t.duration),20),this.context.quadraticCurveTo(this.tX(t.start+t.duration),20,this.tX(t.start+t.duration)-2,22),this.context.lineTo(this.tX(t.start)+2,22),this.context.quadraticCurveTo(this.tX(t.start)+2,22,this.tX(t.start),20),this.context.lineTo(this.tX(t.start),4),this.context.quadraticCurveTo(this.tX(t.start),4,this.tX(t.start)+2,2),this.context.closePath(),this.context.fill(),this.context.beginPath(),this.context.fillStyle=this.longTaskPattern,this.context.moveTo(this.tX(t.start+m)+2,2),this.context.lineTo(this.tX(t.start+t.duration)-2,2),this.context.quadraticCurveTo(this.tX(t.start+t.duration),2,this.tX(t.start+t.duration),4),this.context.lineTo(this.tX(t.start+t.duration),20),this.context.quadraticCurveTo(this.tX(t.start+t.duration),20,this.tX(t.start+t.duration)-2,22),this.context.lineTo(this.tX(t.start+50),22),this.context.lineTo(this.tX(t.start+50),2),this.context.closePath(),this.context.fill(),e&&(this.context.beginPath(),this.context.strokeStyle=this.theme.frame,this.context.rect(this.tX(t.start)-2,0,this.tD(t.duration)+4,24),this.context.lineWidth=2,this.context.stroke(),this.context.lineWidth=1),this.context.restore()}render(){for(let t=0;t<this.boxes.length;t++)t!==this.hoverBox&&t!==this.selectedBox&&this.renderTimebox(this.boxes[t],!1);-1!==this.hoverBox&&this.renderTimebox(this.boxes[this.hoverBox],!0),-1!==this.selectedBox&&this.renderTimebox(this.boxes[this.selectedBox],!0),this.renderLaneLabel(this.label)}}const h=s.RenderCoordinator.RenderCoordinator.instance(),l={fcp:"FCP",lcp:"LCP",ls:"LS",longTasks:"Long Tasks",longTask:"Long Task",firstContentfulPaint:"First Contentful Paint",largestContentfulPaint:"Largest Contentful Paint",good:"Good",needsImprovement:"Needs improvement",poor:"Poor"},c=e.i18n.registerUIStrings("panels/timeline/components/WebVitalsTimeline.ts",l),d=e.i18n.getLocalizedString.bind(void 0,c),m=50;function x(t,e){if(!(t instanceof e))throw new TypeError(`Instance expected to be of type ${e.name} but got ${t.constructor.name}`)}class u extends HTMLElement{static litTagName=n.literal`devtools-timeline-webvitals`;shadow=this.attachShadow({mode:"open"});mainFrameNavigations=[];startTime=0;duration=1e3;maxDuration=1e3;width=0;height=0;canvas;hoverLane=null;fcpLane;lcpLane;layoutShiftsLane;longTasksLane;context;animationFrame=null;overlay;constructor(){super(),this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height=`${Math.max(120,120)}px`,this.shadow.appendChild(this.canvas),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this)),this.canvas.addEventListener("pointerout",this.handlePointerOut.bind(this)),this.canvas.addEventListener("click",this.handleClick.bind(this));const t=this.canvas.getContext("2d");x(t,CanvasRenderingContext2D),this.context=t,this.fcpLane=new a(this,d(l.fcp),(t=>this.getMarkerTypeForFCPEvent(t)),this.getFCPMarkerOverlay),this.lcpLane=new a(this,d(l.lcp),(t=>this.getMarkerTypeForLCPEvent(t)),this.getLCPMarkerOverlay),this.layoutShiftsLane=new a(this,d(l.ls),(t=>"Bad")),this.longTasksLane=new r(this,d(l.longTasks),this.getLongTaskOverlay),this.overlay=document.createElement("devtools-timeline-webvitals-tooltip"),this.overlay.style.position="absolute",this.overlay.style.visibility="hidden",this.ownerDocument.body.appendChild(this.overlay)}set data(t){this.startTime=t.startTime||this.startTime,this.duration=t.duration||this.duration,this.maxDuration=t.maxDuration||this.maxDuration,this.mainFrameNavigations=t.mainFrameNavigations||this.mainFrameNavigations,t.fcps&&this.fcpLane.setEvents(t.fcps),t.lcps&&this.lcpLane.setEvents(t.lcps),t.layoutShifts&&this.layoutShiftsLane.setEvents(t.layoutShifts),t.longTasks&&this.longTasksLane.setTimeboxes(t.longTasks),this.scheduleRender()}getContext(){return this.context}getLineHeight(){return 24}hideOverlay(){this.overlay.style.visibility="hidden"}showOverlay(t){this.overlay.data={content:t},this.overlay.style.visibility="visible"}handlePointerMove(t){this.updateOverlayPosition(t.clientX,t.clientY);const e=t.offsetX,i=t.offsetY,s=Math.floor(i/24);this.hoverLane=s,this.fcpLane.handlePointerMove(1===this.hoverLane?e:null),this.lcpLane.handlePointerMove(2===this.hoverLane?e:null),this.layoutShiftsLane.handlePointerMove(3===this.hoverLane?e:null),this.longTasksLane.handlePointerMove(4===this.hoverLane?e:null),this.scheduleRender()}updateOverlayPosition(t,e){h.read((()=>{const i=this.getBoundingClientRect(),s=this.overlay.getBoundingClientRect(),n=t+10+s.width>i.x+i.width?t-s.width-10:t+10;h.write((()=>{this.overlay.style.top=`${e+10}px`,this.overlay.style.left=`${n}px`}))}))}handlePointerOut(t){this.fcpLane.handlePointerMove(null),this.lcpLane.handlePointerMove(null),this.layoutShiftsLane.handlePointerMove(null),this.longTasksLane.handlePointerMove(null),this.scheduleRender()}handleClick(t){const e=t.offsetX;this.focus(),this.fcpLane.handleClick(1===this.hoverLane?e:null),this.lcpLane.handleClick(2===this.hoverLane?e:null),this.layoutShiftsLane.handleClick(3===this.hoverLane?e:null),this.longTasksLane.handleClick(4===this.hoverLane?e:null),this.scheduleRender()}tX(t){return(t-this.startTime)/this.duration*this.width}tD(t){return t/this.duration*this.width}setSize(t,e){const i=window.devicePixelRatio;this.width=t,this.height=Math.max(e,120),this.canvas.width=Math.floor(this.width*i),this.canvas.height=Math.floor(this.height*i),this.context.scale(i,i),this.style.width=this.width+"px",this.style.height=this.height+"px",this.render()}connectedCallback(){this.style.display="block",this.tabIndex=0;const t=this.canvas.getBoundingClientRect(),e=t.width,i=t.height;this.setSize(e,i),this.render()}disconnectedCallback(){this.overlay.remove()}getMarkerTypeForFCPEvent(t){const e=this.getTimeSinceLastMainFrameNavigation(t.timestamp);return e<=2e3?"Good":e<=4e3?"Medium":"Bad"}getMarkerTypeForLCPEvent(t){const e=this.getTimeSinceLastMainFrameNavigation(t.timestamp);return e<=2500?"Good":e<=4e3?"Medium":"Bad"}getFCPMarkerOverlay(){return n.html` <table class="table"> <thead> <td colspan="3" class="title">${d(l.firstContentfulPaint)}</td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td> ≤ ${e.TimeUtilities.millisToString(2e3)}</td> </tr> <tr> <td><span class="medium"></span></td> <td>${d(l.needsImprovement)}</td> <td></td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(4e3)}</td> </tr> </tbody> </table> `}getLCPMarkerOverlay(){return n.html` <table class="table"> <thead> <td colspan="3" class="title">${d(l.largestContentfulPaint)}</td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td> ≤ ${e.TimeUtilities.millisToString(2500)}</td> </tr> <tr> <td><span class="medium"></span></td> <td>${d(l.needsImprovement)}</td> <td></td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(4e3)}</td> </tr> </tbody> </table> `}getLongTaskOverlay(t){return n.html` <table class="table"> <thead> <td colspan="3" class="title"> ${d(l.longTask)} <span class="small"> ${e.TimeUtilities.millisToString(t.duration)} </span> </td> </thead> <tbody> <tr> <td><span class="good"></span></td> <td>${d(l.good)}</td> <td>≤ ${e.TimeUtilities.millisToString(m)}</td> </tr> <tr> <td><span class="bad"></span></td> <td>${d(l.poor)}</td> <td>> ${e.TimeUtilities.millisToString(m)}</td> </tr> </tbody> </table> `}renderMainFrameNavigations(t){this.context.save(),this.context.strokeStyle="blue",this.context.beginPath();for(const e of t)this.context.moveTo(this.tX(e),0),this.context.lineTo(this.tX(e),this.height);this.context.stroke(),this.context.restore()}getTimeSinceLastMainFrameNavigation(t){let e=0,i=0;for(;e<this.mainFrameNavigations.length&&this.mainFrameNavigations[e]<=t;)i=this.mainFrameNavigations[e],e++;return t-i}render(){this.context.save(),this.context.clearRect(0,0,this.width,this.height),this.context.strokeStyle="#dadce0",this.context.beginPath();for(let t=0;t<5;t++)this.context.moveTo(0,24*t+.5),this.context.lineTo(this.width,24*t+.5);this.context.moveTo(0,119.5),this.context.lineTo(this.width,119.5),this.context.stroke(),this.context.restore(),this.context.save(),this.context.font="11px "+t.Platform.fontFamily();const e=this.context.measureText("Web Vitals"),i=e.actualBoundingBoxAscent-e.actualBoundingBoxDescent;this.context.fillStyle="#202124",this.context.fillText("Web Vitals",6,4+i),this.context.restore(),this.context.save(),this.context.translate(0,Number(24)),this.fcpLane.render(),this.context.translate(0,Number(24)),this.lcpLane.render(),this.context.translate(0,Number(24)),this.layoutShiftsLane.render(),this.context.translate(0,Number(24)),this.longTasksLane.render(),this.context.restore(),this.renderMainFrameNavigations(this.mainFrameNavigations)}scheduleRender(){this.animationFrame||(this.animationFrame=window.requestAnimationFrame((()=>{this.animationFrame=null,this.render()})))}}i.CustomElements.defineComponent("devtools-timeline-webvitals",u);var g=Object.freeze({__proto__:null,LINE_HEIGHT:24,LONG_TASK_THRESHOLD:m,assertInstanceOf:x,WebVitalsTimeline:u});export{g as WebVitalsTimeline};
