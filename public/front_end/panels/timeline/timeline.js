import*as e from"../../core/sdk/sdk.js";import*as t from"../../core/common/common.js";import*as i from"../../core/i18n/i18n.js";import*as n from"../../core/platform/platform.js";import*as r from"../../models/timeline_model/timeline_model.js";import*as a from"../../ui/legacy/components/perf_ui/perf_ui.js";import*as s from"../../ui/legacy/legacy.js";import*as o from"../../models/bindings/bindings.js";import*as l from"../../ui/legacy/components/utils/utils.js";import*as d from"../../core/host/host.js";import*as c from"../../core/root/root.js";import*as h from"../../models/extensions/extensions.js";import*as m from"../mobile_throttling/mobile_throttling.js";import*as u from"../../models/text_utils/text_utils.js";import*as p from"../coverage/coverage.js";import*as g from"../../ui/legacy/components/data_grid/data_grid.js";import*as v from"../layer_viewer/layer_viewer.js";import*as T from"../../ui/legacy/theme_support/theme_support.js";import*as f from"./components/components.js";class w{x;y;width;height;color;outlineColor;constructor([e,t,i,n]){this.x=e,this.y=t,this.width=i,this.height=n,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}}let S;class b{static instance(e={forceNew:null}){const{forceNew:t}=e;return S&&!t||(S=new b),S}linkify(t,i){const n=document.createElement("span"),r=t,{x:a,y:s,width:o,height:l}=r;return n.textContent=`Location: [${a},${s}], Size: [${o}x${l}]`,n.addEventListener("mouseover",(()=>e.OverlayModel.OverlayModel.highlightRect(r))),n.addEventListener("mouseleave",(()=>e.OverlayModel.OverlayModel.clearHighlight())),n}}var y=Object.freeze({__proto__:null,CLSRect:w,Linkifier:b});const C=new CSSStyleSheet;C.replaceSync(".children,.content,.header{min-height:initial;line-height:initial}.children li::before{display:none}.content{margin-bottom:4px}.content .stack-preview-container{margin-left:8px}.content .node-list{margin-left:10px}.tree-outline li{white-space:normal}\n/*# sourceURL=invalidationsTree.css */\n");const k=new CSSStyleSheet;k.replaceSync(".image-preview-container{background:0 0;text-align:center;border-spacing:0}.image-preview-container img{margin:6px 0;max-width:100px;max-height:100px;background-image:var(--image-file-checker);user-select:text;vertical-align:top;-webkit-user-drag:auto}.image-container{padding:0}.image-container>div{min-height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer}.image-preview-container .row{line-height:1.2;vertical-align:baseline}.image-preview-container .title{padding-right:.5em;text-align:right;color:var(--color-text-secondary);white-space:nowrap}.image-preview-container .description{white-space:nowrap;text-align:left;color:var(--color-text-primary)}.image-preview-container .description-link{max-width:20em}.image-preview-container .source-link{white-space:normal;word-break:break-all;color:var(--color-link);cursor:pointer}\n/*# sourceURL=imagePreview.css */\n");const M=new CSSStyleSheet;M.replaceSync('.content{margin-left:5px}.history-dropdown-button{width:160px;height:26px;text-align:left;display:flex;border:1px solid transparent}.history-dropdown-button[disabled]{opacity:50%;border:1px solid transparent}.history-dropdown-button>.content{padding-right:5px;overflow:hidden;text-overflow:ellipsis;flex:1 1;min-width:35px}.history-dropdown-button:focus-visible::before{content:"";position:absolute;top:2px;left:0;right:0;bottom:2px;border-radius:2px;background:var(--divider-line)}@media (forced-colors:active){.history-dropdown-button[disabled]{opacity:100%}.history-dropdown-button[disabled] [is=ui-icon].icon-mask{background-color:GrayText}}\n/*# sourceURL=historyToolbarButton.css */\n');const P=new CSSStyleSheet;P.replaceSync('.timeline-toolbar-container{display:flex;flex:none}.timeline-toolbar-container>.toolbar{background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}.timeline-main-toolbar{flex:1 1 auto}.timeline-settings-pane{flex:none;background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}#timeline-overview-panel{flex:none;position:relative;border-bottom:1px solid var(--color-details-hairline)}#timeline-overview-grid{background-color:var(--color-background)}#timeline-overview-grid .timeline-grid-header{height:12px}#timeline-overview-grid .resources-dividers-label-bar{pointer-events:auto;height:12px}#timeline-overview-grid .resources-divider-label{top:1px}.timeline-details-split{flex:auto}.timeline.panel .status-pane-container{z-index:1000;display:flex;align-items:center;pointer-events:none}.timeline.panel .status-pane-container.tinted{background-color:var(--color-background-elevation-2);pointer-events:auto}#timeline-overview-panel .overview-strip{margin-top:2px;justify-content:center}#timeline-overview-panel .overview-strip .timeline-overview-strip-title{color:var(--color-text-secondary);font-size:10px;font-weight:700;z-index:100;background-color:var(--color-background-opacity-80);padding:0 4px;position:absolute;top:-2px;right:0}#timeline-overview-cpu-activity{flex-basis:20px}#timeline-overview-network{flex-basis:8px}#timeline-overview-framerate{flex-basis:16px;margin-top:0!important}#timeline-overview-filmstrip{flex-basis:30px}#timeline-overview-memory{flex-basis:20px}#timeline-overview-cpu-activity::before,#timeline-overview-framerate::before,#timeline-overview-network::before{content:"";position:absolute;left:0;right:0;bottom:0;border-bottom:1px solid var(--divider-line);z-index:-200}.overview-strip .background{z-index:-10}#timeline-overview-responsiveness{flex-basis:5px;margin-top:0!important}#timeline-overview-input{flex-basis:6px}#timeline-overview-pane{flex:auto;position:relative;overflow:hidden}#timeline-overview-container{display:flex;flex-direction:column;flex:none;position:relative;overflow:hidden}#timeline-overview-container canvas{width:100%;height:100%}.popover ul{margin:0;padding:0;list-style-type:none}.memory-graph-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--color-text-secondary);white-space:nowrap;padding:0 4px;background-color:var(--color-background-opacity-80)}#memory-graphs-canvas-container{overflow:hidden;flex:auto;position:relative}#memory-counters-graph{flex:auto}#memory-graphs-canvas-container .memory-counter-marker{position:absolute;border-radius:3px;width:5px;height:5px;margin-left:-3px;margin-top:-2px}#memory-graphs-container .timeline-memory-header{flex:0 0 26px;background-color:var(--color-background-elevation-1);border-bottom:1px solid var(--color-details-hairline);justify-content:space-between}#memory-graphs-container .timeline-memory-header::after{content:"";background-image:var(--image-file-toolbarResizerVertical);background-repeat:no-repeat;background-position:right center,center;flex:20px 0 0;margin:0 4px}.timeline-memory-toolbar{flex-shrink:1}.memory-counter-value{margin:8px}#counter-values-bar{flex:0 0 20px;border-top:solid 1px var(--color-details-hairline);width:100%;overflow:hidden;line-height:18px}#timeline-overview-coverage{flex-basis:20px}.timeline-overview-coverage-label{position:absolute;right:0;bottom:0;font-size:9px;color:var(--color-text-secondary);white-space:nowrap;padding:0 4px;background-color:var(--color-background-opacity-80)}.timeline-details{vertical-align:top}.timeline-details-view{color:var(--color-text-secondary);overflow:hidden}.timeline-details-view-body{flex:auto;overflow:auto;position:relative;background-color:var(--color-background-elevation-1);user-select:text}.timeline-details-view-block{flex:none;display:flex;background-color:var(--color-background);flex-direction:column;padding-bottom:5px;border-bottom:var(--legacy-divider-border)}.timeline-details-view-row{padding-left:10px;line-height:20px}.timeline-details-view-block .timeline-details-stack-values{flex-direction:column!important}.timeline-details-chip-title{font-size:13px;padding:8px;display:flex;align-items:center}.timeline-details-view-row-title:not(:empty){color:var(--color-text-secondary);overflow:hidden;padding-right:10px;display:inline-block}.timeline-details-warning{--override-details-warning-background-color:rgb(250 209 209 / 48%);background-color:var(--override-details-warning-background-color)}.-theme-with-dark-background .timeline-details-warning,:host-context(.-theme-with-dark-background) .timeline-details-warning{--override-details-warning-background-color:rgb(87 10 10 / 48%)}.timeline-details-warning .timeline-details-view-row-title{color:var(--color-red)}.timeline-details-view-row-value{display:inline-block;user-select:text;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}.timeline-details-warning .timeline-details-view-row-value{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.timeline-details-view-row-value .stack-preview-container{line-height:11px}.timeline-details-view-pie-chart-wrapper{margin:4px 0}.timeline-details-view-pie-chart{margin-top:5px}.timeline-details-view-row-stack-trace{padding:4px 0;line-height:inherit}.timeline-flamechart{overflow:hidden}.timeline-flamechart-resizer{flex:8px 0 0;background-color:var(--color-background-elevation-1);border:1px var(--color-details-hairline);border-style:solid none;display:flex;flex-direction:row;align-items:flex-end;justify-content:center}.timeline-network-resizer-disabled>.timeline-flamechart-resizer{display:none}.timeline-flamechart-resizer::after{content:"...";font-size:14px;margin-bottom:-1px}.timeline-layers-view-properties table{width:100%;border-collapse:collapse}.timeline-layers-view-properties td{border:1px solid var(--color-details-hairline);line-height:22px}.timeline-filmstrip-preview>img{margin-top:5px;max-width:500px;max-height:300px;cursor:pointer;border:1px solid var(--color-details-hairline)}.timeline-tree-view{display:flex;overflow:hidden}.timeline-tree-view .toolbar{background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border)}.timeline-tree-view .data-grid{border:none;flex:auto}.timeline-tree-view .data-grid .data-container{overflow-y:scroll;top:21px}.timeline-tree-view .data-grid.data-grid-fits-viewport .corner{display:table-cell}.timeline-tree-view .data-grid table.data{background:var(--color-background)}.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:var(--color-background-hover-overlay)}.timeline-tree-view .data-grid td.numeric-column{text-align:right;position:relative}.timeline-tree-view .data-grid div.background-percent-bar{float:right}.timeline-tree-view .data-grid span.percent-column{color:var(--color-text-secondary);width:45px;display:inline-block}.timeline-tree-view .data-grid tr.selected span{color:inherit}.timeline-tree-view .data-grid .name-container{display:flex;align-items:center;padding-left:2px}.timeline-tree-view .data-grid .name-container .activity-icon{width:12px;height:12px;border:1px solid var(--divider-line);margin:3px 0}.timeline-tree-view .data-grid .name-container .activity-icon-container{margin-right:3px;display:flex;flex-wrap:wrap;align-items:center;justify-content:center;width:18px;height:18px;overflow:hidden}.timeline-tree-view .data-grid .name-container .activity-warning::after{content:"[deopt]";margin:0 4px;line-height:12px;font-size:10px;color:var(--color-text-disabled)}.timeline-tree-view .data-grid tr.selected .name-container .activity-warning::after{color:var(--color-text-secondary-selected)}.timeline-tree-view .data-grid .name-container .activity-link{flex:auto;text-align:right;overflow:hidden;text-overflow:ellipsis;margin-left:5px}.timeline-tree-view .data-grid .background-bar-container{position:absolute;left:3px;right:0}.timeline-tree-view .data-grid .background-bar{--override-background-bar-background-color:hsl(43deg 84% 64% / 20%);--override-background-bar-border-color:hsl(43deg 84% 64%);float:right;height:18px;background-color:var(--override-background-bar-background-color);border-bottom:1px solid var(--override-background-bar-border-color)}.timeline-tree-view .data-grid .selected .background-bar{background-color:var(--color-background-opacity-50);border-bottom:1px solid var(--color-background-opacity-80)}.-theme-with-dark-background .timeline-tree-view .data-grid .background-bar,:host-context(.-theme-with-dark-background) .timeline-tree-view .data-grid .background-bar{--override-background-bar-background-color:rgb(169 126 15 / 20%);--override-background-bar-border-color:rgb(169 126 15)}.timeline-tree-view .timeline-details-view-body .full-widget-dimmed-banner{background-color:inherit}.timeline-details .filter-input-field{width:120px}.timeline-tree-view .data-grid .header-container{height:21px}.timeline-stack-view-header{height:27px;background-color:var(--color-background-elevation-1);padding:6px 10px;color:var(--color-text-secondary);white-space:nowrap;border-bottom:var(--legacy-divider-border)}.timeline-landing-page{position:absolute;background-color:var(--color-background);justify-content:center;align-items:center;overflow:auto;font-size:13px;color:var(--color-text-secondary)}@media (forced-colors:active){.timeline-tree-view .data-grid .name-container .activity-icon{forced-color-adjust:none}.timeline-tree-view .data-grid tr.selected .name-container .activity-link .devtools-link,.timeline-tree-view .data-grid tr.selected div.background-percent-bar span,.timeline-tree-view .data-grid tr.selected span.percent-column{color:HighlightText}.timeline-tree-view .data-grid .background-bar,.timeline-tree-view .data-grid tr:hover td:not(.bottom-filler-td){background-color:transparent}.timeline-tree-view .data-grid tr.selected .background-bar{background-color:transparent;border-bottom-color:HighlightText}}.timeline-additional-metrics{display:flex;flex:0 0 27px;background-color:var(--color-background-elevation-1);border-top:var(--legacy-divider-border);overflow:hidden;z-index:100}.timeline-details-view-row-stack-trace div{white-space:nowrap;text-overflow:ellipsis;line-height:12px}.timeline-details-view-body>div{overflow-y:hidden;overflow-x:auto}.timeline-landing-page>div{max-width:450px;margin:10px}.timeline-details-chip-title>div{width:12px;height:12px;border:1px solid var(--color-details-hairline);display:inline-block;margin-right:4px;content:" "}.timeline-paint-profiler-log-split>div:last-child{background-color:var(--color-background-elevation-1);z-index:0}.timeline-layers-view-properties>div:last-child,.timeline-layers-view>div:last-child{background-color:var(--color-background-elevation-1)}.timeline.panel .status-pane-container>div{pointer-events:auto}.timeline-landing-page>div>p{flex:none;white-space:pre-line}.timeline-tree-view .data-grid .name-container div{flex:none}.status-pane-container>.small-dialog{width:100%;height:100%}\n/*# sourceURL=timelinePanel.css */\n');const x=new CSSStyleSheet;x.replaceSync(".timeline-status-dialog{display:flex;flex-direction:column;padding:16px 16px 12px;align-self:center;background-color:var(--color-background);box-shadow:var(--drop-shadow)}.status-dialog-line{margin:2px;height:14px;display:flex;align-items:baseline}.status-dialog-line .label{display:inline-block;width:80px;text-align:right;color:var(--color-text-primary);margin-right:10px}.timeline-status-dialog .progress .indicator-container{display:inline-block;width:200px;height:8px;background-color:var(--color-background-elevation-2)}.timeline-status-dialog .progress .indicator{background-color:var(--color-primary-variant);height:100%;width:0;margin:0}.timeline-status-dialog .stop-button{margin-top:8px;height:100%;align-self:flex-end}.timeline-status-dialog .stop-button button{min-width:80px}.timeline-status-dialog.small-dialog{width:inherit;justify-content:center}.small-dialog>.stop-button{align-self:center;margin-top:20px;height:initial}@media (forced-colors:active){.timeline-status-dialog{border:1px solid canvastext}.timeline-status-dialog .progress .indicator-container{border:1px solid ButtonText;background-color:ButtonFace}.timeline-status-dialog .progress .indicator{forced-color-adjust:none;background-color:ButtonText}}\n/*# sourceURL=timelineStatusDialog.css */\n");const R={malformedTimelineDataUnknownJson:"Malformed timeline data: Unknown JSON format",malformedTimelineInputWrongJson:"Malformed timeline input, wrong JSON brackets balance",malformedTimelineDataS:"Malformed timeline data: {PH1}",legacyTimelineFormatIsNot:"Legacy Timeline format is not supported.",malformedCpuProfileFormat:"Malformed CPU profile format"},I=i.i18n.registerUIStrings("panels/timeline/TimelineLoader.ts",R),E=i.i18n.getLocalizedString.bind(void 0,I);class L{client;backingStorage;tracingModel;canceledCallback;state;buffer;firstRawChunk;firstChunk;loadedBytes;totalSize;jsonTokenizer;constructor(t){this.client=t,this.backingStorage=new o.TempFile.TempFileBackingStorage,this.tracingModel=new e.TracingModel.TracingModel(this.backingStorage),this.canceledCallback=null,this.state=D.Initial,this.buffer="",this.firstRawChunk=!0,this.firstChunk=!0,this.loadedBytes=0,this.jsonTokenizer=new u.TextUtils.BalancedJSONTokenizer(this.writeBalancedJSON.bind(this),!0)}static loadFromFile(e,t){const i=new L(t),n=new o.FileUtils.ChunkedFileReader(e,F);return i.canceledCallback=n.cancel.bind(n),i.totalSize=e.size,n.read(i).then((e=>{!e&&n.error()&&i.reportErrorAndCancelLoading(n.error().message)})),i}static loadFromEvents(e,t){const i=new L(t);return setTimeout((async()=>{t.loadingStarted();for(let n=0;n<e.length;n+=5e3){const r=e.slice(n,n+5e3);i.tracingModel.addEvents(r),t.loadingProgress((n+r.length)/e.length),await new Promise((e=>setTimeout(e)))}i.close()})),i}static loadFromURL(e,t){const i=new L(t);return d.ResourceLoader.loadAsStream(e,null,i),i}cancel(){this.tracingModel=null,this.backingStorage.reset(),this.client&&(this.client.loadingComplete(null),this.client=null),this.canceledCallback&&this.canceledCallback()}async write(e){if(!this.client)return Promise.resolve();if(this.loadedBytes+=e.length,this.firstRawChunk)await this.client.loadingStarted(),await new Promise((e=>requestAnimationFrame((()=>requestAnimationFrame(e)))));else{let e;this.totalSize&&(e=this.loadedBytes/this.totalSize,e=e>1?e-Math.floor(e):e),await this.client.loadingProgress(e)}if(this.firstRawChunk=!1,this.state===D.Initial)if(e.startsWith('{"nodes":['))this.state=D.LoadingCPUProfileFormat;else if("{"===e[0])this.state=D.LookingForEvents;else{if("["!==e[0])return this.reportErrorAndCancelLoading(E(R.malformedTimelineDataUnknownJson)),Promise.resolve();this.state=D.ReadingEvents}if(this.state===D.LoadingCPUProfileFormat)return this.buffer+=e,Promise.resolve();if(this.state===D.LookingForEvents){const t='"traceEvents":',i=this.buffer.length-t.length;this.buffer+=e;const n=this.buffer.indexOf(t,i);if(-1===n)return Promise.resolve();e=this.buffer.slice(n+t.length),this.state=D.ReadingEvents}return this.state!==D.ReadingEvents||this.jsonTokenizer.write(e)||(this.state=D.SkippingTail,this.firstChunk&&this.reportErrorAndCancelLoading(E(R.malformedTimelineInputWrongJson))),Promise.resolve()}writeBalancedJSON(e){let t,i=e+"]";if(!this.firstChunk){const e=i.indexOf(",");-1!==e&&(i=i.slice(e+1)),i="["+i}try{t=JSON.parse(i)}catch(e){return void this.reportErrorAndCancelLoading(E(R.malformedTimelineDataS,{PH1:e.toString()}))}if(this.firstChunk&&(this.firstChunk=!1,this.looksLikeAppVersion(t[0])))this.reportErrorAndCancelLoading(E(R.legacyTimelineFormatIsNot));else try{this.tracingModel.addEvents(t)}catch(e){this.reportErrorAndCancelLoading(E(R.malformedTimelineDataS,{PH1:e.toString()}))}}reportErrorAndCancelLoading(e){e&&t.Console.Console.instance().error(e),this.cancel()}looksLikeAppVersion(e){return"string"==typeof e&&-1!==e.indexOf("Chrome")}async close(){this.client&&(this.client.processingStarted(),setTimeout((()=>this.finalizeTrace()),0))}finalizeTrace(){this.state===D.LoadingCPUProfileFormat&&(this.parseCPUProfileFormat(this.buffer),this.buffer=""),this.tracingModel.tracingComplete(),this.client.loadingComplete(this.tracingModel)}parseCPUProfileFormat(e){let t;try{const i=JSON.parse(e);t=r.TimelineJSProfile.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i,1,!0)}catch(e){return void this.reportErrorAndCancelLoading(E(R.malformedCpuProfileFormat))}this.tracingModel.addEvents(t)}}const F=5e6;var D;!function(e){e.Initial="Initial",e.LookingForEvents="LookingForEvents",e.ReadingEvents="ReadingEvents",e.SkippingTail="SkippingTail",e.LoadingCPUProfileFormat="LoadingCPUProfileFormat"}(D||(D={}));var U=Object.freeze({__proto__:null,TimelineLoader:L,TransferChunkLengthBytes:F,get State(){return D}});class H{provider;performanceModel;completionCallback;completionPromise;timeOffset;constructor(e,t){this.provider=e,this.performanceModel=t,this.completionPromise=new Promise((e=>{this.completionCallback=e})),this.timeOffset=0}loadingStarted(){}processingStarted(){}loadingProgress(e){}loadingComplete(e){e&&(this.performanceModel.addExtensionEvents(this.provider.longDisplayName(),e,this.timeOffset),this.completionCallback())}complete(e,t){e?(this.timeOffset=t,L.loadFromURL(e,this)):this.completionCallback()}start(){this.provider.start(this)}stop(){return this.provider.stop(),this.completionPromise}}var W=Object.freeze({__proto__:null,ExtensionTracingSession:H});const N={cpuProfileForATargetIsNot:"CPU profile for a target is not available.",tracingNotSupported:"Performance trace recording not supported for this type of target"},V=i.i18n.registerUIStrings("panels/timeline/TimelineController.ts",N),B=i.i18n.getLocalizedString.bind(void 0,V);class A{target;tracingManager;performanceModel;client;tracingModel;extensionSessions;extensionTraceProviders;tracingCompleteCallback;profiling;cpuProfiles;constructor(t,i){this.target=t,this.tracingManager=t.model(e.TracingManager.TracingManager),this.performanceModel=new vi,this.performanceModel.setMainTarget(t),this.client=i;const n=new o.TempFile.TempFileBackingStorage;this.tracingModel=new e.TracingModel.TracingModel(n),this.extensionSessions=[],e.TargetManager.TargetManager.instance().observeModels(e.CPUProfilerModel.CPUProfilerModel,this)}dispose(){e.TargetManager.TargetManager.instance().unobserveModels(e.CPUProfilerModel.CPUProfilerModel,this)}mainTarget(){return this.target}async startRecording(t,i){function n(e){return"disabled-by-default-"+e}this.extensionTraceProviders=h.ExtensionServer.ExtensionServer.instance().traceProviders().slice();const a=["-*","devtools.timeline",n("devtools.timeline"),n("devtools.timeline.frame"),"v8.execute",n("v8.compile"),r.TimelineModel.TimelineModelImpl.Category.Console,r.TimelineModel.TimelineModelImpl.Category.UserTiming,r.TimelineModel.TimelineModelImpl.Category.Loading];a.push(r.TimelineModel.TimelineModelImpl.Category.LatencyInfo),c.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&t.enableJSSampling&&a.push(n("v8.runtime_stats_sampling")),!c.Runtime.Runtime.queryParam("timelineTracingJSProfileDisabled")&&t.enableJSSampling&&a.push(n("v8.cpu_profiler")),a.push(n("devtools.timeline.stack")),c.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&a.push(n("devtools.timeline.invalidationTracking")),t.capturePictures&&a.push(n("devtools.timeline.layers"),n("devtools.timeline.picture"),n("blink.graphics_context_annotations")),t.captureFilmStrip&&a.push(n("devtools.screenshot")),this.extensionSessions=i.map((e=>new H(e,this.performanceModel))),this.extensionSessions.forEach((e=>e.start())),this.performanceModel.setRecordStartTime(Date.now());const s=await this.startRecordingWithCategories(a.join(","),t.enableJSSampling);return s.getError()&&(await this.waitForTracingToStop(!1),await e.TargetManager.TargetManager.instance().resumeAllTargets()),s}async stopRecording(){return this.tracingManager&&this.tracingManager.stop(),this.client.loadingStarted(),await this.waitForTracingToStop(!0),this.allSourcesFinished(),this.performanceModel}async waitForTracingToStop(e){const t=[];this.tracingManager&&e&&t.push(new Promise((e=>{this.tracingCompleteCallback=e}))),t.push(this.stopProfilingOnAllModels());const i=this.extensionSessions.map((e=>e.stop()));i.length&&t.push(Promise.race([Promise.all(i),new Promise((e=>setTimeout(e,5e3)))])),await Promise.all(t)}modelAdded(e){this.profiling&&e.startRecording()}modelRemoved(e){}async startProfilingOnAllModels(){this.profiling=!0;const t=e.TargetManager.TargetManager.instance().models(e.CPUProfilerModel.CPUProfilerModel);await Promise.all(t.map((e=>e.startRecording())))}addCpuProfile(e,i){i?(this.cpuProfiles||(this.cpuProfiles=new Map),this.cpuProfiles.set(e,i)):t.Console.Console.instance().warn(B(N.cpuProfileForATargetIsNot))}async stopProfilingOnAllModels(){const t=this.profiling?e.TargetManager.TargetManager.instance().models(e.CPUProfilerModel.CPUProfilerModel):[];this.profiling=!1;const i=[];for(const e of t){const t=e.target().id(),n=e.stopRecording().then(this.addCpuProfile.bind(this,t));i.push(n)}await Promise.all(i)}async startRecordingWithCategories(t,i){if(!this.tracingManager)throw new Error(N.tracingNotSupported);return await e.TargetManager.TargetManager.instance().suspendAllTargets("performance-timeline"),i&&c.Runtime.Runtime.queryParam("timelineTracingJSProfileDisabled")&&await this.startProfilingOnAllModels(),this.tracingManager.start(this,t,"")}traceEventsCollected(e){this.tracingModel.addEvents(e)}tracingComplete(){this.tracingCompleteCallback&&(this.tracingCompleteCallback(void 0),this.tracingCompleteCallback=null)}allSourcesFinished(){this.client.processingStarted(),setTimeout((()=>this.finalizeTrace()),0)}async finalizeTrace(){this.injectCpuProfileEvents(),await e.TargetManager.TargetManager.instance().resumeAllTargets(),this.tracingModel.tracingComplete(),this.client.loadingComplete(this.tracingModel)}injectCpuProfileEvent(t,i,n){if(!n)return;const a={cat:e.TracingModel.DevToolsMetadataEventCategory,ph:e.TracingModel.Phase.Instant,ts:1e3*this.tracingModel.maximumRecordTime(),pid:t,tid:i,name:r.TimelineModel.RecordType.CpuProfile,args:{data:{cpuProfile:n}}};this.tracingModel.addEvents([a])}buildTargetToProcessIdMap(){const t=r.TimelineModel.TimelineModelImpl.DevToolsMetadataEvent,i=this.tracingModel.devToolsMetadataEvents(),a=i.find((e=>e.name===t.TracingStartedInBrowser));if(!a)return null;const s=new n.MapUtilities.Multimap,o=new Map,l=a.args.data.frames;for(const e of l)o.set(e.frame,e.processId);for(const e of i){const i=e.args.data;switch(e.name){case t.FrameCommittedInBrowser:i.processId?o.set(i.frame,i.processId):s.set(i.processPseudoId,i.frame);break;case t.ProcessReadyInBrowser:for(const e of s.get(i.processPseudoId)||[])o.set(e,i.processId)}}const d=l.find((e=>!e.parent)).processId,c=this.tracingModel.getProcessById(d);if(c){const t=e.TargetManager.TargetManager.instance().mainTarget();t&&o.set(t.id(),c.id())}return o}injectCpuProfileEvents(){if(!this.cpuProfiles)return;const t=r.TimelineModel.TimelineModelImpl.DevToolsMetadataEvent,i=this.tracingModel.devToolsMetadataEvents(),n=this.buildTargetToProcessIdMap();if(n)for(const[e,t]of this.cpuProfiles){const i=n.get(e);if(!i)continue;const a=this.tracingModel.getProcessById(i),s=a&&a.threadByName(r.TimelineModel.TimelineModelImpl.RendererMainThreadName);s&&this.injectCpuProfileEvent(i,s.id(),t)}else{const n=i.filter((e=>e.name===t.TracingStartedInPage)),a=n[n.length-1];if(a){const e=a.thread.process().id();if(this.tracingManager){const t=this.cpuProfiles.get(this.tracingManager.target().id());this.injectCpuProfileEvent(e,a.thread.id(),t)}}else{let t=0;for(const i of this.cpuProfiles){const n=e.TargetManager.TargetManager.instance().targetById(i[0]),a=n&&n.name();this.tracingModel.addEvents(r.TimelineJSProfile.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i[1],++t,1===t,a))}}}const a=i.filter((e=>e.name===t.TracingSessionIdForWorker));for(const e of a){const t=e.args.data.workerId,i=this.cpuProfiles.get(t);this.injectCpuProfileEvent(e.thread.process().id(),e.args.data.workerThreadId,i)}this.cpuProfiles=null}tracingBufferUsage(e){this.client.recordingProgress(e)}eventsRetrievalProgress(e){this.client.loadingProgress(e)}}var z=Object.freeze({__proto__:null,TimelineController:A});const O={net:"NET",cpu:"CPU",fps:"FPS",heap:"HEAP",sSDash:"{PH1} – {PH2}",coverage:"COVERAGE"},G=i.i18n.registerUIStrings("panels/timeline/TimelineEventOverview.ts",O),_=i.i18n.getLocalizedString.bind(void 0,G);class j extends a.TimelineOverviewPane.TimelineOverviewBase{model;constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),this.model=null,t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}setModel(e){this.model=e}renderBar(e,t,i,n,r){const a=e,s=t-e,o=this.context();o.fillStyle=r,o.fillRect(a,i,s,n)}}class q extends j{constructor(){super("input",null)}update(){if(super.update(),!this.model)return;const e=this.height(),t=ni.eventDispatchDesciptors(),i=new Map;let a=-1;for(const e of t){for(const t of e.eventTypes)i.set(t,e);a=Math.max(a,e.priority)}const s=2*window.devicePixelRatio,o=this.model.timelineModel().minimumRecordTime(),l=this.model.timelineModel().maximumRecordTime()-o,d=this.width(),c=d/l;for(let t=0;t<=a;++t)for(const a of this.model.timelineModel().tracks())for(let l=0;l<a.events.length;++l){const h=a.events[l];if(h.name!==r.TimelineModel.RecordType.EventDispatch)continue;const m=i.get(h.args.data.type);if(!m||m.priority!==t)continue;if(void 0===h.endTime)continue;const u=n.NumberUtilities.clamp(Math.floor((h.startTime-o)*c),0,d),p=n.NumberUtilities.clamp(Math.ceil((h.endTime-o)*c),0,d),g=Math.max(p-u,s);this.renderBar(u,u+g,0,e,m.color)}}}class J extends j{constructor(){super("network",_(O.net))}update(){if(super.update(),!this.model)return;const e=this.model.timelineModel(),t=this.height()/2,i=e.minimumRecordTime(),n=e.maximumRecordTime()-i,r=this.width(),a=r/n,s=new Path2D,o=new Path2D,l=new Set(["VeryHigh","High","Medium"]);for(const n of e.networkRequests()){const e=l.has(n.priority)?s:o,d=Math.max(Math.floor((n.startTime-i)*a),0),c=Math.min(Math.ceil((n.endTime-i)*a+1),r);e.rect(d,0,c-d,t-1)}const d=this.context();d.save(),d.fillStyle="hsl(214, 60%, 60%)",d.fill(s),d.translate(0,t),d.fillStyle="hsl(214, 80%, 80%)",d.fill(o),d.restore()}}const X=new WeakMap;class $ extends j{backgroundCanvas;constructor(){super("cpu-activity",_(O.cpu)),this.backgroundCanvas=this.element.createChild("canvas","fill background")}resetCanvas(){super.resetCanvas(),this.backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this.backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}update(){if(super.update(),!this.model)return;const e=this.model.timelineModel(),t=4*window.devicePixelRatio,i=this.width(),n=this.height(),a=n,s=e.minimumRecordTime(),o=e.maximumRecordTime()-s,l=t/(i/o),d=ni.categories(),c=ni.getTimelineMainEventCategories(),h=c.indexOf("other");console.assert(0===c.indexOf("idle"));for(let e=1;e<c.length;++e)X.set(d[c[e]],e);const m=this.backgroundCanvas.getContext("2d");if(!m)throw new Error("Could not find 2d canvas");for(const t of e.tracks())t.type===r.TimelineModel.TrackType.MainThread&&t.forMainFrame?u(this.context(),t.events):u(m,t.events);function u(e,m){const u=new ee(s,l,(function(e){let i=a;for(let r=1;r<c.length;++r){const a=(e[r]||0)/l*n;i-=a,v[r].bezierCurveTo(p,T[r],p,i,p+t/2,i),T[r]=i}p+=t}));let p=0;const g=[],v=[],T=[];for(let e=0;e<c.length;++e)v[e]=new Path2D,v[e].moveTo(0,n),T[e]=n;r.TimelineModel.TimelineModelImpl.forEachEvent(m,(function(e){const t=g.length?g[g.length-1]:0;u.appendInterval(e.startTime,t),g.push(X.get(ni.eventStyle(e).category)||h)}),(function(e){const t=g.pop();void 0!==e.endTime&&t&&u.appendInterval(e.endTime,t)})),u.appendInterval(s+o+l,0);for(let t=c.length-1;t>0;--t)v[t].lineTo(i,n),e.fillStyle=d[c[t]].color,e.fill(v[t])}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let r=.5;r<i+n;r+=t)e.moveTo(r,0),e.lineTo(r-n,n);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(m)}}class K extends j{constructor(){super("responsiveness",null)}update(){if(super.update(),!this.model)return;const e=this.height(),t=this.model.timelineModel().minimumRecordTime(),i=this.model.timelineModel().maximumRecordTime()-t,n=this.width()/i,a=this.model.frames(),s=this.context(),o=new Path2D,l=new Path2D;for(let e=0;e<a.length;++e){const t=a[e];t.hasWarnings()&&d(t.startTime,t.duration)}for(const e of this.model.timelineModel().tracks()){const t=e.events;for(let e=0;e<t.length;++e){if(!r.TimelineModel.TimelineData.forEvent(t[e]).warning)continue;const i=t[e].duration;void 0!==i&&d(t[e].startTime,i)}}function d(i,r){const a=Math.round(n*(i-t)),s=Math.round(n*r);o.rect(a,0,s,e),l.moveTo(a+s,0),l.lineTo(a+s,e)}s.fillStyle="hsl(0, 80%, 90%)",s.strokeStyle="red",s.lineWidth=2*window.devicePixelRatio,s.fill(o),s.stroke(l)}}class Y extends j{frameToImagePromise;lastFrame;lastElement;drawGeneration;emptyImage;imageWidth;constructor(){super("filmstrip",null),this.frameToImagePromise=new Map,this.lastFrame=null,this.lastElement=null,this.reset()}update(){super.update();const e=this.model?this.model.filmStripModel().frames():[];if(!e.length)return;const t=Symbol("drawGeneration");this.drawGeneration=t,this.imageByFrame(e[0]).then((e=>{if(this.drawGeneration!==t)return;if(!e||!e.naturalWidth||!e.naturalHeight)return;const i=this.height()-2*Y.Padding,n=Math.ceil(i*e.naturalWidth/e.naturalHeight),r=Math.min(200/e.naturalWidth,1);this.emptyImage=new Image(e.naturalWidth*r,e.naturalHeight*r),this.drawFrames(n,i)}))}async imageByFrame(e){let t=this.frameToImagePromise.get(e);if(!t){const i=await e.imageDataPromise();t=s.UIUtils.loadImageFromData(i),this.frameToImagePromise.set(e,t)}return t}drawFrames(e,t){if(!e||!this.model)return;const i=this.model.filmStripModel();if(!i.frames().length)return;const n=Y.Padding,r=this.width(),a=i.zeroTime(),s=i.spanTime()/r,o=this.context(),l=this.drawGeneration;o.beginPath();for(let l=n;l<r;l+=e+2*n){const n=a+(l+e/2)*s,r=i.frameByTimestamp(n);r&&(o.rect(l-.5,.5,e+1,t+1),this.imageByFrame(r).then(d.bind(this,l)))}function d(i,n){this.drawGeneration===l&&n&&o.drawImage(n,i,1,e,t)}o.strokeStyle="#ddd",o.stroke()}async overviewInfoPromise(e){if(!this.model||!this.model.filmStripModel().frames().length)return null;const t=this.calculator();if(!t)return null;const i=t.positionToTime(e),n=this.model.filmStripModel().frameByTimestamp(i);if(n===this.lastFrame)return this.lastElement;const r=n?this.imageByFrame(n):Promise.resolve(this.emptyImage),a=await r,s=document.createElement("div");return s.classList.add("frame"),a&&s.createChild("div","thumbnail").appendChild(a),this.lastFrame=n,this.lastElement=s,s}reset(){this.lastFrame=null,this.lastElement=null,this.frameToImagePromise=new Map,this.imageWidth=0}static Padding=2}class Q extends j{constructor(){super("framerate",_(O.fps))}update(){if(super.update(),!this.model)return;const e=this.model.frames();if(!e.length)return;const t=this.height(),i=Number(window.devicePixelRatio),n=t-2*i,r=this.model.timelineModel().minimumRecordTime(),a=this.model.timelineModel().maximumRecordTime()-r,s=this.width()/a,o=t-i,l=this.context(),d=o+10*window.devicePixelRatio;let c=0,h=d;const m=window.devicePixelRatio,u=1&m?.5:0,p=1.5*window.devicePixelRatio;l.beginPath(),l.moveTo(0,h);for(let t=0;t<e.length;++t){const i=e[t];c=Math.round((i.startTime-r)*s)+u,l.lineTo(c,h),l.lineTo(c,h+p),h=i.idle?d:Math.round(o-n*Math.min(16.666666666666668/i.duration,1))-u,l.lineTo(c,h+p),l.lineTo(c,h)}const g=e[e.length-1];g&&(c=Math.round((g.startTime+g.duration-r)*s)+u),l.lineTo(c,h),l.lineTo(c,d),l.fillStyle="hsl(110, 50%, 88%)",l.strokeStyle="hsl(110, 50%, 60%)",l.lineWidth=m,l.fill(),l.stroke()}}class Z extends j{heapSizeLabel;constructor(){super("memory",_(O.heap)),this.heapSizeLabel=this.element.createChild("div","memory-graph-label")}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}update(){super.update();const e=window.devicePixelRatio;if(!this.model)return void this.resetHeapSizeLabels();const t=this.model.timelineModel().tracks().filter((e=>e.type===r.TimelineModel.TrackType.MainThread&&e.forMainFrame)).map((e=>e.events)),i=3*e;let a=0,s=1e11;const o=this.model.timelineModel().minimumRecordTime(),l=this.model.timelineModel().maximumRecordTime();function d(e){return e.name===r.TimelineModel.RecordType.UpdateCounters}for(let e=0;e<t.length;e++)t[e]=t[e].filter(d);function c(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(a=Math.max(a,t.jsHeapSizeUsed),s=Math.min(s,t.jsHeapSizeUsed))}for(let e=0;e<t.length;e++)t[e].forEach(c);s=Math.min(s,a);const h=this.width(),m=this.height()-i,u=h/(l-o),p=(m-1)/Math.max(a-s,1),g=new Array(h);function v(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const i=Math.round((e.startTime-o)*u),n=Math.round((t.jsHeapSizeUsed-s)*p);g[i]=Math.max(g[i]||0,n)}for(let e=0;e<t.length;e++)t[e].forEach(v);const T=this.context(),f=m+i+1;T.translate(.5,.5),T.beginPath(),T.moveTo(-1,f);let w=0,S=!0,b=0;for(let e=0;e<g.length;e++){if(void 0===g[e])continue;S&&(S=!1,w=g[e],T.lineTo(-1,m-w));const t=g[e];Math.abs(t-w)>2&&Math.abs(e-b)>1&&T.lineTo(e,m-w),w=t,T.lineTo(e,m-w),b=e}T.lineTo(h+1,m-w),T.lineTo(h+1,f),T.closePath(),T.fillStyle="hsla(220, 90%, 70%, 0.2)",T.fill(),T.lineWidth=1,T.strokeStyle="hsl(220, 90%, 70%)",T.stroke(),this.heapSizeLabel.textContent=_(O.sSDash,{PH1:n.NumberUtilities.bytesToString(s),PH2:n.NumberUtilities.bytesToString(a)})}}class ee{lastTime;quantDuration;callback;counters;remainder;constructor(e,t,i){this.lastTime=e,this.quantDuration=t,this.callback=i,this.counters=[],this.remainder=t}appendInterval(e,t){let i=e-this.lastTime;if(i<=this.remainder)return this.counters[t]=(this.counters[t]||0)+i,this.remainder-=i,void(this.lastTime=e);for(this.counters[t]=(this.counters[t]||0)+this.remainder,this.callback(this.counters),i-=this.remainder;i>=this.quantDuration;){const e=[];e[t]=this.quantDuration,this.callback(e),i-=this.quantDuration}this.counters=[],this.counters[t]=i,this.lastTime=e,this.remainder=this.quantDuration-i}}class te extends j{heapSizeLabel;coverageModel;constructor(){super("coverage",_(O.coverage)),this.heapSizeLabel=this.element.createChild("div","timeline-overview-coverage-label")}resetHeapSizeLabels(){this.heapSizeLabel.textContent=""}setModel(e){if(super.setModel(e),e){const t=e.mainTarget();t&&(this.coverageModel=t.model(p.CoverageModel.CoverageModel))}}update(){super.update();const e=window.devicePixelRatio;if(!this.coverageModel)return;let t=0,i=0;const n=new Map,r=new Map;for(const e of this.coverageModel.entries())for(const a of e.entries()){t+=a.getSize();for(const[e,t]of a.usedByTimestamp()){i+=t;let s=r.get(e);void 0===s&&(s=new Set,r.set(e,s)),s.add(a);const o=n.get(e);void 0===o?n.set(e,t):n.set(e,o+t)}}const a=new Set,s=new Map;let o=0,l=0;const d=Array.from(r.entries()).sort(((e,t)=>e[0]-t[0]));for(const[e,t]of d){for(const e of t.values())a.has(e)||(a.add(e),o+=e.getSize());l+=n.get(e)||0,s.set(e,l/o)}const c=t?Math.round(100*i/t):0,h=3*e;if(!this.model)return;const m=this.model.timelineModel().minimumRecordTime()/1e3,u=this.model.timelineModel().maximumRecordTime()/1e3,p=this.width(),g=this.height()-h,v=p/(u-m),T=g-1;let f=0;const w=this.context(),S=g+h+1;w.translate(.5,.5),w.beginPath(),w.moveTo(-1,S),w.lineTo(-1,g-f);let b=null;for(const e of this.coverageModel.getCoverageUpdateTimes()){const t=s.get(e)||b;if(b=t,!t)continue;if(e>u)break;const i=(e-m)*v;f=t*T,w.lineTo(i,g-f)}const y="hsl(220, 90%, 70%)";w.lineTo(p+1,g-f),w.lineTo(p+1,S),w.closePath(),w.fillStyle="hsla(220, 90%, 70%, 0.2)",w.fill(),w.lineWidth=1,w.strokeStyle=y,w.stroke(),b=null;for(const e of this.coverageModel.getCoverageUpdateTimes()){const t=s.get(e)||b;if(b=t,!t)continue;w.beginPath();const i=(e-m)*v,n=g-t*T;w.arc(i,n,2,0,2*Math.PI,!1),w.closePath(),w.stroke(),w.fillStyle=s.has(e)?y:"hsl(0, 100%, 100%)",w.fill()}this.heapSizeLabel.textContent=`${c}% used`}}var ie=Object.freeze({__proto__:null,TimelineEventOverview:j,TimelineEventOverviewInput:q,TimelineEventOverviewNetwork:J,TimelineEventOverviewCPUActivity:$,TimelineEventOverviewResponsiveness:K,TimelineFilmStripOverview:Y,TimelineEventOverviewFrames:Q,TimelineEventOverviewMemory:Z,Quantizer:ee,TimelineEventOverviewCoverage:te});class ne extends r.TimelineModelFilter.TimelineModelFilter{minimumRecordDuration;constructor(){super(),this.minimumRecordDuration=0}setMinimumRecordDuration(e){this.minimumRecordDuration=e}accept(e){return(e.endTime?e.endTime-e.startTime:0)>=this.minimumRecordDuration}}class re extends r.TimelineModelFilter.TimelineModelFilter{constructor(){super()}accept(e){return!ni.eventStyle(e).category.hidden}}class ae extends r.TimelineModelFilter.TimelineModelFilter{regExpInternal;constructor(e){super(),this.setRegExp(e||null)}setRegExp(e){this.regExpInternal=e}regExp(){return this.regExpInternal}accept(e){return!this.regExpInternal||ni.testContentMatching(e,this.regExpInternal)}}var se=Object.freeze({__proto__:null,IsLong:ne,Category:re,TimelineRegExp:ae});const oe={performance:"Performance",filter:"Filter",selfTime:"Self Time",totalTime:"Total Time",activity:"Activity",selectItemForDetails:"Select item for details.",notOptimizedS:"Not optimized: {PH1}",fms:"{PH1} ms",percentPlaceholder:"{PH1} %",chromeExtensionsOverhead:"[`Chrome` extensions overhead]",vRuntime:"[`V8` Runtime]",unattributed:"[unattributed]",javascript:"JavaScript",page:"Page",noGrouping:"No Grouping",groupByActivity:"Group by Activity",groupByCategory:"Group by Category",groupByDomain:"Group by Domain",groupByFrame:"Group by Frame",groupBySubdomain:"Group by Subdomain",groupByUrl:"Group by URL",groupBy:"Group by",filterCallTree:"Filter call tree",filterBottomup:"Filter bottom-up",heaviestStack:"Heaviest stack",showHeaviestStack:"Show Heaviest stack",hideHeaviestStack:"Hide Heaviest stack",timelineStack:"Timeline Stack"},le=i.i18n.registerUIStrings("panels/timeline/TimelineTreeView.ts",oe),de=i.i18n.getLocalizedString.bind(void 0,le);class ce extends s.Widget.VBox{modelInternal;track;tree;searchResults;linkifier;dataGrid;lastHoveredProfileNode;textFilterInternal;taskFilter;startTime;endTime;splitWidget;detailsView;searchableView;currentThreadSetting;lastSelectedNodeInternal;textFilterUI;root;currentResult;constructor(){super(),this.modelInternal=null,this.track=null,this.tree=null,this.element.classList.add("timeline-tree-view"),this.searchResults=[]}static eventNameForSorting(e){if(e.name===r.TimelineModel.RecordType.JSFrame){const t=e.args.data;return t.functionName+"@"+(t.scriptId||t.url||"")}return e.name+":@"+r.TimelineProfileTree.eventURL(e)}setSearchableView(e){this.searchableView=e}setModel(e,t){this.modelInternal=e,this.track=t,this.refreshTree()}getToolbarInputAccessiblePlaceHolder(){return""}model(){return this.modelInternal}init(){this.linkifier=new l.Linkifier.Linkifier,this.taskFilter=new r.TimelineModelFilter.ExclusiveNameFilter([r.TimelineModel.RecordType.Task]),this.textFilterInternal=new ae,this.currentThreadSetting=t.Settings.Settings.instance().createSetting("timelineTreeCurrentThread",0),this.currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this.splitWidget=new s.SplitWidget.SplitWidget(!0,!0,"timelineTreeViewDetailsSplitWidget");const i=new s.Widget.VBox,n=new s.Toolbar.Toolbar("",i.element);n.makeWrappable(!0),this.populateToolbar(n),this.dataGrid=new g.SortableDataGrid.SortableDataGrid({displayName:de(oe.performance),columns:e,refreshCallback:void 0,editCallback:void 0,deleteCallback:void 0}),this.dataGrid.addEventListener(g.DataGrid.Events.SortingChanged,this.sortingChanged,this),this.dataGrid.element.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.dataGrid.setResizeMethod(g.DataGrid.ResizeMethod.Last),this.dataGrid.setRowContextMenuCallback(this.onContextMenu.bind(this)),this.dataGrid.asWidget().show(i.element),this.dataGrid.addEventListener(g.DataGrid.Events.SelectedNode,this.updateDetailsForSelection,this),this.detailsView=new s.Widget.VBox,this.detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this.splitWidget.setMainWidget(i),this.splitWidget.setSidebarWidget(this.detailsView),this.splitWidget.hideSidebar(),this.splitWidget.show(this.element),this.splitWidget.addEventListener(s.SplitWidget.Events.ShowModeChanged,this.onShowModeChanged,this),this.lastSelectedNodeInternal}lastSelectedNode(){return this.lastSelectedNodeInternal}updateContents(e){this.setRange(e.startTime(),e.endTime())}setRange(e,t){this.startTime=e,this.endTime=t,this.refreshTree()}filters(){return[this.taskFilter,this.textFilterInternal,...this.modelInternal?this.modelInternal.filters():[]]}filtersWithoutTextFilter(){return[this.taskFilter,...this.modelInternal?this.modelInternal.filters():[]]}textFilter(){return this.textFilterInternal}exposePercentages(){return!1}populateToolbar(e){const t=new s.Toolbar.ToolbarInput(de(oe.filter),this.getToolbarInputAccessiblePlaceHolder());t.addEventListener(s.Toolbar.ToolbarInput.Event.TextChanged,(()=>{const e=t.value();this.textFilterInternal.setRegExp(e?createPlainTextSearchRegex(e,"i"):null),this.refreshTree()}),this),this.textFilterUI=t,e.appendToolbarItem(t)}modelEvents(){return this.track?this.track.syncEvents():[]}onHover(e){}appendContextMenuItems(e,t){}linkifyLocation(e){if(!this.modelInternal)return null;const t=this.modelInternal.timelineModel().targetByEvent(e);if(!t)return null;const i=r.TimelineProfileTree.eventStackFrame(e);return i?this.linkifier.maybeLinkifyConsoleCallFrame(t,i,{showColumnNumber:!0,inlineFrameIndex:0}):null}selectProfileNode(e,t){const i=[];let n=e;for(;n;n=n.parent)i.push(n);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const r=this.dataGridNodeForTreeNode(e);r&&r.dataGrid&&(r.reveal(),r.select(t))}refreshTree(){if(this.linkifier.reset(),this.dataGrid.rootNode().removeChildren(),!this.modelInternal)return void this.updateDetailsForSelection();this.root=this.buildTree();const e=this.root.children();let t=0,i=0;const n=this.root.totalTime-this.root.selfTime;for(const n of e.values())t=Math.max(t,n.selfTime),i=Math.max(i,n.totalTime);for(const r of e.values()){const e=new me(r,n,t,i,this);this.dataGrid.insertChild(e)}this.sortingChanged(),this.updateDetailsForSelection(),this.searchableView&&this.searchableView.refreshSearch();const r=this.dataGrid.rootNode();r.children.length>0&&r.children[0].select(!0)}buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new r.TimelineProfileTree.TopDownRootNode(this.modelEvents(),this.filters(),this.startTime,this.endTime,e,t)}populateColumns(e){e.push({id:"self",title:de(oe.selfTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:de(oe.totalTime),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:de(oe.activity),disclosure:!0,sortable:!0})}sortingChanged(){const e=this.dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"startTime":t=function(e,t){const i=t,n=e.profileNode.event,r=i.profileNode.event;return n.startTime-r.startTime};break;case"self":t=i.bind(null,"selfTime");break;case"total":t=i.bind(null,"totalTime");break;case"activity":t=function(e,t){const i=t,n=e.profileNode.event,r=i.profileNode.event,a=ce.eventNameForSorting(n),s=ce.eventNameForSorting(r);return a.localeCompare(s)};break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t,i){const n=i;return t.profileNode[e]-n.profileNode[e]}this.dataGrid.sortNodes(t,!this.dataGrid.isSortOrderAscending())}onShowModeChanged(){this.splitWidget.showMode()!==s.SplitWidget.ShowMode.OnlyMain&&(this.lastSelectedNodeInternal=void 0,this.updateDetailsForSelection())}updateDetailsForSelection(){const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;if(e===this.lastSelectedNodeInternal)return;if(this.lastSelectedNodeInternal=e,this.splitWidget.showMode()===s.SplitWidget.ShowMode.OnlyMain)return;if(this.detailsView.detachChildWidgets(),this.detailsView.element.removeChildren(),e&&this.showDetailsForNode(e))return;const t=this.detailsView.element.createChild("div","full-widget-dimmed-banner");s.UIUtils.createTextChild(t,de(oe.selectItemForDetails))}showDetailsForNode(e){return!1}onMouseMove(e){const t=e.target&&e.target instanceof Node?this.dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this.lastHoveredProfileNode&&(this.lastHoveredProfileNode=i,this.onHover(i))}onContextMenu(e,t){const i=t;i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement);const n=i.profileNode;n&&this.appendContextMenuItems(e,n)}dataGridNodeForTreeNode(e){return ue.get(e)||null}searchCanceled(){this.searchResults=[],this.currentResult=0}performSearch(e,t,i){if(this.searchResults=[],this.currentResult=0,!this.root)return;const n=e.toSearchRegex();this.searchResults=this.root.searchTree((e=>ni.testContentMatching(e,n))),this.searchableView.updateSearchMatchesCount(this.searchResults.length)}jumpToNextSearchResult(){this.searchResults.length&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=n.NumberUtilities.mod(this.currentResult+1,this.searchResults.length))}jumpToPreviousSearchResult(){this.searchResults.length&&(this.selectProfileNode(this.searchResults[this.currentResult],!1),this.currentResult=n.NumberUtilities.mod(this.currentResult-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class he extends g.SortableDataGrid.SortableDataGridNode{populated;profileNode;treeView;grandTotalTime;maxSelfTime;maxTotalTime;linkElement;constructor(e,t,i,n,r){super(null,!1),this.populated=!1,this.profileNode=e,this.treeView=r,this.grandTotalTime=t,this.maxSelfTime=i,this.maxTotalTime=n,this.linkElement=null}createCell(e){return"activity"===e?this.createNameCell(e):this.createValueCell(e)||super.createCell(e)}createNameCell(e){const t=this.createTD(e),i=t.createChild("div","name-container"),n=i.createChild("div","activity-icon-container"),r=n.createChild("div","activity-icon"),a=i.createChild("div","activity-name"),o=this.profileNode.event;if(this.profileNode.isGroupNode()){const e=this.treeView.displayInfoForGroupNode(this.profileNode);a.textContent=e.name,r.style.backgroundColor=e.color,e.icon&&n.insertBefore(e.icon,r)}else if(o){const e=o.args.data,t=e&&e.deoptReason;t&&(i.createChild("div","activity-warning").title=de(oe.notOptimizedS,{PH1:t})),a.textContent=ni.eventTitle(o),this.linkElement=this.treeView.linkifyLocation(o),this.linkElement&&i.createChild("div","activity-link").appendChild(this.linkElement);const n=ni.eventStyle(o).category;s.ARIAUtils.setAccessibleName(r,n.title),r.style.backgroundColor=n.color}return t}createValueCell(e){if("self"!==e&&"total"!==e&&"startTime"!==e)return null;let t,i,n,r=!1;switch(e){case"startTime":{n=this.profileNode.event;const e=this.treeView.model();if(!e)throw new Error("Unable to find model for tree view");t=(n?n.startTime:0)-e.timelineModel().minimumRecordTime()}break;case"self":t=this.profileNode.selfTime,i=this.maxSelfTime,r=!0;break;case"total":t=this.profileNode.totalTime,i=this.maxTotalTime,r=!0;break;default:return null}const a=this.createTD(e);a.className="numeric-column",a.setAttribute("title",de(oe.fms,{PH1:t.toFixed(4)}));const s=a.createChild("div");return s.createChild("span").textContent=de(oe.fms,{PH1:t.toFixed(1)}),r&&this.treeView.exposePercentages()&&(s.createChild("span","percent-column").textContent=de(oe.percentPlaceholder,{PH1:(t/this.grandTotalTime*100).toFixed(1)})),i&&(s.classList.add("background-percent-bar"),a.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/i).toFixed(1)+"%"),a}}class me extends he{constructor(e,t,i,n,r){super(e,t,i,n,r),this.setHasChildren(this.profileNode.hasChildren()),ue.set(e,this)}populate(){if(!this.populated&&(this.populated=!0,this.profileNode.children))for(const e of this.profileNode.children().values()){const t=new me(e,this.grandTotalTime,this.maxSelfTime,this.maxTotalTime,this.treeView);this.insertChildOrdered(t)}}static gridNodeSymbol=Symbol("treeGridNode")}const ue=new WeakMap;class pe extends ce{groupBySetting;stackView;productByURLCache;colorByURLCache;executionContextNamesByOrigin;constructor(){super(),this.groupBySetting=t.Settings.Settings.instance().createSetting("timelineTreeGroupBy",pe.GroupBy.None),this.groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this.stackView=new Te(this),this.stackView.addEventListener(Te.Events.SelectionChanged,this.onStackViewSelectionChanged,this),this.productByURLCache=new Map,this.colorByURLCache=new Map,this.executionContextNamesByOrigin=new Map}setModel(e,t){super.setModel(e,t)}updateContents(e){this.updateExtensionResolver(),super.updateContents(e);const t=this.dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}updateExtensionResolver(){this.executionContextNamesByOrigin=new Map;for(const t of e.TargetManager.TargetManager.instance().models(e.RuntimeModel.RuntimeModel))for(const e of t.executionContexts())this.executionContextNamesByOrigin.set(e.origin,e.name)}beautifyDomainName(e){return pe.isExtensionInternalURL(e)?e=de(oe.chromeExtensionsOverhead):pe.isV8NativeURL(e)?e=de(oe.vRuntime):e.startsWith("chrome-extension")&&(e=this.executionContextNamesByOrigin.get(e)||e),e}displayInfoForGroupNode(e){const t=ni.categories(),i=e.id?ni.eventColor(e.event):t.other.color,n=de(oe.unattributed),a="symbol"==typeof e.id?void 0:e.id;switch(this.groupBySetting.get()){case pe.GroupBy.Category:{const e=a?t[a]||t.other:{title:n,color:n};return{name:e.title,color:e.color,icon:void 0}}case pe.GroupBy.Domain:case pe.GroupBy.Subdomain:return{name:(a?this.beautifyDomainName(a):void 0)||n,color:i,icon:void 0};case pe.GroupBy.EventName:if(!e.event)throw new Error("Unable to find event for group by operation");return{name:e.event.name===r.TimelineModel.RecordType.JSFrame?de(oe.javascript):ni.eventTitle(e.event),color:e.event.name===r.TimelineModel.RecordType.JSFrame?ni.eventStyle(e.event).category.color:i,icon:void 0};case pe.GroupBy.URL:break;case pe.GroupBy.Frame:{if(!this.modelInternal)throw new Error("Unable to find model for group by frame operation");const e=a?this.modelInternal.timelineModel().pageFrameById(a):void 0;return{name:e?ni.displayNameForFrame(e,80):de(oe.page),color:i,icon:void 0}}default:console.assert(!1,"Unexpected grouping type")}return{name:a||n,color:i,icon:void 0}}populateToolbar(e){super.populateToolbar(e);const t=pe.GroupBy,i=[{label:de(oe.noGrouping),value:t.None},{label:de(oe.groupByActivity),value:t.EventName},{label:de(oe.groupByCategory),value:t.Category},{label:de(oe.groupByDomain),value:t.Domain},{label:de(oe.groupByFrame),value:t.Frame},{label:de(oe.groupBySubdomain),value:t.Subdomain},{label:de(oe.groupByUrl),value:t.URL}];e.appendToolbarItem(new s.Toolbar.ToolbarSettingComboBox(i,this.groupBySetting,de(oe.groupBy))),e.appendSpacer(),e.appendToolbarItem(this.splitWidget.createShowHideSidebarButton(de(oe.showHeaviestStack),de(oe.hideHeaviestStack)))}buildHeaviestStack(e){console.assert(Boolean(e.parent),"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce(((e,t)=>e.totalTime>t.totalTime?e:t)),t.push(i)}return t}exposePercentages(){return!0}onStackViewSelectionChanged(){const e=this.stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}showDetailsForNode(e){const t=this.buildHeaviestStack(e);return this.stackView.setStack(t,e),this.stackView.show(this.detailsView.element),!0}groupingFunction(e){const t=pe.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>ni.eventStyle(e).title;case t.Category:return e=>ni.eventStyle(e).category.name;case t.Subdomain:return this.domainByEvent.bind(this,!1);case t.Domain:return this.domainByEvent.bind(this,!0);case t.URL:return e=>r.TimelineProfileTree.eventURL(e)||"";case t.Frame:return e=>r.TimelineModel.TimelineData.forEvent(e).frameId||"";default:return console.assert(!1,`Unexpected aggregation setting: ${e}`),null}}domainByEvent(e,i){const n=r.TimelineProfileTree.eventURL(i);if(!n)return"";if(pe.isExtensionInternalURL(n))return pe.extensionInternalPrefix;if(pe.isV8NativeURL(n))return pe.v8NativePrefix;const a=t.ParsedURL.ParsedURL.fromString(n);if(!a)return"";if("chrome-extension"===a.scheme)return a.scheme+"://"+a.host;if(!e)return a.host;if(/^[.0-9]+$/.test(a.host))return a.host;const s=/([^.]*\.)?[^.]*$/.exec(a.host);return s&&s[0]||""}appendContextMenuItems(e,t){if(this.groupBySetting.get()!==pe.GroupBy.Frame)return;if(!t.isGroupNode())return;if(!this.modelInternal)return;const i=this.modelInternal.timelineModel().pageFrameById(t.id);i&&i.ownerNode&&e.appendApplicableItems(i.ownerNode)}static isExtensionInternalURL(e){return e.startsWith(pe.extensionInternalPrefix)}static isV8NativeURL(e){return e.startsWith(pe.v8NativePrefix)}static extensionInternalPrefix="extensions::";static v8NativePrefix="native "}!function(e){let t;!function(e){e.None="None",e.EventName="EventName",e.Category="Category",e.Domain="Domain",e.Subdomain="Subdomain",e.URL="URL",e.Frame="Frame"}(t=e.GroupBy||(e.GroupBy={}))}(pe||(pe={}));class ge extends pe{constructor(){super(),this.dataGrid.markColumnAsSortedBy("total",g.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return de(oe.filterCallTree)}buildTree(){const e=this.groupBySetting.get();return this.buildTopDownTree(!1,this.groupingFunction(e))}}class ve extends pe{constructor(){super(),this.dataGrid.markColumnAsSortedBy("self",g.DataGrid.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return de(oe.filterBottomup)}buildTree(){return new r.TimelineProfileTree.BottomUpRootNode(this.modelEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this.startTime,this.endTime,this.groupingFunction(this.groupBySetting.get()))}}class Te extends(t.ObjectWrapper.eventMixin(s.Widget.VBox)){treeView;dataGrid;constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=de(oe.heaviestStack),this.treeView=e;const t=[{id:"total",title:de(oe.totalTime),fixedWidth:!0,width:"110px"},{id:"activity",title:de(oe.activity)}];this.dataGrid=new g.ViewportDataGrid.ViewportDataGrid({displayName:de(oe.timelineStack),columns:t,deleteCallback:void 0,editCallback:void 0,refreshCallback:void 0}),this.dataGrid.setResizeMethod(g.DataGrid.ResizeMethod.Last),this.dataGrid.addEventListener(g.DataGrid.Events.SelectedNode,this.onSelectionChanged,this),this.dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this.dataGrid.rootNode();i.removeChildren();let n=null;const r=Math.max.apply(Math,e.map((e=>e.totalTime)));for(const a of e){const e=new he(a,r,r,r,this.treeView);i.appendChild(e),a===t&&(n=e)}n&&n.revealAndSelect()}selectedTreeNode(){const e=this.dataGrid.selectedNode;return e&&e.profileNode}onSelectionChanged(){this.dispatchEventToListeners(Te.Events.SelectionChanged)}}!function(e){let t;!function(e){e.SelectionChanged="SelectionChanged"}(t=e.Events||(e.Events={}))}(Te||(Te={}));var fe=Object.freeze({__proto__:null,TimelineTreeView:ce,GridNode:he,TreeGridNode:me,get AggregatedTimelineTreeView(){return pe},CallTreeTimelineTreeView:ge,BottomUpTimelineTreeView:ve,get TimelineStackView(){return Te}});const we={filterEventLog:"Filter event log",startTime:"Start Time",durationFilter:"Duration filter",Dms:"{PH1} ms",all:"All"},Se=i.i18n.registerUIStrings("panels/timeline/EventsTimelineTreeView.ts",we),be=i.i18n.getLocalizedString.bind(void 0,Se);class ye extends ce{filtersControl;delegate;currentTree;constructor(e){super(),this.filtersControl=new Ce,this.filtersControl.addEventListener("FilterChanged",this.onFilterChanged,this),this.init(),this.delegate=e,this.dataGrid.markColumnAsSortedBy("startTime",g.DataGrid.Order.Ascending),this.splitWidget.showBoth()}filters(){return[...super.filters(),...this.filtersControl.filters()]}updateContents(e){if(super.updateContents(e),e.type()===Vt.Type.TraceEvent){const t=e.object();this.selectEvent(t,!0)}}getToolbarInputAccessiblePlaceHolder(){return be(we.filterEventLog)}buildTree(){return this.currentTree=this.buildTopDownTree(!0,null),this.currentTree}onFilterChanged(){const e=this.lastSelectedNode(),t=e&&e.event;this.refreshTree(),t&&this.selectEvent(t,!1)}findNodeWithEvent(e){const t=[this.currentTree.children().values()];for(;t.length;){const{done:i,value:n}=t[t.length-1].next();if(i)t.pop();else{if(n.event===e)return n;t.push(n.children().values())}}return null}selectEvent(e,t){const i=this.findNodeWithEvent(e);if(i&&(this.selectProfileNode(i,!1),t)){const e=this.dataGridNodeForTreeNode(i);e&&e.expand()}}populateColumns(e){e.push({id:"startTime",title:be(we.startTime),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter((e=>e.fixedWidth)).forEach((e=>{e.width="80px"}))}populateToolbar(e){super.populateToolbar(e),this.filtersControl.populateToolbar(e)}showDetailsForNode(e){const t=e.event;if(!t)return!1;const i=this.model();return!!i&&(ni.buildTraceEventDetails(t,i.timelineModel(),this.linkifier,!1).then((e=>this.detailsView.element.appendChild(e))),!0)}onHover(e){this.delegate.highlightEvent(e&&e.event)}}class Ce extends t.ObjectWrapper.ObjectWrapper{categoryFilter;durationFilter;filtersInternal;constructor(){super(),this.categoryFilter=new re,this.durationFilter=new ne,this.filtersInternal=[this.categoryFilter,this.durationFilter]}filters(){return this.filtersInternal}populateToolbar(e){const t=new s.Toolbar.ToolbarComboBox(function(){const e=t.selectedOption().value,i=parseInt(e,10);this.durationFilter.setMinimumRecordDuration(i),this.notifyFiltersChanged()}.bind(this),be(we.durationFilter));for(const e of Ce.durationFilterPresetsMs)t.addOption(t.createOption(e?`≥ ${be(we.Dms,{PH1:e})}`:be(we.all),String(e)));e.appendToolbarItem(t);const i=new Map,n=ni.categories();for(const t in n){const a=n[t];if(!a.visible)continue;const o=new s.Toolbar.ToolbarCheckbox(a.title,void 0,r.bind(this,t));o.setChecked(!0),o.inputElement.style.backgroundColor=a.color,i.set(a.name,o),e.appendToolbarItem(o)}function r(e){const t=ni.categories(),n=i.get(e);t[e].hidden=!n||!n.checked(),this.notifyFiltersChanged()}}notifyFiltersChanged(){this.dispatchEventToListeners("FilterChanged")}static durationFilterPresetsMs=[0,1,15]}var ke=Object.freeze({__proto__:null,EventsTimelineTreeView:ye,Filters:Ce});class Me extends s.SplitWidget.SplitWidget{model;showPaintProfilerCallback;rightSplitWidget;layerViewHost;layers3DView;frameLayerTree;updateWhenVisible;constructor(e,t){super(!0,!1,"timelineLayersView"),this.model=e,this.showPaintProfilerCallback=t,this.element.classList.add("timeline-layers-view"),this.rightSplitWidget=new s.SplitWidget.SplitWidget(!0,!0,"timelineLayersViewDetails"),this.rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this.rightSplitWidget);const i=new s.Widget.VBox;this.setSidebarWidget(i),this.layerViewHost=new v.LayerViewHost.LayerViewHost;const n=new v.LayerTreeOutline.LayerTreeOutline(this.layerViewHost);i.element.appendChild(n.element),this.layers3DView=new v.Layers3DView.Layers3DView(this.layerViewHost),this.layers3DView.addEventListener(v.Layers3DView.Events.PaintProfilerRequested,this.onPaintProfilerRequested,this),this.rightSplitWidget.setMainWidget(this.layers3DView);const r=new v.LayerDetailsView.LayerDetailsView(this.layerViewHost);this.rightSplitWidget.setSidebarWidget(r),r.addEventListener(v.LayerDetailsView.Events.PaintProfilerRequested,this.onPaintProfilerRequested,this)}showLayerTree(e){this.frameLayerTree=e,this.isShowing()?this.update():this.updateWhenVisible=!0}wasShown(){this.updateWhenVisible&&(this.updateWhenVisible=!1,this.update())}async onPaintProfilerRequested(e){const t=e.data,i=await this.layers3DView.snapshotForSelection(t);i&&this.showPaintProfilerCallback(i.snapshot)}update(){this.frameLayerTree&&this.frameLayerTree.layerTreePromise().then((e=>this.layerViewHost.setLayerTree(e)))}}var Pe=Object.freeze({__proto__:null,TimelineLayersView:Me});const xe=new CSSStyleSheet;xe.replaceSync(".paint-profiler-image-view{overflow:hidden}.paint-profiler-image-view .paint-profiler-image-container{transform-origin:0 0}.paint-profiler-image-view .paint-profiler-image-container div{border-color:var(--color-details-hairline);border-style:solid;z-index:100;position:absolute;top:0;left:0}.paint-profiler-image-view img{border:solid 1px var(--color-background-inverted)}\n/*# sourceURL=timelinePaintProfiler.css */\n");class Re extends s.SplitWidget.SplitWidget{frameModel;logAndImageSplitWidget;imageView;paintProfilerView;logTreeView;needsUpdateWhenVisible;pendingSnapshot;event;paintProfilerModel;lastLoadedSnapshot;constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this.frameModel=e,this.logAndImageSplitWidget=new s.SplitWidget.SplitWidget(!0,!1),this.logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this.logAndImageSplitWidget),this.imageView=new Ie,this.logAndImageSplitWidget.setMainWidget(this.imageView),this.paintProfilerView=new v.PaintProfilerView.PaintProfilerView(this.imageView.showImage.bind(this.imageView)),this.paintProfilerView.addEventListener(v.PaintProfilerView.Events.WindowChanged,this.onWindowChanged,this),this.setSidebarWidget(this.paintProfilerView),this.logTreeView=new v.PaintProfilerView.PaintProfilerCommandLogView,this.logAndImageSplitWidget.setSidebarWidget(this.logTreeView),this.needsUpdateWhenVisible=!1,this.pendingSnapshot=null,this.event=null,this.paintProfilerModel=null,this.lastLoadedSnapshot=null}wasShown(){super.wasShown(),this.needsUpdateWhenVisible&&(this.needsUpdateWhenVisible=!1,this.update())}setSnapshot(e){this.releaseSnapshot(),this.pendingSnapshot=e,this.event=null,this.updateWhenVisible()}setEvent(e,t){return this.releaseSnapshot(),this.paintProfilerModel=e,this.pendingSnapshot=null,this.event=t,this.updateWhenVisible(),this.event.name===r.TimelineModel.RecordType.Paint?Boolean(r.TimelineModel.TimelineData.forEvent(t).picture):this.event.name===r.TimelineModel.RecordType.RasterTask&&this.frameModel.hasRasterTile(this.event)}updateWhenVisible(){this.isShowing()?this.update():this.needsUpdateWhenVisible=!0}update(){let e;if(this.logTreeView.setCommandLog([]),this.paintProfilerView.setSnapshotAndLog(null,[],null),this.pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this.pendingSnapshot});else if(this.event&&this.event.name===r.TimelineModel.RecordType.Paint){e=r.TimelineModel.TimelineData.forEvent(this.event).picture.objectPromise().then((e=>this.paintProfilerModel.loadSnapshot(e.skp64))).then((e=>e&&{rect:null,snapshot:e}))}else{if(!this.event||this.event.name!==r.TimelineModel.RecordType.RasterTask)return void console.assert(!1,"Unexpected event type or no snapshot");e=this.frameModel.rasterTilePromise(this.event)}function t(e,t,i){this.logTreeView.setCommandLog(i||[]),this.paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then((e=>{if(this.releaseSnapshot(),!e)return void this.imageView.showImage();const i=e.snapshot;this.lastLoadedSnapshot=i,this.imageView.setMask(e.rect),i.commandLog().then((n=>t.call(this,i,e.rect,n||[])))}))}releaseSnapshot(){this.lastLoadedSnapshot&&(this.lastLoadedSnapshot.release(),this.lastLoadedSnapshot=null)}onWindowChanged(){this.logTreeView.updateWindow(this.paintProfilerView.selectionWindow())}}class Ie extends s.Widget.Widget{imageContainer;imageElement;maskElement;transformController;maskRectangle;constructor(){super(!0),this.contentElement.classList.add("fill","paint-profiler-image-view"),this.imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this.imageElement=this.imageContainer.createChild("img"),this.maskElement=this.imageContainer.createChild("div"),this.imageElement.addEventListener("load",this.updateImagePosition.bind(this),!1),this.transformController=new v.TransformController.TransformController(this.contentElement,!0),this.transformController.addEventListener(v.TransformController.Events.TransformChanged,this.updateImagePosition,this)}onResize(){this.imageElement.src&&this.updateImagePosition()}updateImagePosition(){const e=this.imageElement.naturalWidth,t=this.imageElement.naturalHeight,i=this.contentElement.clientWidth,n=this.contentElement.clientHeight,r=.1*i,a=.1*n,o=(i-r)/e,l=(n-a)/t,d=Math.min(o,l);if(this.maskRectangle){const i=this.maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this.maskRectangle.x+"px",i.borderTopWidth=this.maskRectangle.y+"px",i.borderRightWidth=e-this.maskRectangle.x-this.maskRectangle.width+"px",i.borderBottomWidth=t-this.maskRectangle.y-this.maskRectangle.height+"px"}this.transformController.setScaleConstraints(.5,10/d);let c=(new WebKitCSSMatrix).scale(this.transformController.scale(),this.transformController.scale()).translate(i/2,n/2).scale(d,d).translate(-e/2,-t/2);const h=s.Geometry.boundsForTransformedPoints(c,[0,0,0,e,t,0]);this.transformController.clampOffsets(r-h.maxX,i-r-h.minX,a-h.maxY,n-a-h.minY),c=(new WebKitCSSMatrix).translate(this.transformController.offsetX(),this.transformController.offsetY()).multiply(c),this.imageContainer.style.webkitTransform=c.toString()}showImage(e){this.imageContainer.classList.toggle("hidden",!e),e&&(this.imageElement.src=e)}setMask(e){this.maskRectangle=e,this.maskElement.classList.toggle("hidden",!e)}wasShown(){super.wasShown(),this.registerCSSFiles([xe])}}var Ee=Object.freeze({__proto__:null,TimelinePaintProfilerView:Re,TimelinePaintImageView:Ie});const Le={summary:"Summary",bottomup:"Bottom-Up",callTree:"Call Tree",eventLog:"Event Log",estimated:"estimated",totalBlockingTimeSmss:"Total blocking time: {PH1}ms{PH2}",learnMore:"Learn more",layers:"Layers",paintProfiler:"Paint Profiler",rangeSS:"Range:  {PH1} – {PH2}"},Fe=i.i18n.registerUIStrings("panels/timeline/TimelineDetailsView.ts",Le),De=i.i18n.getLocalizedString.bind(void 0,Fe);class Ue extends s.Widget.VBox{detailsLinkifier;tabbedPane;defaultDetailsWidget;defaultDetailsContentElement;rangeDetailViews;additionalMetricsToolbar;model;track;lazyPaintProfilerView;lazyLayersView;preferredTabId;selection;constructor(e){super(),this.element.classList.add("timeline-details"),this.detailsLinkifier=new l.Linkifier.Linkifier,this.tabbedPane=new s.TabbedPane.TabbedPane,this.tabbedPane.show(this.element),this.defaultDetailsWidget=new s.Widget.VBox,this.defaultDetailsWidget.element.classList.add("timeline-details-view"),this.defaultDetailsContentElement=this.defaultDetailsWidget.element.createChild("div","timeline-details-view-body vbox"),this.appendTab(He.Details,De(Le.summary),this.defaultDetailsWidget),this.setPreferredTab(He.Details),this.rangeDetailViews=new Map;const t=new ve;this.appendTab(He.BottomUp,De(Le.bottomup),t),this.rangeDetailViews.set(He.BottomUp,t);const i=new ge;this.appendTab(He.CallTree,De(Le.callTree),i),this.rangeDetailViews.set(He.CallTree,i);const n=new ye(e);this.appendTab(He.EventLog,De(Le.eventLog),n),this.rangeDetailViews.set(He.EventLog,n),this.additionalMetricsToolbar=new s.Toolbar.Toolbar("timeline-additional-metrics"),this.element.appendChild(this.additionalMetricsToolbar.element),this.tabbedPane.addEventListener(s.TabbedPane.Events.TabSelected,this.tabSelected,this)}setModel(e,t){this.model!==e&&(this.model&&this.model.removeEventListener(pi.WindowChanged,this.onWindowChanged,this),this.model=e,this.model&&this.model.addEventListener(pi.WindowChanged,this.onWindowChanged,this)),this.track=t,this.tabbedPane.closeTabs([He.PaintProfiler,He.LayerViewer],!1);for(const i of this.rangeDetailViews.values())i.setModel(e,t);if(this.lazyPaintProfilerView=null,this.lazyLayersView=null,this.setSelection(null),this.additionalMetricsToolbar.removeToolbarItems(),e&&e.timelineModel()){const{estimated:t,time:i}=e.timelineModel().totalBlockingTime(),n=t?` (${De(Le.estimated)})`:"",r=De(Le.totalBlockingTimeSmss,{PH1:i.toFixed(2),PH2:n}),a=document.createElement("span"),o=s.XLink.XLink.create("https://web.dev/tbt/",De(Le.learnMore));o.style.marginRight="2px",a.appendChild(o),this.additionalMetricsToolbar.appendText(r),this.additionalMetricsToolbar.appendToolbarItem(new s.Toolbar.ToolbarItem(a))}}setContent(e){const t=this.tabbedPane.otherTabs(He.Details);for(let e=0;e<t.length;++e)this.rangeDetailViews.has(t[e])||this.tabbedPane.closeTab(t[e]);this.defaultDetailsContentElement.removeChildren(),this.defaultDetailsContentElement.appendChild(e)}updateContents(){const e=this.rangeDetailViews.get(this.tabbedPane.selectedTabId||"");if(e){const t=this.model.window();e.updateContents(this.selection||Vt.fromRange(t.left,t.right))}}appendTab(e,t,i,n){this.tabbedPane.appendTab(e,t,i,void 0,void 0,n),this.preferredTabId!==this.tabbedPane.selectedTabId&&this.tabbedPane.selectTab(e)}headerElement(){return this.tabbedPane.headerElement()}setPreferredTab(e){this.preferredTabId=e}onWindowChanged(){this.selection||this.updateContentsFromWindow()}updateContentsFromWindow(){if(!this.model)return void this.setContent(s.Fragment.html`<div>`);const e=this.model.window();this.updateSelectedRangeStats(e.left,e.right),this.updateContents()}setSelection(e){if(this.detailsLinkifier.reset(),this.selection=e,this.selection){switch(this.selection.type()){case Vt.Type.TraceEvent:{const e=this.selection.object();ni.buildTraceEventDetails(e,this.model.timelineModel(),this.detailsLinkifier,!0).then((t=>this.appendDetailsTabsForTraceEventAndShowDetails(e,t)));break}case Vt.Type.Frame:{const e=this.selection.object(),t=this.model.filmStripModelFrame(e);if(this.setContent(ni.generateDetailsContentForFrame(e,t)),e.layerTree){const t=this.layersView();t.showLayerTree(e.layerTree),this.tabbedPane.hasTab(He.LayerViewer)||this.appendTab(He.LayerViewer,De(Le.layers),t)}break}case Vt.Type.NetworkRequest:{const e=this.selection.object();ni.buildNetworkRequestDetails(e,this.model.timelineModel(),this.detailsLinkifier).then(this.setContent.bind(this));break}case Vt.Type.Range:this.updateSelectedRangeStats(this.selection.startTime(),this.selection.endTime())}this.updateContents()}else this.updateContentsFromWindow()}tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this.updateContents())}layersView(){return this.lazyLayersView||(this.lazyLayersView=new Me(this.model.timelineModel(),this.showSnapshotInPaintProfiler.bind(this))),this.lazyLayersView}paintProfilerView(){return this.lazyPaintProfilerView||(this.lazyPaintProfilerView=new Re(this.model.frameModel())),this.lazyPaintProfilerView}showSnapshotInPaintProfiler(e){const t=this.paintProfilerView();t.setSnapshot(e),this.tabbedPane.hasTab(He.PaintProfiler)||this.appendTab(He.PaintProfiler,De(Le.paintProfiler),t,!0),this.tabbedPane.selectTab(He.PaintProfiler,!0)}appendDetailsTabsForTraceEventAndShowDetails(e,t){this.setContent(t),e.name!==r.TimelineModel.RecordType.Paint&&e.name!==r.TimelineModel.RecordType.RasterTask||this.showEventInPaintProfiler(e)}showEventInPaintProfiler(t){const i=e.TargetManager.TargetManager.instance().models(e.PaintProfiler.PaintProfilerModel)[0];if(!i)return;const n=this.paintProfilerView();n.setEvent(i,t)&&(this.tabbedPane.hasTab(He.PaintProfiler)||this.appendTab(He.PaintProfiler,De(Le.paintProfiler),n))}updateSelectedRangeStats(e,t){if(!this.model||!this.track)return;const n=ni.statsForTimeRange(this.track.syncEvents(),e,t),r=e-this.model.timelineModel().minimumRecordTime(),a=t-this.model.timelineModel().minimumRecordTime(),s=new hi(null,null);s.addSection(De(Le.rangeSS,{PH1:i.TimeUtilities.millisToString(r),PH2:i.TimeUtilities.millisToString(a)}));const o=ni.generatePieChart(n);s.appendElementRow("",o),this.setContent(s.fragment)}}var He;!function(e){e.Details="Details",e.EventLog="EventLog",e.CallTree="CallTree",e.BottomUp="BottomUp",e.PaintProfiler="PaintProfiler",e.LayerViewer="LayerViewer"}(He||(He={}));var We=Object.freeze({__proto__:null,TimelineDetailsView:Ue,get Tab(){return He}});const Ne=new CSSStyleSheet;Ne.replaceSync(".timeline-flamechart-popover{overflow:hidden}.timeline-flamechart-popover span{margin-right:5px}.timeline-flamechart-popover span.timeline-info-network-time{color:var(--color-primary)}.timeline-flamechart-popover span.timeline-info-time{color:var(--color-accent-green)}.timeline-flamechart-popover span.timeline-info-warning{color:var(--color-accent-red)}.timeline-flamechart-popover span.timeline-info-warning *{color:inherit}\n/*# sourceURL=timelineFlamechartPopover.css */\n");const Ve={onIgnoreList:"On ignore list",input:"Input",animation:"Animation",timings:"Timings",console:"Console",mainS:"Main — {PH1}",main:"Main",frameS:"Frame — {PH1}",subframe:"Subframe",raster:"Raster",rasterizerThreadS:"Rasterizer Thread {PH1}",gpu:"GPU",thread:"Thread",experience:"Experience",interactions:"Interactions",frames:"Frames",sSelfS:"{PH1} (self {PH2})",occurrencesS:"Occurrences: {PH1}",sFfps:"{PH1} ~ {PH2} fps",idleFrame:"Idle Frame",droppedFrame:"Dropped Frame",frame:"Frame",longFrame:"Long frame",threadS:"Thread {PH1}"},Be=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartDataProvider.ts",Ve),Ae=i.i18n.getLocalizedString.bind(void 0,Be);class ze extends t.ObjectWrapper.ObjectWrapper{font;timelineDataInternal;currentLevel;performanceModel;model;minimumBoundaryInternal;maximumBoundary;timeSpan;consoleColorGenerator;extensionColorGenerator;headerLevel1;headerLevel2;staticHeader;framesHeader;collapsibleTimingsHeader;timingsHeader;screenshotsHeader;interactionsHeaderLevel1;interactionsHeaderLevel2;experienceHeader;flowEventIndexById;entryData;entryTypeByLevel;markers;asyncColorByInteractionPhase;screenshotImageCache;extensionInfo;entryIndexToTitle;asyncColorByCategory;lastInitiatorEntry;entryParent;frameGroup;lastSelection;colorForEvent;constructor(){super(),this.reset(),this.font="11px "+d.Platform.fontFamily(),this.timelineDataInternal=null,this.currentLevel=0,this.performanceModel=null,this.model=null,this.minimumBoundaryInternal=0,this.maximumBoundary=0,this.timeSpan=0,this.consoleColorGenerator=new t.Color.Generator({min:30,max:55,count:void 0},{min:70,max:100,count:6},50,.7),this.extensionColorGenerator=new t.Color.Generator({min:210,max:300,count:void 0},{min:70,max:100,count:6},70,.7),this.headerLevel1=this.buildGroupStyle({shareHeaderLine:!1}),this.headerLevel2=this.buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this.staticHeader=this.buildGroupStyle({collapsible:!1}),this.framesHeader=this.buildGroupStyle({useFirstLineForOverview:!0}),this.collapsibleTimingsHeader=this.buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!0}),this.timingsHeader=this.buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!1}),this.screenshotsHeader=this.buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),this.interactionsHeaderLevel1=this.buildGroupStyle({useFirstLineForOverview:!0}),this.interactionsHeaderLevel2=this.buildGroupStyle({padding:2,nestingLevel:1}),this.experienceHeader=this.buildGroupStyle({collapsible:!1}),this.flowEventIndexById=new Map}buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:T.ThemeSupport.instance().patchColorText("#222",T.ThemeSupport.ColorUsage.Foreground),backgroundColor:T.ThemeSupport.instance().patchColorText("white",T.ThemeSupport.ColorUsage.Background),font:this.font,nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e){this.reset(),this.performanceModel=e,this.model=e&&e.timelineModel()}groupTrack(e){return e.track||null}navStartTimes(){return this.model?this.model.navStartTimes():new Map}entryTitle(t){const i=qe,n=this.entryType(t);if(n===i.Event){const i=this.entryData[t];return i.phase===e.TracingModel.Phase.AsyncStepInto||i.phase===e.TracingModel.Phase.AsyncStepPast?i.name+":"+i.args.step:Ge.get(i)?Ae(Ve.onIgnoreList):this.performanceModel&&this.performanceModel.timelineModel().isMarkerEvent(i)?ni.markerShortTitle(i):ni.eventTitle(i)}if(n===i.ExtensionEvent){return this.entryData[t].name}if(n===i.Screenshot)return"";let r=this.entryIndexToTitle[t];return r||(r=`Unexpected entryIndex ${t}`,console.error(r)),r}textColor(e){const t=this.entryData[e];return t&&Ge.get(t)?"#888":st.textColor}entryFont(e){return this.font}reset(){this.currentLevel=0,this.timelineDataInternal=null,this.entryData=[],this.entryParent=[],this.entryTypeByLevel=[],this.entryIndexToTitle=[],this.markers=[],this.asyncColorByCategory=new Map,this.asyncColorByInteractionPhase=new Map,this.extensionInfo=[],this.screenshotImageCache=new Map}maxStackDepth(){return this.currentLevel}timelineData(){return this.timelineDataInternal?this.timelineDataInternal:(this.timelineDataInternal=new a.FlameChart.TimelineData([],[],[],[]),this.model?(this.flowEventIndexById.clear(),this.minimumBoundaryInternal=this.model.minimumRecordTime(),this.timeSpan=this.model.isEmpty()?1e3:this.model.maximumRecordTime()-this.minimumBoundaryInternal,this.currentLevel=0,this.model.isGenericTrace()?this.processGenericTrace():this.processInspectorTrace(),this.timelineDataInternal):this.timelineDataInternal)}processGenericTrace(){const e=this.buildGroupStyle({shareHeaderLine:!1}),t=this.buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),i=qe.Event,a=new n.MapUtilities.Multimap;if(this.model){for(const e of this.model.tracks())null!==e.thread?a.set(e.thread.process(),e):console.error("Failed to process track");for(const n of a.keysArray()){if(a.size>1){const t=`${n.name()} ${n.id()}`;this.appendHeader(t,e,!1)}for(const e of a.get(n)){const n=this.appendSyncEvents(e,e.events,e.name,t,i,!0);!this.timelineDataInternal||this.timelineDataInternal.selectedGroup&&e.name!==r.TimelineModel.TimelineModelImpl.BrowserMainThreadName||(this.timelineDataInternal.selectedGroup=n)}}}}processInspectorTrace(){this.appendFrames(),this.appendInteractionRecords();const e=qe.Event,t=e=>{switch(e.type){case r.TimelineModel.TrackType.Input:return 0;case r.TimelineModel.TrackType.Animation:return 1;case r.TimelineModel.TrackType.Timings:return 2;case r.TimelineModel.TrackType.Console:return 3;case r.TimelineModel.TrackType.Experience:return 4;case r.TimelineModel.TrackType.MainThread:return e.forMainFrame?5:6;case r.TimelineModel.TrackType.Worker:return 7;case r.TimelineModel.TrackType.Raster:return 8;case r.TimelineModel.TrackType.GPU:return 9;case r.TimelineModel.TrackType.Other:return 10;default:return-1}};if(!this.model)return;const i=this.model.tracks().slice();i.sort(((e,i)=>t(e)-t(i)));let n=0;for(const t of i)switch(t.type){case r.TimelineModel.TrackType.Input:this.appendAsyncEventsGroup(t,Ae(Ve.input),t.asyncEvents,this.interactionsHeaderLevel2,e,!1);break;case r.TimelineModel.TrackType.Animation:this.appendAsyncEventsGroup(t,Ae(Ve.animation),t.asyncEvents,this.interactionsHeaderLevel2,e,!1);break;case r.TimelineModel.TrackType.Timings:{const i=t.asyncEvents.length>0?this.collapsibleTimingsHeader:this.timingsHeader;this.appendHeader(Ae(Ve.timings),i,!0).track=t,this.appendPageMetrics(),this.copyPerfMarkEvents(t),this.appendSyncEvents(t,t.events,null,null,e,!0),this.appendAsyncEventsGroup(t,null,t.asyncEvents,null,e,!0);break}case r.TimelineModel.TrackType.Console:this.appendAsyncEventsGroup(t,Ae(Ve.console),t.asyncEvents,this.headerLevel1,e,!0);break;case r.TimelineModel.TrackType.MainThread:if(t.forMainFrame){const i=this.appendSyncEvents(t,t.events,t.url?Ae(Ve.mainS,{PH1:t.url}):Ae(Ve.main),this.headerLevel1,e,!0);i&&this.timelineDataInternal&&(this.timelineDataInternal.selectedGroup=i)}else this.appendSyncEvents(t,t.events,t.url?Ae(Ve.frameS,{PH1:t.url}):Ae(Ve.subframe),this.headerLevel1,e,!0);break;case r.TimelineModel.TrackType.Worker:this.appendSyncEvents(t,t.events,t.name,this.headerLevel1,e,!0);break;case r.TimelineModel.TrackType.Raster:n||this.appendHeader(Ae(Ve.raster),this.headerLevel1,!1),++n,this.appendSyncEvents(t,t.events,Ae(Ve.rasterizerThreadS,{PH1:n}),this.headerLevel2,e,!0);break;case r.TimelineModel.TrackType.GPU:this.appendSyncEvents(t,t.events,Ae(Ve.gpu),this.headerLevel1,e,!0);break;case r.TimelineModel.TrackType.Other:this.appendSyncEvents(t,t.events,t.name||Ae(Ve.thread),this.headerLevel1,e,!0),this.appendAsyncEventsGroup(t,t.name,t.asyncEvents,this.headerLevel1,e,!0);break;case r.TimelineModel.TrackType.Experience:this.appendSyncEvents(t,t.events,Ae(Ve.experience),this.experienceHeader,e,!0)}this.timelineDataInternal&&this.timelineDataInternal.selectedGroup&&(this.timelineDataInternal.selectedGroup.expanded=!0);for(let e=0;e<this.extensionInfo.length;e++)this.innerAppendExtensionEvents(e);this.markers.sort(((e,t)=>e.startTime()-t.startTime())),this.timelineDataInternal&&(this.timelineDataInternal.markers=this.markers),this.flowEventIndexById.clear()}minimumBoundary(){return this.minimumBoundaryInternal}totalTime(){return this.timeSpan}search(t,i,n){const r=[],a=qe;this.timelineData();for(let e=0;e<this.entryData.length;++e){if(this.entryType(e)!==a.Event)continue;const s=this.entryData[e];s.startTime>i||((s.endTime||s.startTime)<t||n.accept(s)&&r.push(e))}return r.sort(((t,i)=>e.TracingModel.Event.compareStartTime(this.entryData[t],this.entryData[i]))),r}appendSyncEvents(t,i,n,a,s,o){if(!i.length)return null;if(!this.performanceModel||!this.model)return null;const l=s===qe.ExtensionEvent,d=[],h=!l&&c.Runtime.experiments.isEnabled("ignoreListJSFramesOnTimeline");let m=0,u=null;t&&t.type===r.TimelineModel.TrackType.MainThread&&(u=this.appendHeader(n,a,o),u.track=t);for(let s=0;s<i.length;++s){const c=i[s];if(this.performanceModel){const e=this.performanceModel.timelineModel().isInteractiveTimeEvent(c),i=this.performanceModel.timelineModel().isLayoutShiftEvent(c),n=e||i;if(t&&t.type===r.TimelineModel.TrackType.MainThread&&n)continue}if(this.performanceModel&&this.performanceModel.timelineModel().isLayoutShiftEvent(c))for(const e of this.performanceModel.frames()){void 0===c.endTime&&c.setEndTime(c.startTime);const t=c.startTime>=e.startTime,i=c.endTime&&c.endTime<=e.endTime;t&&i&&(c.startTime=e.startTime,c.setEndTime(e.endTime))}if(!l&&this.performanceModel.timelineModel().isMarkerEvent(c)&&this.markers.push(new ot(c.startTime,c.startTime-this.model.minimumRecordTime(),ni.markerStyleForEvent(c))),!e.TracingModel.TracingModel.isFlowPhase(c.phase)){if(!c.endTime&&c.phase!==e.TracingModel.Phase.Instant)continue;if(e.TracingModel.TracingModel.isAsyncPhase(c.phase))continue;if(!l&&!this.performanceModel.isVisible(c))continue}for(;d.length&&d[d.length-1].endTime<=c.startTime;)d.pop();if(Ge.set(c,!1),h&&this.isIgnoreListedEvent(c)){const e=d[d.length-1];if(e&&Ge.get(e))continue;Ge.set(c,!0)}!u&&n&&(u=this.appendHeader(n,a,o),o&&(u.track=t));const p=this.currentLevel+d.length,g=this.appendEvent(c,p);d.length&&(this.entryParent[g]=d[d.length-1]),!l&&this.performanceModel.timelineModel().isMarkerEvent(c)&&(this.timelineDataInternal.entryTotalTimes[this.entryData.length]=void 0),m=Math.max(m,d.length+1),c.endTime&&d.push(c)}return this.entryTypeByLevel.length=this.currentLevel+m,this.entryTypeByLevel.fill(s,this.currentLevel),this.currentLevel+=m,u}isIgnoreListedEvent(e){if(e.name!==r.TimelineModel.RecordType.JSFrame)return!1;const t=e.args.data.url;return t&&this.isIgnoreListedURL(t)}isIgnoreListedURL(e){return o.IgnoreListManager.IgnoreListManager.instance().isIgnoreListedURL(e)}appendAsyncEventsGroup(e,t,i,n,r,a){if(!i.length)return null;const s=[];let o=null;for(let r=0;r<i.length;++r){const l=i[r];if(!this.performanceModel||!this.performanceModel.isVisible(l))continue;!o&&t&&(o=this.appendHeader(t,n,a),a&&(o.track=e));const d=l.startTime;let c;for(c=0;c<s.length&&s[c]>d;++c);this.appendAsyncEvent(l,this.currentLevel+c),s[c]=l.endTime}return this.entryTypeByLevel.length=this.currentLevel+s.length,this.entryTypeByLevel.fill(r,this.currentLevel),this.currentLevel+=s.length,o}appendInteractionRecords(){if(!this.performanceModel)return;const e=this.performanceModel.interactionRecords();if(e.length){this.appendHeader(Ae(Ve.interactions),this.interactionsHeaderLevel1,!1);for(const t of e){const e=this.entryData.length;this.entryData.push(t.data),this.entryIndexToTitle[e]=t.data,this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[e]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[e]=t.end-t.begin,this.timelineDataInternal.entryStartTimes[e]=t.begin)}this.entryTypeByLevel[this.currentLevel++]=qe.InteractionRecord}}appendPageMetrics(){if(this.entryTypeByLevel[this.currentLevel]=qe.Event,!this.performanceModel||!this.model)return;const t=[],i=[],n=[],r=this.performanceModel.timelineModel();for(const e of this.model.tracks())for(const a of e.events)r.isLayoutShiftEvent(a)&&n.push(a),r.isMarkerEvent(a)&&(r.isLCPCandidateEvent(a)||r.isLCPInvalidateEvent(a)?i.push(a):t.push(a));if(i.length>0){const e=new Map;for(const t of i){const i=t.args.data.navigationId,n=e.get(i);(!n||n.args.data.candidateIndex<t.args.data.candidateIndex)&&e.set(i,t)}const n=Array.from(e.values()).filter((e=>r.isLCPCandidateEvent(e)));t.push(...n)}if(n.length&&ui(n),t.sort(e.TracingModel.Event.compareStartTime),this.timelineDataInternal){const e=this.timelineDataInternal.entryTotalTimes;for(const i of t)this.appendEvent(i,this.currentLevel),e[e.length-1]=Number.NaN}++this.currentLevel}copyPerfMarkEvents(t){if(this.entryTypeByLevel[this.currentLevel]=qe.Event,!this.performanceModel||!this.model||!t)return;const i=this.performanceModel.timelineModel(),n=["workerStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","navigationStart","unloadEventStart","unloadEventEnd","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];for(const a of this.model.tracks())if(a.type===r.TimelineModel.TrackType.MainThread)for(const r of a.events)if(i.isUserTimingEvent(r)){if(n.includes(r.name))continue;if(e.TracingModel.TracingModel.isAsyncPhase(r.phase))continue;r.setEndTime(r.startTime),t.events.push(r)}++this.currentLevel}appendFrames(){if(!this.performanceModel||!this.timelineDataInternal||!this.model)return;const e=this.performanceModel.filmStripModel().frames(),t=Boolean(e.length);this.framesHeader.collapsible=t,this.appendHeader(Ae(Ve.frames),this.framesHeader,!1),this.frameGroup=this.timelineDataInternal.groups[this.timelineDataInternal.groups.length-1];const i=ni.markerStyleForFrame();this.entryTypeByLevel[this.currentLevel]=qe.Frame;for(const e of this.performanceModel.frames())this.markers.push(new ot(e.startTime,e.startTime-this.model.minimumRecordTime(),i)),this.appendFrame(e);if(++this.currentLevel,!t)return;let n;this.appendHeader("",this.screenshotsHeader,!1),this.entryTypeByLevel[this.currentLevel]=qe.Screenshot;for(const t of e)this.entryData.push(t),this.timelineDataInternal.entryLevels.push(this.currentLevel),this.timelineDataInternal.entryStartTimes.push(t.timestamp),n&&this.timelineDataInternal.entryTotalTimes.push(t.timestamp-n),n=t.timestamp;e.length&&void 0!==n&&this.timelineDataInternal.entryTotalTimes.push(this.model.maximumRecordTime()-n),++this.currentLevel}entryType(e){return this.entryTypeByLevel[this.timelineDataInternal.entryLevels[e]]}prepareHighlightedEntryInfo(e){let t,n,r="",a="timeline-info-time";const l=this.entryType(e);if(l===qe.Event){const a=this.entryData[e],s=a.duration,l=a.selfTime,d=1e-6;if("number"==typeof s&&(r=Math.abs(s-l)>d&&l>d?Ae(Ve.sSelfS,{PH1:i.TimeUtilities.millisToString(s,!0),PH2:i.TimeUtilities.millisToString(l,!0)}):i.TimeUtilities.millisToString(s,!0)),t=this.performanceModel&&this.performanceModel.timelineModel().isMarkerEvent(a)?ni.eventTitle(a):this.entryTitle(e),n=ni.eventWarning(a),this.model&&this.model.isLayoutShiftEvent(a)){r=Ae(Ve.occurrencesS,{PH1:1})}if(this.model&&this.model.isParseHTMLEvent(a)){const e=a.args.beginData.startLine,i=a.args.endData&&a.args.endData.endLine;t+=` - ${o.ResourceUtils.displayNameForURL(a.args.beginData.url)} [${-1!==i||i===e?`${e}...${i}`:e}]`}}else{if(l!==qe.Frame)return null;{const s=this.entryData[e];r=Ae(Ve.sFfps,{PH1:i.TimeUtilities.preciseMillisToString(s.duration,1),PH2:(1e3/s.duration).toFixed(0)}),s.idle?t=Ae(Ve.idleFrame):s.dropped?(t=Ae(Ve.droppedFrame),a="timeline-info-warning"):t=Ae(Ve.frame),s.hasWarnings()&&(n=document.createElement("span"),n.textContent=Ae(Ve.longFrame))}}const d=document.createElement("div"),c=s.Utils.createShadowRootWithCoreStyles(d,{cssFile:[Ne],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover");return c.createChild("span",a).textContent=r,c.createChild("span","timeline-info-title").textContent=t,n&&(n.classList.add("timeline-info-warning"),c.appendChild(n)),d}entryColor(i){function n(e,i,n){let r=e.get(i);if(r)return r;const a=t.Color.Color.parse(n(i));if(!a)throw new Error("Could not parse color from entry");return r=a.setAlpha(.7).asString(t.Color.Format.RGBA)||"",e.set(i,r),r}if(!this.performanceModel||!this.model)return"";const a=qe,s=this.entryType(i);if(s===a.Event){const t=this.entryData[i];if(this.model.isGenericTrace())return this.genericTraceEventColor(t);if(this.performanceModel.timelineModel().isMarkerEvent(t))return ni.markerStyleForEvent(t).color;if(!e.TracingModel.TracingModel.isAsyncPhase(t.phase)&&this.colorForEvent)return this.colorForEvent(t);if(t.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)||t.hasCategory(r.TimelineModel.TimelineModelImpl.Category.UserTiming))return this.consoleColorGenerator.colorForID(t.name);if(t.hasCategory(r.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const e=r.TimelineIRModel.TimelineIRModel.phaseForEvent(t)||r.TimelineIRModel.Phases.Uncategorized;return n(this.asyncColorByInteractionPhase,e,ni.interactionPhaseColor)}const a=ni.eventStyle(t).category;return n(this.asyncColorByCategory,a,(()=>a.color))}if(s===a.Frame)return"white";if(s===a.InteractionRecord)return"transparent";if(s===a.ExtensionEvent){const e=this.entryData[i];return this.extensionColorGenerator.colorForID(e.name)}return""}genericTraceEventColor(e){const t=e.categoriesString||e.name;return t?`hsl(${n.StringUtilities.hashCode(t)%300+30}, 40%, 70%)`:"#ccc"}drawFrame(e,t,n,r,a,s,o){const l=this.entryData[e];r+=1,s-=2,t.fillStyle=l.idle?"white":l.dropped?"#f0b7b1":l.hasWarnings()?"#fad1d1":"#d7f0d1",t.fillRect(r,a,s,o);const d=i.TimeUtilities.preciseMillisToString(l.duration,1),c=t.measureText(d).width;c<=s&&(t.fillStyle=this.textColor(e),t.fillText(d,r+(s-c)/2,a+o-4))}async drawScreenshot(e,t,i,n,r,a){const o=this.entryData[e];if(!this.screenshotImageCache.has(o)){this.screenshotImageCache.set(o,null);const e=await o.imageDataPromise(),t=await s.UIUtils.loadImageFromData(e);return this.screenshotImageCache.set(o,t),void this.dispatchEventToListeners(je.DataChanged)}const l=this.screenshotImageCache.get(o);if(!l)return;const d=i+1,c=n+1,h=a-2,m=h/l.naturalHeight,u=Math.floor(l.naturalWidth*m);t.save(),t.beginPath(),t.rect(i,n,r,a),t.clip(),t.drawImage(l,d,c,u,h),t.strokeStyle="#ccc",t.strokeRect(d-.5,c-.5,Math.min(r-1,u+1),h),t.restore()}decorateEntry(e,t,i,n,a,s,o,l,d){const c=this.entryData[e],h=this.entryType(e),m=qe;if(h===m.Frame)return this.drawFrame(e,t,i,n,a,s,o),!0;if(h===m.Screenshot)return this.drawScreenshot(e,t,n,a,s,o),!0;if(h===m.InteractionRecord){const e=ni.interactionPhaseColor(c);return t.fillStyle=e,t.fillRect(n,a,s-1,2),t.fillRect(n,a-3,2,3),t.fillRect(n+s-3,a-3,2,3),!1}if(h===m.Event){const e=c;if(e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const i=r.TimelineModel.TimelineData.forEvent(e).timeWaitingForMainThread;if(i){t.fillStyle="hsla(0, 70%, 60%, 1)";const e=Math.floor(l-n+i*d);t.fillRect(n,a+o-3,e,2)}}r.TimelineModel.TimelineData.forEvent(e).warning&&function(e,i){const n=8;t.save(),t.beginPath(),t.rect(e,a,i,o),t.clip(),t.beginPath(),t.fillStyle="red",t.moveTo(e+i-n,a),t.lineTo(e+i,a),t.lineTo(e+i,a+n),t.fill(),t.restore()}(n,s-1.5)}return!1}forceDecoration(e){const t=qe,i=this.entryType(e);if(i===t.Frame)return!0;if(i===t.Screenshot)return!0;if(i===t.Event){const t=this.entryData[e];return Boolean(r.TimelineModel.TimelineData.forEvent(t).warning)}return!1}appendExtensionEvents(e){this.extensionInfo.push(e),this.timelineDataInternal&&this.innerAppendExtensionEvents(this.extensionInfo.length-1)}innerAppendExtensionEvents(e){const t=this.extensionInfo[e],i=qe.ExtensionEvent,n=[...t.model.sortedProcesses().map((e=>e.sortedThreads()))].flat();if(!n.length)return;const r=!(1!==n.length||n[0].events().length&&n[0].asyncEvents().length);r||this.appendHeader(t.title,this.headerLevel1,!1);const a=r?this.headerLevel2:this.headerLevel1;let s=0;for(const e of n){const n=r?t.title:e.name()||Ae(Ve.threadS,{PH1:++s});this.appendAsyncEventsGroup(null,n,e.asyncEvents(),a,i,!1),this.appendSyncEvents(null,e.events(),n,a,i,!1)}}appendHeader(e,t,i){const n={startLevel:this.currentLevel,name:e,style:t,selectable:i};return this.timelineDataInternal.groups.push(n),n}appendEvent(e,t){const i=this.entryData.length;this.entryData.push(e);const n=this.timelineDataInternal;return n.entryLevels[i]=t,n.entryTotalTimes[i]=e.duration||Oe,n.entryStartTimes[i]=e.startTime,_e.set(e,i),i}appendAsyncEvent(t,i){if(e.TracingModel.TracingModel.isNestableAsyncPhase(t.phase))return void this.appendEvent(t,i);const n=t.steps,r=n.length>1&&n[1].phase===e.TracingModel.Phase.AsyncStepPast?1:0;for(let e=0;e<n.length-1;++e){const t=this.entryData.length;this.entryData.push(n[e+r]);const a=n[e].startTime,s=this.timelineDataInternal;s.entryLevels[t]=i,s.entryTotalTimes[t]=n[e+1].startTime-a,s.entryStartTimes[t]=a}}appendFrame(e){const t=this.entryData.length;this.entryData.push(e),this.entryIndexToTitle[t]=i.TimeUtilities.millisToString(e.duration,!0),this.timelineDataInternal&&(this.timelineDataInternal.entryLevels[t]=this.currentLevel,this.timelineDataInternal.entryTotalTimes[t]=e.duration,this.timelineDataInternal.entryStartTimes[t]=e.startTime)}createSelection(e){const t=this.entryType(e);let i=null;return t===qe.Event?i=Vt.fromTraceEvent(this.entryData[e]):t===qe.Frame&&(i=Vt.fromFrame(this.entryData[e])),i&&(this.lastSelection=new at(i,e)),i}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||e.type()===Vt.Type.Range)return-1;if(this.lastSelection&&this.lastSelection.timelineSelection.object()===e.object())return this.lastSelection.entryIndex;const t=this.entryData.indexOf(e.object());return-1!==t&&(this.lastSelection=new at(e,t)),t}buildFlowForInitiator(e){if(this.lastInitiatorEntry===e)return!1;this.lastInitiatorEntry=e;let t=this.eventByIndex(e);const i=this.timelineDataInternal;if(!i)return!1;for(i.flowStartTimes=[],i.flowStartLevels=[],i.flowEndTimes=[],i.flowEndLevels=[];t;){let e;for(;t&&(e=r.TimelineModel.TimelineData.forEvent(t).initiator(),!e);t=this.eventParent(t));if(!e||!t)break;const n=_e.get(t),a=_e.get(e);i.flowStartTimes.push(e.endTime||e.startTime),i.flowStartLevels.push(i.entryLevels[a]),i.flowEndTimes.push(t.startTime),i.flowEndLevels.push(i.entryLevels[n]),t=e}return!0}eventParent(e){const t=_e.get(e);return void 0===t?null:this.entryParent[t]||null}eventByIndex(e){return e>=0&&this.entryType(e)===qe.Event?this.entryData[e]:null}setEventColorMapping(e){this.colorForEvent=e}}const Oe=.001,Ge=new WeakMap,_e=new WeakMap;var je,qe;(je||(je={})).DataChanged="DataChanged",function(e){e.Frame="Frame",e.Event="Event",e.InteractionRecord="InteractionRecord",e.ExtensionEvent="ExtensionEvent",e.Screenshot="Screenshot"}(qe||(qe={}));var Je=Object.freeze({__proto__:null,TimelineFlameChartDataProvider:ze,InstantEventVisibleDurationMs:Oe,get Events(){return je},get EntryType(){return qe}});const Xe={network:"Network"},$e=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartNetworkDataProvider.ts",Xe),Ke=i.i18n.getLocalizedString.bind(void 0,$e);class Ye{font;style;group;minimumBoundaryInternal;maximumBoundary;timeSpan;requests;maxLevel;model;timelineDataInternal;startTime;endTime;lastSelection;priorityToValue;constructor(){this.font="11px "+d.Platform.fontFamily(),this.setModel(null),this.style={padding:4,height:17,collapsible:!0,color:T.ThemeSupport.instance().patchColorText("#222",T.ThemeSupport.ColorUsage.Foreground),font:this.font,backgroundColor:T.ThemeSupport.instance().patchColorText("white",T.ThemeSupport.ColorUsage.Background),nestingLevel:0,useFirstLineForOverview:!1,useDecoratorsForOverview:!0,shareHeaderLine:!1},this.group={startLevel:0,name:Ke(Xe.network),expanded:!1,style:this.style},this.minimumBoundaryInternal=0,this.maximumBoundary=0,this.timeSpan=0,this.requests=[],this.maxLevel=0}setModel(e){this.model=e&&e.timelineModel(),this.timelineDataInternal=null}isEmpty(){return this.timelineData(),!this.requests.length}maxStackDepth(){return this.maxLevel}timelineData(){return this.timelineDataInternal||(this.requests=[],this.timelineDataInternal=new a.FlameChart.TimelineData([],[],[],[]),this.model&&this.appendTimelineData()),this.timelineDataInternal}minimumBoundary(){return this.minimumBoundaryInternal}totalTime(){return this.timeSpan}setWindowTimes(e,t){this.startTime=e,this.endTime=t,this.updateTimelineData()}createSelection(e){if(-1===e)return null;const t=this.requests[e];return this.lastSelection=new at(Vt.fromNetworkRequest(t),e),this.lastSelection.timelineSelection}entryIndexForSelection(e){if(!e)return-1;if(this.lastSelection&&this.lastSelection.timelineSelection.object()===e.object())return this.lastSelection.entryIndex;if(e.type()!==Vt.Type.NetworkRequest)return-1;const t=e.object(),i=this.requests.indexOf(t);return-1!==i&&(this.lastSelection=new at(Vt.fromNetworkRequest(t),i)),i}entryColor(e){const t=this.requests[e],i=ni.networkRequestCategory(t);return ni.networkCategoryColor(i)}textColor(e){return st.textColor}entryTitle(e){const i=this.requests[e],n=new t.ParsedURL.ParsedURL(i.url||"");return n.isValid?`${n.displayName} (${n.host})`:i.url||null}entryFont(e){return this.font}decorateEntry(e,t,i,r,a,o,l,d,c){const h=this.requests[e];if(!h.timing)return!1;const m=h.timing,u=h.beginTime(),p=e=>Math.floor(d+(e-u)*c),g=h.getStartTime(),v=h.endTime,{sendStartTime:f,headersEndTime:w}=h.getSendReceiveTiming(),S=Math.max(p(f),d),b=Math.max(p(w),S),y=Math.max(p(h.finishTime||v),b+2),C=p(g),k=Math.max(p(v),y);if(t.fillStyle="hsla(0, 100%, 100%, 0.8)",t.fillRect(S+.5,a+.5,b-S-.5,l-2),t.fillStyle=T.ThemeSupport.instance().patchColorText("white",T.ThemeSupport.ColorUsage.Background),t.fillRect(r,a-.5,S-r,l),t.fillRect(y,a-.5,r+o-y,l),!h.cached()&&m.pushStart){const i=p(1e3*m.pushStart),r=m.pushEnd?p(1e3*m.pushEnd):C,s=n.NumberUtilities.clamp(r-i-2,0,4),o=1;if(t.save(),t.beginPath(),t.moveTo(i+s,a+l/2),t.lineTo(i,a+o),t.lineTo(r-s,a+o),t.lineTo(r,a+l/2),t.lineTo(r-s,a+l-o),t.lineTo(i,a+l-o),t.closePath(),m.pushEnd)t.fillStyle=this.entryColor(e);else{const n=t.createLinearGradient(i,0,r,0);n.addColorStop(0,this.entryColor(e)),n.addColorStop(1,"white"),t.fillStyle=n}t.globalAlpha=.3,t.fill(),t.restore()}function M(e,i,n){t.moveTo(e,n-3),t.lineTo(e,n+3),t.moveTo(e,n),t.lineTo(i,n)}t.beginPath(),t.lineWidth=1,t.strokeStyle="#ccc";const P=Math.floor(a+l/2)+.5,x=k-.5;if(M(C+.5,S,P),M(x,y,P),t.stroke(),"string"==typeof h.priority){const e=this.colorForPriority(h.priority);e&&(t.fillStyle=e,t.fillRect(S+.5,a+.5,3.5,3.5))}const R=Math.max(S,0),I=y-R;if(I>=20&&(i=this.entryTitle(e)||"",h.fromServiceWorker&&(i="⚙ "+i),i)){const e=4,n=l-5,r=s.UIUtils.trimTextEnd(t,i,I-2*e);t.fillStyle="#333",t.fillText(r,R+e,a+n)}return!0}forceDecoration(e){return!0}prepareHighlightedEntryInfo(e){const t=this.requests[e];if(!t.url)return null;const r=document.createElement("div"),o=s.Utils.createShadowRootWithCoreStyles(r,{cssFile:[Ne],delegatesFocus:void 0}).createChild("div","timeline-flamechart-popover"),l=t.getStartTime(),d=t.endTime-l;if(l&&isFinite(d)&&(o.createChild("span","timeline-info-network-time").textContent=i.TimeUtilities.millisToString(d,!0)),"string"==typeof t.priority){const e=o.createChild("span");e.textContent=a.NetworkPriorities.uiLabelForNetworkPriority(t.priority),e.style.color=this.colorForPriority(t.priority)||"black"}return o.createChild("span").textContent=n.StringUtilities.trimMiddle(t.url,80),r}colorForPriority(e){this.priorityToValue||(this.priorityToValue=new Map([["VeryLow",1],["Low",2],["Medium",3],["High",4],["VeryHigh",5]]));const t=this.priorityToValue.get(e);return t?`hsla(214, 80%, 50%, ${t/5})`:null}appendTimelineData(){this.model&&(this.minimumBoundaryInternal=this.model.minimumRecordTime(),this.maximumBoundary=this.model.maximumRecordTime(),this.timeSpan=this.model.isEmpty()?1e3:this.maximumBoundary-this.minimumBoundaryInternal,this.model.networkRequests().forEach(this.appendEntry.bind(this)),this.updateTimelineData())}updateTimelineData(){if(!this.timelineDataInternal)return;const e=[];let t=0;for(let i=0;i<this.requests.length;++i){const n=this.requests[i],r=n.beginTime(),a=this.startTime;if(r<this.endTime&&n.endTime>a){for(;e.length&&e[e.length-1]<=r;)e.pop();this.timelineDataInternal.entryLevels[i]=e.length,e.push(n.endTime),t=Math.max(t,e.length)}else this.timelineDataInternal.entryLevels[i]=-1}for(let e=0;e<this.requests.length;++e)-1===this.timelineDataInternal.entryLevels[e]&&(this.timelineDataInternal.entryLevels[e]=t);this.timelineDataInternal=new a.FlameChart.TimelineData(this.timelineDataInternal.entryLevels,this.timelineDataInternal.entryTotalTimes,this.timelineDataInternal.entryStartTimes,[this.group]),this.maxLevel=t}appendEntry(e){this.requests.push(e),this.timelineDataInternal.entryStartTimes.push(e.beginTime()),this.timelineDataInternal.entryTotalTimes.push(e.endTime-e.beginTime()),this.timelineDataInternal.entryLevels.push(this.requests.length-1)}preferredHeight(){return this.style.height*(this.group.expanded?n.NumberUtilities.clamp(this.maxLevel+1,4,8.5):1)}isExpanded(){return this.group&&Boolean(this.group.expanded)}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}navStartTimes(){return this.model?this.model.navStartTimes():new Map}}var Qe=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:Ye});class Ze extends s.Widget.VBox{delegate;webVitalsTimeline;chartViewport;constructor(e){super(!0,!0),this.delegate=e,this.element.style.height="120px",this.element.style.flex="0 auto",this.webVitalsTimeline=new f.WebVitalsTimeline.WebVitalsTimeline,this.chartViewport=new a.ChartViewport.ChartViewport(this),this.chartViewport.show(this.contentElement),this.chartViewport.alwaysShowVerticalScroll(),this.chartViewport.setContentHeight(114),this.chartViewport.viewportElement.appendChild(this.webVitalsTimeline)}windowChanged(e,t,i){this.delegate.windowChanged(e,t,i)}updateRangeSelection(e,t){this.delegate.updateRangeSelection(e,t)}setSize(e,t){this.webVitalsTimeline.setSize(e,t)}update(){this.webVitalsTimeline.render()}}const et={sAtS:"{PH1} at {PH2}"},tt=i.i18n.registerUIStrings("panels/timeline/TimelineFlameChartView.ts",et),it=i.i18n.getLocalizedString.bind(void 0,tt);class nt extends s.SplitWidget.SplitWidget{webVitals;model;constructor(e,t,i,n,r,a){super(e,t,i,n,r,a)}setWebVitals(e){this.webVitals=e,this.webVitals.setMinimumSize(0,120)}setWindowTimes(e,t,i){if(!this.webVitals)return;const n=e-(this.model?this.model.timelineModel().minimumRecordTime():0);this.webVitals.chartViewport.setWindowTimes(e,t,i),this.webVitals.webVitalsTimeline.data={startTime:n,duration:t-e,fcps:void 0,lcps:void 0,layoutShifts:void 0,longTasks:void 0,mainFrameNavigations:void 0,maxDuration:void 0}}setModelAndUpdateBoundaries(t){if(this.model=t,!this.webVitals||!t)return;const i=t.window().left,n=t.window().right,r=t.timelineModel(),a=r.tracks().reduce(((e,t)=>e.concat(t.events)),[]),s=t.timelineModel().minimumRecordTime(),o=e=>a.filter(e).map((e=>e.startTime-s)),l=a.filter((e=>r.isLCPCandidateEvent(e)||r.isLCPInvalidateEvent(e))),d=new Map;for(const e of l){const t=e.args.data.navigationId,i=d.get(t);(!i||i.args.data.candidateIndex<e.args.data.candidateIndex)&&d.set(t,e)}const c=Array.from(d.values()).filter((e=>r.isLCPCandidateEvent(e))),h=a.filter((t=>e.TracingModel.TracingModel.isCompletePhase(t.phase)&&r.isLongRunningTask(t))).map((e=>({start:e.startTime-s,duration:e.duration||0})));this.webVitals.chartViewport.setBoundaries(i,n-i),this.webVitals.chartViewport.setWindowTimes(i,n);const m=i-(this.model?this.model.timelineModel().minimumRecordTime():0);this.webVitals.webVitalsTimeline.data={startTime:m,duration:n-i,maxDuration:r.maximumRecordTime(),fcps:a.filter((e=>r.isFCPEvent(e))).map((e=>({timestamp:e.startTime-s,e:e}))),lcps:c.map((e=>e.startTime)).map((e=>({timestamp:e-s}))),layoutShifts:o((e=>r.isLayoutShiftEvent(e))).map((e=>({timestamp:e}))),longTasks:h,mainFrameNavigations:o((e=>r.isMainFrameNavigationStartEvent(e)))}}}class rt extends s.Widget.VBox{delegate;model;searchResults;eventListeners;showMemoryGraphSetting;showWebVitalsSetting;networkSplitWidget;mainDataProvider;mainFlameChart;networkFlameChartGroupExpansionSetting;networkDataProvider;networkFlameChart;networkPane;splitResizer;webVitals;mainSplitWidget;chartSplitWidget;countersView;detailsSplitWidget;detailsView;onMainEntrySelected;onNetworkEntrySelected;nextExtensionIndex;boundRefresh;selectedTrack;groupBySetting;searchableView;urlToColorCache;needsResizeToPreferredHeights;selectedSearchResult;searchRegex;constructor(e){super(),this.element.classList.add("timeline-flamechart"),this.delegate=e,this.model=null,this.eventListeners=[],this.showMemoryGraphSetting=t.Settings.Settings.instance().createSetting("timelineShowMemory",!1),this.showWebVitalsSetting=t.Settings.Settings.instance().createSetting("timelineWebVitals",!1),this.networkSplitWidget=new s.SplitWidget.SplitWidget(!1,!1,"timelineFlamechartMainView",150),this.networkSplitWidget.sidebarElement().style.zIndex="120";const i=t.Settings.Settings.instance().createSetting("timelineFlamechartMainViewGroupExpansion",{});this.mainDataProvider=new ze,this.mainDataProvider.addEventListener(je.DataChanged,(()=>this.mainFlameChart.scheduleUpdate())),this.mainFlameChart=new a.FlameChart.FlameChart(this.mainDataProvider,this,i),this.mainFlameChart.alwaysShowVerticalScroll(),this.mainFlameChart.enableRuler(!1),this.networkFlameChartGroupExpansionSetting=t.Settings.Settings.instance().createSetting("timelineFlamechartNetworkViewGroupExpansion",{}),this.networkDataProvider=new Ye,this.networkFlameChart=new a.FlameChart.FlameChart(this.networkDataProvider,this,this.networkFlameChartGroupExpansionSetting),this.networkFlameChart.alwaysShowVerticalScroll(),this.networkFlameChart.disableRangeSelection(),this.networkPane=new s.Widget.VBox,this.networkPane.setMinimumSize(23,23),this.networkFlameChart.show(this.networkPane.element),this.splitResizer=this.networkPane.element.createChild("div","timeline-flamechart-resizer"),this.networkSplitWidget.hideDefaultResizer(!0),this.networkSplitWidget.installResizer(this.splitResizer),this.webVitals=new Ze(this),this.mainSplitWidget=new nt(!1,!1,"timelineFlamechartMainAndVitalsView",void 0,120),this.mainSplitWidget.setWebVitals(this.webVitals),this.mainSplitWidget.setMainWidget(this.mainFlameChart),this.mainSplitWidget.setSidebarWidget(this.webVitals),this.toggleWebVitalsLane(),this.networkSplitWidget.setMainWidget(this.mainSplitWidget),this.networkSplitWidget.setSidebarWidget(this.networkPane),this.chartSplitWidget=new s.SplitWidget.SplitWidget(!1,!0,"timelineCountersSplitViewState"),this.countersView=new bi(this.delegate),this.chartSplitWidget.setMainWidget(this.networkSplitWidget),this.chartSplitWidget.setSidebarWidget(this.countersView),this.chartSplitWidget.hideDefaultResizer(),this.chartSplitWidget.installResizer(this.countersView.resizerElement()),this.updateCountersGraphToggle(),this.detailsSplitWidget=new s.SplitWidget.SplitWidget(!1,!0,"timelinePanelDetailsSplitViewState"),this.detailsSplitWidget.element.classList.add("timeline-details-split"),this.detailsView=new Ue(e),this.detailsSplitWidget.installResizer(this.detailsView.headerElement()),this.detailsSplitWidget.setMainWidget(this.chartSplitWidget),this.detailsSplitWidget.setSidebarWidget(this.detailsView),this.detailsSplitWidget.show(this.element),this.onMainEntrySelected=this.onEntrySelected.bind(this,this.mainDataProvider),this.onNetworkEntrySelected=this.onEntrySelected.bind(this,this.networkDataProvider),this.mainFlameChart.addEventListener(a.FlameChart.Events.EntrySelected,this.onMainEntrySelected,this),this.mainFlameChart.addEventListener(a.FlameChart.Events.EntryInvoked,this.onMainEntrySelected,this),this.networkFlameChart.addEventListener(a.FlameChart.Events.EntrySelected,this.onNetworkEntrySelected,this),this.networkFlameChart.addEventListener(a.FlameChart.Events.EntryInvoked,this.onNetworkEntrySelected,this),this.mainFlameChart.addEventListener(a.FlameChart.Events.EntryHighlighted,this.onEntryHighlighted,this),this.nextExtensionIndex=0,this.boundRefresh=this.refresh.bind(this),this.selectedTrack=null,this.mainDataProvider.setEventColorMapping(ni.eventColor),this.groupBySetting=t.Settings.Settings.instance().createSetting("timelineTreeGroupBy",pe.GroupBy.None),this.groupBySetting.addChangeListener(this.updateColorMapper,this),this.updateColorMapper()}toggleWebVitalsLane(){this.showWebVitalsSetting.get()?(this.mainSplitWidget.showBoth(),this.mainSplitWidget.setSidebarSize(120),this.mainSplitWidget.setResizable(!1),this.mainSplitWidget.hideDefaultResizer(!0)):this.mainSplitWidget.hideSidebar()}updateColorMapper(){this.urlToColorCache=new Map,this.model&&(this.mainDataProvider.setEventColorMapping(ni.eventColor),this.mainFlameChart.update())}onWindowChanged(e){const{window:t,animate:i}=e.data;this.mainFlameChart.setWindowTimes(t.left,t.right,i),this.networkFlameChart.setWindowTimes(t.left,t.right,i),this.networkDataProvider.setWindowTimes(t.left,t.right),this.mainSplitWidget.setWindowTimes(t.left,t.right,Boolean(i)),this.updateSearchResults(!1,!1)}windowChanged(e,t,i){this.model&&this.model.setWindow({left:e,right:t},i)}updateRangeSelection(e,t){this.delegate.select(Vt.fromRange(e,t))}updateSelectedGroup(e,t){if(e!==this.mainFlameChart)return;const i=t?this.mainDataProvider.groupTrack(t):null;this.selectedTrack=i,this.updateTrack()}setModel(e){if(e!==this.model){if(t.EventTarget.removeEventListeners(this.eventListeners),this.model=e,this.selectedTrack=null,this.mainDataProvider.setModel(this.model),this.networkDataProvider.setModel(this.model),this.model){this.eventListeners=[this.model.addEventListener(pi.WindowChanged,this.onWindowChanged,this),this.model.addEventListener(pi.ExtensionDataAdded,this.appendExtensionData,this)];const t=this.model.window();this.mainFlameChart.setWindowTimes(t.left,t.right),this.networkFlameChart.setWindowTimes(t.left,t.right),this.networkDataProvider.setWindowTimes(t.left,t.right),this.mainSplitWidget.setModelAndUpdateBoundaries(e),this.updateSearchResults(!1,!1)}this.updateColorMapper(),this.updateTrack(),this.nextExtensionIndex=0,this.appendExtensionData(),this.refresh()}}updateTrack(){this.countersView.setModel(this.model,this.selectedTrack),this.detailsView.setModel(this.model,this.selectedTrack)}refresh(){this.networkDataProvider.isEmpty()?(this.mainFlameChart.enableRuler(!0),this.networkSplitWidget.hideSidebar()):(this.mainFlameChart.enableRuler(!1),this.networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this.mainFlameChart.reset(),this.networkFlameChart.reset(),this.updateSearchResults(!1,!1)}appendExtensionData(){if(!this.model)return;const e=this.model.extensionInfo();for(;this.nextExtensionIndex<e.length;)this.mainDataProvider.appendExtensionEvents(e[this.nextExtensionIndex++]);this.mainFlameChart.scheduleUpdate()}onEntryHighlighted(t){e.OverlayModel.OverlayModel.hideDOMNodeHighlight();const i=t.data,n=this.mainDataProvider.eventByIndex(i);if(!n)return;const a=this.model&&this.model.timelineModel().targetByEvent(n);if(!a)return;const s=r.TimelineModel.TimelineData.forEvent(n).backendNodeIds;if(s)for(let t=0;t<s.length;++t)new e.DOMModel.DeferredDOMNode(a,s[t]).highlight()}highlightEvent(e){const t=e?this.mainDataProvider.entryIndexForSelection(Vt.fromTraceEvent(e)):-1;t>=0?this.mainFlameChart.highlightEntry(t):this.mainFlameChart.hideHighlight()}willHide(){this.networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),this.showMemoryGraphSetting.removeChangeListener(this.updateCountersGraphToggle,this),o.IgnoreListManager.IgnoreListManager.instance().removeChangeListener(this.boundRefresh)}wasShown(){this.networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),this.showMemoryGraphSetting.addChangeListener(this.updateCountersGraphToggle,this),o.IgnoreListManager.IgnoreListManager.instance().addChangeListener(this.boundRefresh),this.needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this.mainFlameChart.scheduleUpdate(),this.networkFlameChart.scheduleUpdate()}updateCountersGraphToggle(){this.showMemoryGraphSetting.get()?this.chartSplitWidget.showBoth():this.chartSplitWidget.hideSidebar()}setSelection(e){let t=this.mainDataProvider.entryIndexForSelection(e);this.mainFlameChart.setSelectedEntry(t),t=this.networkDataProvider.entryIndexForSelection(e),this.networkFlameChart.setSelectedEntry(t),this.detailsView&&this.detailsView.setSelection(e)}onEntrySelected(e,t){const i=t.data;c.Runtime.experiments.isEnabled("timelineEventInitiators")&&e===this.mainDataProvider&&this.mainDataProvider.buildFlowForInitiator(i)&&this.mainFlameChart.scheduleUpdate(),this.delegate.select(e.createSelection(i))}resizeToPreferredHeights(){this.isShowing()?(this.needsResizeToPreferredHeights=!1,this.networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this.networkDataProvider.isExpanded()),this.networkSplitWidget.setSidebarSize(this.networkDataProvider.preferredHeight()+this.splitResizer.clientHeight+a.FlameChart.HeaderHeight+2)):this.needsResizeToPreferredHeights=!0}setSearchableView(e){this.searchableView=e}jumpToNextSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):-1;this.selectSearchResult(n.NumberUtilities.mod(e+1,this.searchResults.length))}jumpToPreviousSearchResult(){if(!this.searchResults||!this.searchResults.length)return;const e=void 0!==this.selectedSearchResult?this.searchResults.indexOf(this.selectedSearchResult):0;this.selectSearchResult(n.NumberUtilities.mod(e-1,this.searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}selectSearchResult(e){this.searchableView.updateCurrentMatchIndex(e),this.searchResults&&(this.selectedSearchResult=this.searchResults[e],this.delegate.select(this.mainDataProvider.createSelection(this.selectedSearchResult)))}updateSearchResults(e,t){const i=this.selectedSearchResult;if(delete this.selectedSearchResult,this.searchResults=[],!this.searchRegex||!this.model)return;const n=new ae(this.searchRegex),r=this.model.window();if(this.searchResults=this.mainDataProvider.search(r.left,r.right,n),this.searchableView.updateSearchMatchesCount(this.searchResults.length),!e||!this.searchResults.length)return;let a=this.searchResults.indexOf(i);-1===a&&(a=t?this.searchResults.length-1:0),this.selectSearchResult(a)}searchCanceled(){void 0!==this.selectedSearchResult&&this.delegate.select(null),delete this.searchResults,delete this.selectedSearchResult,delete this.searchRegex}performSearch(e,t,i){this.searchRegex=e.toSearchRegex(),this.updateSearchResults(t,i)}}class at{timelineSelection;entryIndex;constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const st={textColor:"#333"};class ot{startTimeInternal;startOffset;style;constructor(e,t,i){this.startTimeInternal=e,this.startOffset=t,this.style=i}startTime(){return this.startTimeInternal}color(){return this.style.color}title(){if(this.style.lowPriority)return null;const e=i.TimeUtilities.millisToString(this.startOffset);return it(et.sAtS,{PH1:this.style.title,PH2:e})}draw(e,t,i,n){this.style.lowPriority&&n<4||(e.save(),this.style.tall&&(e.strokeStyle=this.style.color,e.lineWidth=this.style.lineWidth,e.translate(this.style.lineWidth<1||1&this.style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this.style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke()),e.restore())}}var lt;!function(e){e.URL="URL"}(lt||(lt={}));var dt=Object.freeze({__proto__:null,TimelineFlameChartView:rt,Selection:at,FlameChartStyle:st,TimelineFlameChartMarker:ot,get ColorBy(){return lt}});const ct=new CSSStyleSheet;ct.replaceSync(".drop-down{padding:1px;box-shadow:var(--drop-shadow);background:var(--color-background)}.preview-item{border-color:transparent;border-style:solid;border-width:1px 5px;padding:2px 0;margin:2px 1px}.preview-item.selected{border-color:var(--legacy-selection-bg-color)}.preview-item canvas{width:100%;height:100%}.text-details{font-size:11px;padding:3px}.text-details span{flex:1 0;padding-left:8px;padding-right:8px}.text-details .name{font-weight:700}.text-details span.time{color:var(--color-text-secondary);text-align:right}.screenshot-thumb{display:flex;border:1px solid var(--color-background-elevation-2);margin:2px 4px}.screenshot-thumb img{margin:auto;max-width:100%;max-height:100%}\n/*# sourceURL=timelineHistoryManager.css */\n");const ht={currentSessionSS:"Current Session: {PH1}. {PH2}",noRecordings:"(no recordings)",sAgo:"({PH1} ago)",moments:"moments",sM:"{PH1} m",sH:"{PH1} h",sD:"{PH1} #{PH2}",selectTimelineSession:"Select Timeline Session"},mt=i.i18n.registerUIStrings("panels/timeline/TimelineHistoryManager.ts",ht),ut=i.i18n.getLocalizedString.bind(void 0,mt);class pt{recordings;action;nextNumberByDomain;buttonInternal;allOverviews;totalHeight;enabled;lastActiveModel;constructor(){this.recordings=[],this.action=s.ActionRegistry.ActionRegistry.instance().action("timeline.show-history"),this.nextNumberByDomain=new Map,this.buttonInternal=new wt(this.action),s.ARIAUtils.markAsMenuButton(this.buttonInternal.element),this.clear(),this.allOverviews=[{constructor:K,height:3},{constructor:Q,height:16},{constructor:$,height:20},{constructor:J,height:8}],this.totalHeight=this.allOverviews.reduce(((e,t)=>e+t.height),0),this.enabled=!0,this.lastActiveModel=null}addRecording(e){this.lastActiveModel=e,this.recordings.unshift(e),this.buildPreview(e);const t=this.title(e);this.buttonInternal.setText(t);const i=this.action.title();if(s.ARIAUtils.setAccessibleName(this.buttonInternal.element,ut(ht.currentSessionSS,{PH1:t,PH2:i})),this.updateState(),this.recordings.length<=gt)return;const n=this.recordings.reduce(((e,t)=>r(e)<r(t)?e:t));function r(e){const t=pt.dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.lastUsed}this.recordings.splice(this.recordings.indexOf(n),1),n.dispose()}setEnabled(e){this.enabled=e,this.updateState()}button(){return this.buttonInternal}clear(){this.recordings.forEach((e=>e.dispose())),this.recordings=[],this.lastActiveModel=null,this.updateState(),this.buttonInternal.setText(ut(ht.noRecordings)),this.nextNumberByDomain.clear()}async showHistoryDropDown(){if(this.recordings.length<2||!this.enabled)return null;const e=await ft.show(this.recordings,this.lastActiveModel,this.buttonInternal.element);if(!e)return null;return this.recordings.indexOf(e)<0?(console.assert(!1,"selected recording not found"),null):(this.setCurrentModel(e),e)}cancelIfShowing(){ft.cancelIfShowing()}navigate(e){if(!this.enabled||!this.lastActiveModel)return null;const t=this.recordings.indexOf(this.lastActiveModel);if(t<0)return null;const i=n.NumberUtilities.clamp(t+e,0,this.recordings.length-1),r=this.recordings[i];return this.setCurrentModel(r),r}setCurrentModel(e){const t=pt.dataForModel(e);if(!t)throw new Error("Unable to find data for model");t.lastUsed=Date.now(),this.lastActiveModel=e;const i=this.title(e),n=this.action.title();this.buttonInternal.setText(i),s.ARIAUtils.setAccessibleName(this.buttonInternal.element,ut(ht.currentSessionSS,{PH1:i,PH2:n}))}updateState(){this.action.setEnabled(this.recordings.length>1&&this.enabled)}static previewElement(e){const t=pt.dataForModel(e);if(!t)throw new Error("Unable to find data for model");const i=e.recordStartTime();return t.time.textContent=i?ut(ht.sAgo,{PH1:pt.coarseAge(i)}):"",t.preview}static coarseAge(e){const t=Math.round((Date.now()-e)/1e3);if(t<50)return ut(ht.moments);const i=Math.round(t/60);if(i<50)return ut(ht.sM,{PH1:i});const n=Math.round(i/60);return ut(ht.sH,{PH1:n})}title(e){const t=pt.dataForModel(e);if(!t)throw new Error("Unable to find data for model");return t.title}buildPreview(e){const i=t.ParsedURL.ParsedURL.fromString(e.timelineModel().pageURL()),n=i?i.host:"",r=this.nextNumberByDomain.get(n)||1,a=ut(ht.sD,{PH1:n,PH2:r});this.nextNumberByDomain.set(n,r+1);const s=document.createElement("span"),o=document.createElement("div");o.classList.add("preview-item"),o.classList.add("vbox");const l={preview:o,title:a,time:s,lastUsed:Date.now()};Tt.set(e,l),o.appendChild(this.buildTextDetails(e,a,s));const d=o.createChild("div","hbox");return d.appendChild(this.buildScreenshotThumbnail(e)),d.appendChild(this.buildOverview(e)),l.preview}buildTextDetails(e,t,n){const r=document.createElement("div");r.classList.add("text-details"),r.classList.add("hbox");const a=r.createChild("span","name");a.textContent=t,s.ARIAUtils.setAccessibleName(a,t);const o=e.tracingModel(),l=i.TimeUtilities.millisToString(o.maximumRecordTime()-o.minimumRecordTime(),!1),d=r.createChild("span","time");return d.appendChild(document.createTextNode(l)),d.appendChild(n),r}buildScreenshotThumbnail(e){const t=document.createElement("div");t.classList.add("screenshot-thumb");t.style.width=1.5*this.totalHeight+"px",t.style.height=this.totalHeight+"px";const i=e.filmStripModel().frames(),n=i[i.length-1];return n?(n.imageDataPromise().then((e=>s.UIUtils.loadImageFromData(e))).then((e=>e&&t.appendChild(e))),t):t}buildOverview(e){const t=document.createElement("div");t.style.width=vt+"px",t.style.height=this.totalHeight+"px";const i=t.createChild("canvas");i.width=window.devicePixelRatio*vt,i.height=window.devicePixelRatio*this.totalHeight;const n=i.getContext("2d");let r=0;for(const t of this.allOverviews){const i=new t.constructor;i.setCanvasSize(vt,t.height),i.setModel(e),i.update();const a=i.context(),s=a.getImageData(0,0,a.canvas.width,a.canvas.height);n&&n.putImageData(s,0,r),r+=t.height*window.devicePixelRatio}return t}static dataForModel(e){return Tt.get(e)||null}}const gt=5,vt=450,Tt=new WeakMap;class ft{glassPane;listControl;focusRestorer;selectionDone;constructor(e){this.glassPane=new s.GlassPane.GlassPane,this.glassPane.setSizeBehavior("MeasureContent"),this.glassPane.setOutsideClickCallback((()=>this.close(null))),this.glassPane.setPointerEventsBehavior("BlockedByGlassPane"),this.glassPane.setAnchorBehavior("PreferBottom"),this.glassPane.element.addEventListener("blur",(()=>this.close(null)));const t=s.Utils.createShadowRootWithCoreStyles(this.glassPane.contentElement,{cssFile:[ct],delegatesFocus:void 0}).createChild("div","drop-down"),i=new s.ListModel.ListModel;this.listControl=new s.ListControl.ListControl(i,this,s.ListControl.ListMode.NonViewport),this.listControl.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),i.replaceAll(e),s.ARIAUtils.markAsMenu(this.listControl.element),s.ARIAUtils.setAccessibleName(this.listControl.element,ut(ht.selectTimelineSession)),t.appendChild(this.listControl.element),t.addEventListener("keydown",this.onKeyDown.bind(this),!1),t.addEventListener("click",this.onClick.bind(this),!1),this.focusRestorer=new s.UIUtils.ElementFocusRestorer(this.listControl.element),this.selectionDone=null}static show(e,t,i){if(ft.instance)return Promise.resolve(null);return new ft(e).show(i,t)}static cancelIfShowing(){ft.instance&&ft.instance.close(null)}show(e,t){return ft.instance=this,this.glassPane.setContentAnchorBox(e.boxInWindow()),this.glassPane.show(this.glassPane.contentElement.ownerDocument),this.listControl.element.focus(),this.listControl.selectItem(t),new Promise((e=>{this.selectionDone=e}))}onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this.listControl.itemForNode(t);i&&this.listControl.selectItem(i)}onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this.close(this.listControl.selectedItem())}onKeyDown(e){switch(e.key){case"Tab":case"Escape":this.close(null);break;case"Enter":this.close(this.listControl.selectedItem());break;default:return}e.consume(!0)}close(e){this.selectionDone&&this.selectionDone(e),this.focusRestorer.restore(),this.glassPane.hide(),ft.instance=null}createElementForItem(e){const t=pt.previewElement(e);return s.ARIAUtils.markAsMenuItem(t),t.classList.remove("selected"),t}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,n){i&&i.classList.remove("selected"),n&&n.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}static instance=null}class wt extends s.Toolbar.ToolbarItem{contentElement;constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),super(t),this.contentElement=this.element.createChild("span","content");const i=s.Icon.Icon.create("smallicon-triangle-down");this.element.appendChild(i),this.element.addEventListener("click",(()=>{e.execute()}),!1),this.setEnabled(e.enabled()),e.addEventListener("Enabled",(e=>this.setEnabled(e.data))),this.setTitle(e.title())}setText(e){this.contentElement.textContent=e}}var St=Object.freeze({__proto__:null,TimelineHistoryManager:pt,maxRecordings:gt,previewWidth:vt,DropDown:ft,ToolbarButton:wt});const bt={frameStart:"Frame Start",drawFrame:"Draw Frame",layout:"Layout",rasterizing:"Rasterizing",drawing:"Drawing",painting:"Painting",system:"System",idle:"Idle"},yt=i.i18n.registerUIStrings("panels/timeline/UIDevtoolsUtils.ts",bt),Ct=i.i18n.getLocalizedString.bind(void 0,yt);let kt=null,Mt=null;class Pt{static isUiDevTools(){return"true"===c.Runtime.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(kt)return kt;const e=xt,t=Pt.categories(),i=t.drawing,n=t.rasterizing,r=t.layout,a=t.painting,s=t.other,o={};return o[e.ViewPaint]=new ri("View::Paint",a),o[e.ViewOnPaint]=new ri("View::OnPaint",a),o[e.ViewPaintChildren]=new ri("View::PaintChildren",a),o[e.ViewOnPaintBackground]=new ri("View::OnPaintBackground",a),o[e.ViewOnPaintBorder]=new ri("View::OnPaintBorder",a),o[e.LayerPaintContentsToDisplayList]=new ri("Layer::PaintContentsToDisplayList",a),o[e.ViewLayout]=new ri("View::Layout",r),o[e.ViewLayoutBoundsChanged]=new ri("View::Layout(bounds_changed)",r),o[e.RasterTask]=new ri("RasterTask",n),o[e.RasterizerTaskImplRunOnWorkerThread]=new ri("RasterizerTaskImpl::RunOnWorkerThread",n),o[e.DirectRendererDrawFrame]=new ri("DirectRenderer::DrawFrame",i),o[e.BeginFrame]=new ri(Ct(bt.frameStart),i,!0),o[e.DrawFrame]=new ri(Ct(bt.drawFrame),i,!0),o[e.NeedsBeginFrameChanged]=new ri("NeedsBeginFrameChanged",i,!0),o[e.ThreadControllerImplRunTask]=new ri("ThreadControllerImpl::RunTask",s),kt=o,o}static categories(){return Mt||(Mt={layout:new ci("layout",Ct(bt.layout),!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),rasterizing:new ci("rasterizing",Ct(bt.rasterizing),!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),drawing:new ci("drawing",Ct(bt.drawing),!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new ci("painting",Ct(bt.painting),!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),other:new ci("other",Ct(bt.system),!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new ci("idle",Ct(bt.idle),!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")},Mt)}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}var xt;!function(e){e.ViewPaint="View::Paint",e.ViewOnPaint="View::OnPaint",e.ViewPaintChildren="View::PaintChildren",e.ViewOnPaintBackground="View::OnPaintBackground",e.ViewOnPaintBorder="View::OnPaintBorder",e.ViewLayout="View::Layout",e.ViewLayoutBoundsChanged="View::Layout(bounds_changed)",e.LayerPaintContentsToDisplayList="Layer::PaintContentsToDisplayList",e.DirectRendererDrawFrame="DirectRenderer::DrawFrame",e.RasterTask="RasterTask",e.RasterizerTaskImplRunOnWorkerThread="RasterizerTaskImpl::RunOnWorkerThread",e.BeginFrame="BeginFrame",e.DrawFrame="DrawFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.ThreadControllerImplRunTask="ThreadControllerImpl::RunTask"}(xt||(xt={}));var Rt=Object.freeze({__proto__:null,UIDevtoolsUtils:Pt,get RecordType(){return xt}});class It extends A{constructor(e,t){super(e,t),ni.setEventStylesMap(Pt.categorizeEvents()),ni.setCategories(Pt.categories()),ni.setTimelineMainEventCategories(Pt.getMainCategoriesList())}}var Et=Object.freeze({__proto__:null,UIDevtoolsController:It});const Lt={dropTimelineFileOrUrlHere:"Drop timeline file or URL here",disableJavascriptSamples:"Disable JavaScript samples",enableAdvancedPaint:"Enable advanced paint instrumentation (slow)",screenshots:"Screenshots",coverage:"Coverage",memory:"Memory",webVitals:"Web Vitals",clear:"Clear",loadProfile:"Load profile…",saveProfile:"Save profile…",captureScreenshots:"Capture screenshots",showMemoryTimeline:"Show memory timeline",showWebVitals:"Show Web Vitals",recordCoverageWithPerformance:"Record coverage with performance trace",captureSettings:"Capture settings",disablesJavascriptSampling:"Disables JavaScript sampling, reduces overhead when running against mobile devices",capturesAdvancedPaint:"Captures advanced paint instrumentation, introduces significant performance overhead",network:"Network:",cpu:"CPU:",networkConditions:"Network conditions",failedToSaveTimelineSSS:"Failed to save timeline: {PH1} ({PH2}, {PH3})",CpuThrottlingIsEnabled:"- CPU throttling is enabled",NetworkThrottlingIsEnabled:"- Network throttling is enabled",SignificantOverheadDueToPaint:"- Significant overhead due to paint instrumentation",JavascriptSamplingIsDisabled:"- JavaScript sampling is disabled",stoppingTimeline:"Stopping timeline…",received:"Received",close:"Close",recordingFailed:"Recording failed",profiling:"Profiling…",bufferUsage:"Buffer usage",learnmore:"Learn more",wasd:"WASD",clickTheRecordButtonSOrHitSTo:"Click the record button {PH1} or hit {PH2} to start a new recording.",clickTheReloadButtonSOrHitSTo:"Click the reload button {PH1} or hit {PH2} to record the page load.",afterRecordingSelectAnAreaOf:"After recording, select an area of interest in the overview by dragging. Then, zoom and pan the timeline with the mousewheel or {PH1} keys. {PH2}",loadingProfile:"Loading profile…",processingProfile:"Processing profile…",initializingProfiler:"Initializing profiler…",status:"Status",time:"Time",description:"Description",stop:"Stop",ssec:"{PH1} sec"},Ft=i.i18n.registerUIStrings("panels/timeline/TimelinePanel.ts",Lt),Dt=i.i18n.getLocalizedString.bind(void 0,Ft);let Ut;class Ht extends s.Panel.Panel{dropTarget;recordingOptionUIControls;state;recordingPageReload;millisecondsToRecordAfterLoadEvent;toggleRecordAction;recordReloadAction;historyManager;performanceModel;viewModeSetting;disableCaptureJSProfileSetting;captureLayersAndPicturesSetting;showScreenshotsSetting;startCoverage;showMemorySetting;showWebVitalsSetting;panelToolbar;panelRightToolbar;timelinePane;overviewPane;overviewControls;statusPaneContainer;flameChart;searchableViewInternal;showSettingsPaneButton;showSettingsPaneSetting;settingsPane;controller;clearButton;loadButton;saveButton;statusPane;landingPage;loader;showScreenshotsToolbarCheckbox;showMemoryToolbarCheckbox;showWebVitalsToolbarCheckbox;startCoverageCheckbox;networkThrottlingSelect;cpuThrottlingSelect;fileSelectorElement;selection;constructor(){super("timeline"),this.element.addEventListener("contextmenu",this.contextMenu.bind(this),!1),this.dropTarget=new s.DropTarget.DropTarget(this.element,[s.DropTarget.Type.File,s.DropTarget.Type.URI],Dt(Lt.dropTimelineFileOrUrlHere),this.handleDrop.bind(this)),this.recordingOptionUIControls=[],this.state=Wt.Idle,this.recordingPageReload=!1,this.millisecondsToRecordAfterLoadEvent=5e3,this.toggleRecordAction=s.ActionRegistry.ActionRegistry.instance().action("timeline.toggle-recording"),this.recordReloadAction=s.ActionRegistry.ActionRegistry.instance().action("timeline.record-reload"),this.historyManager=new pt,this.performanceModel=null,this.viewModeSetting=t.Settings.Settings.instance().createSetting("timelineViewMode",Nt.FlameChart),this.disableCaptureJSProfileSetting=t.Settings.Settings.instance().createSetting("timelineDisableJSSampling",!1),this.disableCaptureJSProfileSetting.setTitle(Dt(Lt.disableJavascriptSamples)),this.captureLayersAndPicturesSetting=t.Settings.Settings.instance().createSetting("timelineCaptureLayersAndPictures",!1),this.captureLayersAndPicturesSetting.setTitle(Dt(Lt.enableAdvancedPaint)),this.showScreenshotsSetting=t.Settings.Settings.instance().createSetting("timelineShowScreenshots",!0),this.showScreenshotsSetting.setTitle(Dt(Lt.screenshots)),this.showScreenshotsSetting.addChangeListener(this.updateOverviewControls,this),this.startCoverage=t.Settings.Settings.instance().createSetting("timelineStartCoverage",!1),this.startCoverage.setTitle(Dt(Lt.coverage)),c.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")||this.startCoverage.set(!1),this.showMemorySetting=t.Settings.Settings.instance().createSetting("timelineShowMemory",!1),this.showMemorySetting.setTitle(Dt(Lt.memory)),this.showMemorySetting.addChangeListener(this.onModeChanged,this),this.showWebVitalsSetting=t.Settings.Settings.instance().createSetting("timelineWebVitals",!1),this.showWebVitalsSetting.setTitle(Dt(Lt.webVitals)),this.showWebVitalsSetting.addChangeListener(this.onWebVitalsChanged,this);const i=this.element.createChild("div","timeline-toolbar-container");this.panelToolbar=new s.Toolbar.Toolbar("timeline-main-toolbar",i),this.panelToolbar.makeWrappable(!0),this.panelRightToolbar=new s.Toolbar.Toolbar("",i),this.createSettingsPane(),this.updateShowSettingsToolbarButton(),this.timelinePane=new s.Widget.VBox,this.timelinePane.show(this.element);const n=this.timelinePane.element.createChild("div","hbox");n.id="timeline-overview-panel",this.overviewPane=new a.TimelineOverviewPane.TimelineOverviewPane("timeline"),this.overviewPane.addEventListener(a.TimelineOverviewPane.Events.WindowChanged,this.onOverviewWindowChanged.bind(this)),this.overviewPane.show(n),this.overviewControls=[],this.statusPaneContainer=this.timelinePane.element.createChild("div","status-pane-container fill"),this.createFileSelector(),e.TargetManager.TargetManager.instance().addModelListener(e.ResourceTreeModel.ResourceTreeModel,e.ResourceTreeModel.Events.Load,this.loadEventFired,this),this.flameChart=new rt(this),this.searchableViewInternal=new s.SearchableView.SearchableView(this.flameChart,null),this.searchableViewInternal.setMinimumSize(0,100),this.searchableViewInternal.element.classList.add("searchable-view"),this.searchableViewInternal.show(this.timelinePane.element),this.flameChart.show(this.searchableViewInternal.element),this.flameChart.setSearchableView(this.searchableViewInternal),this.searchableViewInternal.hideWidget(),this.onModeChanged(),this.onWebVitalsChanged(),this.populateToolbar(),this.showLandingPage(),this.updateTimelineControls(),h.ExtensionServer.ExtensionServer.instance().addEventListener(h.ExtensionServer.Events.TraceProviderAdded,this.appendExtensionsToToolbar,this),e.TargetManager.TargetManager.instance().addEventListener(e.TargetManager.Events.SuspendStateChanged,this.onSuspendStateChanged,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return Ut&&!t||(Ut=new Ht),Ut}searchableView(){return this.searchableViewInternal}wasShown(){super.wasShown(),s.Context.Context.instance().setFlavor(Ht,this),this.registerCSSFiles([P]),d.userMetrics.panelLoaded("timeline","DevTools.Launch.Timeline")}willHide(){s.Context.Context.instance().setFlavor(Ht,null),this.historyManager.cancelIfShowing()}loadFromEvents(e){this.state===Wt.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromEvents(e,this))}onOverviewWindowChanged(e){if(!this.performanceModel)return;const t=e.data.startTime,i=e.data.endTime;this.performanceModel.setWindow({left:t,right:i},!0)}onModelWindowChanged(e){const t=e.data.window;this.overviewPane.setWindowTimes(t.left,t.right)}setState(e){this.state=e,this.updateTimelineControls()}createSettingCheckbox(e,t){const i=new s.Toolbar.ToolbarSettingCheckbox(e,t);return this.recordingOptionUIControls.push(i),i}populateToolbar(){this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButton(this.recordReloadAction)),this.clearButton=new s.Toolbar.ToolbarButton(Dt(Lt.clear),"largeicon-clear"),this.clearButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(()=>this.onClearButton())),this.panelToolbar.appendToolbarItem(this.clearButton),this.loadButton=new s.Toolbar.ToolbarButton(Dt(Lt.loadProfile),"largeicon-load"),this.loadButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(()=>{d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceImported),this.selectFileToLoad()})),this.saveButton=new s.Toolbar.ToolbarButton(Dt(Lt.saveProfile),"largeicon-download"),this.saveButton.addEventListener(s.Toolbar.ToolbarButton.Events.Click,(e=>{d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceExported),this.saveToFile()})),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.loadButton),this.panelToolbar.appendToolbarItem(this.saveButton),this.panelToolbar.appendSeparator(),this.panelToolbar.appendToolbarItem(this.historyManager.button()),this.panelToolbar.registerCSSFiles([M]),this.panelToolbar.appendSeparator(),this.panelToolbar.appendSeparator(),this.showScreenshotsToolbarCheckbox=this.createSettingCheckbox(this.showScreenshotsSetting,Dt(Lt.captureScreenshots)),this.panelToolbar.appendToolbarItem(this.showScreenshotsToolbarCheckbox),this.showMemoryToolbarCheckbox=this.createSettingCheckbox(this.showMemorySetting,Dt(Lt.showMemoryTimeline)),this.panelToolbar.appendToolbarItem(this.showMemoryToolbarCheckbox),this.showWebVitalsToolbarCheckbox=this.createSettingCheckbox(this.showWebVitalsSetting,Dt(Lt.showWebVitals)),this.panelToolbar.appendToolbarItem(this.showWebVitalsToolbarCheckbox),c.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")&&(this.startCoverageCheckbox=this.createSettingCheckbox(this.startCoverage,Dt(Lt.recordCoverageWithPerformance)),this.panelToolbar.appendToolbarItem(this.startCoverageCheckbox)),this.panelToolbar.appendToolbarItem(s.Toolbar.Toolbar.createActionButtonForId("components.collect-garbage")),this.panelRightToolbar.appendSeparator(),this.panelRightToolbar.appendToolbarItem(this.showSettingsPaneButton)}createSettingsPane(){this.showSettingsPaneSetting=t.Settings.Settings.instance().createSetting("timelineShowSettingsToolbar",!1),this.showSettingsPaneButton=new s.Toolbar.ToolbarSettingToggle(this.showSettingsPaneSetting,"largeicon-settings-gear",Dt(Lt.captureSettings)),e.NetworkManager.MultitargetNetworkManager.instance().addEventListener(e.NetworkManager.MultitargetNetworkManager.Events.ConditionsChanged,this.updateShowSettingsToolbarButton,this),e.CPUThrottlingManager.CPUThrottlingManager.instance().addEventListener(e.CPUThrottlingManager.Events.RateChanged,this.updateShowSettingsToolbarButton,this),this.disableCaptureJSProfileSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.captureLayersAndPicturesSetting.addChangeListener(this.updateShowSettingsToolbarButton,this),this.settingsPane=new s.Widget.HBox,this.settingsPane.element.classList.add("timeline-settings-pane"),this.settingsPane.show(this.element);const i=new s.Toolbar.Toolbar("",this.settingsPane.element);i.element.classList.add("flex-auto"),i.makeVertical(),i.appendToolbarItem(this.createSettingCheckbox(this.disableCaptureJSProfileSetting,Dt(Lt.disablesJavascriptSampling))),i.appendToolbarItem(this.createSettingCheckbox(this.captureLayersAndPicturesSetting,Dt(Lt.capturesAdvancedPaint)));const n=new s.Widget.VBox;n.element.classList.add("flex-auto"),n.show(this.settingsPane.element);const r=new s.Toolbar.Toolbar("",n.element);r.appendText(Dt(Lt.network)),this.networkThrottlingSelect=this.createNetworkConditionsSelect(),r.appendToolbarItem(this.networkThrottlingSelect);const a=new s.Toolbar.Toolbar("",n.element);a.appendText(Dt(Lt.cpu)),this.cpuThrottlingSelect=m.ThrottlingManager.throttlingManager().createCPUThrottlingSelector(),a.appendToolbarItem(this.cpuThrottlingSelect),this.showSettingsPaneSetting.addChangeListener(this.updateSettingsPaneVisibility.bind(this)),this.updateSettingsPaneVisibility()}appendExtensionsToToolbar(e){const t=e.data,i=Ht.settingForTraceProvider(t),n=this.createSettingCheckbox(i,t.longDisplayName());this.panelToolbar.appendToolbarItem(n)}static settingForTraceProvider(e){let i=_t.get(e);if(!i){const n=e.persistentIdentifier();i=t.Settings.Settings.instance().createSetting(n,!1),i.setTitle(e.shortDisplayName()),_t.set(e,i)}return i}createNetworkConditionsSelect(){const e=new s.Toolbar.ToolbarComboBox(null,Dt(Lt.networkConditions));return e.setMaxWidth(140),m.ThrottlingManager.throttlingManager().decorateSelectWithNetworkThrottling(e.selectElement()),e}prepareToLoadTimeline(){console.assert(this.state===Wt.Idle),this.setState(Wt.Loading),this.performanceModel&&(this.performanceModel.dispose(),this.performanceModel=null)}createFileSelector(){this.fileSelectorElement&&this.fileSelectorElement.remove(),this.fileSelectorElement=s.UIUtils.createFileSelectorElement(this.loadFromFile.bind(this)),this.timelinePane.element.appendChild(this.fileSelectorElement)}contextMenu(e){const t=new s.ContextMenu.ContextMenu(e);t.appendItemsAtLocation("timelineMenu"),t.show()}async saveToFile(){if(this.state!==Wt.Idle)return;const e=this.performanceModel;if(!e)return;const i=new Date,r="Profile-"+n.DateUtilities.toISO8601Compact(i)+".json",a=new o.FileUtils.FileOutputStream;if(!await a.open(r))return;const s=await e.save(a);s&&t.Console.Console.instance().error(Dt(Lt.failedToSaveTimelineSSS,{PH1:s.message,PH2:s.name,PH3:s.code}))}async showHistory(){const e=await this.historyManager.showHistoryDropDown();e&&e!==this.performanceModel&&this.setModel(e)}navigateHistory(e){const t=this.historyManager.navigate(e);return t&&t!==this.performanceModel&&this.setModel(t),!0}selectFileToLoad(){this.fileSelectorElement&&this.fileSelectorElement.click()}loadFromFile(e){this.state===Wt.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromFile(e,this),this.createFileSelector())}loadFromURL(e){this.state===Wt.Idle&&(this.prepareToLoadTimeline(),this.loader=L.loadFromURL(e,this))}updateOverviewControls(){this.overviewControls=[],this.overviewControls.push(new K),c.Runtime.experiments.isEnabled("inputEventsOnTimelineOverview")&&this.overviewControls.push(new q),this.overviewControls.push(new Q),this.overviewControls.push(new $),this.overviewControls.push(new J),this.showScreenshotsSetting.get()&&this.performanceModel&&this.performanceModel.filmStripModel().frames().length&&this.overviewControls.push(new Y),this.showMemorySetting.get()&&this.overviewControls.push(new Z),this.startCoverage.get()&&this.overviewControls.push(new te);for(const e of this.overviewControls)e.setModel(this.performanceModel);this.overviewPane.setOverviewControls(this.overviewControls)}onModeChanged(){this.updateOverviewControls(),this.doResize(),this.select(null)}onWebVitalsChanged(){this.flameChart.toggleWebVitalsLane()}updateSettingsPaneVisibility(){this.showSettingsPaneSetting.get()?this.settingsPane.showWidget():this.settingsPane.hideWidget()}updateShowSettingsToolbarButton(){const t=[];if(1!==e.CPUThrottlingManager.CPUThrottlingManager.instance().cpuThrottlingRate()&&t.push(Dt(Lt.CpuThrottlingIsEnabled)),e.NetworkManager.MultitargetNetworkManager.instance().isThrottling()&&t.push(Dt(Lt.NetworkThrottlingIsEnabled)),this.captureLayersAndPicturesSetting.get()&&t.push(Dt(Lt.SignificantOverheadDueToPaint)),this.disableCaptureJSProfileSetting.get()&&t.push(Dt(Lt.JavascriptSamplingIsDisabled)),this.showSettingsPaneButton.setDefaultWithRedColor(t.length>0),this.showSettingsPaneButton.setToggleWithRedColor(t.length>0),t.length){const e=document.createElement("div");t.forEach((t=>{e.createChild("div").textContent=t})),this.showSettingsPaneButton.setTitle(e.textContent||"")}else this.showSettingsPaneButton.setTitle(Dt(Lt.captureSettings))}setUIControlsEnabled(e){this.recordingOptionUIControls.forEach((t=>t.setEnabled(e)))}async getCoverageViewWidget(){const e=s.ViewManager.ViewManager.instance().view("coverage");return await e.widget()}async startRecording(){console.assert(!this.statusPane,"Status pane is already opened."),this.setState(Wt.StartPending);const t={enableJSSampling:!this.disableCaptureJSProfileSetting.get(),capturePictures:this.captureLayersAndPicturesSetting.get(),captureFilmStrip:this.showScreenshotsSetting.get(),startCoverage:this.startCoverage.get()};t.startCoverage&&await s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.ensureRecordingStarted())),this.showRecordingStarted();const i=h.ExtensionServer.ExtensionServer.instance().traceProviders().filter((e=>Ht.settingForTraceProvider(e).get())),n=e.TargetManager.TargetManager.instance().mainTarget();Pt.isUiDevTools()?this.controller=new It(n,this):this.controller=new A(n,this),this.setUIControlsEnabled(!1),this.hideLandingPage();try{const e=await this.controller.startRecording(t,i);if(e.getError())throw new Error(e.getError());this.recordingStarted()}catch(e){this.recordingFailed(e.message)}}async stopRecording(){if(this.statusPane&&(this.statusPane.finish(),this.statusPane.updateStatus(Dt(Lt.stoppingTimeline)),this.statusPane.updateProgressBar(Dt(Lt.received),0)),this.setState(Wt.StopPending),this.startCoverage.get()&&await s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.stopRecording())),this.controller){const e=await this.controller.stopRecording();this.performanceModel=e,this.setUIControlsEnabled(!0),this.controller.dispose(),this.controller=null}}recordingFailed(e){this.statusPane&&this.statusPane.hide(),this.statusPane=new Bt({description:e,buttonText:Dt(Lt.close),buttonDisabled:!1,showProgress:void 0,showTimer:void 0},(()=>this.loadingComplete(null))),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Dt(Lt.recordingFailed)),this.setState(Wt.RecordingFailed),this.performanceModel=null,this.setUIControlsEnabled(!0),this.controller&&(this.controller.dispose(),this.controller=null)}onSuspendStateChanged(){this.updateTimelineControls()}updateTimelineControls(){const e=Wt;this.toggleRecordAction.setToggled(this.state===e.Recording),this.toggleRecordAction.setEnabled(this.state===e.Recording||this.state===e.Idle),this.recordReloadAction.setEnabled(this.state===e.Idle),this.historyManager.setEnabled(this.state===e.Idle),this.clearButton.setEnabled(this.state===e.Idle),this.panelToolbar.setEnabled(this.state!==e.Loading),this.panelRightToolbar.setEnabled(this.state!==e.Loading),this.dropTarget.setEnabled(this.state===e.Idle),this.loadButton.setEnabled(this.state===e.Idle),this.saveButton.setEnabled(this.state===e.Idle&&Boolean(this.performanceModel))}toggleRecording(){this.state===Wt.Idle?(this.recordingPageReload=!1,this.startRecording(),d.userMetrics.actionTaken(d.UserMetrics.Action.TimelineStarted)):this.state===Wt.Recording&&this.stopRecording()}recordReload(){this.state===Wt.Idle&&(this.recordingPageReload=!0,this.startRecording(),d.userMetrics.actionTaken(d.UserMetrics.Action.TimelinePageReloadStarted))}onClearButton(){this.historyManager.clear(),this.clear()}clear(){this.showLandingPage(),this.reset()}reset(){a.LineLevelProfile.Performance.instance().reset(),this.setModel(null)}applyFilters(e){e.timelineModel().isGenericTrace()||c.Runtime.experiments.isEnabled("timelineShowAllEvents")||e.setFilters([ni.visibleEventsFilter()])}setModel(e){if(this.performanceModel&&this.performanceModel.removeEventListener(pi.WindowChanged,this.onModelWindowChanged,this),this.performanceModel=e,e?(this.searchableViewInternal.showWidget(),this.applyFilters(e)):this.searchableViewInternal.hideWidget(),this.flameChart.setModel(e),this.updateOverviewControls(),this.overviewPane.reset(),e&&this.performanceModel){this.performanceModel.addEventListener(pi.WindowChanged,this.onModelWindowChanged,this),this.overviewPane.setNavStartTimes(e.timelineModel().navStartTimes()),this.overviewPane.setBounds(e.timelineModel().minimumRecordTime(),e.timelineModel().maximumRecordTime()),a.LineLevelProfile.Performance.instance().reset();for(const t of e.timelineModel().cpuProfiles())a.LineLevelProfile.Performance.instance().appendCPUProfile(t);this.setMarkers(e.timelineModel()),this.flameChart.setSelection(null),this.overviewPane.setWindowTimes(e.window().left,e.window().right)}for(const t of this.overviewControls)t.setModel(e);this.flameChart&&this.flameChart.resizeToPreferredHeights(),this.updateTimelineControls()}recordingStarted(){if(this.recordingPageReload&&this.controller){const t=this.controller.mainTarget().model(e.ResourceTreeModel.ResourceTreeModel);t&&t.reloadPage()}this.reset(),this.setState(Wt.Recording),this.showRecordingStarted(),this.statusPane&&(this.statusPane.enableAndFocusButton(),this.statusPane.updateStatus(Dt(Lt.profiling)),this.statusPane.updateProgressBar(Dt(Lt.bufferUsage),0),this.statusPane.startTimer()),this.hideLandingPage()}recordingProgress(e){this.statusPane&&this.statusPane.updateProgressBar(Dt(Lt.bufferUsage),100*e)}showLandingPage(){if(this.landingPage)return void this.landingPage.show(this.statusPaneContainer);function e(e,t){const i=document.createElement(e);return i.textContent=t,i}const t=s.XLink.XLink.create("https://developer.chrome.com/docs/devtools/evaluate-performance/",Dt(Lt.learnmore)),n=e("b",s.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),r=e("b",s.ShortcutRegistry.ShortcutRegistry.instance().shortcutsForAction("timeline.record-reload")[0].title()),a=e("b",Dt(Lt.wasd));this.landingPage=new s.Widget.VBox,this.landingPage.contentElement.classList.add("timeline-landing-page","fill");const o=this.landingPage.contentElement.createChild("div"),l=s.UIUtils.createInlineButton(s.Toolbar.Toolbar.createActionButton(this.toggleRecordAction)),d=s.UIUtils.createInlineButton(s.Toolbar.Toolbar.createActionButtonForId("timeline.record-reload"));o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Ft,Lt.clickTheRecordButtonSOrHitSTo,{PH1:l,PH2:n})),o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Ft,Lt.clickTheReloadButtonSOrHitSTo,{PH1:d,PH2:r})),o.createChild("p").appendChild(i.i18n.getFormatLocalizedString(Ft,Lt.afterRecordingSelectAnAreaOf,{PH1:a,PH2:t})),this.landingPage.show(this.statusPaneContainer)}hideLandingPage(){this.landingPage.detach()}loadingStarted(){this.hideLandingPage(),this.statusPane&&this.statusPane.hide(),this.statusPane=new Bt({showProgress:!0,showTimer:void 0,buttonDisabled:void 0,buttonText:void 0,description:void 0},(()=>this.cancelLoading())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Dt(Lt.loadingProfile)),this.loader||this.statusPane.finish(),this.loadingProgress(0)}loadingProgress(e){"number"==typeof e&&this.statusPane&&this.statusPane.updateProgressBar(Dt(Lt.received),100*e)}processingStarted(){this.statusPane&&this.statusPane.updateStatus(Dt(Lt.processingProfile))}loadingComplete(e){delete this.loader,this.setState(Wt.Idle),this.statusPane&&this.statusPane.hide(),this.statusPane=null,e?(this.performanceModel||(this.performanceModel=new vi),this.performanceModel.setTracingModel(e),this.setModel(this.performanceModel),this.historyManager.addRecording(this.performanceModel),this.startCoverage.get()&&s.ViewManager.ViewManager.instance().showView("coverage").then((()=>this.getCoverageViewWidget())).then((e=>e.processBacklog())).then((()=>this.updateOverviewControls()))):this.clear()}showRecordingStarted(){this.statusPane||(this.statusPane=new Bt({showTimer:!0,showProgress:!0,buttonDisabled:!0,description:void 0,buttonText:void 0},(()=>this.stopRecording())),this.statusPane.showPane(this.statusPaneContainer),this.statusPane.updateStatus(Dt(Lt.initializingProfiler)))}cancelLoading(){this.loader&&this.loader.cancel()}setMarkers(e){const t=new Map,i=r.TimelineModel.RecordType,n=e.minimumRecordTime();for(const r of e.timeMarkerEvents())r.name!==i.TimeStamp&&r.name!==i.ConsoleTime&&t.set(r.startTime,ni.createEventDivider(r,n));for(const i of e.navStartTimes().values())t.set(i.startTime,ni.createEventDivider(i,n));this.overviewPane.setMarkers(t)}async loadEventFired(e){if(this.state!==Wt.Recording||!this.recordingPageReload||!this.controller||this.controller.mainTarget()!==e.data.resourceTreeModel.target())return;const t=this.controller;await new Promise((e=>setTimeout(e,this.millisecondsToRecordAfterLoadEvent))),t===this.controller&&this.state===Wt.Recording&&this.stopRecording()}frameForSelection(e){switch(e.type()){case Vt.Type.Frame:return e.object();case Vt.Type.Range:return null;case Vt.Type.TraceEvent:return this.performanceModel?this.performanceModel.frameModel().getFramesWithinWindow(e.endTimeInternal,e.endTimeInternal)[0]:null;default:return console.assert(!1,"Should never be reached"),null}}jumpToFrame(e){const t=this.selection&&this.frameForSelection(this.selection);if(!t||!this.performanceModel)return;const i=this.performanceModel.frames();let r=i.indexOf(t);console.assert(r>=0,"Can't find current frame in the frame list"),r=n.NumberUtilities.clamp(r+e,0,i.length-1);const a=i[r];return this.revealTimeRange(a.startTime,a.endTime),this.select(Vt.fromFrame(a)),!0}select(e){this.selection=e,this.flameChart.setSelection(e)}selectEntryAtTime(t,i){if(t){for(let r=n.ArrayUtilities.upperBound(t,i,((e,t)=>e-t.startTime))-1;r>=0;--r){const n=t[r],a=n.endTime||n.startTime;if(e.TracingModel.TracingModel.isTopLevelEvent(n)&&a<i)break;if(this.performanceModel&&this.performanceModel.isVisible(n)&&a>=i)return void this.select(Vt.fromTraceEvent(n))}this.select(null)}}highlightEvent(e){this.flameChart.highlightEvent(e)}revealTimeRange(e,t){if(!this.performanceModel)return;const i=this.performanceModel.window();let n=0;i.right<t?n=t-i.right:i.left>e&&(n=e-i.left),this.performanceModel.setWindow({left:i.left+n,right:i.right+n},!0)}handleDrop(e){const i=e.items;if(!i.length)return;const n=i[0];if(d.userMetrics.actionTaken(d.UserMetrics.Action.PerfPanelTraceImported),"string"===n.kind){const i=e.getData("text/uri-list");new t.ParsedURL.ParsedURL(i).isValid&&this.loadFromURL(i)}else if("file"===n.kind){const e=i[0].getAsFile();if(!e)return;this.loadFromFile(e)}}}var Wt,Nt;!function(e){e.Idle="Idle",e.StartPending="StartPending",e.Recording="Recording",e.StopPending="StopPending",e.Loading="Loading",e.RecordingFailed="RecordingFailed"}(Wt||(Wt={})),function(e){e.FlameChart="FlameChart",e.BottomUp="BottomUp",e.CallTree="CallTree",e.EventLog="EventLog"}(Nt||(Nt={}));class Vt{typeInternal;startTimeInternal;endTimeInternal;objectInternal;constructor(e,t,i,n){this.typeInternal=e,this.startTimeInternal=t,this.endTimeInternal=i,this.objectInternal=n||null}static fromFrame(e){return new Vt(Vt.Type.Frame,e.startTime,e.endTime,e)}static fromNetworkRequest(e){return new Vt(Vt.Type.NetworkRequest,e.startTime,e.endTime||e.startTime,e)}static fromTraceEvent(e){return new Vt(Vt.Type.TraceEvent,e.startTime,e.endTime||e.startTime+1,e)}static fromRange(e,t){return new Vt(Vt.Type.Range,e,t)}type(){return this.typeInternal}object(){return this.objectInternal}startTime(){return this.startTimeInternal}endTime(){return this.endTimeInternal}}!function(e){let t;!function(e){e.Frame="Frame",e.NetworkRequest="NetworkRequest",e.TraceEvent="TraceEvent",e.Range="Range"}(t=e.Type||(e.Type={}))}(Vt||(Vt={}));class Bt extends s.Widget.VBox{status;time;progressLabel;progressBar;description;button;startTime;timeUpdateTimer;constructor(e,t){super(!0),this.contentElement.classList.add("timeline-status-dialog");const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=Dt(Lt.status),this.status=i.createChild("div","content"),s.ARIAUtils.markAsStatus(this.status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=Dt(Lt.time),this.time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this.progressLabel=e.createChild("div","label"),this.progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),s.ARIAUtils.markAsProgressBar(this.progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=Dt(Lt.description),this.description=t.createChild("div","content"),this.description.innerText=e.description}const n=e.buttonText||Dt(Lt.stop);this.button=s.UIUtils.createTextButton(n,t,"",!0),this.button.disabled=!1==!e.buttonDisabled,this.contentElement.createChild("div","stop-button").appendChild(this.button)}finish(){this.stopTimer(),this.button.disabled=!0}hide(){this.element.parentNode.classList.remove("tinted"),this.arrangeDialog(this.element.parentNode),this.element.remove()}showPane(e){this.arrangeDialog(e),this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this.button.disabled=!1,this.button.focus()}updateStatus(e){this.status.textContent=e}updateProgressBar(e,t){this.progressLabel.textContent=e,this.progressBar.style.width=t.toFixed(1)+"%",s.ARIAUtils.setValueNow(this.progressBar,t),this.updateTimer()}startTimer(){this.startTime=Date.now(),this.timeUpdateTimer=window.setInterval(this.updateTimer.bind(this,!1),1e3),this.updateTimer()}stopTimer(){this.timeUpdateTimer&&(clearInterval(this.timeUpdateTimer),this.updateTimer(!0),delete this.timeUpdateTimer)}updateTimer(e){if(this.arrangeDialog(this.element.parentNode),!this.timeUpdateTimer)return;const t=(Date.now()-this.startTime)/1e3;this.time.textContent=Dt(Lt.ssec,{PH1:t.toFixed(e?1:0)})}arrangeDialog(e){const t=e.clientWidth<325;this.element.classList.toggle("small-dialog",t),this.contentElement.classList.toggle("small-dialog",t)}wasShown(){super.wasShown(),this.registerCSSFiles([x])}}let At,zt;class Ot{static instance(e={forceNew:null}){const{forceNew:t}=e;return At&&!t||(At=new Ot),At}handleQueryParam(e){s.ViewManager.ViewManager.instance().showView("timeline").then((()=>{Ht.instance().loadFromURL(window.decodeURIComponent(e))}))}}class Gt{static instance(e={forceNew:null}){const{forceNew:t}=e;return zt&&!t||(zt=new Gt),zt}handleAction(e,t){const i=s.Context.Context.instance().flavor(Ht);switch(console.assert(i&&i instanceof Ht),t){case"timeline.toggle-recording":return i.toggleRecording(),!0;case"timeline.record-reload":return i.recordReload(),!0;case"timeline.save-to-file":return i.saveToFile(),!0;case"timeline.load-from-file":return i.selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i.jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i.jumpToFrame(1),!0;case"timeline.show-history":return i.showHistory(),!0;case"timeline.previous-recording":return i.navigateHistory(1),!0;case"timeline.next-recording":return i.navigateHistory(-1),!0}return!1}}const _t=new WeakMap;var jt=Object.freeze({__proto__:null,TimelinePanel:Ht,get State(){return Wt},get ViewMode(){return Nt},rowHeight:18,headerHeight:20,get TimelineSelection(){return Vt},StatusPane:Bt,LoadTimelineHandler:Ot,ActionDelegate:Gt});const qt={sAndS:"{PH1} and {PH2}",sAndSOther:"{PH1}, {PH2}, and 1 other",task:"Task",other:"Other",animation:"Animation",event:"Event",requestMainThreadFrame:"Request Main Thread Frame",frameStart:"Frame Start",frameStartMainThread:"Frame Start (main thread)",drawFrame:"Draw Frame",hitTest:"Hit Test",scheduleStyleRecalculation:"Schedule Style Recalculation",recalculateStyle:"Recalculate Style",invalidateLayout:"Invalidate Layout",layout:"Layout",paintSetup:"Paint Setup",paintImage:"Paint Image",updateLayer:"Update Layer",updateLayerTree:"Update Layer Tree",paint:"Paint",rasterizePaint:"Rasterize Paint",scroll:"Scroll",compositeLayers:"Composite Layers",computeIntersections:"Compute Intersections",parseHtml:"Parse HTML",parseStylesheet:"Parse Stylesheet",installTimer:"Install Timer",removeTimer:"Remove Timer",timerFired:"Timer Fired",xhrReadyStateChange:"`XHR` Ready State Change",xhrLoad:"`XHR` Load",compileScript:"Compile Script",cacheScript:"Cache Script Code",compileCode:"Compile Code",optimizeCode:"Optimize Code",evaluateScript:"Evaluate Script",compileModule:"Compile Module",cacheModule:"Cache Module Code",evaluateModule:"Evaluate Module",streamingCompileTask:"Streaming Compile Task",waitingForNetwork:"Waiting for Network",parseAndCompile:"Parse and Compile",streamingWasmResponse:"Streaming Wasm Response",compiledWasmModule:"Compiled Wasm Module",cachedWasmModule:"Cached Wasm Module",wasmModuleCacheHit:"Wasm Module Cache Hit",wasmModuleCacheInvalid:"Wasm Module Cache Invalid",frameStartedLoading:"Frame Started Loading",onloadEvent:"Onload Event",domcontentloadedEvent:"DOMContentLoaded Event",firstPaint:"First Paint",firstContentfulPaint:"First Contentful Paint",largestContentfulPaint:"Largest Contentful Paint",timestamp:"Timestamp",consoleTime:"Console Time",userTiming:"User Timing",willSendRequest:"Will Send Request",sendRequest:"Send Request",receiveResponse:"Receive Response",finishLoading:"Finish Loading",receiveData:"Receive Data",runMicrotasks:"Run Microtasks",functionCall:"Function Call",gcEvent:"GC Event",majorGc:"Major GC",minorGc:"Minor GC",jsFrame:"JS Frame",requestAnimationFrame:"Request Animation Frame",cancelAnimationFrame:"Cancel Animation Frame",animationFrameFired:"Animation Frame Fired",requestIdleCallback:"Request Idle Callback",cancelIdleCallback:"Cancel Idle Callback",fireIdleCallback:"Fire Idle Callback",createWebsocket:"Create WebSocket",sendWebsocketHandshake:"Send WebSocket Handshake",receiveWebsocketHandshake:"Receive WebSocket Handshake",destroyWebsocket:"Destroy WebSocket",embedderCallback:"Embedder Callback",imageDecode:"Image Decode",imageResize:"Image Resize",gpu:"GPU",inputLatency:"Input Latency",domGc:"DOM GC",encrypt:"Encrypt",encryptReply:"Encrypt Reply",decrypt:"Decrypt",decryptReply:"Decrypt Reply",digest:"Digest",digestReply:"Digest Reply",sign:"Sign",signReply:"Sign Reply",verify:"Verify",verifyReply:"Verify Reply",asyncTask:"Async Task",layoutShift:"Layout Shift",keyCharacter:"Key — Character",keyDown:"Key Down",keyUp:"Key Up",click:"Click",contextMenu:"Context Menu",mouseDown:"Mouse Down",mouseMove:"Mouse Move",mouseUp:"Mouse Up",mouseWheel:"Mouse Wheel",scrollBegin:"Scroll Begin",scrollEnd:"Scroll End",scrollUpdate:"Scroll Update",flingStart:"Fling Start",flingHalt:"Fling Halt",tap:"Tap",tapHalt:"Tap Halt",tapBegin:"Tap Begin",tapDown:"Tap Down",touchCancel:"Touch Cancel",touchEnd:"Touch End",touchMove:"Touch Move",touchStart:"Touch Start",pinchBegin:"Pinch Begin",pinchEnd:"Pinch End",pinchUpdate:"Pinch Update",compile:"Compile",parse:"Parse",sS:"{PH1}: {PH2}",response:"Response",fling:"Fling",drag:"Drag",uncategorized:"Uncategorized",sCollected:"{PH1} collected",sSs:"{PH1} [{PH2}…{PH3}]",sSSquareBrackets:"{PH1} [{PH2}…]",learnMore:"Learn more",compilationCacheStatus:"Compilation cache status",compilationCacheSize:"Compilation cache size",scriptLoadedFromCache:"script loaded from cache",failedToLoadScriptFromCache:"failed to load script from cache",scriptNotEligible:"script not eligible",totalTime:"Total Time",selfTime:"Self Time",collected:"Collected",function:"Function",timerId:"Timer ID",timeout:"Timeout",repeats:"Repeats",callbackId:"Callback ID",resource:"Resource",requestMethod:"Request Method",statusCode:"Status Code",mimeTypeCaps:"MIME Type",priority:"Priority",encodedData:"Encoded Data",sBytes:"{n, plural, =1 {# Byte} other {# Bytes}}",decodedBody:"Decoded Body",module:"Module",script:"Script",streamed:"Streamed",eagerCompile:"Compiling all functions eagerly",url:"Url",producedCacheSize:"Produced Cache Size",consumedCacheSize:"Consumed Cache Size",location:"Location",sSCurlyBrackets:"({PH1}, {PH2})",dimensions:"Dimensions",sSDimensions:"{PH1} × {PH2}",layerRoot:"Layer Root",ownerElement:"Owner Element",imageUrl:"Image URL",stylesheetUrl:"Stylesheet URL",elementsAffected:"Elements Affected",nodesThatNeedLayout:"Nodes That Need Layout",sOfS:"{PH1} of {PH2}",layoutRoot:"Layout root",message:"Message",websocketProtocol:"WebSocket Protocol",callbackFunction:"Callback Function",state:"State",range:"Range",allottedTime:"Allotted Time",invokedByTimeout:"Invoked by Timeout",type:"Type",size:"Size",details:"Details",cumulativeLayoutShifts:"Cumulative Layout Shifts",evolvedClsLink:"evolved",sCLSInformation:"{PH1} can result in poor user experiences. It has recently {PH2}.",warning:"Warning",score:"Score",cumulativeScore:"Cumulative Score",currentClusterScore:"Current Cluster Score",currentClusterId:"Current Cluster ID",hadRecentInput:"Had recent input",yes:"Yes",no:"No",movedFrom:"Moved from",movedTo:"Moved to",timeWaitingForMainThread:"Time Waiting for Main Thread",relatedNode:"Related Node",preview:"Preview",aggregatedTime:"Aggregated Time",networkRequest:"Network request",loadFromCache:"load from cache",networkTransfer:"network transfer",SSSResourceLoading:" ({PH1} {PH2} + {PH3} resource loading)",duration:"Duration",mimeType:"Mime Type",FromMemoryCache:" (from memory cache)",FromCache:" (from cache)",FromPush:" (from push)",FromServiceWorker:" (from `service worker`)",initiator:"Initiator",timerInstalled:"Timer Installed",animationFrameRequested:"Animation Frame Requested",idleCallbackRequested:"Idle Callback Requested",recalculationForced:"Recalculation Forced",firstLayoutInvalidation:"First Layout Invalidation",layoutForced:"Layout Forced",callStacks:"Call Stacks",stackTrace:"Stack Trace",invalidations:"Invalidations",pendingFor:"Pending for",reveal:"Reveal",firstInvalidated:"First Invalidated",styleInvalidations:"Style Invalidations",layoutInvalidations:"Layout Invalidations",otherInvalidations:"Other Invalidations",paintProfiler:"Paint Profiler",sAtS:"{PH1} at {PH2}",loading:"Loading",experience:"Experience",scripting:"Scripting",rendering:"Rendering",painting:"Painting",async:"Async",system:"System",idle:"Idle",sSelf:"{PH1} (self)",sChildren:"{PH1} (children)",timeSpentInRendering:"Time spent in rendering",frame:"Frame",fps:"FPS",cpuTime:"CPU time",layerTree:"Layer tree",show:"Show",sAtSParentheses:"{PH1} (at {PH2})",emptyPlaceholder:"{PH1}",jank:"jank",sLongFrameTimesAreAnIndicationOf:"{PH1}. Long frame times are an indication of {PH2}",forcedReflow:"Forced reflow",sIsALikelyPerformanceBottleneck:"{PH1} is a likely performance bottleneck.",idleCallbackExecutionExtended:"Idle callback execution extended beyond deadline by {PH1}",handlerTookS:"Handler took {PH1}",recurringHandlerTookS:"Recurring handler took {PH1}",longTask:"Long task",sTookS:"{PH1} took {PH2}.",notOptimized:"Not optimized",emptyPlaceholderColon:": {PH1}",unknownCause:"Unknown cause",sForS:"{PH1} for {PH2}",sSDot:"{PH1}. {PH2}",unknown:"unknown",stackTraceColon:"Stack trace:",nodes:"Nodes:",node:"Node:",changedIdToSs:'(changed id to "{PH1}"{PH2})',changedClassToSs:'(changed class to "{PH1}"{PH2})',changedAttributeToSs:'(changed attribute to "{PH1}"{PH2})',changedPesudoToSs:'(changed pseudo to "{PH1}"{PH2})',changedSs:'(changed "{PH1}"{PH2})',sSAndSOthers:"{PH1}, {PH2}, and {PH3} others",UnknownNode:"[ unknown node ]"},Jt=i.i18n.registerUIStrings("panels/timeline/TimelineUIUtils.ts",qt),Xt=i.i18n.getLocalizedString.bind(void 0,Jt);let $t,Kt,Yt,Qt,Zt,ei,ti;const ii=new WeakMap;class ni{static initEventStyles(){if($t)return $t;const e=r.TimelineModel.RecordType,t=ni.categories(),i=t.rendering,n=t.scripting,a=t.loading,s=t.experience,o=t.painting,l=t.other,d=t.idle,c={};return c[e.Task]=new ri(Xt(qt.task),l),c[e.Program]=new ri(Xt(qt.other),l),c[e.Animation]=new ri(Xt(qt.animation),i),c[e.EventDispatch]=new ri(Xt(qt.event),n),c[e.RequestMainThreadFrame]=new ri(Xt(qt.requestMainThreadFrame),i,!0),c[e.BeginFrame]=new ri(Xt(qt.frameStart),i,!0),c[e.BeginMainThreadFrame]=new ri(Xt(qt.frameStartMainThread),i,!0),c[e.DrawFrame]=new ri(Xt(qt.drawFrame),i,!0),c[e.HitTest]=new ri(Xt(qt.hitTest),i),c[e.ScheduleStyleRecalculation]=new ri(Xt(qt.scheduleStyleRecalculation),i),c[e.RecalculateStyles]=new ri(Xt(qt.recalculateStyle),i),c[e.UpdateLayoutTree]=new ri(Xt(qt.recalculateStyle),i),c[e.InvalidateLayout]=new ri(Xt(qt.invalidateLayout),i,!0),c[e.Layout]=new ri(Xt(qt.layout),i),c[e.PaintSetup]=new ri(Xt(qt.paintSetup),o),c[e.PaintImage]=new ri(Xt(qt.paintImage),o,!0),c[e.UpdateLayer]=new ri(Xt(qt.updateLayer),o,!0),c[e.UpdateLayerTree]=new ri(Xt(qt.updateLayerTree),i),c[e.Paint]=new ri(Xt(qt.paint),o),c[e.RasterTask]=new ri(Xt(qt.rasterizePaint),o),c[e.ScrollLayer]=new ri(Xt(qt.scroll),i),c[e.CompositeLayers]=new ri(Xt(qt.compositeLayers),o),c[e.ComputeIntersections]=new ri(Xt(qt.computeIntersections),i),c[e.ParseHTML]=new ri(Xt(qt.parseHtml),a),c[e.ParseAuthorStyleSheet]=new ri(Xt(qt.parseStylesheet),a),c[e.TimerInstall]=new ri(Xt(qt.installTimer),n),c[e.TimerRemove]=new ri(Xt(qt.removeTimer),n),c[e.TimerFire]=new ri(Xt(qt.timerFired),n),c[e.XHRReadyStateChange]=new ri(Xt(qt.xhrReadyStateChange),n),c[e.XHRLoad]=new ri(Xt(qt.xhrLoad),n),c[e.CompileScript]=new ri(Xt(qt.compileScript),n),c[e.CacheScript]=new ri(Xt(qt.cacheScript),n),c[e.CompileCode]=new ri(Xt(qt.compileCode),n),c[e.OptimizeCode]=new ri(Xt(qt.optimizeCode),n),c[e.EvaluateScript]=new ri(Xt(qt.evaluateScript),n),c[e.CompileModule]=new ri(Xt(qt.compileModule),n),c[e.CacheModule]=new ri(Xt(qt.cacheModule),n),c[e.EvaluateModule]=new ri(Xt(qt.evaluateModule),n),c[e.StreamingCompileScript]=new ri(Xt(qt.streamingCompileTask),l),c[e.StreamingCompileScriptWaiting]=new ri(Xt(qt.waitingForNetwork),d),c[e.StreamingCompileScriptParsing]=new ri(Xt(qt.parseAndCompile),n),c[e.WasmStreamFromResponseCallback]=new ri(Xt(qt.streamingWasmResponse),n),c[e.WasmCompiledModule]=new ri(Xt(qt.compiledWasmModule),n),c[e.WasmCachedModule]=new ri(Xt(qt.cachedWasmModule),n),c[e.WasmModuleCacheHit]=new ri(Xt(qt.wasmModuleCacheHit),n),c[e.WasmModuleCacheInvalid]=new ri(Xt(qt.wasmModuleCacheInvalid),n),c[e.FrameStartedLoading]=new ri(Xt(qt.frameStartedLoading),a,!0),c[e.MarkLoad]=new ri(Xt(qt.onloadEvent),n,!0),c[e.MarkDOMContent]=new ri(Xt(qt.domcontentloadedEvent),n,!0),c[e.MarkFirstPaint]=new ri(Xt(qt.firstPaint),o,!0),c[e.MarkFCP]=new ri(Xt(qt.firstContentfulPaint),i,!0),c[e.MarkLCPCandidate]=new ri(Xt(qt.largestContentfulPaint),i,!0),c[e.TimeStamp]=new ri(Xt(qt.timestamp),n),c[e.ConsoleTime]=new ri(Xt(qt.consoleTime),n),c[e.UserTiming]=new ri(Xt(qt.userTiming),n),c[e.ResourceWillSendRequest]=new ri(Xt(qt.willSendRequest),a),c[e.ResourceSendRequest]=new ri(Xt(qt.sendRequest),a),c[e.ResourceReceiveResponse]=new ri(Xt(qt.receiveResponse),a),c[e.ResourceFinish]=new ri(Xt(qt.finishLoading),a),c[e.ResourceReceivedData]=new ri(Xt(qt.receiveData),a),c[e.RunMicrotasks]=new ri(Xt(qt.runMicrotasks),n),c[e.FunctionCall]=new ri(Xt(qt.functionCall),n),c[e.GCEvent]=new ri(Xt(qt.gcEvent),n),c[e.MajorGC]=new ri(Xt(qt.majorGc),n),c[e.MinorGC]=new ri(Xt(qt.minorGc),n),c[e.JSFrame]=new ri(Xt(qt.jsFrame),n),c[e.RequestAnimationFrame]=new ri(Xt(qt.requestAnimationFrame),n),c[e.CancelAnimationFrame]=new ri(Xt(qt.cancelAnimationFrame),n),c[e.FireAnimationFrame]=new ri(Xt(qt.animationFrameFired),n),c[e.RequestIdleCallback]=new ri(Xt(qt.requestIdleCallback),n),c[e.CancelIdleCallback]=new ri(Xt(qt.cancelIdleCallback),n),c[e.FireIdleCallback]=new ri(Xt(qt.fireIdleCallback),n),c[e.WebSocketCreate]=new ri(Xt(qt.createWebsocket),n),c[e.WebSocketSendHandshakeRequest]=new ri(Xt(qt.sendWebsocketHandshake),n),c[e.WebSocketReceiveHandshakeResponse]=new ri(Xt(qt.receiveWebsocketHandshake),n),c[e.WebSocketDestroy]=new ri(Xt(qt.destroyWebsocket),n),c[e.EmbedderCallback]=new ri(Xt(qt.embedderCallback),n),c[e.DecodeImage]=new ri(Xt(qt.imageDecode),o),c[e.ResizeImage]=new ri(Xt(qt.imageResize),o),c[e.GPUTask]=new ri(Xt(qt.gpu),t.gpu),c[e.LatencyInfo]=new ri(Xt(qt.inputLatency),n),c[e.GCCollectGarbage]=new ri(Xt(qt.domGc),n),c[e.CryptoDoEncrypt]=new ri(Xt(qt.encrypt),n),c[e.CryptoDoEncryptReply]=new ri(Xt(qt.encryptReply),n),c[e.CryptoDoDecrypt]=new ri(Xt(qt.decrypt),n),c[e.CryptoDoDecryptReply]=new ri(Xt(qt.decryptReply),n),c[e.CryptoDoDigest]=new ri(Xt(qt.digest),n),c[e.CryptoDoDigestReply]=new ri(Xt(qt.digestReply),n),c[e.CryptoDoSign]=new ri(Xt(qt.sign),n),c[e.CryptoDoSignReply]=new ri(Xt(qt.signReply),n),c[e.CryptoDoVerify]=new ri(Xt(qt.verify),n),c[e.CryptoDoVerifyReply]=new ri(Xt(qt.verifyReply),n),c[e.AsyncTask]=new ri(Xt(qt.asyncTask),t.async),c[e.LayoutShift]=new ri(Xt(qt.layoutShift),s),$t=c,c}static setEventStylesMap(e){$t=e}static inputEventDisplayName(e){if(!Kt){const e=r.TimelineIRModel.InputEvents;Kt=new Map([[e.Char,Xt(qt.keyCharacter)],[e.KeyDown,Xt(qt.keyDown)],[e.KeyDownRaw,Xt(qt.keyDown)],[e.KeyUp,Xt(qt.keyUp)],[e.Click,Xt(qt.click)],[e.ContextMenu,Xt(qt.contextMenu)],[e.MouseDown,Xt(qt.mouseDown)],[e.MouseMove,Xt(qt.mouseMove)],[e.MouseUp,Xt(qt.mouseUp)],[e.MouseWheel,Xt(qt.mouseWheel)],[e.ScrollBegin,Xt(qt.scrollBegin)],[e.ScrollEnd,Xt(qt.scrollEnd)],[e.ScrollUpdate,Xt(qt.scrollUpdate)],[e.FlingStart,Xt(qt.flingStart)],[e.FlingCancel,Xt(qt.flingHalt)],[e.Tap,Xt(qt.tap)],[e.TapCancel,Xt(qt.tapHalt)],[e.ShowPress,Xt(qt.tapBegin)],[e.TapDown,Xt(qt.tapDown)],[e.TouchCancel,Xt(qt.touchCancel)],[e.TouchEnd,Xt(qt.touchEnd)],[e.TouchMove,Xt(qt.touchMove)],[e.TouchStart,Xt(qt.touchStart)],[e.PinchBegin,Xt(qt.pinchBegin)],[e.PinchEnd,Xt(qt.pinchEnd)],[e.PinchUpdate,Xt(qt.pinchUpdate)]])}return Kt.get(e)||null}static frameDisplayName(e){if(!r.TimelineJSProfile.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return s.UIUtils.beautifyFunctionName(e.functionName);const t=r.TimelineJSProfile.TimelineJSProfileProcessor.nativeGroup(e.functionName),i=r.TimelineJSProfile.TimelineJSProfileProcessor.NativeGroups;switch(t){case i.Compile:return Xt(qt.compile);case i.Parse:return Xt(qt.parse)}return e.functionName}static testContentMatching(e,t){const i=[ni.eventStyle(e).title],n=r.TimelineModel.TimelineData.forEvent(e).url;return n&&i.push(n),function e(t,n){if(!n)return;for(const r in t){const a=t[r],s=typeof a;"string"===s?i.push(a):"number"===s?i.push(String(a)):"object"===s&&e(a,n-1)}}(e.args,2),t.test(i.join("|"))}static eventURL(e){const t=e.args.data||e.args.beginData,i=t&&t.url;if(i)return i;const n=t&&t.stackTrace,a=n&&n.length&&n[0]||r.TimelineModel.TimelineData.forEvent(e).topFrame();return a&&a.url||null}static eventStyle(e){const t=ni.initEventStyles();if(e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.UserTiming))return new ri(e.name,ni.categories().scripting);if(e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.LatencyInfo)){const t="InputLatency::",i=e.name.startsWith(t)?e.name.substr(t.length):e.name,n=ni.inputEventDisplayName(i);return new ri(n||i,ni.categories().scripting)}let i=t[e.name];return i||(i=new ri(e.name,ni.categories().other,!0),t[e.name]=i),i}static eventColor(e){if(e.name===r.TimelineModel.RecordType.JSFrame){const t=e.args.data;if(ni.isUserFrame(t))return ni.colorForId(t.url)}const i=ni.eventStyle(e).category.color;if(e.name===r.TimelineModel.RecordType.StreamingCompileScriptWaiting){const e=t.Color.Color.parse(ni.categories().scripting.color);if(!e)throw new Error("Unable to parse color from TimelineUIUtils.categories().scripting.color");return e.setAlpha(.3).asString(null)}return i}static eventColorByProduct(e,i,n){const r=ni.eventURL(n)||"";let a=i.get(r);if(a)return a;const s="#f2ecdc",o=t.ParsedURL.ParsedURL.fromString(r);if(!o)return s;const l=o.host;return e.rootFrames().some((e=>new t.ParsedURL.ParsedURL(e.url).host===l))&&(a=s),a||(a=s),i.set(r,a),a}static eventTitle(e){const t=r.TimelineModel.RecordType,i=e.args.data;if(e.name===t.JSFrame)return ni.frameDisplayName(i);const n=ni.eventStyle(e).title;return e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)?n:e.name===t.TimeStamp?Xt(qt.sS,{PH1:n,PH2:i.message}):e.name===t.Animation&&i&&i.name?Xt(qt.sS,{PH1:n,PH2:i.name}):e.name===t.EventDispatch&&i&&i.type?Xt(qt.sS,{PH1:n,PH2:i.type}):n}static interactionPhaseStyles(){let e=Yt;return e||(e=new Map([[r.TimelineIRModel.Phases.Idle,{color:"white",label:"Idle"}],[r.TimelineIRModel.Phases.Response,{color:"hsl(43, 83%, 64%)",label:Xt(qt.response)}],[r.TimelineIRModel.Phases.Scroll,{color:"hsl(256, 67%, 70%)",label:Xt(qt.scroll)}],[r.TimelineIRModel.Phases.Fling,{color:"hsl(256, 67%, 70%)",label:Xt(qt.fling)}],[r.TimelineIRModel.Phases.Drag,{color:"hsl(256, 67%, 70%)",label:Xt(qt.drag)}],[r.TimelineIRModel.Phases.Animation,{color:"hsl(256, 67%, 70%)",label:Xt(qt.animation)}],[r.TimelineIRModel.Phases.Uncategorized,{color:"hsl(0, 0%, 87%)",label:Xt(qt.uncategorized)}]]),Yt=e),e}static interactionPhaseColor(e){const t=ni.interactionPhaseStyles().get(e);if(!t)throw new Error(`Unknown phase ${e}`);return t.color}static interactionPhaseLabel(e){const t=ni.interactionPhaseStyles().get(e);if(!t)throw new Error(`Unknown phase ${e}`);return t.label}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static networkRequestCategory(e){const t=ai;switch(e.mimeType){case"text/html":return t.HTML;case"application/javascript":case"application/x-javascript":case"text/javascript":return t.Script;case"text/css":return t.Style;case"audio/ogg":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":case"font/opentype":case"font/woff2":case"application/font-woff":return t.Media;default:return t.Other}}static networkCategoryColor(e){const t=ai;switch(e){case t.HTML:return"hsl(214, 67%, 66%)";case t.Script:return"hsl(43, 83%, 64%)";case t.Style:return"hsl(256, 67%, 70%)";case t.Media:return"hsl(109, 33%, 55%)";default:return"hsl(0, 0%, 70%)"}}static async buildDetailsTextForTraceEvent(t,i){const a=r.TimelineModel.RecordType;let s;const l=t.args.data;switch(t.name){case a.GCEvent:case a.MajorGC:case a.MinorGC:{const e=t.args.usedHeapSizeBefore-t.args.usedHeapSizeAfter;s=Xt(qt.sCollected,{PH1:n.NumberUtilities.bytesToString(e)});break}case a.FunctionCall:l&&(s=await d(l.scriptId,l.lineNumber,l.columnNumber));break;case a.JSFrame:s=ni.frameDisplayName(l);break;case a.EventDispatch:s=l?l.type:null;break;case a.Paint:{const e=ni.quadWidth(l.clip),t=ni.quadHeight(l.clip);e&&t&&(s=Xt(qt.sSDimensions,{PH1:e,PH2:t}));break}case a.ParseHTML:{const e=t.args.beginData.startLine,i=t.args.endData&&t.args.endData.endLine,n=o.ResourceUtils.displayNameForURL(t.args.beginData.url);s=i>=0?Xt(qt.sSs,{PH1:n,PH2:e+1,PH3:i+1}):Xt(qt.sSSquareBrackets,{PH1:n,PH2:e+1});break}case a.CompileModule:case a.CacheModule:s=o.ResourceUtils.displayNameForURL(t.args.fileName);break;case a.CompileScript:case a.CacheScript:case a.EvaluateScript:{const e=l&&l.url;e&&(s=o.ResourceUtils.displayNameForURL(e)+":"+(l.lineNumber+1));break}case a.WasmCompiledModule:case a.WasmModuleCacheHit:{const e=t.args.url;e&&(s=o.ResourceUtils.displayNameForURL(e));break}case a.StreamingCompileScript:case a.XHRReadyStateChange:case a.XHRLoad:{const e=l.url;e&&(s=o.ResourceUtils.displayNameForURL(e));break}case a.TimeStamp:s=l.message;break;case a.WebSocketCreate:case a.WebSocketSendHandshakeRequest:case a.WebSocketReceiveHandshakeResponse:case a.WebSocketDestroy:case a.ResourceWillSendRequest:case a.ResourceSendRequest:case a.ResourceReceivedData:case a.ResourceReceiveResponse:case a.ResourceFinish:case a.PaintImage:case a.DecodeImage:case a.ResizeImage:case a.DecodeLazyPixelRef:{const e=r.TimelineModel.TimelineData.forEvent(t).url;e&&(s=o.ResourceUtils.displayNameForURL(e));break}case a.EmbedderCallback:s=l.callbackName;break;case a.Animation:s=l&&l.name;break;case a.AsyncTask:s=l?l.name:null;break;default:s=t.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)?null:await async function(){const e=r.TimelineModel.TimelineData.forEvent(t).topFrame();if(!e)return null;let i=await d(e.scriptId,e.lineNumber,e.columnNumber);i||(i=e.url+":"+(e.lineNumber+1)+":"+(e.columnNumber+1));return i}()}return s;async function d(t,n,r){const a=i?i.model(e.DebuggerModel.DebuggerModel):null;if(!i||i.isDisposed()||!t||!a)return null;const s=a.createRawLocationByScriptId(t,n,r);if(!s)return null;const l=await o.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(s);return l?l.linkText(!1,!0):null}}static async buildDetailsNodeForTraceEvent(e,t,i){const n=r.TimelineModel.RecordType;let a,o=null;const d=e.args.data;switch(e.name){case n.GCEvent:case n.MajorGC:case n.MinorGC:case n.EventDispatch:case n.Paint:case n.Animation:case n.EmbedderCallback:case n.ParseHTML:case n.WasmStreamFromResponseCallback:case n.WasmCompiledModule:case n.WasmModuleCacheHit:case n.WasmCachedModule:case n.WasmModuleCacheInvalid:case n.WebSocketCreate:case n.WebSocketSendHandshakeRequest:case n.WebSocketReceiveHandshakeResponse:case n.WebSocketDestroy:a=await ni.buildDetailsTextForTraceEvent(e,t);break;case n.PaintImage:case n.DecodeImage:case n.ResizeImage:case n.DecodeLazyPixelRef:case n.XHRReadyStateChange:case n.XHRLoad:case n.ResourceWillSendRequest:case n.ResourceSendRequest:case n.ResourceReceivedData:case n.ResourceReceiveResponse:case n.ResourceFinish:{const t=r.TimelineModel.TimelineData.forEvent(e).url;if(t){const e={tabStop:!0,className:void 0,columnNumber:void 0,showColumnNumber:!1,inlineFrameIndex:0,text:void 0,lineNumber:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0};o=l.Linkifier.Linkifier.linkifyURL(t,e)}break}case n.FunctionCall:case n.JSFrame:{o=document.createElement("span"),s.UIUtils.createTextChild(o,ni.frameDisplayName(d));const e=c(d.scriptId,d.url,d.lineNumber,d.columnNumber);e&&(s.UIUtils.createTextChild(o," @ "),o.appendChild(e));break}case n.CompileModule:case n.CacheModule:o=c(null,e.args.fileName,0,0);break;case n.CompileScript:case n.CacheScript:case n.EvaluateScript:{const e=d.url;e&&(o=c(null,e,d.lineNumber,0));break}case n.StreamingCompileScript:{const e=d.url;e&&(o=c(null,e,0,0));break}default:e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)?a=null:o=function(){const n=r.TimelineModel.TimelineData.forEvent(e).topFrame();return n?i.maybeLinkifyConsoleCallFrame(t,n,{className:"timeline-details",tabStop:!0,inlineFrameIndex:0,showColumnNumber:!0}):null}()}return!o&&a&&(o=document.createTextNode(a)),o;function c(e,n,r,a){const s={columnNumber:a,showColumnNumber:!0,inlineFrameIndex:0,className:"timeline-details",tabStop:!0};return i.linkifyScriptLocation(t,e,n,r,s)}}static buildDetailsNodeForPerformanceEvent(e){let t="https://web.dev/user-centric-performance-metrics/",i="page performance metrics";const n=r.TimelineModel.RecordType;switch(e.name){case n.MarkLCPCandidate:t="https://web.dev/lcp/",i="largest contentful paint";break;case n.MarkFCP:t="https://web.dev/first-contentful-paint/",i="first contentful paint"}return s.Fragment.html`<div>${s.XLink.XLink.create(t,Xt(qt.learnMore))} about ${i}.</div>`}static buildConsumeCacheDetails(e,t){"consumedCacheSize"in e?(t.appendTextRow(Xt(qt.compilationCacheStatus),Xt(qt.scriptLoadedFromCache)),t.appendTextRow(Xt(qt.compilationCacheSize),n.NumberUtilities.bytesToString(e.consumedCacheSize))):e&&"cacheRejected"in e&&e.cacheRejected?t.appendTextRow(Xt(qt.compilationCacheStatus),Xt(qt.failedToLoadScriptFromCache)):t.appendTextRow(Xt(qt.compilationCacheStatus),Xt(qt.scriptNotEligible))}static async buildTraceEventDetails(o,d,c,h){const m=d.targetByEvent(o);let u=null;if(m){const t=m;if(void 0===o[li]){let e=null;const i=r.TimelineModel.TimelineData.forEvent(o).url;i?e=await l.ImagePreview.ImagePreview.build(t,i,!1,{imageAltText:l.ImagePreview.ImagePreview.defaultAltTextForImageURL(i),precomputedFeatures:void 0}):r.TimelineModel.TimelineData.forEvent(o).picture&&(e=await ni.buildPicturePreviewContent(o,t)),o[li]=e}const i=new Set,n=r.TimelineModel.TimelineData.forEvent(o);if(n.backendNodeIds)for(let e=0;e<n.backendNodeIds.length;++e)i.add(n.backendNodeIds[e]);const a=r.TimelineModel.InvalidationTracker.invalidationEventsFor(o);if(a&&ni.collectInvalidationNodeIds(i,a),i.size){const n=t.model(e.DOMModel.DOMModel);n&&(u=await n.pushNodesByBackendIdsToFrontend(i))}}const p=r.TimelineModel.RecordType;let g;o.name===p.LayoutShift&&(h=!1);const v=new hi(d.targetByEvent(o),c),T=d.isMarkerEvent(o)?ni.markerStyleForEvent(o).color:ni.eventStyle(o).category.color;v.addSection(ni.eventTitle(o),T);const f=o.args.data,S=r.TimelineModel.TimelineData.forEvent(o),b=S.initiator();let y=null;if(S.warning&&v.appendWarningRow(o),o.name===p.JSFrame&&f.deoptReason&&v.appendWarningRow(o,r.TimelineModel.TimelineModelImpl.WarningType.V8Deopt),h&&!Number.isNaN(o.duration||0)&&(v.appendTextRow(Xt(qt.totalTime),i.TimeUtilities.millisToString(o.duration||0,!0)),v.appendTextRow(Xt(qt.selfTime),i.TimeUtilities.millisToString(o.selfTime,!0))),d.isGenericTrace()){for(const e in o.args)try{v.appendTextRow(e,JSON.stringify(o.args[e]))}catch(t){v.appendTextRow(e,`<${typeof o.args[e]}>`)}return v.fragment}switch(o.name){case p.GCEvent:case p.MajorGC:case p.MinorGC:{const e=o.args.usedHeapSizeBefore-o.args.usedHeapSizeAfter;v.appendTextRow(Xt(qt.collected),n.NumberUtilities.bytesToString(e));break}case p.JSFrame:case p.FunctionCall:{const e=await ni.buildDetailsNodeForTraceEvent(o,d.targetByEvent(o),c);e&&v.appendElementRow(Xt(qt.function),e);break}case p.TimerFire:case p.TimerInstall:case p.TimerRemove:v.appendTextRow(Xt(qt.timerId),f.timerId),o.name===p.TimerInstall&&(v.appendTextRow(Xt(qt.timeout),i.TimeUtilities.millisToString(f.timeout)),v.appendTextRow(Xt(qt.repeats),!f.singleShot));break;case p.FireAnimationFrame:v.appendTextRow(Xt(qt.callbackId),f.id);break;case p.ResourceWillSendRequest:case p.ResourceSendRequest:case p.ResourceReceiveResponse:case p.ResourceReceivedData:case p.ResourceFinish:if(y=S.url,y){const e={tabStop:!0,className:void 0,columnNumber:void 0,showColumnNumber:!1,inlineFrameIndex:0,lineNumber:void 0,text:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0};v.appendElementRow(Xt(qt.resource),l.Linkifier.Linkifier.linkifyURL(y,e))}if(f.requestMethod&&v.appendTextRow(Xt(qt.requestMethod),f.requestMethod),"number"==typeof f.statusCode&&v.appendTextRow(Xt(qt.statusCode),f.statusCode),f.mimeType&&v.appendTextRow(Xt(qt.mimeTypeCaps),f.mimeType),"priority"in f){const e=a.NetworkPriorities.uiLabelForNetworkPriority(f.priority);v.appendTextRow(Xt(qt.priority),e)}f.encodedDataLength&&v.appendTextRow(Xt(qt.encodedData),Xt(qt.sBytes,{n:f.encodedDataLength})),f.decodedBodyLength&&v.appendTextRow(Xt(qt.decodedBody),Xt(qt.sBytes,{n:f.decodedBodyLength}));break;case p.CompileModule:v.appendLocationRow(Xt(qt.module),o.args.fileName,0);break;case p.CompileScript:{y=f&&f.url,y&&v.appendLocationRow(Xt(qt.script),y,f.lineNumber,f.columnNumber);(f.eager??!1)&&v.appendTextRow(Xt(qt.eagerCompile),!0);const e=f.streamed;v.appendTextRow(Xt(qt.streamed),e+(e?"":`: ${f.notStreamedReason}`)),ni.buildConsumeCacheDetails(f,v);break}case p.CacheModule:y=f&&f.url,v.appendTextRow(Xt(qt.compilationCacheSize),n.NumberUtilities.bytesToString(f.producedCacheSize));break;case p.CacheScript:y=f&&f.url,y&&v.appendLocationRow(Xt(qt.script),y,f.lineNumber,f.columnNumber),v.appendTextRow(Xt(qt.compilationCacheSize),n.NumberUtilities.bytesToString(f.producedCacheSize));break;case p.EvaluateScript:y=f&&f.url,y&&v.appendLocationRow(Xt(qt.script),y,f.lineNumber,f.columnNumber);break;case p.WasmStreamFromResponseCallback:case p.WasmCompiledModule:case p.WasmCachedModule:case p.WasmModuleCacheHit:case p.WasmModuleCacheInvalid:if(f){y=o.args.url,y&&v.appendTextRow(Xt(qt.url),y);const e=o.args.producedCachedSize;e&&v.appendTextRow(Xt(qt.producedCacheSize),e);const t=o.args.consumedCachedSize;t&&v.appendTextRow(Xt(qt.consumedCacheSize),t)}break;case p.Paint:{const e=f.clip;v.appendTextRow(Xt(qt.location),Xt(qt.sSCurlyBrackets,{PH1:e[0],PH2:e[1]}));const t=ni.quadWidth(e),i=ni.quadHeight(e);v.appendTextRow(Xt(qt.dimensions),Xt(qt.sSDimensions,{PH1:t,PH2:i}))}case p.PaintSetup:case p.Rasterize:case p.ScrollLayer:g=Xt(qt.layerRoot);break;case p.PaintImage:case p.DecodeLazyPixelRef:case p.DecodeImage:case p.ResizeImage:case p.DrawLazyPixelRef:if(g=Xt(qt.ownerElement),y=S.url,y){const e={tabStop:!0,className:void 0,columnNumber:void 0,showColumnNumber:!1,lineNumber:void 0,inlineFrameIndex:0,text:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0};v.appendElementRow(Xt(qt.imageUrl),l.Linkifier.Linkifier.linkifyURL(y,e))}break;case p.ParseAuthorStyleSheet:if(y=f.styleSheetUrl,y){const e={tabStop:!0,className:void 0,columnNumber:void 0,showColumnNumber:!1,inlineFrameIndex:0,lineNumber:void 0,text:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0};v.appendElementRow(Xt(qt.stylesheetUrl),l.Linkifier.Linkifier.linkifyURL(y,e))}break;case p.UpdateLayoutTree:case p.RecalculateStyles:v.appendTextRow(Xt(qt.elementsAffected),o.args.elementCount);break;case p.Layout:{const e=o.args.beginData;v.appendTextRow(Xt(qt.nodesThatNeedLayout),Xt(qt.sOfS,{PH1:e.dirtyObjects,PH2:e.totalObjects})),g=Xt(qt.layoutRoot);break}case p.ConsoleTime:v.appendTextRow(Xt(qt.message),o.name);break;case p.WebSocketCreate:case p.WebSocketSendHandshakeRequest:case p.WebSocketReceiveHandshakeResponse:case p.WebSocketDestroy:{const e=b?b.args.data:f;void 0!==e.webSocketURL&&v.appendTextRow(i.i18n.lockedString("URL"),e.webSocketURL),void 0!==e.webSocketProtocol&&v.appendTextRow(Xt(qt.websocketProtocol),e.webSocketProtocol),void 0!==f.message&&v.appendTextRow(Xt(qt.message),f.message);break}case p.EmbedderCallback:v.appendTextRow(Xt(qt.callbackFunction),f.callbackName);break;case p.Animation:o.phase===e.TracingModel.Phase.NestableAsyncInstant&&v.appendTextRow(Xt(qt.state),f.state);break;case p.ParseHTML:{const e=o.args.beginData,t=e.startLine-1,i=o.args.endData?o.args.endData.endLine-1:void 0;y=e.url,y&&v.appendLocationRange(Xt(qt.range),y,t,i);break}case p.FireIdleCallback:v.appendTextRow(Xt(qt.allottedTime),i.TimeUtilities.millisToString(f.allottedMilliseconds)),v.appendTextRow(Xt(qt.invokedByTimeout),f.timedOut);case p.RequestIdleCallback:case p.CancelIdleCallback:v.appendTextRow(Xt(qt.callbackId),f.id);break;case p.EventDispatch:v.appendTextRow(Xt(qt.type),f.type);break;case p.MarkLCPCandidate:v.appendTextRow(Xt(qt.type),String(f.type)),v.appendTextRow(Xt(qt.size),String(f.size));case p.MarkFirstPaint:case p.MarkFCP:case p.MarkLoad:case p.MarkDOMContent:{let e=o.startTime-d.minimumRecordTime();const{navigationId:t}=o.args.data;if(t){const i=d.navStartTimes().get(t);i&&(e=o.startTime-i.startTime)}v.appendTextRow(Xt(qt.timestamp),i.TimeUtilities.preciseMillisToString(e,1)),v.appendElementRow(Xt(qt.details),ni.buildDetailsNodeForPerformanceEvent(o));break}case p.LayoutShift:{const e=document.createElement("span"),n=s.XLink.XLink.create("https://web.dev/cls/",Xt(qt.cumulativeLayoutShifts)),r=s.XLink.XLink.create("https://web.dev/evolving-cls/",Xt(qt.evolvedClsLink));e.appendChild(i.i18n.getFormatLocalizedString(Jt,qt.sCLSInformation,{PH1:n,PH2:r})),v.appendElementRow(Xt(qt.warning),e,!0),v.appendTextRow(Xt(qt.score),f.score.toPrecision(4)),v.appendTextRow(Xt(qt.cumulativeScore),f.cumulative_score.toPrecision(4)),"_current_cluster_id"in f&&v.appendTextRow(Xt(qt.currentClusterId),f._current_cluster_id),"_current_cluster_score"in f&&v.appendTextRow(Xt(qt.currentClusterScore),f._current_cluster_score.toPrecision(4)),v.appendTextRow(Xt(qt.hadRecentInput),f.had_recent_input?Xt(qt.yes):Xt(qt.no));for(const e of f.impacted_nodes){const i=new w(e.old_rect),n=new w(e.new_rect),r=await t.Linkifier.Linkifier.linkify(i),a=await t.Linkifier.Linkifier.linkify(n);v.appendElementRow(Xt(qt.movedFrom),r),v.appendElementRow(Xt(qt.movedTo),a)}break}default:{const e=await ni.buildDetailsNodeForTraceEvent(o,d.targetByEvent(o),c);e&&v.appendElementRow(Xt(qt.details),e);break}}S.timeWaitingForMainThread&&v.appendTextRow(Xt(qt.timeWaitingForMainThread),i.TimeUtilities.millisToString(S.timeWaitingForMainThread,!0));for(let e=0;e<S.backendNodeIds.length;++e){const i=u&&u.get(S.backendNodeIds[e]);if(i){const e=await t.Linkifier.Linkifier.linkify(i);v.appendElementRow(g||Xt(qt.relatedNode),e)}}o[li]&&(v.addSection(Xt(qt.preview)),v.appendElementRow("",o[li])),(b||S.stackTraceForSelfOrInitiator()||r.TimelineModel.InvalidationTracker.invalidationEventsFor(o))&&ni.generateCauses(o,d.targetByEvent(o),u,v);const C={};if(h&&ni.aggregatedStatsForTraceEvent(C,d,o)){v.addSection(Xt(qt.aggregatedTime));const e=ni.generatePieChart(C,ni.eventStyle(o).category,o.selfTime);v.appendElementRow("",e)}return v.fragment}static statsForTimeRange(t,i,a){if(!t.length)return{idle:a-i};!function(t){if(t[mi])return;const i={},n=[];let a=0;function s(e,t){let n=i[e];if(n||(n={time:[],value:[]},i[e]=n),n.time.length&&n.time[n.time.length-1]===t||a>t)return;const r=n.value.length>0?n.value[n.value.length-1]:0;n.value.push(r+t-a),n.time.push(t)}function o(e,t,i){e&&s(e,i),a=i,t&&s(t,i)}r.TimelineModel.TimelineModelImpl.forEachEvent(t,(function(e){const t=ni.eventStyle(e).category.name,i=n.length?n[n.length-1]:null;t!==i&&o(i||null,t,e.startTime),n.push(t)}),(function(e){const t=n.pop(),i=n.length?n[n.length-1]:null;t!==i&&o(t||null,i||null,e.endTime||0)}),void 0,void 0,void 0,function(){const t=ni.visibleEventsFilter();return i=>t.accept(i)||e.TracingModel.TracingModel.isTopLevelEvent(i)}());t[mi]=i}(t);const s=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(l(a),l(i)),o=Object.values(s).reduce(((e,t)=>e+t),0);return s.idle=Math.max(0,a-i-o),s;function l(e){const i={},r=t[mi];for(const t in r){const a=r[t],s=n.ArrayUtilities.upperBound(a.time,e,n.ArrayUtilities.DEFAULT_COMPARATOR);let o;if(0===s)o=0;else if(s===a.time.length)o=a.value[a.value.length-1];else{const t=a.time[s-1],i=a.time[s],n=a.value[s-1];o=n+(a.value[s]-n)*(e-t)/(i-t)}i[t]=o}return i}}static async buildNetworkRequestDetails(e,t,s){const o=t.targetByEvent(e.children[0]),d=new hi(o,s),c=ni.networkRequestCategory(e),h=ni.networkCategoryColor(c);if(d.addSection(Xt(qt.networkRequest),h),e.url){const t={tabStop:!0,className:void 0,columnNumber:void 0,showColumnNumber:!1,text:void 0,inlineFrameIndex:0,lineNumber:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0};d.appendElementRow(i.i18n.lockedString("URL"),l.Linkifier.Linkifier.linkifyURL(e.url,t))}const m=e.endTime-(e.getStartTime()||-1/0);if(isFinite(m)){let t=i.TimeUtilities.millisToString(m,!0);const n=(e.finishTime||e.getStartTime())-e.getStartTime(),r=e.endTime-(e.finishTime||0);if(isFinite(n)&&isFinite(r)){const a=i.TimeUtilities.millisToString(n,!0),s=i.TimeUtilities.millisToString(r,!0),o=e.cached()?Xt(qt.loadFromCache):Xt(qt.networkTransfer);t+=Xt(qt.SSSResourceLoading,{PH1:a,PH2:o,PH3:s})}d.appendTextRow(Xt(qt.duration),t)}if(e.requestMethod&&d.appendTextRow(Xt(qt.requestMethod),e.requestMethod),"string"==typeof e.priority){const t=a.NetworkPriorities.uiLabelForNetworkPriority(e.priority);d.appendTextRow(Xt(qt.priority),t)}e.mimeType&&d.appendTextRow(Xt(qt.mimeType),e.mimeType);let u="";e.memoryCached()?u+=Xt(qt.FromMemoryCache):e.cached()?u+=Xt(qt.FromCache):e.timing&&e.timing.pushStart&&(u+=Xt(qt.FromPush)),e.fromServiceWorker&&(u+=Xt(qt.FromServiceWorker)),!e.encodedDataLength&&u||(u=`${n.NumberUtilities.bytesToString(e.encodedDataLength)}${u}`),d.appendTextRow(Xt(qt.encodedData),u),e.decodedBodyLength&&d.appendTextRow(Xt(qt.decodedBody),n.NumberUtilities.bytesToString(e.decodedBodyLength));const p=Xt(qt.initiator),g=e.children[0],v=r.TimelineModel.TimelineData.forEvent(g).topFrame();if(v){const e=s.maybeLinkifyConsoleCallFrame(o,v,{tabStop:!0,className:void 0,inlineFrameIndex:0,showColumnNumber:!0});e&&d.appendElementRow(p,e)}else{const e=r.TimelineModel.TimelineData.forEvent(g).initiator();if(e){const t=r.TimelineModel.TimelineData.forEvent(e).url;if(t){const e=s.maybeLinkifyScriptLocation(o,null,t,0,{tabStop:!0,className:void 0,inlineFrameIndex:0,columnNumber:void 0});e&&d.appendElementRow(p,e)}}}if(!ii.get(e)&&e.url&&o){const t=await l.ImagePreview.ImagePreview.build(o,e.url,!1,{imageAltText:l.ImagePreview.ImagePreview.defaultAltTextForImageURL(e.url),precomputedFeatures:void 0});ii.set(e,t)}const T=ii.get(e);return T&&d.appendElementRow(Xt(qt.preview),T),d.fragment}static stackTraceFromCallFrames(e){return{callFrames:e}}static generateCauses(e,t,n,a){const o=r.TimelineModel.RecordType;let l,d;switch(e.name){case o.TimerFire:l=Xt(qt.timerInstalled);break;case o.FireAnimationFrame:l=Xt(qt.animationFrameRequested);break;case o.FireIdleCallback:l=Xt(qt.idleCallbackRequested);break;case o.UpdateLayoutTree:case o.RecalculateStyles:d=Xt(qt.recalculationForced);break;case o.Layout:l=Xt(qt.firstLayoutInvalidation),d=Xt(qt.layoutForced)}const c=r.TimelineModel.TimelineData.forEvent(e);c.stackTrace&&c.stackTrace.length&&(a.addSection(Xt(qt.callStacks)),a.appendStackTrace(d||Xt(qt.stackTrace),ni.stackTraceFromCallFrames(c.stackTrace)));const h=r.TimelineModel.TimelineData.forEvent(e).initiator();if(r.TimelineModel.InvalidationTracker.invalidationEventsFor(e)&&t)a.addSection(Xt(qt.invalidations)),ni.generateInvalidations(e,t,n,a);else if(h){const t=e.startTime-h.startTime;a.appendTextRow(Xt(qt.pendingFor),i.TimeUtilities.preciseMillisToString(t,1));const n=document.createElement("span");n.classList.add("devtools-link"),s.ARIAUtils.markAsLink(n),n.tabIndex=0,n.textContent=Xt(qt.reveal),n.addEventListener("click",(()=>{Ht.instance().select(Vt.fromTraceEvent(h))})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&(Ht.instance().select(Vt.fromTraceEvent(h)),e.consume(!0))})),a.appendElementRow(Xt(qt.initiator),n);const o=r.TimelineModel.TimelineData.forEvent(h).stackTrace;o&&a.appendStackTrace(l||Xt(qt.firstInvalidated),ni.stackTraceFromCallFrames(o))}}static generateInvalidations(e,t,i,n){const a=r.TimelineModel.InvalidationTracker.invalidationEventsFor(e);if(!a)return;const s={};for(const e of a)s[e.type]||(s[e.type]=[]),s[e.type].push(e);Object.keys(s).forEach((function(e){ni.generateInvalidationsForType(e,t,s[e],i,n)}))}static generateInvalidationsForType(e,t,i,n,a){let o;switch(e){case r.TimelineModel.RecordType.StyleRecalcInvalidationTracking:o=Xt(qt.styleInvalidations);break;case r.TimelineModel.RecordType.LayoutInvalidationTracking:o=Xt(qt.layoutInvalidations);break;default:o=Xt(qt.otherInvalidations)}const l=new s.TreeOutline.TreeOutlineInShadow;l.registerCSSFiles([C]),l.element.classList.add("invalidations-tree");const d=function(e){const t=new Map;for(let i=0;i<e.length;i++){const n=e[i];let r="";n.cause.reason&&(r+=n.cause.reason+"."),n.cause.stackTrace&&n.cause.stackTrace.forEach((function(e){r+=e.functionName+".",r+=e.scriptId+".",r+=e.url+".",r+=e.lineNumber+".",r+=e.columnNumber+"."}));const a=t.get(r);a?a.push(n):t.set(r,[n])}return[...t.values()]}(i);d.forEach((function(e){const i=new oi(t,n,a,e);l.appendChild(i)})),a.appendElementRow(o,l.element,!1,!0)}static collectInvalidationNodeIds(e,t){n.SetUtilities.addAll(e,t.map((e=>e.nodeId)).filter((e=>e)))}static aggregatedStatsForTraceEvent(t,i,r){const a=i.inspectedTargetEvents();const s=n.ArrayUtilities.binaryIndexOf(a,r.startTime,(function(e,t){return e-t.startTime}));if(s<0)return!1;let o=!1;const l=r.endTime;if(l)for(let e=s;e<a.length;e++){const i=a[e];if(i.startTime>=l)break;if(!i.selfTime)continue;if(i.thread!==r.thread)continue;e>s&&(o=!0);const n=ni.eventStyle(i).category.name;t[n]=(t[n]||0)+i.selfTime}if(e.TracingModel.TracingModel.isAsyncPhase(r.phase)){if(r.endTime){let e=0;for(const i in t)e+=t[i];t.idle=Math.max(0,r.endTime-r.startTime-e)}return!1}return o}static async buildPicturePreviewContent(e,t){const i=await new r.TimelineFrameModel.LayerPaintEvent(e,t).snapshotPromise();if(!i)return null;const n=i.snapshot.replay();i.snapshot.release();const a=await n;if(!a)return null;const o=document.createElement("div"),d=o.attachShadow({mode:"open"});d.adoptedStyleSheets=[k];const c=d.createChild("div");c.classList.add("image-preview-container","vbox","link");const h=c.createChild("img");h.src=a,h.alt=l.ImagePreview.ImagePreview.defaultAltTextForImageURL(a);return c.createChild("a").textContent=Xt(qt.paintProfiler),s.ARIAUtils.markAsLink(c),c.tabIndex=0,c.addEventListener("click",(()=>Ht.instance().select(Vt.fromTraceEvent(e))),!1),c.addEventListener("keydown",(t=>{"Enter"===t.key&&(Ht.instance().select(Vt.fromTraceEvent(e)),t.consume(!0))})),o}static createEventDivider(e,t){const n=document.createElement("div");n.classList.add("resources-event-divider");const r=i.TimeUtilities.millisToString(e.startTime-t);s.Tooltip.Tooltip.install(n,Xt(qt.sAtS,{PH1:ni.eventTitle(e),PH2:r}));const a=ni.markerStyleForEvent(e);return a.tall&&(n.style.backgroundColor=a.color),n}static visibleTypes(){const e=ni.initEventStyles(),t=[];for(const i in e)e[i].hidden||t.push(i);return t}static visibleEventsFilter(){return new r.TimelineModelFilter.TimelineVisibleEventsFilter(ni.visibleTypes())}static categories(){return Qt||(Qt={loading:new ci("loading",Xt(qt.loading),!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),experience:new ci("experience",Xt(qt.experience),!1,"hsl(5, 80%, 74%)","hsl(5, 80%, 66%)"),scripting:new ci("scripting",Xt(qt.scripting),!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),rendering:new ci("rendering",Xt(qt.rendering),!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new ci("painting",Xt(qt.painting),!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),gpu:new ci("gpu",Xt(qt.gpu),!1,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),async:new ci("async",Xt(qt.async),!1,"hsl(0, 100%, 50%)","hsl(0, 100%, 40%)"),other:new ci("other",Xt(qt.system),!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new ci("idle",Xt(qt.idle),!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")},Qt)}static setCategories(e){Qt=e}static getTimelineMainEventCategories(){return Zt||(Zt=["idle","loading","painting","rendering","scripting","other"],Zt)}static setTimelineMainEventCategories(e){Zt=e}static generatePieChart(e,t,n){let r=0;for(const t in e)r+=e[t];const s=document.createElement("div");s.classList.add("timeline-details-view-pie-chart-wrapper"),s.classList.add("hbox");const o=new a.PieChart.PieChart,l=[];function d(e,t,i,n){i&&l.push({value:i,color:n,title:t})}if(t){n&&d(t.name,Xt(qt.sSelf,{PH1:t.title}),n,t.color);const i=e[t.name]-(n||0);i>0&&d(t.name,Xt(qt.sChildren,{PH1:t.title}),i,t.childColor)}for(const i in ni.categories()){const n=ni.categories()[i];n!==t&&d(n.name,n.title,e[n.name],n.childColor)}o.data={chartName:Xt(qt.timeSpentInRendering),size:110,formatter:e=>i.TimeUtilities.preciseMillisToString(e),showLegend:!0,total:r,slices:l};return s.createChild("div","vbox").appendChild(o),s}static generateDetailsContentForFrame(e,t){const n=new hi(null,null);n.addSection(Xt(qt.frame));const r=ni.frameDuration(e);n.appendElementRow(Xt(qt.duration),r,e.hasWarnings());const o=e.endTime-e.startTime;if(n.appendTextRow(Xt(qt.fps),Math.floor(1e3/o)),n.appendTextRow(Xt(qt.cpuTime),i.TimeUtilities.millisToString(e.cpuTime,!0)),t){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),t.imageDataPromise().then((e=>s.UIUtils.loadImageFromData(e))).then((t=>t&&e.appendChild(t))),n.appendElementRow("",e),e.addEventListener("click",function(e){new a.FilmStripView.Dialog(e,0)}.bind(null,t),!1)}return e.layerTree&&n.appendElementRow(Xt(qt.layerTree),l.Linkifier.Linkifier.linkifyRevealable(e.layerTree,Xt(qt.show))),n.fragment}static frameDuration(e){const t=Xt(qt.sAtSParentheses,{PH1:i.TimeUtilities.millisToString(e.endTime-e.startTime,!0),PH2:i.TimeUtilities.millisToString(e.startTimeOffset,!0)});if(!e.hasWarnings())return i.i18n.getFormatLocalizedString(Jt,qt.emptyPlaceholder,{PH1:t});const n=s.XLink.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/",Xt(qt.jank));return i.i18n.getFormatLocalizedString(Jt,qt.sLongFrameTimesAreAnIndicationOf,{PH1:t,PH2:n})}static createFillStyle(e,t,i,n,r,a){const s=e.createLinearGradient(0,0,t,i);return s.addColorStop(0,n),s.addColorStop(.25,r),s.addColorStop(.75,r),s.addColorStop(1,a),s}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(ei)return ei;const e="hsl(40,100%,80%)",t="hsl(40,100%,50%)";return ei=[new di(1,e,["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new di(1,e,["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new di(2,"hsl(90,100%,40%)",["wheel"]),new di(3,t,["click","mousedown","mouseup"]),new di(3,t,["touchstart","touchend","touchmove","touchcancel"]),new di(3,t,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new di(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],ei}static markerShortTitle(e){const t=r.TimelineModel.RecordType;switch(e.name){case t.MarkDOMContent:return i.i18n.lockedString("DCL");case t.MarkLoad:return i.i18n.lockedString("L");case t.MarkFirstPaint:return i.i18n.lockedString("FP");case t.MarkFCP:return i.i18n.lockedString("FCP");case t.MarkLCPCandidate:return i.i18n.lockedString("LCP")}return null}static markerStyleForEvent(e){const t=[6,4],i=ni.eventTitle(e),n=r.TimelineModel.RecordType;if(e.name!==n.NavigationStart&&(e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.Console)||e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.UserTiming)))return{title:i,dashStyle:t,lineWidth:.5,color:e.hasCategory(r.TimelineModel.TimelineModelImpl.Category.UserTiming)?"purple":"orange",tall:!1,lowPriority:!1};let a=!1,s="grey";switch(e.name){case n.NavigationStart:s="#FF9800",a=!0;break;case n.FrameStartedLoading:s="green",a=!0;break;case n.MarkDOMContent:s="#0867CB",a=!0;break;case n.MarkLoad:s="#B31412",a=!0;break;case n.MarkFirstPaint:s="#228847",a=!0;break;case n.MarkFCP:s="#1A6937",a=!0;break;case n.MarkLCPCandidate:s="#1A3422",a=!0;break;case n.TimeStamp:s="orange"}return{title:i,dashStyle:t,lineWidth:.5,color:s,tall:a,lowPriority:!1}}static markerStyleForFrame(){return{title:Xt(qt.frame),color:"rgba(100, 100, 100, 0.4)",lineWidth:3,dashStyle:[3],tall:!0,lowPriority:!0}}static colorForId(e){return ti||(ti=new t.Color.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:3},85),ti.setColorForID("","#f2ecdc")),ti.colorForID(e)}static eventWarning(e,t){const n=r.TimelineModel.TimelineData.forEvent(e),a=t||n.warning;if(!a)return null;const o=r.TimelineModel.TimelineModelImpl.WarningType,l=document.createElement("span"),d=e.args.data;switch(a){case o.ForcedStyle:case o.ForcedLayout:{const e=s.XLink.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts",Xt(qt.forcedReflow));l.appendChild(i.i18n.getFormatLocalizedString(Jt,qt.sIsALikelyPerformanceBottleneck,{PH1:e}));break}case o.IdleDeadlineExceeded:{const t=i.TimeUtilities.millisToString((e.duration||0)-d.allottedMilliseconds,!0);l.textContent=Xt(qt.idleCallbackExecutionExtended,{PH1:t});break}case o.LongHandler:l.textContent=Xt(qt.handlerTookS,{PH1:i.TimeUtilities.millisToString(e.duration||0,!0)});break;case o.LongRecurringHandler:l.textContent=Xt(qt.recurringHandlerTookS,{PH1:i.TimeUtilities.millisToString(e.duration||0,!0)});break;case o.LongTask:{const t=s.XLink.XLink.create("https://web.dev/rail/#goals-and-guidelines",Xt(qt.longTask));l.appendChild(i.i18n.getFormatLocalizedString(Jt,qt.sTookS,{PH1:t,PH2:i.TimeUtilities.millisToString(e.duration||0,!0)}));break}case o.V8Deopt:l.appendChild(s.XLink.XLink.create("https://github.com/GoogleChrome/devtools-docs/issues/53",Xt(qt.notOptimized))),s.UIUtils.createTextChild(l,Xt(qt.emptyPlaceholderColon,{PH1:d.deoptReason}));break;default:console.assert(!1,"Unhandled TimelineModel.WarningType")}return l}static displayNameForFrame(e,t){return t||(t=30),e.url.startsWith("about:")?`"${n.StringUtilities.trimMiddle(e.name,t)}"`:e.url.trimEnd(t)}}class ri{title;category;hidden;constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}var ai;!function(e){e.HTML="HTML",e.Script="Script",e.Style="Style",e.Media="Media",e.Other="Other"}(ai||(ai={}));const si=Symbol("aggregatedStats");class oi extends s.TreeOutline.TreeElement{toggleOnClick;relatedNodesMap;contentHelper;invalidations;constructor(e,t,i,n){super("",!0),this.listItemElement.classList.add("header"),this.selectable=!1,this.toggleOnClick=!0,this.relatedNodesMap=t,this.contentHelper=i,this.invalidations=n,this.title=this.createTitle(e)}createTitle(e){const t=this.invalidations[0],n=t.cause.reason||Xt(qt.unknownCause),r=t.cause.stackTrace&&t.cause.stackTrace[0],a=this.getTruncatedNodesElement(this.invalidations);if(null===a)return i.i18n.getFormatLocalizedString(Jt,qt.emptyPlaceholder,{PH1:n});const s=i.i18n.getFormatLocalizedString(Jt,qt.sForS,{PH1:n,PH2:a});if(r&&this.contentHelper.linkifier()){const t=document.createElement("span");t.classList.add("monospace");const n=i.i18n.getFormatLocalizedString(Jt,qt.sSDot,{PH1:s,PH2:t});t.createChild("span").textContent=ni.frameDisplayName(r);const a=this.contentHelper.linkifier();if(a){const i=a.maybeLinkifyConsoleCallFrame(e,r,{showColumnNumber:!0,inlineFrameIndex:0});i&&(i.textContent&&"​"!==i.textContent||(i.textContent=Xt(qt.unknown)),t.createChild("span").textContent=" @ ",t.createChild("span").appendChild(i))}return n}return s}async onpopulate(){const e=document.createElement("div");e.classList.add("content");const t=this.invalidations[0];if(t.cause.stackTrace){const i=e.createChild("div");s.UIUtils.createTextChild(i,Xt(qt.stackTraceColon)),this.contentHelper.createChildStackTraceElement(i,ni.stackTraceFromCallFrames(t.cause.stackTrace))}s.UIUtils.createTextChild(e,1!==this.invalidations.length?Xt(qt.nodes):Xt(qt.node));const i=e.createChild("div","node-list");let n=!0;for(let e=0;e<this.invalidations.length;e++){const t=this.invalidations[e],r=this.createInvalidationNode(t,!0);if(r){n||s.UIUtils.createTextChild(i,", "),n=!1,i.appendChild(r);const e=t.extraData?", "+t.extraData:"";t.changedId?s.UIUtils.createTextChild(i,Xt(qt.changedIdToSs,{PH1:t.changedId,PH2:e})):t.changedClass?s.UIUtils.createTextChild(i,Xt(qt.changedClassToSs,{PH1:t.changedClass,PH2:e})):t.changedAttribute?s.UIUtils.createTextChild(i,Xt(qt.changedAttributeToSs,{PH1:t.changedAttribute,PH2:e})):t.changedPseudo?s.UIUtils.createTextChild(i,Xt(qt.changedPesudoToSs,{PH1:t.changedPseudo,PH2:e})):t.selectorPart&&s.UIUtils.createTextChild(i,Xt(qt.changedSs,{PH1:t.selectorPart,extraData:e}))}}const r=new s.TreeOutline.TreeElement(e,!1);r.selectable=!1,this.appendChild(r)}getTruncatedNodesElement(e){const t=[],n={};for(let i=0;i<e.length;i++){const r=e[i],a=this.createInvalidationNode(r,!1);a.addEventListener("click",(e=>e.consume()),!1),a&&r.nodeId&&!n[r.nodeId]&&(t.push(a),n[r.nodeId]=!0)}if(1===t.length){const e=t[0];return e instanceof HTMLSpanElement?e:null}return 2===t.length?i.i18n.getFormatLocalizedString(Jt,qt.sAndS,{PH1:t[0],PH2:t[1]}):3===t.length?i.i18n.getFormatLocalizedString(Jt,qt.sAndSOther,{PH1:t[0],PH2:t[1]}):t.length>=4?i.i18n.getFormatLocalizedString(Jt,qt.sSAndSOthers,{PH1:t[0],PH2:t[1],PH3:String(t.length-2)}):null}createInvalidationNode(e,i){const n=e.nodeId&&this.relatedNodesMap?this.relatedNodesMap.get(e.nodeId):null;if(n){const e=document.createElement("span");return t.Linkifier.Linkifier.linkify(n).then((t=>e.appendChild(t))),e}if(e.nodeName){const t=document.createElement("span");return t.textContent=e.nodeName,t}if(i){const e=document.createElement("span");return s.UIUtils.createTextChild(e,Xt(qt.UnknownNode))}throw new Error("Unable to create invalidation node")}}const li=Symbol("previewElement");class di{priority;color;eventTypes;constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class ci{name;title;visible;childColor;color;hiddenInternal;constructor(e,t,i,n,r){this.name=e,this.title=t,this.visible=i,this.childColor=n,this.color=r,this.hidden=!1}get hidden(){return Boolean(this.hiddenInternal)}set hidden(e){this.hiddenInternal=e}}class hi{fragment;linkifierInternal;target;element;tableElement;constructor(e,t){this.fragment=document.createDocumentFragment(),this.linkifierInternal=t,this.target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this.tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),s.UIUtils.createTextChild(i,e)}this.tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this.linkifierInternal}appendTextRow(e,t){const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t.toString()}appendElementRow(e,t,i,n){const r=this.tableElement.createChild("div","timeline-details-view-row");i&&r.classList.add("timeline-details-warning"),n&&r.classList.add("timeline-details-stack-values");r.createChild("div","timeline-details-view-row-title").textContent=e;const a=r.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):s.UIUtils.createTextChild(a,t||"")}appendLocationRow(e,t,i,n){if(!this.linkifierInternal||!this.target)return;const r={tabStop:!0,className:void 0,columnNumber:n,showColumnNumber:!0,inlineFrameIndex:0,text:void 0,lineNumber:void 0,preventClick:void 0,maxLength:void 0,bypassURLTrimming:void 0},a=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,r);a&&this.appendElementRow(e,a)}appendLocationRange(e,t,i,r){if(!this.linkifierInternal||!this.target)return;const a=document.createElement("span"),o=this.linkifierInternal.maybeLinkifyScriptLocation(this.target,null,t,i,{tabStop:!0,className:void 0,inlineFrameIndex:0,columnNumber:void 0});o&&(a.appendChild(o),s.UIUtils.createTextChild(a,n.StringUtilities.sprintf(" [%s…%s]",i+1,(r||0)+1||"")),this.appendElementRow(e,a))}appendStackTrace(e,t){if(!this.linkifierInternal||!this.target)return;const i=this.tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,this.createChildStackTraceElement(i,t)}createChildStackTraceElement(e,t){if(!this.linkifierInternal||!this.target)return;e.classList.add("timeline-details-stack-values");const i=e.createChild("div","timeline-details-view-row-value timeline-details-view-row-stack-trace"),n=l.JSPresentationUtils.buildStackTracePreviewContents(this.target,this.linkifierInternal,{stackTrace:t,tabStops:!0});i.appendChild(n.element)}appendWarningRow(e,t){const i=ni.eventWarning(e,t);i&&this.appendElementRow(Xt(qt.warning),i,!0)}}const mi=Symbol("categoryBreakdownCache");function ui(e){let t=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=0,r=0,a=new Set;for(const s of e)if(!s.args.data.had_recent_input&&void 0!==s.args.data.weighted_score_delta){if(s.startTime-t>5e3||s.startTime-i>1e3){t=s.startTime;for(const e of a)e.args.data._current_cluster_score=r,e.args.data._current_cluster_id=n;n+=1,r=0,a=new Set}i=s.startTime,r+=s.args.data.weighted_score_delta,a.add(s)}for(const e of a)e.args.data._current_cluster_score=r,e.args.data._current_cluster_id=n}var pi,gi=Object.freeze({__proto__:null,TimelineUIUtils:ni,TimelineRecordStyle:ri,get NetworkCategory(){return ai},aggregatedStatsKey:si,InvalidationsGroupElement:oi,previewElementSymbol:li,EventDispatchTypeDescriptor:di,TimelineCategory:ci,TimelineDetailsContentHelper:hi,categoryBreakdownCacheSymbol:mi,assignLayoutShiftsToClusters:ui});class vi extends t.ObjectWrapper.ObjectWrapper{mainTargetInternal;tracingModelInternal;filtersInternal;timelineModelInternal;frameModelInternal;filmStripModelInternal;irModel;windowInternal;extensionTracingModels;recordStartTimeInternal;constructor(){super(),this.mainTargetInternal=null,this.tracingModelInternal=null,this.filtersInternal=[],this.timelineModelInternal=new r.TimelineModel.TimelineModelImpl,this.frameModelInternal=new r.TimelineFrameModel.TimelineFrameModel((e=>ni.eventStyle(e).category.name)),this.filmStripModelInternal=null,this.irModel=new r.TimelineIRModel.TimelineIRModel,this.windowInternal={left:0,right:1/0},this.extensionTracingModels=[],this.recordStartTimeInternal=void 0}setMainTarget(e){this.mainTargetInternal=e}mainTarget(){return this.mainTargetInternal}setRecordStartTime(e){this.recordStartTimeInternal=e}recordStartTime(){return this.recordStartTimeInternal}setFilters(e){this.filtersInternal=e}filters(){return this.filtersInternal}isVisible(e){return this.filtersInternal.every((t=>t.accept(e)))}setTracingModel(e){this.tracingModelInternal=e,this.timelineModelInternal.setEvents(e);let t=null,i=null;for(const e of this.timelineModelInternal.tracks())e.type===r.TimelineModel.TrackType.Input&&(t=e.asyncEvents),e.type===r.TimelineModel.TrackType.Animation&&(i=e.asyncEvents);(t||i)&&this.irModel.populate(t||[],i||[]);const n=this.timelineModelInternal.tracks().filter((e=>e.type===r.TimelineModel.TrackType.MainThread&&e.forMainFrame&&e.events.length)).map((e=>{const t=e.events[0];return{thread:t.thread,time:t.startTime}}));this.frameModelInternal.addTraceEvents(this.mainTargetInternal,this.timelineModelInternal.inspectedTargetEvents(),n);for(const e of this.extensionTracingModels)e.model.adjustTime(this.tracingModelInternal.minimumRecordTime()+e.timeOffset/1e3-this.recordStartTimeInternal);this.autoWindowTimes()}addExtensionEvents(e,t,i){this.extensionTracingModels.push({model:t,title:e,timeOffset:i}),this.tracingModelInternal&&(t.adjustTime(this.tracingModelInternal.minimumRecordTime()+i/1e3-this.recordStartTimeInternal),this.dispatchEventToListeners(pi.ExtensionDataAdded))}tracingModel(){if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.tracingModelInternal}timelineModel(){return this.timelineModelInternal}filmStripModel(){if(this.filmStripModelInternal)return this.filmStripModelInternal;if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.filmStripModelInternal=new e.FilmStripModel.FilmStripModel(this.tracingModelInternal),this.filmStripModelInternal}frames(){return this.frameModelInternal.getFrames()}frameModel(){return this.frameModelInternal}interactionRecords(){return this.irModel.interactionRecords()}extensionInfo(){return this.extensionTracingModels}dispose(){this.tracingModelInternal&&this.tracingModelInternal.dispose();for(const e of this.extensionTracingModels)e.model.dispose()}filmStripModelFrame(e){const t=e.idle?e.startTime:e.endTime,i=this.filmStripModelInternal.frameByTimestamp(t);return i&&i.timestamp-e.endTime<10?i:null}save(e){if(!this.tracingModelInternal)throw"call setTracingModel before accessing PerformanceModel";return this.tracingModelInternal.backingStorage().writeToStream(e)}setWindow(e,t){this.windowInternal=e,this.dispatchEventToListeners(pi.WindowChanged,{window:e,animate:t})}window(){return this.windowInternal}autoWindowTimes(){const e=this.timelineModelInternal;let t=[];for(const i of e.tracks())i.type===r.TimelineModel.TrackType.MainThread&&i.forMainFrame&&(t=i.tasks);if(!t.length)return void this.setWindow({left:e.minimumRecordTime(),right:e.maximumRecordTime()});function i(e,i){let n=e,r=(t[n].startTime+t[n].endTime)/2,a=0;const s=Math.sign(i-e);for(let o=e;o!==i;o+=s){const e=t[o],i=(e.startTime+e.endTime)/2;a<.1*Math.abs(r-i)&&(n=o,r=i,a=0),a+=e.duration}return n}const n=i(t.length-1,0),a=i(0,n);let s=t[a].startTime,o=t[n].endTime;const l=o-s;l<.1*(e.maximumRecordTime()-e.minimumRecordTime())?(s=e.minimumRecordTime(),o=e.maximumRecordTime()):(s=Math.max(s-.05*l,e.minimumRecordTime()),o=Math.min(o+.05*l,e.maximumRecordTime())),this.setWindow({left:s,right:o})}}!function(e){e.ExtensionDataAdded="ExtensionDataAdded",e.WindowChanged="WindowChanged"}(pi||(pi={}));var Ti=Object.freeze({__proto__:null,PerformanceModel:vi,get Events(){return pi}});const fi={jsHeap:"JS Heap",documents:"Documents",nodes:"Nodes",listeners:"Listeners",gpuMemory:"GPU Memory",ss:"[{PH1} – {PH2}]"},wi=i.i18n.registerUIStrings("panels/timeline/CountersGraph.ts",fi),Si=i.i18n.getLocalizedString.bind(void 0,wi);class bi extends s.Widget.VBox{delegate;calculator;model;header;toolbar;graphsContainer;canvasContainer;canvas;timelineGrid;counters;counterUI;countersByName;gpuMemoryCounter;track;currentValuesBar;markerXPosition;constructor(e){super(),this.element.id="memory-graphs-container",this.delegate=e,this.calculator=new ki,this.header=new s.Widget.HBox,this.header.element.classList.add("timeline-memory-header"),this.header.show(this.element),this.toolbar=new s.Toolbar.Toolbar("timeline-memory-toolbar"),this.header.element.appendChild(this.toolbar.element),this.graphsContainer=new s.Widget.VBox,this.graphsContainer.show(this.element);const t=new s.Widget.VBoxWithResizeCallback(this.resize.bind(this));t.show(this.graphsContainer.element),this.createCurrentValuesBar(),this.canvasContainer=t.element,this.canvasContainer.id="memory-graphs-canvas-container",this.canvas=document.createElement("canvas"),this.canvasContainer.appendChild(this.canvas),this.canvas.id="memory-counters-graph",this.canvasContainer.addEventListener("mouseover",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.canvasContainer.addEventListener("mouseleave",this.onMouseLeave.bind(this),!0),this.canvasContainer.addEventListener("click",this.onClick.bind(this),!0),this.timelineGrid=new a.TimelineGrid.TimelineGrid,this.canvasContainer.appendChild(this.timelineGrid.dividersElement),this.counters=[],this.counterUI=[],this.countersByName=new Map,this.countersByName.set("jsHeapSizeUsed",this.createCounter(Si(fi.jsHeap),"hsl(220, 90%, 43%)",n.NumberUtilities.bytesToString)),this.countersByName.set("documents",this.createCounter(Si(fi.documents),"hsl(0, 90%, 43%)")),this.countersByName.set("nodes",this.createCounter(Si(fi.nodes),"hsl(120, 90%, 43%)")),this.countersByName.set("jsEventListeners",this.createCounter(Si(fi.listeners),"hsl(38, 90%, 43%)")),this.gpuMemoryCounter=this.createCounter(Si(fi.gpuMemory),"hsl(300, 90%, 43%)",n.NumberUtilities.bytesToString),this.countersByName.set("gpuMemoryUsedKB",this.gpuMemoryCounter)}setModel(e,t){this.model!==e&&(this.model&&this.model.removeEventListener(pi.WindowChanged,this.onWindowChanged,this),this.model=e,this.model&&this.model.addEventListener(pi.WindowChanged,this.onWindowChanged,this)),this.calculator.setZeroTime(e?e.timelineModel().minimumRecordTime():0);for(let e=0;e<this.counters.length;++e)this.counters[e].reset(),this.counterUI[e].reset();if(this.scheduleRefresh(),this.track=t,!t)return;const i=t.syncEvents();for(let e=0;e<i.length;++e){const t=i[e];if(t.name!==r.TimelineModel.RecordType.UpdateCounters)continue;const n=t.args.data;if(!n)return;for(const e in n){const i=this.countersByName.get(e);i&&i.appendSample(t.startTime,n[e])}const a="gpuMemoryLimitKB";a in n&&this.gpuMemoryCounter.setLimit(n[a])}}createCurrentValuesBar(){this.currentValuesBar=this.graphsContainer.element.createChild("div"),this.currentValuesBar.id="counter-values-bar"}createCounter(e,t,i){const n=new yi;return this.counters.push(n),this.counterUI.push(new Ci(this,e,t,n,i)),n}resizerElement(){return this.header.element}resize(){const e=this.canvas.parentElement;this.canvas.width=e.clientWidth*window.devicePixelRatio,this.canvas.height=e.clientHeight*window.devicePixelRatio,this.calculator.setDisplayWidth(this.canvas.width),this.refresh()}onWindowChanged(e){const t=e.data.window;this.calculator.setWindow(t.left,t.right),this.scheduleRefresh()}scheduleRefresh(){s.UIUtils.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this.clear();for(const e of this.counters)e.calculateVisibleIndexes(this.calculator),e.calculateXValues(this.canvas.width);for(const e of this.counterUI)e.drawGraph(this.canvas)}onClick(e){const t=e.x-this.canvasContainer.totalOffsetLeft();let i,n=1/0;for(const e of this.counterUI){if(!e.counter.times.length)continue;const r=e.recordIndexAt(t),a=Math.abs(t*window.devicePixelRatio-e.counter.x[r]);a<n&&(n=a,i=e.counter.times[r])}void 0!==i&&this.track&&this.delegate.selectEntryAtTime(this.track.events.length?this.track.events:this.track.asyncEvents,i)}onMouseLeave(e){delete this.markerXPosition,this.clearCurrentValueAndMarker()}clearCurrentValueAndMarker(){for(let e=0;e<this.counterUI.length;e++)this.counterUI[e].clearCurrentValueAndMarker()}onMouseMove(e){const t=e.x-this.canvasContainer.totalOffsetLeft();this.markerXPosition=t,this.refreshCurrentValues()}refreshCurrentValues(){if(void 0!==this.markerXPosition)for(let e=0;e<this.counterUI.length;++e)this.counterUI[e].updateCurrentValue(this.markerXPosition)}refresh(){this.timelineGrid.updateDividers(this.calculator),this.draw(),this.refreshCurrentValues()}clear(){const e=this.canvas.getContext("2d");if(!e)throw new Error("Unable to get canvas context");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class yi{times;values;x;minimumIndex;maximumIndex;maxTime;minTime;limitValue;constructor(){this.times=[],this.values=[],this.x=[],this.minimumIndex=0,this.maximumIndex=0,this.maxTime=0,this.minTime=0}appendSample(e,t){this.values.length&&this.values[this.values.length-1]===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this.limitValue=e}calculateBounds(){let e,t;for(let i=this.minimumIndex;i<=this.maximumIndex;i++){const n=this.values[i];(void 0===t||n<t)&&(t=n),(void 0===e||n>e)&&(e=n)}return t=t||0,e=e||1,this.limitValue&&(e>.5*this.limitValue&&(e=Math.max(e,this.limitValue)),t=Math.min(t,this.limitValue)),{min:t,max:e}}calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this.minimumIndex=n.NumberUtilities.clamp(n.ArrayUtilities.upperBound(this.times,t,n.ArrayUtilities.DEFAULT_COMPARATOR)-1,0,this.times.length-1),this.maximumIndex=n.NumberUtilities.clamp(n.ArrayUtilities.lowerBound(this.times,i,n.ArrayUtilities.DEFAULT_COMPARATOR),0,this.times.length-1),this.minTime=t,this.maxTime=i}calculateXValues(e){if(!this.values.length)return;const t=e/(this.maxTime-this.minTime);this.x=new Array(this.values.length);for(let e=this.minimumIndex+1;e<=this.maximumIndex;e++)this.x[e]=t*(this.times[e]-this.minTime)}}class Ci{countersPane;counter;formatter;setting;filter;range;value;graphColor;limitColor;graphYValues;verticalPadding;currentValueLabel;marker;constructor(e,i,r,a,o){this.countersPane=e,this.counter=a,this.formatter=o||n.NumberUtilities.withThousandsSeparator,this.setting=t.Settings.Settings.instance().createSetting("timelineCountersGraph-"+i,!0),this.setting.setTitle(i),this.filter=new s.Toolbar.ToolbarSettingCheckbox(this.setting,i),this.filter.inputElement.classList.add("-theme-preserve-input");const l=t.Color.Color.parse(r);if(l){const e=l.setAlpha(.5).asString(t.Color.Format.RGBA),i=this.filter.element;e&&(i.style.backgroundColor=e),i.style.borderColor="transparent"}this.filter.inputElement.addEventListener("click",this.toggleCounterGraph.bind(this)),e.toolbar.appendToolbarItem(this.filter),this.range=this.filter.element.createChild("span","range"),this.value=e.currentValuesBar.createChild("span","memory-counter-value"),this.value.style.color=r,this.graphColor=r,l&&(this.limitColor=l.setAlpha(.3).asString(t.Color.Format.RGBA)),this.graphYValues=[],this.verticalPadding=10,this.currentValueLabel=i,this.marker=e.canvasContainer.createChild("div","memory-counter-marker"),this.marker.style.backgroundColor=r,this.clearCurrentValueAndMarker()}reset(){this.range.textContent=""}setRange(e,t){const i=this.formatter(e),n=this.formatter(t);this.range.textContent=Si(fi.ss,{PH1:i,PH2:n})}toggleCounterGraph(){this.value.classList.toggle("hidden",!this.filter.checked()),this.countersPane.refresh()}recordIndexAt(e){return n.ArrayUtilities.upperBound(this.counter.x,e*window.devicePixelRatio,n.ArrayUtilities.DEFAULT_COMPARATOR,this.counter.minimumIndex+1,this.counter.maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this.recordIndexAt(e),i=n.NumberUtilities.withThousandsSeparator(this.counter.values[t]);this.value.textContent=`${this.currentValueLabel}: ${i}`;const r=this.graphYValues[t]/window.devicePixelRatio;this.marker.style.left=e+"px",this.marker.style.top=r+"px",this.marker.classList.remove("hidden")}clearCurrentValueAndMarker(){this.value.textContent="",this.marker.classList.add("hidden")}drawGraph(e){const t=e.getContext("2d");if(!t)throw new Error("Unable to get canvas context");const i=e.width,n=e.height-2*this.verticalPadding;if(n<=0)return void(this.graphYValues=[]);const r=this.verticalPadding,a=this.counter,s=a.values;if(!s.length)return;const o=a.calculateBounds(),l=o.min,d=o.max;if(this.setRange(l,d),!this.visible())return;const c=this.graphYValues,h=d-l,m=h?n/h:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let u=s[a.minimumIndex],p=Math.round(r+n-(u-l)*m);t.moveTo(0,p);let g=a.minimumIndex;for(;g<=a.maximumIndex;g++){const e=Math.round(a.x[g]);t.lineTo(e,p);const i=s[g];void 0!==i&&(u=i),p=Math.round(r+n-(u-l)*m),t.lineTo(e,p),c[g]=p}if(c.length=g,t.lineTo(i,p),t.strokeStyle=this.graphColor,t.stroke(),a.limitValue){const e=Math.round(r+n-(a.limitValue-l)*m);t.moveTo(0,e),t.lineTo(i,e),this.limitColor&&(t.strokeStyle=this.limitColor),t.stroke()}t.closePath(),t.restore()}visible(){return this.filter.checked()}}class ki{minimumBoundaryInternal;maximumBoundaryInternal;workingArea;zeroTimeInternal;constructor(){this.minimumBoundaryInternal=0,this.maximumBoundaryInternal=0,this.workingArea=0,this.zeroTimeInternal=0}setZeroTime(e){this.zeroTimeInternal=e}computePosition(e){return(e-this.minimumBoundaryInternal)/this.boundarySpan()*this.workingArea}setWindow(e,t){this.minimumBoundaryInternal=e,this.maximumBoundaryInternal=t}setDisplayWidth(e){this.workingArea=e}formatValue(e,t){return i.TimeUtilities.preciseMillisToString(e-this.zeroTime(),t)}maximumBoundary(){return this.maximumBoundaryInternal}minimumBoundary(){return this.minimumBoundaryInternal}zeroTime(){return this.zeroTimeInternal}boundarySpan(){return this.maximumBoundaryInternal-this.minimumBoundaryInternal}}var Mi=Object.freeze({__proto__:null,CountersGraph:bi,Counter:yi,CounterUI:Ci,Calculator:ki});export{y as CLSLinkifier,Mi as CountersGraph,ke as EventsTimelineTreeView,W as ExtensionTracingSession,Ti as PerformanceModel,z as TimelineController,We as TimelineDetailsView,ie as TimelineEventOverview,se as TimelineFilters,Je as TimelineFlameChartDataProvider,Qe as TimelineFlameChartNetworkDataProvider,dt as TimelineFlameChartView,St as TimelineHistoryManager,Pe as TimelineLayersView,U as TimelineLoader,Ee as TimelinePaintProfilerView,jt as TimelinePanel,fe as TimelineTreeView,gi as TimelineUIUtils,Et as UIDevtoolsController,Rt as UIDevtoolsUtils};
