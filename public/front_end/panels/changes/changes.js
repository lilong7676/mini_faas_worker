import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as i from"../../core/root/root.js";import*as o from"../../third_party/diff/diff.js";import*as r from"../../ui/components/diff_view/diff_view.js";import*as s from"../../ui/legacy/legacy.js";import*as n from"../../models/workspace_diff/workspace_diff.js";import*as a from"../../core/platform/platform.js";import*as c from"../../models/workspace/workspace.js";import*as d from"../snippets/snippets.js";const l=new CSSStyleSheet;l.replaceSync("[slot=insertion-point-main]{flex-direction:column;display:flex}[slot=insertion-point-sidebar]{overflow:auto}.diff-container{flex:1;overflow:auto}:focus.selected{--override-selected-color:#fff;background-color:var(--legacy-selection-bg-color);color:var(--override-selected-color)}.-theme-with-dark-background :focus.selected,:host-context(.-theme-with-dark-background) :focus.selected{--override-selected-color:rgb(0 0 0)}.changes-toolbar{background-color:var(--color-background-elevation-1);border-top:var(--legacy-divider-border)}\n/*# sourceURL=changesView.css */\n");const h=new CSSStyleSheet;h.replaceSync(".tree-outline{--override-script-snippet-tree-item-color:hsl(48deg 70% 50%);--override-stylesheet-tree-item-color:hsl(256deg 50% 50%);--override-image-font-tree-item-color:hsl(109deg 33% 50%)}.-theme-with-dark-background .tree-outline,:host-context(.-theme-with-dark-background) .tree-outline{--override-script-snippet-tree-item-color:rgb(217 181 38);--override-stylesheet-tree-item-color:rgb(98 64 191);--override-image-font-tree-item-color:rgb(101 170 85)}li .icon{margin:-3px -5px;background:var(--color-background-elevation-2)}.tree-outline li{min-height:20px}.tree-outline li:hover:not(.selected) .selection{display:block;background-color:var(--item-hover-color)}.navigator-script-tree-item .icon,.navigator-sm-script-tree-item .icon,.navigator-snippet-tree-item .icon{background:var(--override-script-snippet-tree-item-color)}.navigator-sm-stylesheet-tree-item .icon,.navigator-stylesheet-tree-item .icon{background:var(--override-stylesheet-tree-item-color)}.navigator-font-tree-item .icon,.navigator-image-tree-item .icon{background:var(--override-image-font-tree-item-color)}@media (forced-colors:active){.navigator-font-tree-item .icon,.navigator-image-tree-item .icon,.navigator-script-tree-item .icon,.navigator-sm-script-tree-item .icon,.navigator-sm-stylesheet-tree-item .icon,.navigator-snippet-tree-item .icon,.navigator-stylesheet-tree-item .icon,li .icon{background-color:ButtonText;background-image:none;forced-color-adjust:none}}\n/*# sourceURL=changesSidebar.css */\n");const f={sFromSourceMap:"{PH1} (from source map)"},u=t.i18n.registerUIStrings("panels/changes/ChangesSidebar.ts",f),g=t.i18n.getLocalizedString.bind(void 0,u);class m extends(e.ObjectWrapper.eventMixin(s.Widget.Widget)){treeoutline;treeElements;workspaceDiff;constructor(e){super(),this.treeoutline=new s.TreeOutline.TreeOutlineInShadow,this.treeoutline.setFocusable(!1),this.treeoutline.setComparator(((e,t)=>a.StringUtilities.compare(e.titleAsText(),t.titleAsText()))),this.treeoutline.addEventListener(s.TreeOutline.Events.ElementSelected,this.selectionChanged,this),s.ARIAUtils.markAsTablist(this.treeoutline.contentElement),this.element.appendChild(this.treeoutline.element),this.treeElements=new Map,this.workspaceDiff=e,this.workspaceDiff.modifiedUISourceCodes().forEach(this.addUISourceCode.bind(this)),this.workspaceDiff.addEventListener("ModifiedStatusChanged",this.uiSourceCodeMofiedStatusChanged,this)}selectUISourceCode(e,t){const i=this.treeElements.get(e);i&&i.select(t)}selectedUISourceCode(){return this.treeoutline.selectedTreeElement?this.treeoutline.selectedTreeElement.uiSourceCode:null}selectionChanged(){this.dispatchEventToListeners("SelectedUISourceCodeChanged")}uiSourceCodeMofiedStatusChanged(e){e.data.isModified?this.addUISourceCode(e.data.uiSourceCode):this.removeUISourceCode(e.data.uiSourceCode)}removeUISourceCode(e){const t=this.treeElements.get(e);if(this.treeElements.delete(e),this.treeoutline.selectedTreeElement===t){const e=t.previousSibling||t.nextSibling;e?e.select(!0):(t.deselect(),this.selectionChanged())}t&&(this.treeoutline.removeChild(t),t.dispose()),0===this.treeoutline.rootElement().childCount()&&this.treeoutline.setFocusable(!1)}addUISourceCode(e){const t=new p(e);this.treeElements.set(e,t),this.treeoutline.setFocusable(!0),this.treeoutline.appendChild(t),this.treeoutline.selectedTreeElement||t.select(!0)}wasShown(){super.wasShown(),this.treeoutline.registerCSSFiles([h])}}class p extends s.TreeOutline.TreeElement{uiSourceCode;eventListeners;constructor(e){super(),this.uiSourceCode=e,this.listItemElement.classList.add("navigator-"+e.contentType().name()+"-tree-item"),s.ARIAUtils.markAsTab(this.listItemElement);let t="largeicon-navigator-file";d.ScriptSnippetFileSystem.isSnippetsUISourceCode(this.uiSourceCode)&&(t="largeicon-navigator-snippet");const i=s.Icon.Icon.create(t,"icon");this.setLeadingIcons([i]),this.eventListeners=[e.addEventListener(c.UISourceCode.Events.TitleChanged,this.updateTitle,this),e.addEventListener(c.UISourceCode.Events.WorkingCopyChanged,this.updateTitle,this),e.addEventListener(c.UISourceCode.Events.WorkingCopyCommitted,this.updateTitle,this)],this.updateTitle()}updateTitle(){let e=this.uiSourceCode.displayName();this.uiSourceCode.isDirty()&&(e="*"+e),this.title=e;let t=this.uiSourceCode.url();this.uiSourceCode.contentType().isFromSourceMap()&&(t=g(f.sFromSourceMap,{PH1:this.uiSourceCode.displayName()})),this.tooltip=t}dispose(){e.EventTarget.removeEventListeners(this.eventListeners)}}var S=Object.freeze({__proto__:null,ChangesSidebar:m,UISourceCodeTreeElement:p});const C={revertAllChangesToCurrentFile:"Revert all changes to current file",noChanges:"No changes",binaryData:"Binary data",sInsertions:"{n, plural, =1 {# insertion (+)} other {# insertions (+)}}",sDeletions:"{n, plural, =1 {# deletion (-)} other {# deletions (-)}}"},v=t.i18n.registerUIStrings("panels/changes/ChangesView.ts",C),b=t.i18n.getLocalizedString.bind(void 0,v);let w,I;class k extends s.Widget.VBox{emptyWidget;workspaceDiff;changesSidebar;selectedUISourceCode;diffContainer;toolbar;diffStats;diffView;constructor(){super(!0);const e=new s.SplitWidget.SplitWidget(!0,!1),t=new s.Widget.Widget;e.setMainWidget(t),e.show(this.contentElement),this.emptyWidget=new s.EmptyWidget.EmptyWidget(""),this.emptyWidget.show(t.element),this.workspaceDiff=n.WorkspaceDiff.workspaceDiff(),this.changesSidebar=new m(this.workspaceDiff),this.changesSidebar.addEventListener("SelectedUISourceCodeChanged",this.selectedUISourceCodeChanged,this),e.setSidebarWidget(this.changesSidebar),this.selectedUISourceCode=null,this.diffContainer=t.element.createChild("div","diff-container"),s.ARIAUtils.markAsTabpanel(this.diffContainer),this.diffContainer.addEventListener("click",(e=>this.click(e))),this.diffView=this.diffContainer.appendChild(new r.DiffView.DiffView),this.toolbar=new s.Toolbar.Toolbar("changes-toolbar",t.element);const i=new s.Toolbar.ToolbarButton(b(C.revertAllChangesToCurrentFile),"largeicon-undo");i.addEventListener(s.Toolbar.ToolbarButton.Events.Click,this.revert.bind(this)),this.toolbar.appendToolbarItem(i),this.diffStats=new s.Toolbar.ToolbarText(""),this.toolbar.appendToolbarItem(this.diffStats),this.toolbar.setEnabled(!1),this.hideDiff(b(C.noChanges)),this.selectedUISourceCodeChanged()}static instance(e={forceNew:null}){const{forceNew:t}=e;return w&&!t||(w=new k),w}selectedUISourceCodeChanged(){this.revealUISourceCode(this.changesSidebar.selectedUISourceCode())}revert(){const e=this.selectedUISourceCode;e&&this.workspaceDiff.revertToOriginal(e)}click(t){if(this.selectedUISourceCode)for(let i=t.target;i;i=i.parentElement){if(i.classList.contains("diff-line-content")){const o=i.getAttribute("data-line-number");o&&(e.Revealer.reveal(this.selectedUISourceCode.uiLocation(Number(o)-1,0),!1),t.consume(!0));break}if(i.classList.contains("diff-listing"))break}}revealUISourceCode(e){this.selectedUISourceCode!==e&&(this.selectedUISourceCode&&this.workspaceDiff.unsubscribeFromDiffChange(this.selectedUISourceCode,this.refreshDiff,this),e&&this.isShowing()&&this.workspaceDiff.subscribeToDiffChange(e,this.refreshDiff,this),this.selectedUISourceCode=e,this.refreshDiff())}wasShown(){this.refreshDiff(),this.registerCSSFiles([l])}async refreshDiff(){if(!this.isShowing())return;if(!this.selectedUISourceCode)return void this.renderDiffRows(null);const e=this.selectedUISourceCode;if(!e.contentType().isTextType())return void this.hideDiff(b(C.binaryData));const t=await this.workspaceDiff.requestDiff(e,{shouldFormatDiff:i.Runtime.experiments.isEnabled("preciseChanges")});this.selectedUISourceCode===e&&this.renderDiffRows(t)}hideDiff(e){this.diffStats.setText(""),this.toolbar.setEnabled(!1),this.diffContainer.style.display="none",this.emptyWidget.text=e,this.emptyWidget.showWidget()}renderDiffRows(e){if(!e||1===e.length&&e[0][0]===o.Diff.Operation.Equal)this.hideDiff(b(C.noChanges));else{this.diffStats.setText(function(e){const t=e.reduce(((e,t)=>e+(t[0]===o.Diff.Operation.Insert?t[1].length:0)),0),i=e.reduce(((e,t)=>e+(t[0]===o.Diff.Operation.Delete?t[1].length:0)),0),r=b(C.sDeletions,{n:i});return`${b(C.sInsertions,{n:t})}, ${r}`}(e)),this.toolbar.setEnabled(!0),this.emptyWidget.hideWidget();const t=this.selectedUISourceCode.mimeType();this.diffContainer.style.display="block",this.diffView.data={diff:e,mimeType:t}}}}class T{static instance(e={forceNew:!1}){const{forceNew:t}=e;return I&&!t||(I=new T),I}async reveal(e,t){if(!(e instanceof n.WorkspaceDiff.DiffUILocation))throw new Error("Internal error: not a diff ui location");await s.ViewManager.ViewManager.instance().showView("changes.changes"),k.instance().changesSidebar.selectUISourceCode(e.uiSourceCode,t)}}var y=Object.freeze({__proto__:null,ChangesView:k,DiffUILocationRevealer:T});export{S as ChangesSidebar,y as ChangesView};
