import*as e from"../../core/common/common.js";import*as t from"../../core/host/host.js";import*as i from"../../core/i18n/i18n.js";import*as o from"../../core/platform/platform.js";import*as r from"../../core/sdk/sdk.js";import*as s from"../../ui/legacy/legacy.js";import*as n from"../../ui/legacy/theme_support/theme_support.js";const a=new CSSStyleSheet;a.replaceSync(".perfmon-pane{overflow:hidden}.perfmon-pane.suspended{opacity:40%;pointer-events:none}.perfmon-pane .perfmon-chart-suspend-overlay{display:none;font-size:26px;align-items:center;justify-content:center}.perfmon-pane.suspended .perfmon-chart-suspend-overlay{display:flex}.perfmon-control-pane{display:flex;flex-direction:column;padding:6px 0;overflow-x:hidden;overflow-y:auto}.perfmon-chart-container{display:flex;flex:1 1;border-left:1px solid var(--color-details-hairline);overflow-y:auto}.perfmon-chart-container canvas{width:100%}.perfmon-indicator{padding:6px 12px;margin:-1px 0;display:flex;flex-shrink:0;width:210px}.perfmon-indicator:hover{background-color:var(--color-background-elevation-0)}.perfmon-indicator:focus-visible{background-color:var(--color-background-elevation-1)}.perfmon-indicator-swatch{margin-right:6px}.perfmon-indicator:not(.active) .perfmon-indicator-swatch{background-color:var(--color-background-elevation-2)!important}.perfmon-indicator-title{flex:0 0 115px}.perfmon-indicator:not(.active) .perfmon-indicator-title{color:var(--color-text-secondary)}.perfmon-indicator-value{flex:0 0 55px;text-align:right;overflow:visible}.perfmon-indicator:not(.active) .perfmon-indicator-value{opacity:0%}\n/*# sourceURL=performanceMonitor.css */\n");const l={graphsDisplayingARealtimeViewOf:"Graphs displaying a real-time view of performance metrics",paused:"Paused",cpuUsage:"CPU usage",jsHeapSize:"JS heap size",domNodes:"DOM Nodes",jsEventListeners:"JS event listeners",documents:"Documents",documentFrames:"Document Frames",layoutsSec:"Layouts / sec",styleRecalcsSec:"Style recalcs / sec"},c=i.i18n.registerUIStrings("panels/performance_monitor/PerformanceMonitor.ts",l),h=i.i18n.getLocalizedString.bind(void 0,c);let m,d,p;class g extends s.Widget.HBox{metricsBuffer;pixelsPerMs;pollIntervalMs;scaleHeight;graphHeight;gridColor;controlPane;canvas;animationId;width;height;model;startTimestamp;pollTimer;constructor(){super(!0),this.contentElement.classList.add("perfmon-pane"),this.metricsBuffer=[],this.pixelsPerMs=.01,this.pollIntervalMs=500,this.scaleHeight=16,this.graphHeight=90,this.gridColor=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.08)",n.ThemeSupport.ColorUsage.Foreground),this.controlPane=new f(this.contentElement);const e=this.contentElement.createChild("div","perfmon-chart-container");this.canvas=e.createChild("canvas"),this.canvas.tabIndex=-1,s.ARIAUtils.setAccessibleName(this.canvas,h(l.graphsDisplayingARealtimeViewOf)),this.contentElement.createChild("div","perfmon-chart-suspend-overlay fill").createChild("div").textContent=h(l.paused),this.controlPane.addEventListener("MetricChanged",this.recalcChartHeight,this),r.TargetManager.TargetManager.instance().observeModels(r.PerformanceMetricsModel.PerformanceMetricsModel,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return m&&!t||(m=new g),m}wasShown(){this.model&&(this.registerCSSFiles([a]),r.TargetManager.TargetManager.instance().addEventListener(r.TargetManager.Events.SuspendStateChanged,this.suspendStateChanged,this),this.model.enable(),this.suspendStateChanged())}willHide(){this.model&&(r.TargetManager.TargetManager.instance().removeEventListener(r.TargetManager.Events.SuspendStateChanged,this.suspendStateChanged,this),this.stopPolling(),this.model.disable())}modelAdded(e){this.model||(this.model=e,this.isShowing()&&this.wasShown())}modelRemoved(e){this.model===e&&(this.isShowing()&&this.willHide(),this.model=null)}suspendStateChanged(){const e=r.TargetManager.TargetManager.instance().allTargetsSuspended();e?this.stopPolling():this.startPolling(),this.contentElement.classList.toggle("suspended",e)}startPolling(){this.startTimestamp=0,this.pollTimer=window.setInterval((()=>this.poll()),this.pollIntervalMs),this.onResize();const e=()=>{this.draw(),this.animationId=this.contentElement.window().requestAnimationFrame((()=>{e()}))};e()}stopPolling(){window.clearInterval(this.pollTimer),this.contentElement.window().cancelAnimationFrame(this.animationId),this.metricsBuffer=[]}async poll(){if(!this.model)return;const e=await this.model.requestMetrics(),t=e.timestamp,i=e.metrics;this.metricsBuffer.push({timestamp:t,metrics:i});const o=this.width/this.pixelsPerMs,r=Math.ceil(o/this.pollIntervalMs*2);this.metricsBuffer.length>2*r&&this.metricsBuffer.splice(0,this.metricsBuffer.length-r),this.controlPane.updateMetrics(i)}draw(){const e=this.canvas.getContext("2d");e.save(),e.scale(window.devicePixelRatio,window.devicePixelRatio),e.clearRect(0,0,this.width,this.height),e.save(),e.translate(0,this.scaleHeight);for(const t of this.controlPane.charts())this.controlPane.isActive(t.metrics[0].name)&&(this.drawChart(e,t,this.graphHeight),e.translate(0,this.graphHeight));e.restore(),this.drawHorizontalGrid(e),e.restore()}drawHorizontalGrid(e){const i=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.02)",n.ThemeSupport.ColorUsage.Foreground);e.font="10px "+t.Platform.fontFamily(),e.fillStyle=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.55)",n.ThemeSupport.ColorUsage.Foreground);const o=Date.now()/1e3;for(let t=Math.ceil(o);;--t){const r=this.width-(1e3*(o-t)-this.pollIntervalMs)*this.pixelsPerMs;if(r<-50)break;e.beginPath(),e.moveTo(r,0),e.lineTo(r,this.height),t>=0&&t%10==0&&e.fillText(new Date(1e3*t).toLocaleTimeString(),r+4,12),e.strokeStyle=t%10?i:this.gridColor,e.stroke()}}drawChart(i,o,r){i.save(),i.rect(0,0,this.width,r),i.clip();const a=1.05*this.calcMax(o),l=o.stacked?new Map:null,c=[];for(let e=o.metrics.length-1;e>=0;--e){const t=o.metrics[e];c.push({path:this.buildMetricPath(o,t,r-8,a,e?l:null),color:t.color})}const h=e.Color.Color.parse(s.Utils.getThemeColorValue("--color-background"));if(h)for(const t of c.reverse()){const o=t.color;i.save();const r=e.Color.Color.parse(o);r&&(i.fillStyle=h.blendWith(r.setAlpha(.2)).asString(null)||"",i.fill(t.path),i.strokeStyle=o,i.lineWidth=.5,i.stroke(t.path),i.restore())}i.fillStyle=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.55)",n.ThemeSupport.ColorUsage.Foreground),i.font=`10px  ${t.Platform.fontFamily()}`,i.fillText(o.title,8,10),this.drawVerticalGrid(i,r-8,a,o),i.restore()}calcMax(e){if(e.max)return e.max;const t=this.width,i=performance.now()-this.pollIntervalMs-t/this.pixelsPerMs;let o=-1/0;for(const t of e.metrics)for(let e=this.metricsBuffer.length-1;e>=0;--e){const r=this.metricsBuffer[e],s=r.metrics.get(t.name);if(void 0!==s&&(o=Math.max(o,s)),r.timestamp<i)break}if(!this.metricsBuffer.length)return 10;const r=Math.pow(10,Math.floor(Math.log10(o)));o=Math.ceil(o/r/2)*r*2;return e.currentMax=.2*o+.8*(e.currentMax||o),e.currentMax}drawVerticalGrid(e,t,i,o){let r=Math.pow(10,Math.floor(Math.log10(i)));const s=Math.floor(i/r);1!==s&&s%2==1&&(r*=2);let a=Math.floor(i/r)*r;const l=i,c=t-18;e.fillStyle=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.55)",n.ThemeSupport.ColorUsage.Foreground),e.strokeStyle=this.gridColor,e.beginPath();for(let t=0;t<2;++t){const t=h(a),i=u.formatNumber(a,o);e.moveTo(0,t),e.lineTo(4,t),e.moveTo(e.measureText(i).width+12,t),e.lineTo(this.width,t),e.fillText(i,8,h(a)+3),a/=2}function h(e){return Math.round(t-c*e/l)+.5}e.stroke(),e.beginPath(),e.moveTo(0,t+.5),e.lineTo(this.width,t+.5),e.strokeStyle=n.ThemeSupport.instance().patchColorText("rgba(0, 0, 0, 0.2)",n.ThemeSupport.ColorUsage.Foreground),e.stroke()}buildMetricPath(e,t,i,r,s){const n=new Path2D,a=i-18;if(a<1)return n;const l=r,c=t.name,h=this.pixelsPerMs,m=performance.now()-this.pollIntervalMs-this.width/h,d=e.smooth;let p=0,g=0,f=0;this.metricsBuffer.length&&(p=(this.metricsBuffer[0].timestamp-m)*h,n.moveTo(p,u(0)),n.lineTo(this.width+5,u(0)),g=u(this.metricsBuffer[this.metricsBuffer.length-1].metrics.get(c)||0),f=this.width+5,n.lineTo(f,g));for(let e=this.metricsBuffer.length-1;e>=0;--e){const t=this.metricsBuffer[e],i=t.timestamp;let r=t.metrics.get(c)||0;s&&(r+=s.get(i)||0,r=o.NumberUtilities.clamp(r,0,1),s.set(i,r));const a=u(r);if(p=(i-m)*h,d){const e=(f+p)/2;n.bezierCurveTo(e,g,e,a,p,a)}else n.lineTo(p,g),n.lineTo(p,a);if(f=p,g=a,i<m)break}return n;function u(e){return Math.round(i-a*e/l)+.5}}onResize(){super.onResize(),this.width=this.canvas.offsetWidth,this.canvas.width=Math.round(this.width*window.devicePixelRatio),this.recalcChartHeight()}recalcChartHeight(){let e=this.scaleHeight;for(const t of this.controlPane.charts())this.controlPane.isActive(t.metrics[0].name)&&(e+=this.graphHeight);this.height=Math.ceil(e*window.devicePixelRatio),this.canvas.height=this.height,this.canvas.style.height=this.height/window.devicePixelRatio+"px"}}class f extends e.ObjectWrapper.ObjectWrapper{element;enabledChartsSetting;enabledCharts;chartsInfo;indicators;constructor(t){super(),this.element=t.createChild("div","perfmon-control-pane"),this.enabledChartsSetting=e.Settings.Settings.instance().createSetting("perfmonActiveIndicators2",["TaskDuration","JSHeapTotalSize","Nodes"]),this.enabledCharts=new Set(this.enabledChartsSetting.get());const i={color:void 0,format:void 0,currentMax:void 0,max:void 0,smooth:void 0,stacked:void 0};this.chartsInfo=[{...i,title:h(l.cpuUsage),metrics:[{name:"TaskDuration",color:"#999"},{name:"ScriptDuration",color:"orange"},{name:"LayoutDuration",color:"blueviolet"},{name:"RecalcStyleDuration",color:"violet"}],format:"Percent",smooth:!0,stacked:!0,color:"red",max:1,currentMax:void 0},{...i,title:h(l.jsHeapSize),metrics:[{name:"JSHeapTotalSize",color:"#99f"},{name:"JSHeapUsedSize",color:"blue"}],format:"Bytes",color:"blue"},{...i,title:h(l.domNodes),metrics:[{name:"Nodes",color:"green"}]},{...i,title:h(l.jsEventListeners),metrics:[{name:"JSEventListeners",color:"yellowgreen"}]},{...i,title:h(l.documents),metrics:[{name:"Documents",color:"darkblue"}]},{...i,title:h(l.documentFrames),metrics:[{name:"Frames",color:"darkcyan"}]},{...i,title:h(l.layoutsSec),metrics:[{name:"LayoutCount",color:"hotpink"}]},{...i,title:h(l.styleRecalcsSec),metrics:[{name:"RecalcStyleCount",color:"deeppink"}]}];for(const e of this.chartsInfo){e.color&&(e.color=n.ThemeSupport.instance().patchColorText(e.color,n.ThemeSupport.ColorUsage.Foreground));for(const t of e.metrics)t.color=n.ThemeSupport.instance().patchColorText(t.color,n.ThemeSupport.ColorUsage.Foreground)}this.indicators=new Map;for(const e of this.chartsInfo){const t=e.metrics[0].name,i=this.enabledCharts.has(t),o=new u(this.element,e,i,this.onToggle.bind(this,t));this.indicators.set(t,o)}}onToggle(e,t){t?this.enabledCharts.add(e):this.enabledCharts.delete(e),this.enabledChartsSetting.set(Array.from(this.enabledCharts)),this.dispatchEventToListeners("MetricChanged")}charts(){return this.chartsInfo}isActive(e){return this.enabledCharts.has(e)}updateMetrics(e){for(const t of this.indicators.keys()){const i=e.get(t);if(void 0!==i){const e=this.indicators.get(t);e&&e.setValue(i)}}}}class u{info;active;onToggle;element;swatchElement;valueElement;constructor(e,t,i,o){const r=t.color||t.metrics[0].color;this.info=t,this.active=i,this.onToggle=o,this.element=e.createChild("div","perfmon-indicator"),this.swatchElement=s.Icon.Icon.create("smallicon-checkmark-square","perfmon-indicator-swatch"),this.swatchElement.style.backgroundColor=r,this.element.appendChild(this.swatchElement),this.element.createChild("div","perfmon-indicator-title").textContent=t.title,this.valueElement=this.element.createChild("div","perfmon-indicator-value"),this.valueElement.style.color=r,this.element.addEventListener("click",(()=>this.toggleIndicator())),this.element.addEventListener("keypress",(e=>this.handleKeypress(e))),this.element.classList.toggle("active",i),s.ARIAUtils.markAsCheckbox(this.element),s.ARIAUtils.setChecked(this.element,this.active),this.element.tabIndex=0}static formatNumber(e,t){switch(d||(d=new Intl.NumberFormat("en-US",{maximumFractionDigits:1}),p=new Intl.NumberFormat("en-US",{maximumFractionDigits:1,style:"percent"})),t.format){case"Percent":return p.format(e);case"Bytes":return o.NumberUtilities.bytesToString(e);default:return d.format(e)}}setValue(e){this.valueElement.textContent=u.formatNumber(e,this.info)}toggleIndicator(){this.active=!this.active,this.element.classList.toggle("active",this.active),s.ARIAUtils.setChecked(this.element,this.active),this.onToggle(this.active)}handleKeypress(e){const t=e;" "!==t.key&&"Enter"!==t.key||this.toggleIndicator()}}const v=new Intl.NumberFormat("en-US",{maximumFractionDigits:1});var w=Object.freeze({__proto__:null,PerformanceMonitorImpl:g,ControlPane:f,MetricIndicator:u,format:v});export{w as PerformanceMonitor};
