import*as t from"../../core/common/common.js";import*as e from"../../core/host/host.js";import*as i from"../../core/i18n/i18n.js";import*as a from"../../core/sdk/sdk.js";import*as n from"../../ui/legacy/components/data_grid/data_grid.js";import*as o from"../../ui/legacy/legacy.js";const r=new CSSStyleSheet;r.replaceSync(".webauthn-pane{overflow:auto;min-width:500px}.webauthn-toolbar-container{display:flex;background-color:var(--color-background-elevation-1);border-bottom:var(--legacy-divider-border);flex:0 0 auto}.webauthn-toolbar{border-bottom:var(--legacy-divider-border);display:inline-block}.authenticators-view{margin:0 10px;min-height:auto;display:none}.webauthn-pane.enabled .authenticators-view{display:block}.new-authenticator-title{line-height:24px;font-weight:700;display:block}.new-authenticator-container{display:none;margin:10px}.webauthn-pane.enabled .new-authenticator-container{display:block}.new-authenticator-form{border:none;padding:10px 0;flex:0 0 auto;margin:0}.webauthn-pane .chrome-select{width:120px}.authenticator-section{display:block;padding:16px 0;border-bottom:1px solid var(--color-details-hairline)}.authenticator-fields{border:none;padding:10px 0;flex:0 0 auto;margin:0}.authenticator-field{display:flex;margin:auto}.authenticator-section-title{line-height:24px;width:260px;display:inline-block}.authenticator-section-title .authenticator-name-field{width:220px;display:inline-block;font-weight:700;border:none;animation:save-flash .2s;text-overflow:ellipsis}.authenticator-section-title.editing-name .authenticator-name-field{border-bottom:1px solid var(--input-outline);font-weight:400;animation:none}.authenticator-field-value{padding:5px 0;display:inline-block;font-family:monospace}.authenticator-option-checkbox{position:relative;top:2px}.authenticator-option{display:flex;padding-bottom:10px;margin:auto}.authenticator-option-label{text-align:right;width:200px;display:inline-block;padding:5px 10px 0 0}.text-button{float:right;white-space:nowrap;overflow:hidden;min-width:28px;background:0 0;border:none;color:var(--color-link);text-decoration:underline;cursor:pointer}td .text-button{min-width:20px;margin:auto}.active-button-container{display:inline-block;min-width:28px}.edit-name-toolbar{display:inline-block;vertical-align:middle}@keyframes save-flash{from{opacity:0%}to{opacity:100%}}.data-grid-data-grid-node.centered{text-align:center}.data-grid td{vertical-align:middle}.credentials-title{display:block;font-weight:700;margin:8px 0}.code{font-family:monospace}.learn-more{display:flex;justify-content:center;align-items:center;height:100%;text-align:center}.webauthn-pane.enabled .learn-more{display:none}\n/*# sourceURL=webauthnPane.css */\n");const s={export:"Export",remove:"Remove",noCredentialsTryCallingSFromYour:"No credentials. Try calling {PH1} from your website.",enableVirtualAuthenticator:"Enable virtual authenticator environment",id:"ID",isResident:"Is Resident",rpId:"RP ID",userHandle:"User Handle",signCount:"Signature Count",actions:"Actions",credentials:"Credentials",useWebauthnForPhishingresistant:"Use WebAuthn for phishing-resistant authentication",learnMore:"Learn more",newAuthenticator:"New authenticator",protocol:"Protocol",transport:"Transport",supportsResidentKeys:"Supports resident keys",add:"Add",addAuthenticator:"Add authenticator",active:"Active",editName:"Edit name",saveName:"Save name",authenticatorS:"Authenticator {PH1}",privateKeypem:"Private key.pem",uuid:"UUID",supportsUserVerification:"Supports user verification",yes:"Yes",no:"No",setSAsTheActiveAuthenticator:"Set {PH1} as the active authenticator"},c=i.i18n.registerUIStrings("panels/webauthn/WebauthnPane.ts",s),l=i.i18n.getLocalizedString.bind(void 0,c);class d extends n.DataGrid.DataGridNode{credential;constructor(t){super(t),this.credential=t}nodeSelfHeight(){return 24}createCell(t){const e=super.createCell(t);if(o.Tooltip.Tooltip.install(e,e.textContent||""),"actions"!==t)return e;const i=o.UIUtils.createTextButton(l(s.export),(()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners("ExportCredential",this.credential)}));e.appendChild(i);const a=o.UIUtils.createTextButton(l(s.remove),(()=>{this.dataGrid&&this.dataGrid.dispatchEventToListeners("RemoveCredential",this.credential)}));return e.appendChild(a),e}}class h extends n.DataGrid.DataGridImpl{}class u extends(t.ObjectWrapper.eventMixin(h)){}class p extends n.DataGrid.DataGridNode{createCells(t){t.removeChildren();const e=this.createTDWithClass(n.DataGrid.Align.Center);this.dataGrid&&(e.colSpan=this.dataGrid.visibleColumnsArray.length);const a=document.createElement("span",{is:"source-code"});a.textContent="navigator.credentials.create()",a.classList.add("code");const o=i.i18n.getFormatLocalizedString(c,s.noCredentialsTryCallingSFromYour,{PH1:a});e.appendChild(o),t.appendChild(e)}}let b;const m={Ctap2:"ctap2",U2f:"u2f"};class v extends o.Widget.VBox{activeAuthId=null;hasBeenEnabled=!1;dataGrids=new Map;enableCheckbox;availableAuthenticatorSetting;model;authenticatorsView;topToolbarContainer;topToolbar;learnMoreView;newAuthenticatorSection;newAuthenticatorForm;protocolSelect;transportSelect;residentKeyCheckboxLabel;residentKeyCheckbox;userVerificationCheckboxLabel;userVerificationCheckbox;addAuthenticatorButton;isEnabling;constructor(){super(!0),a.TargetManager.TargetManager.instance().observeModels(a.WebAuthnModel.WebAuthnModel,this),this.contentElement.classList.add("webauthn-pane"),this.availableAuthenticatorSetting=t.Settings.Settings.instance().createSetting("webauthnAuthenticators",[]),this.createToolbar(),this.authenticatorsView=this.contentElement.createChild("div","authenticators-view"),this.createNewAuthenticatorSection(),this.updateVisibility(!1)}static instance(t={forceNew:null}){const{forceNew:e}=t;return b&&!e||(b=new v),b}modelAdded(t){t.target()===a.TargetManager.TargetManager.instance().mainTarget()&&(this.model=t)}modelRemoved(t){t.target()===a.TargetManager.TargetManager.instance().mainTarget()&&(this.model=void 0)}async loadInitialAuthenticators(){let t=null;const e=this.availableAuthenticatorSetting.get();for(const i of e){if(!this.model)continue;const e=await this.model.addAuthenticator(i);this.addAuthenticatorSection(e,i),i.authenticatorId=e,i.active&&(t=e)}this.availableAuthenticatorSetting.set(e),t&&this.setActiveAuthenticator(t)}async ownerViewDisposed(){this.enableCheckbox&&this.enableCheckbox.setChecked(!1),await this.setVirtualAuthEnvEnabled(!1)}createToolbar(){this.topToolbarContainer=this.contentElement.createChild("div","webauthn-toolbar-container"),this.topToolbar=new o.Toolbar.Toolbar("webauthn-toolbar",this.topToolbarContainer);const t=l(s.enableVirtualAuthenticator);this.enableCheckbox=new o.Toolbar.ToolbarCheckbox(t,t,this.handleCheckboxToggle.bind(this)),this.topToolbar.appendToolbarItem(this.enableCheckbox)}createCredentialsDataGrid(t){const e=[{id:"credentialId",title:l(s.id),longText:!0,weight:24},{id:"isResidentCredential",title:l(s.isResident),dataType:n.DataGrid.DataType.Boolean,weight:10},{id:"rpId",title:l(s.rpId)},{id:"userHandle",title:l(s.userHandle)},{id:"signCount",title:l(s.signCount)},{id:"actions",title:l(s.actions)}],i={displayName:l(s.credentials),columns:e,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0},a=new u(i);return a.renderInline(),a.setStriped(!0),a.addEventListener("ExportCredential",this.handleExportCredential,this),a.addEventListener("RemoveCredential",this.handleRemoveCredential.bind(this,t)),this.dataGrids.set(t,a),a}handleExportCredential({data:t}){this.exportCredential(t)}handleRemoveCredential(t,{data:e}){this.removeCredential(t,e.credentialId)}async updateCredentials(t){const e=this.dataGrids.get(t);if(e){if(this.model){const i=await this.model.getCredentials(t);e.rootNode().removeChildren();for(const t of i){const i=new d(t);e.rootNode().appendChild(i)}this.maybeAddEmptyNode(e)}setTimeout(this.updateCredentials.bind(this,t),1e3)}}maybeAddEmptyNode(t){if(t.rootNode().children.length)return;const e=new p;t.rootNode().appendChild(e)}async setVirtualAuthEnvEnabled(t){await this.isEnabling,this.isEnabling=new Promise((async i=>{t&&!this.hasBeenEnabled&&(e.userMetrics.actionTaken(e.UserMetrics.Action.VirtualAuthenticatorEnvironmentEnabled),this.hasBeenEnabled=!0),this.model&&await this.model.setVirtualAuthEnvEnabled(t),t?await this.loadInitialAuthenticators():this.removeAuthenticatorSections(),this.updateVisibility(t),this.isEnabling=void 0,i()}))}updateVisibility(t){this.contentElement.classList.toggle("enabled",t)}removeAuthenticatorSections(){this.authenticatorsView.innerHTML="",this.dataGrids.clear()}handleCheckboxToggle(t){this.setVirtualAuthEnvEnabled(t.target.checked)}updateEnabledTransportOptions(t){if(!this.transportSelect)return;const e=this.transportSelect.value;this.transportSelect.removeChildren();for(const e of t)this.transportSelect.appendChild(new Option(e,e));this.transportSelect.value=e,this.transportSelect.value||(this.transportSelect.selectedIndex=0)}updateNewAuthenticatorSectionOptions(){this.protocolSelect&&this.residentKeyCheckbox&&this.userVerificationCheckbox&&("ctap2"===this.protocolSelect.value?(this.residentKeyCheckbox.disabled=!1,this.userVerificationCheckbox.disabled=!1,this.updateEnabledTransportOptions(["usb","ble","nfc","internal"])):(this.residentKeyCheckbox.checked=!1,this.residentKeyCheckbox.disabled=!0,this.userVerificationCheckbox.checked=!1,this.userVerificationCheckbox.disabled=!0,this.updateEnabledTransportOptions(["usb","ble","nfc"])))}createNewAuthenticatorSection(){this.learnMoreView=this.contentElement.createChild("div","learn-more"),this.learnMoreView.appendChild(o.Fragment.html` <div> ${l(s.useWebauthnForPhishingresistant)}<br><br> ${o.XLink.XLink.create("https://developers.google.com/web/updates/2018/05/webauthn",l(s.learnMore))} </div> `),this.newAuthenticatorSection=this.contentElement.createChild("div","new-authenticator-container");const t=o.UIUtils.createLabel(l(s.newAuthenticator),"new-authenticator-title");this.newAuthenticatorSection.appendChild(t),this.newAuthenticatorForm=this.newAuthenticatorSection.createChild("div","new-authenticator-form");const e=this.newAuthenticatorForm.createChild("div","authenticator-option"),i=this.newAuthenticatorForm.createChild("div","authenticator-option"),a=this.newAuthenticatorForm.createChild("div","authenticator-option"),n=this.newAuthenticatorForm.createChild("div","authenticator-option"),r=this.newAuthenticatorForm.createChild("div","authenticator-option"),c=o.UIUtils.createLabel(l(s.protocol),"authenticator-option-label");e.appendChild(c),this.protocolSelect=e.createChild("select","chrome-select"),o.ARIAUtils.bindLabelToControl(c,this.protocolSelect),Object.values(m).sort().forEach((t=>{this.protocolSelect&&this.protocolSelect.appendChild(new Option(t,t))})),this.protocolSelect&&(this.protocolSelect.value="ctap2");const d=o.UIUtils.createLabel(l(s.transport),"authenticator-option-label");i.appendChild(d),this.transportSelect=i.createChild("select","chrome-select"),o.ARIAUtils.bindLabelToControl(d,this.transportSelect),this.residentKeyCheckboxLabel=o.UIUtils.CheckboxLabel.create(l(s.supportsResidentKeys),!1),this.residentKeyCheckboxLabel.textElement.classList.add("authenticator-option-label"),a.appendChild(this.residentKeyCheckboxLabel.textElement),this.residentKeyCheckbox=this.residentKeyCheckboxLabel.checkboxElement,this.residentKeyCheckbox.checked=!1,this.residentKeyCheckbox.classList.add("authenticator-option-checkbox"),a.appendChild(this.residentKeyCheckboxLabel),this.userVerificationCheckboxLabel=o.UIUtils.CheckboxLabel.create("Supports user verification",!1),this.userVerificationCheckboxLabel.textElement.classList.add("authenticator-option-label"),n.appendChild(this.userVerificationCheckboxLabel.textElement),this.userVerificationCheckbox=this.userVerificationCheckboxLabel.checkboxElement,this.userVerificationCheckbox.checked=!1,this.userVerificationCheckbox.classList.add("authenticator-option-checkbox"),n.appendChild(this.userVerificationCheckboxLabel),this.addAuthenticatorButton=o.UIUtils.createTextButton(l(s.add),this.handleAddAuthenticatorButton.bind(this),""),r.createChild("div","authenticator-option-label"),r.appendChild(this.addAuthenticatorButton);const h=o.UIUtils.createLabel(l(s.addAuthenticator),"");o.ARIAUtils.bindLabelToControl(h,this.addAuthenticatorButton),this.updateNewAuthenticatorSectionOptions(),this.protocolSelect&&this.protocolSelect.addEventListener("change",this.updateNewAuthenticatorSectionOptions.bind(this))}async handleAddAuthenticatorButton(){const t=this.createOptionsFromCurrentInputs();if(this.model){const e=await this.model.addAuthenticator(t),i=this.availableAuthenticatorSetting.get();i.push({authenticatorId:e,active:!0,...t}),this.availableAuthenticatorSetting.set(i.map((t=>({...t,active:t.authenticatorId===e}))));const a=await this.addAuthenticatorSection(e,t),n=window.matchMedia("(prefers-reduced-motion: reduce)").matches;a.scrollIntoView({block:"start",behavior:n?"auto":"smooth"})}}async addAuthenticatorSection(t,e){const i=document.createElement("div");i.classList.add("authenticator-section"),i.setAttribute("data-authenticator-id",t),this.authenticatorsView.appendChild(i);const a=i.createChild("div","authenticator-section-header"),n=a.createChild("div","authenticator-section-title");o.ARIAUtils.markAsHeading(n,2),await this.clearActiveAuthenticator();const r=a.createChild("div","active-button-container"),c=o.UIUtils.createRadioLabel(`active-authenticator-${t}`,l(s.active));c.radioElement.addEventListener("click",this.setActiveAuthenticator.bind(this,t)),r.appendChild(c),c.radioElement.checked=!0,this.activeAuthId=t;const d=a.createChild("button","text-button");d.textContent=l(s.remove),d.addEventListener("click",this.removeAuthenticator.bind(this,t));const h=new o.Toolbar.Toolbar("edit-name-toolbar",n),u=new o.Toolbar.ToolbarButton(l(s.editName),"largeicon-edit"),p=new o.Toolbar.ToolbarButton(l(s.saveName),"largeicon-checkmark");p.setVisible(!1);const b=n.createChild("input","authenticator-name-field");b.disabled=!0;const m=t.slice(-5);b.value=l(s.authenticatorS,{PH1:m}),this.updateActiveLabelTitle(c,b.value),u.addEventListener(o.Toolbar.ToolbarButton.Events.Click,(()=>this.handleEditNameButton(n,b,u,p))),p.addEventListener(o.Toolbar.ToolbarButton.Events.Click,(()=>this.handleSaveNameButton(n,b,u,p,c))),b.addEventListener("focusout",(()=>this.handleSaveNameButton(n,b,u,p,c))),b.addEventListener("keydown",(t=>{"Enter"===t.key&&this.handleSaveNameButton(n,b,u,p,c)})),h.appendToolbarItem(u),h.appendToolbarItem(p),this.createAuthenticatorFields(i,t,e);const v=document.createElement("div");v.classList.add("credentials-title"),v.textContent=l(s.credentials),i.appendChild(v);return this.createCredentialsDataGrid(t).asWidget().show(i),this.updateCredentials(t),i}exportCredential(t){let e="-----BEGIN PRIVATE KEY-----\n";for(let i=0;i<t.privateKey.length;i+=64)e+=t.privateKey.substring(i,i+64)+"\n";e+="-----END PRIVATE KEY-----";const i=document.createElement("a");i.download=l(s.privateKeypem),i.href="data:application/x-pem-file,"+encodeURIComponent(e),i.click()}async removeCredential(t,e){const i=this.dataGrids.get(t);i&&(i.rootNode().children.find((t=>t.data.credentialId===e)).remove(),this.maybeAddEmptyNode(i),this.model&&await this.model.removeCredential(t,e))}createAuthenticatorFields(t,e,i){const a=t.createChild("div","authenticator-fields"),n=a.createChild("div","authenticator-field"),r=a.createChild("div","authenticator-field"),c=a.createChild("div","authenticator-field"),d=a.createChild("div","authenticator-field"),h=a.createChild("div","authenticator-field");n.appendChild(o.UIUtils.createLabel(l(s.uuid),"authenticator-option-label")),r.appendChild(o.UIUtils.createLabel(l(s.protocol),"authenticator-option-label")),c.appendChild(o.UIUtils.createLabel(l(s.transport),"authenticator-option-label")),d.appendChild(o.UIUtils.createLabel(l(s.supportsResidentKeys),"authenticator-option-label")),h.appendChild(o.UIUtils.createLabel(l(s.supportsUserVerification),"authenticator-option-label")),n.createChild("div","authenticator-field-value").textContent=e,r.createChild("div","authenticator-field-value").textContent=i.protocol,c.createChild("div","authenticator-field-value").textContent=i.transport,d.createChild("div","authenticator-field-value").textContent=i.hasResidentKey?l(s.yes):l(s.no),h.createChild("div","authenticator-field-value").textContent=i.hasUserVerification?l(s.yes):l(s.no)}handleEditNameButton(t,e,i,a){e.disabled=!1,t.classList.add("editing-name"),e.focus(),a.setVisible(!0),i.setVisible(!1)}handleSaveNameButton(t,e,i,a,n){e.disabled=!0,t.classList.remove("editing-name"),i.setVisible(!0),a.setVisible(!1),this.updateActiveLabelTitle(n,e.value)}updateActiveLabelTitle(t,e){o.Tooltip.Tooltip.install(t.radioElement,l(s.setSAsTheActiveAuthenticator,{PH1:e}))}removeAuthenticator(t){if(this.authenticatorsView){const e=this.authenticatorsView.querySelector(`[data-authenticator-id=${CSS.escape(t)}]`);e&&e.remove()}this.dataGrids.delete(t),this.model&&this.model.removeAuthenticator(t);const e=this.availableAuthenticatorSetting.get().filter((e=>e.authenticatorId!==t));if(this.availableAuthenticatorSetting.set(e),this.activeAuthId===t){const t=Array.from(this.dataGrids.keys());t.length?this.setActiveAuthenticator(t[0]):this.activeAuthId=null}}createOptionsFromCurrentInputs(){if(!(this.protocolSelect&&this.transportSelect&&this.residentKeyCheckbox&&this.userVerificationCheckbox))throw new Error("Unable to create options from current inputs");return{protocol:this.protocolSelect.options[this.protocolSelect.selectedIndex].value,transport:this.transportSelect.options[this.transportSelect.selectedIndex].value,hasResidentKey:this.residentKeyCheckbox.checked,hasUserVerification:this.userVerificationCheckbox.checked,automaticPresenceSimulation:!0,isUserVerified:!0}}async setActiveAuthenticator(t){await this.clearActiveAuthenticator(),this.model&&await this.model.setAutomaticPresenceSimulation(t,!0),this.activeAuthId=t;const e=this.availableAuthenticatorSetting.get().map((e=>({...e,active:e.authenticatorId===t})));this.availableAuthenticatorSetting.set(e),this.updateActiveButtons()}updateActiveButtons(){const t=this.authenticatorsView.getElementsByClassName("authenticator-section");Array.from(t).forEach((t=>{const e=t.querySelector("input.dt-radio-button");e&&(e.checked=t.dataset.authenticatorId===this.activeAuthId)}))}async clearActiveAuthenticator(){this.activeAuthId&&this.model&&await this.model.setAutomaticPresenceSimulation(this.activeAuthId,!1),this.activeAuthId=null,this.updateActiveButtons()}wasShown(){super.wasShown(),this.registerCSSFiles([r])}}var C=Object.freeze({__proto__:null,WebauthnPaneImpl:v});export{C as WebauthnPane};
