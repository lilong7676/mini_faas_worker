import*as e from"../../core/common/common.js";import*as t from"../../core/sdk/sdk.js";import*as i from"../../core/i18n/i18n.js";import*as o from"../../core/root/root.js";import*as s from"../../ui/legacy/components/color_picker/color_picker.js";import*as n from"../../ui/legacy/legacy.js";import*as r from"../../core/platform/platform.js";import*as a from"../../models/text_utils/text_utils.js";import*as l from"../../ui/legacy/components/data_grid/data_grid.js";import*as d from"../../ui/legacy/components/utils/utils.js";import*as c from"./components/components.js";import*as h from"../../core/host/host.js";class u extends e.ObjectWrapper.ObjectWrapper{currentUrl;constructor(){super(),this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),t.TargetManager.TargetManager.instance().addEventListener(t.TargetManager.Events.InspectedURLChanged,this.checkUrlAndResetIfChanged,this)}checkUrlAndResetIfChanged(){this.currentUrl!==t.TargetManager.TargetManager.instance().inspectedURL()&&(this.currentUrl=t.TargetManager.TargetManager.instance().inspectedURL(),this.dispatchEventToListeners("Reset"))}}var v=Object.freeze({__proto__:null,OverviewController:u});const p={topAppliedToAStatically:"`Top` applied to a statically positioned element",leftAppliedToAStatically:"`Left` applied to a statically positioned element",rightAppliedToAStatically:"`Right` applied to a statically positioned element",bottomAppliedToAStatically:"`Bottom` applied to a statically positioned element",widthAppliedToAnInlineElement:"`Width` applied to an inline element",heightAppliedToAnInlineElement:"`Height` applied to an inline element",verticalAlignmentAppliedTo:"Vertical alignment applied to element which is neither `inline` nor `table-cell`"},m=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewUnusedDeclarations.ts",p),g=i.i18n.getLocalizedString.bind(void 0,m);class w{static add(e,t,i){const o=e.get(t)||[];o.push(i),e.set(t,o)}static checkForUnusedPositionValues(e,t,i,o,s,n,r,a){if("static"===i[o]){if("auto"!==i[s]){const o=g(p.topAppliedToAStatically);this.add(e,o,{declaration:`top: ${i[s]}`,nodeId:t})}if("auto"!==i[n]){const o=g(p.leftAppliedToAStatically);this.add(e,o,{declaration:`left: ${i[n]}`,nodeId:t})}if("auto"!==i[r]){const o=g(p.rightAppliedToAStatically);this.add(e,o,{declaration:`right: ${i[r]}`,nodeId:t})}if("auto"!==i[a]){const o=g(p.bottomAppliedToAStatically);this.add(e,o,{declaration:`bottom: ${i[a]}`,nodeId:t})}}}static checkForUnusedWidthAndHeightValues(e,t,i,o,s,n){if("inline"===i[o]){if("auto"!==i[s]){const o=g(p.widthAppliedToAnInlineElement);this.add(e,o,{declaration:`width: ${i[s]}`,nodeId:t})}if("auto"!==i[n]){const o=g(p.heightAppliedToAnInlineElement);this.add(e,o,{declaration:`height: ${i[n]}`,nodeId:t})}}}static checkForInvalidVerticalAlignment(e,t,i,o,s){if(i[o]&&"inline"!==i[o]&&!i[o].startsWith("table")&&"baseline"!==i[s]){const o=g(p.verticalAlignmentAppliedTo);this.add(e,o,{declaration:`vertical-align: ${i[s]}`,nodeId:t})}}}var f=Object.freeze({__proto__:null,CSSOverviewUnusedDeclarations:w});class b extends t.SDKModel.SDKModel{#e;#t;#i;#o;#s;constructor(e){super(e),this.#e=e.runtimeAgent(),this.#t=e.cssAgent(),this.#i=e.domAgent(),this.#o=e.domsnapshotAgent(),this.#s=e.overlayAgent()}highlightNode(t){const i={contentColor:e.Color.PageHighlight.Content.toProtocolRGBA(),showInfo:!0,contrastAlgorithm:o.Runtime.experiments.isEnabled("APCA")?"apca":"aa"};this.#s.invoke_hideHighlight(),this.#s.invoke_highlightNode({backendNodeId:t,highlightConfig:i})}async getNodeStyleStats(){const t=new Map,i=new Map,n=new Map,r=new Map,a=new Map,l=new Map,d=new Map,c=t=>t.hasAlpha()?t.asString(e.Color.Format.HEXA):t.asString(e.Color.Format.HEX),h=(t,i,o)=>{if(-1===t)return;const s=f[t];if(!s)return;const n=e.Color.Color.parse(s);if(!n||0===n.rgba()[3])return;const r=c(n);if(!r)return;const a=o.get(r)||new Set;return a.add(i),o.set(r,a),n},u=e=>new Set(["altglyph","circle","ellipse","path","polygon","polyline","rect","svg","text","textpath","tref","tspan"]).has(e.toLowerCase()),v=e=>new Set(["iframe","video","embed","img"]).has(e.toLowerCase()),p=(e,t)=>new Set(["tr","td","thead","tbody"]).has(e.toLowerCase())&&t.startsWith("table");let m=0;const{documents:g,strings:f}=await this.#o.invoke_captureSnapshot({computedStyles:["background-color","color","fill","border-top-width","border-top-color","border-bottom-width","border-bottom-color","border-left-width","border-left-color","border-right-width","border-right-color","font-family","font-size","font-weight","line-height","position","top","right","bottom","left","display","width","height","vertical-align"],includeTextColorOpacities:!0,includeBlendedBackgroundColors:!0});for(const{nodes:b,layout:S}of g){m+=S.nodeIndex.length;for(let m=0;m<S.styles.length;m++){const g=S.styles[m],C=S.nodeIndex[m];if(!b.backendNodeId||!b.nodeName)continue;const y=b.backendNodeId[C],x=b.nodeName[C],[k,I,$,T,M,A,E,F,L,O,R,V,_,N,P,D,z,W,B,U,q,H,G,j]=g;h(k,y,t);const Q=h(I,y,i);if(u(f[x])&&h($,y,r),"0px"!==f[T]&&h(M,y,a),"0px"!==f[A]&&h(E,y,a),"0px"!==f[F]&&h(L,y,a),"0px"!==f[O]&&h(R,y,a),V&&-1!==V){const e=f[V],t=l.get(e)||new Map,i="font-size",o="font-weight",s="line-height",n=t.get(i)||new Map,r=t.get(o)||new Map,a=t.get(s)||new Map;if(-1!==_){const e=f[_],t=n.get(e)||[];t.push(y),n.set(e,t)}if(-1!==N){const e=f[N],t=r.get(e)||[];t.push(y),r.set(e,t)}if(-1!==P){const e=f[P],t=a.get(e)||[];t.push(y),a.set(e,t)}t.set(i,n),t.set(o,r),t.set(s,a),l.set(e,t)}const X=Q&&S.blendedBackgroundColors&&-1!==S.blendedBackgroundColors[m]?e.Color.Color.parse(f[S.blendedBackgroundColors[m]]):null;if(Q&&X){const t=new s.ContrastInfo.ContrastInfo({backgroundColors:[X.asString(e.Color.Format.HEXA)],computedFontSize:-1!==_?f[_]:"",computedFontWeight:-1!==N?f[N]:""}),i=Q.blendWithAlpha(S.textColorOpacities?S.textColorOpacities[m]:1);t.setColor(i);const r=`${c(i)}_${c(X)}`;if(o.Runtime.experiments.isEnabled("APCA")){const e=t.contrastRatioAPCA(),o=t.contrastRatioAPCAThreshold();if(!(!(!e||!o)&&Math.abs(e)>=o)){const t={nodeId:y,contrastRatio:e,textColor:i,backgroundColor:X,thresholdsViolated:{aa:!1,aaa:!1,apca:!0}};n.has(r)?n.get(r).push(t):n.set(r,[t])}}else{const e=t.contrastRatioThreshold("aa")||0,o=t.contrastRatioThreshold("aaa")||0,s=t.contrastRatio()||0;if(e>s||o>s){const t={nodeId:y,contrastRatio:s,textColor:i,backgroundColor:X,thresholdsViolated:{aa:e>s,aaa:o>s,apca:!1}};n.has(r)?n.get(r).push(t):n.set(r,[t])}}}w.checkForUnusedPositionValues(d,y,f,D,z,U,W,B),u(f[x])||v(f[x])||w.checkForUnusedWidthAndHeightValues(d,y,f,q,H,G),-1===j||p(f[x],f[q])||w.checkForInvalidVerticalAlignment(d,y,f,q,j)}}return{backgroundColors:t,textColors:i,textColorContrastIssues:n,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d,elementCount:m}}getComputedStyleForNode(e){return this.#t.invoke_getComputedStyleForNode({nodeId:e})}async getMediaQueries(){const e=await this.#t.invoke_getMediaQueries(),t=new Map;if(!e)return t;for(const i of e.medias){if("linkedSheet"===i.source)continue;const e=t.get(i.text)||[];e.push(i),t.set(i.text,e)}return t}async getGlobalStylesheetStats(){const{result:e}=await this.#e.invoke_evaluate({expression:"(function() {\n      let styleRules = 0;\n      let inlineStyles = 0;\n      let externalSheets = 0;\n      const stats = {\n        // Simple.\n        type: new Set(),\n        class: new Set(),\n        id: new Set(),\n        universal: new Set(),\n        attribute: new Set(),\n\n        // Non-simple.\n        nonSimple: new Set()\n      };\n\n      for (const styleSheet of document.styleSheets) {\n        if (styleSheet.href) {\n          externalSheets++;\n        } else {\n          inlineStyles++;\n        }\n\n        // Attempting to grab rules can trigger a DOMException.\n        // Try it and if it fails skip to the next stylesheet.\n        let rules;\n        try {\n          rules = styleSheet.rules;\n        } catch (err) {\n          continue;\n        }\n\n        for (const rule of rules) {\n          if ('selectorText' in rule) {\n            styleRules++;\n\n            // Each group that was used.\n            for (const selectorGroup of rule.selectorText.split(',')) {\n              // Each selector in the group.\n              for (const selector of selectorGroup.split(/[\\t\\n\\f\\r ]+/g)) {\n                if (selector.startsWith('.')) {\n                  // Class.\n                  stats.class.add(selector);\n                } else if (selector.startsWith('#')) {\n                  // Id.\n                  stats.id.add(selector);\n                } else if (selector.startsWith('*')) {\n                  // Universal.\n                  stats.universal.add(selector);\n                } else if (selector.startsWith('[')) {\n                  // Attribute.\n                  stats.attribute.add(selector);\n                } else {\n                  // Type or non-simple selector.\n                  const specialChars = /[#.:\\[\\]|\\+>~]/;\n                  if (specialChars.test(selector)) {\n                    stats.nonSimple.add(selector);\n                  } else {\n                    stats.type.add(selector);\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      return {\n        styleRules,\n        inlineStyles,\n        externalSheets,\n        stats: {\n          // Simple.\n          type: stats.type.size,\n          class: stats.class.size,\n          id: stats.id.size,\n          universal: stats.universal.size,\n          attribute: stats.attribute.size,\n\n          // Non-simple.\n          nonSimple: stats.nonSimple.size\n        }\n      }\n    })()",returnByValue:!0});if("object"===e.type)return e.value}}t.SDKModel.SDKModel.register(b,{capabilities:t.Target.Capability.DOM,autostart:!1});var S=Object.freeze({__proto__:null,CSSOverviewModel:b});const C=new CSSStyleSheet;C.replaceSync(".overview-processing-view{overflow:hidden;padding:16px;justify-content:center;align-items:center;height:100%}.overview-processing-view h1{font-size:16px;text-align:center;font-weight:400;margin:0;padding:8px}.overview-processing-view h2{font-size:12px;text-align:center;font-weight:400;margin:0;padding-top:32px}\n/*# sourceURL=cssOverviewProcessingView.css */\n");const y={cancel:"Cancel"},x=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewProcessingView.ts",y),k=i.i18n.getLocalizedString.bind(void 0,x);class I extends n.Widget.Widget{#n;#r;fragment;constructor(e){super(),this.#n=new Intl.NumberFormat("en-US"),this.#r=e,this.render()}render(){const e=n.UIUtils.createTextButton(k(y.cancel),(()=>this.#r.dispatchEventToListeners("RequestOverviewCancel")),"",!0);this.setDefaultFocusedElement(e),this.fragment=n.Fragment.Fragment.build`
      <div class="vbox overview-processing-view">
        <h1>Processing page</h1>
        <div>${e}</div>
      </div>
    `,this.contentElement.appendChild(this.fragment.element()),this.contentElement.style.overflow="auto"}wasShown(){super.wasShown(),this.registerCSSFiles([C])}}var $=Object.freeze({__proto__:null,CSSOverviewProcessingView:I});const T=new CSSStyleSheet;T.replaceSync('.overview-completed-view{overflow:auto;--overview-default-padding:28px;--overview-icon-padding:32px}.overview-completed-view .colors ul,.overview-completed-view .summary ul{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0}.overview-completed-view .summary ul{display:grid;grid-template-columns:repeat(auto-fill,140px);grid-gap:16px}.overview-completed-view .colors ul li{display:inline-block;margin:0 0 16px;padding:0 8px 0 0}.overview-completed-view .summary ul li{display:flex;flex-direction:column;grid-column-start:auto}.overview-completed-view li .label{font-size:12px;padding-bottom:2px}.overview-completed-view li .value{font-size:17px}.overview-completed-view ul li span{font-weight:700}.unused-rules-grid .data-container,.unused-rules-grid .header-container,.unused-rules-grid table.data{position:relative}.unused-rules-grid .data-container{top:0;max-height:350px}.unused-rules-grid{border-left:none;border-right:none}.unused-rules-grid .monospace{display:block;height:18px}.element-grid{flex:1;border-left:none;border-right:none;overflow:auto}.block{width:65px;height:25px;border-radius:3px;margin-right:16px;cursor:pointer}.block-title{padding-top:4px;font-size:12px;color:var(--color-text-primary);text-transform:uppercase;letter-spacing:0}.results-section{flex-shrink:0;border-bottom:1px solid var(--color-details-hairline);padding:var(--overview-default-padding) 0 var(--overview-default-padding) 0}.horizontally-padded{padding-left:var(--overview-default-padding);padding-right:var(--overview-default-padding)}.results-section h1{font-size:15px;font-weight:400;padding:0;margin:0 0 20px;padding-left:calc(var(--overview-default-padding) + var(--overview-icon-padding));position:relative;height:26px;line-height:26px}.results-section h1::before{content:"";display:block;position:absolute;left:var(--overview-default-padding);top:0;width:26px;height:26px;background-image:var(--image-file-cssoverview_icons_2x);background-size:104px 26px}.results-section.horizontally-padded h1{padding-left:var(--overview-icon-padding)}.results-section.horizontally-padded h1::before{left:0}.results-section.summary h1{padding-left:0}.results-section.summary h1::before{display:none}.results-section.colors h1::before{background-position:0 0}.results-section.font-info h1::before{background-position:-26px 0}.results-section.unused-declarations h1::before{background-position:-52px 0}.results-section.media-queries h1::before{background-position:-78px 0}.results-section.colors h2{margin-top:20px;font-size:13px;font-weight:400}.overview-completed-view .font-info ul,.overview-completed-view .media-queries ul,.overview-completed-view .unused-declarations ul{width:100%;list-style:none;margin:0;padding:0 var(--overview-default-padding)}.overview-completed-view .font-info ul li,.overview-completed-view .media-queries ul li,.overview-completed-view .unused-declarations ul li{display:grid;grid-template-columns:2fr 3fr;grid-gap:12px;margin-bottom:4px;align-items:center}.overview-completed-view .font-info button,.overview-completed-view .media-queries button,.overview-completed-view .unused-declarations button{border:none;padding:0;margin:0;display:flex;align-items:center;border-radius:2px;cursor:pointer;height:28px;background:0 0}.overview-completed-view .font-info button .details,.overview-completed-view .media-queries button .details,.overview-completed-view .unused-declarations button .details{min-width:100px;text-align:right;margin-right:8px;color:var(--color-primary);pointer-events:none}.overview-completed-view .font-info button .bar-container,.overview-completed-view .media-queries button .bar-container,.overview-completed-view .unused-declarations button .bar-container{flex:1;pointer-events:none}.overview-completed-view .font-info button .bar,.overview-completed-view .media-queries button .bar,.overview-completed-view .unused-declarations button .bar{height:8px;background:var(--color-primary);border-radius:2px;min-width:2px}.overview-completed-view .font-info button:focus .details,.overview-completed-view .font-info button:hover .details,.overview-completed-view .media-queries button:focus .details,.overview-completed-view .media-queries button:hover .details,.overview-completed-view .unused-declarations button:focus .details,.overview-completed-view .unused-declarations button:hover .details{color:var(--color-primary-variant)}.overview-completed-view .font-info button:focus .bar,.overview-completed-view .font-info button:hover .bar,.overview-completed-view .media-queries button:focus .bar,.overview-completed-view .media-queries button:hover .bar,.overview-completed-view .unused-declarations button:focus .bar,.overview-completed-view .unused-declarations button:hover .bar{background-color:var(--color-primary-variant);box-shadow:0 1px 2px var(--divider-line),0 0 0 2px var(--color-primary-variant);color:var(--color-background)}.overview-completed-view .font-info .font-metric{display:grid;grid-template-columns:1fr 1fr 1fr;grid-gap:12px}.overview-completed-view .font-info ul{padding:0}.overview-completed-view .font-info ul li{grid-template-columns:1fr 4fr}.overview-completed-view .font-info h2{font-size:14px;font-weight:700;margin:0 0 1em}.overview-completed-view .font-info h3{font-size:13px;font-weight:400;font-style:italic;margin:0 0 .5em}.overview-completed-view .font-info{padding-bottom:0}.overview-completed-view .font-family{padding:var(--overview-default-padding)}.overview-completed-view .font-family:nth-child(2n+1){background:var(--color-background)}.overview-completed-view .font-family:first-of-type{padding-top:0}.contrast-warning{display:flex;align-items:baseline}.contrast-warning .threshold-label{font-weight:400;width:30px}.contrast-warning [is=ui-icon]{margin-left:5px}.contrast-preview{padding:0 5px}.contrast-container-in-grid{display:flex;align-items:baseline}.contrast-container-in-grid>*{margin-right:5px;min-width:initial}[is=ui-icon].smallicon-checkmark-square{background-color:var(--color-green)}[is=ui-icon].smallicon-no{background-color:var(--color-red)}.data .nodeId-column{align-items:center;display:flex;height:20px}.show-element{margin:0 0 0 8px;padding:0;background:0 0;border:none;-webkit-mask-image:var(--image-file-ic_show_node_16x16);background-color:var(--color-text-secondary);width:16px;height:16px;display:none;cursor:pointer;flex:none}.show-element:focus,.show-element:hover{background-color:var(--color-primary)}.nodeId-column:focus-within .show-element,.nodeId-column:hover .show-element{display:inline-block}\n/*# sourceURL=cssOverviewCompletedView.css */\n');const M=new CSSStyleSheet;M.replaceSync(".overview-sidebar-panel{overflow:auto;display:flex;background:var(--color-background-elevation-1)}.overview-sidebar-panel-item{height:30px;padding-left:30px;display:flex;align-items:center;cursor:pointer;color:var(--color-text-primary)}.overview-sidebar-panel-item:focus,.overview-sidebar-panel-item:hover{background:var(--color-background-highlight)}.overview-sidebar-panel-item.selected{background:var(--color-primary);color:var(--color-background)}.overview-toolbar{border-bottom:1px solid var(--color-details-hairline)}\n/*# sourceURL=cssOverviewSidebarPanel.css */\n");const A={clearOverview:"Clear overview"},E=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewSidebarPanel.ts",A),F=i.i18n.getLocalizedString.bind(void 0,E);class L extends(e.ObjectWrapper.eventMixin(n.Widget.VBox)){static get ITEM_CLASS_NAME(){return"overview-sidebar-panel-item"}static get SELECTED(){return"selected"}constructor(){super(!0),this.contentElement.classList.add("overview-sidebar-panel"),this.contentElement.addEventListener("click",this.onItemClick.bind(this));const e=new n.Toolbar.ToolbarButton(F(A.clearOverview),"largeicon-clear");e.addEventListener(n.Toolbar.ToolbarButton.Events.Click,this.reset,this);const t=this.contentElement.createChild("div","overview-toolbar");new n.Toolbar.Toolbar("",t).appendToolbarItem(e)}addItem(e,t){const i=this.contentElement.createChild("div",L.ITEM_CLASS_NAME);i.textContent=e,i.dataset.id=t}reset(){this.dispatchEventToListeners("Reset")}deselectAllItems(){this.contentElement.querySelectorAll(`.${L.ITEM_CLASS_NAME}`).forEach((e=>{e.classList.remove(L.SELECTED)}))}onItemClick(e){const t=e.composedPath()[0];if(!t.classList.contains(L.ITEM_CLASS_NAME))return;const{id:i}=t.dataset;i&&(this.select(i),this.dispatchEventToListeners("ItemSelected",i))}select(e){const t=this.contentElement.querySelector(`[data-id=${CSS.escape(e)}]`);t&&(t.classList.contains(L.SELECTED)||(this.deselectAllItems(),t.classList.add(L.SELECTED)))}wasShown(){super.wasShown(),this.registerCSSFiles([M])}}var O=Object.freeze({__proto__:null,CSSOverviewSidebarPanel:L});const R={overviewSummary:"Overview summary",colors:"Colors",fontInfo:"Font info",unusedDeclarations:"Unused declarations",mediaQueries:"Media queries",elements:"Elements",externalStylesheets:"External stylesheets",inlineStyleElements:"Inline style elements",styleRules:"Style rules",typeSelectors:"Type selectors",idSelectors:"ID selectors",classSelectors:"Class selectors",universalSelectors:"Universal selectors",attributeSelectors:"Attribute selectors",nonsimpleSelectors:"Non-simple selectors",backgroundColorsS:"Background colors: {PH1}",textColorsS:"Text colors: {PH1}",fillColorsS:"Fill colors: {PH1}",borderColorsS:"Border colors: {PH1}",thereAreNoFonts:"There are no fonts.",thereAreNoUnusedDeclarations:"There are no unused declarations.",thereAreNoMediaQueries:"There are no media queries.",contrastIssues:"Contrast issues",nOccurrences:"{n, plural, =1 {# occurrence} other {# occurrences}}",contrastIssuesS:"Contrast issues: {PH1}",textColorSOverSBackgroundResults:"Text color {PH1} over {PH2} background results in low contrast for {PH3} elements",aa:"AA",aaa:"AAA",apca:"APCA",element:"Element",declaration:"Declaration",source:"Source",contrastRatio:"Contrast ratio",cssOverviewElements:"CSS Overview Elements",showElement:"Show element"},V=i.i18n.registerUIStrings("panels/css_overview/CSSOverviewCompletedView.ts",R),_=i.i18n.getLocalizedString.bind(void 0,V);function N(e){let[t,i,o]=e.hsla();return t=Math.round(360*t),i=Math.round(100*i),o=Math.round(100*o),o=Math.max(0,o-15),`1px solid hsl(${t}deg ${i}% ${o}%)`}class P extends n.Panel.PanelWithSidebar{#r;#n;#a;#l;#d;#c;#h;#u;#v;#p;#m;#g;constructor(e){super("css_overview_completed_view"),this.#r=e,this.#n=new Intl.NumberFormat("en-US"),this.#a=new n.SplitWidget.SplitWidget(!0,!0),this.#l=new n.Widget.VBox,this.#d=new D,this.#d.addEventListener("TabClosed",(e=>{0===e.data&&this.#a.setSidebarMinimized(!0)})),this.#a.setMainWidget(this.#l),this.#a.setSidebarWidget(this.#d),this.#a.setVertical(!1),this.#a.setSecondIsSidebar(!0),this.#a.setSidebarMinimized(!0),this.#c=new L,this.splitWidget().setSidebarWidget(this.#c),this.splitWidget().setMainWidget(this.#a),this.#v=new d.Linkifier.Linkifier(20,!0),this.#p=new Map,this.#c.addItem(_(R.overviewSummary),"summary"),this.#c.addItem(_(R.colors),"colors"),this.#c.addItem(_(R.fontInfo),"font-info"),this.#c.addItem(_(R.unusedDeclarations),"unused-declarations"),this.#c.addItem(_(R.mediaQueries),"media-queries"),this.#c.select("summary"),this.#c.addEventListener("ItemSelected",this.sideBarItemSelected,this),this.#c.addEventListener("Reset",this.sideBarReset,this),this.#r.addEventListener("Reset",this.reset,this),this.#r.addEventListener("PopulateNodes",this.createElementsView,this),this.#l.element.addEventListener("click",this.onClick.bind(this)),this.#m=null}wasShown(){super.wasShown(),this.#a.registerCSSFiles([T]),this.registerCSSFiles([T])}initializeModels(e){const i=e.model(t.CSSModel.CSSModel),o=e.model(t.DOMModel.DOMModel);if(!i||!o)throw new Error("Target must provide CSS and DOM models");this.#h=i,this.#u=o}sideBarItemSelected(e){const{data:t}=e,i=this.#g.$(t);i&&i.scrollIntoView()}sideBarReset(){this.#r.dispatchEventToListeners("Reset")}reset(){this.#l.element.removeChildren(),this.#a.setSidebarMinimized(!0),this.#d.closeTabs(),this.#p=new Map,P.pushedNodes.clear(),this.#c.select("summary")}onClick(e){if(!e.target)return;const t=e.target.dataset,i=t.type;if(!i||!this.#m)return;let o;switch(i){case"contrast":{const e=t.section,s=t.key;if(!s)return;o={type:i,key:s,nodes:this.#m.textColorContrastIssues.get(s)||[],section:e};break}case"color":{const e=t.color,s=t.section;if(!e)return;let n;switch(s){case"text":n=this.#m.textColors.get(e);break;case"background":n=this.#m.backgroundColors.get(e);break;case"fill":n=this.#m.fillColors.get(e);break;case"border":n=this.#m.borderColors.get(e)}if(!n)return;n=Array.from(n).map((e=>({nodeId:e}))),o={type:i,color:e,nodes:n,section:s};break}case"unused-declarations":{const e=t.declaration;if(!e)return;const s=this.#m.unusedDeclarations.get(e);if(!s)return;o={type:i,declaration:e,nodes:s};break}case"media-queries":{const e=t.text;if(!e)return;const s=this.#m.mediaQueries.get(e);if(!s)return;o={type:i,text:e,nodes:s};break}case"font-info":{const e=t.value;if(!t.path)return;const[s,n]=t.path.split("/");if(!e)return;const r=this.#m.fontInfo.get(s);if(!r)return;const a=r.get(n);if(!a)return;const l=a.get(e);if(!l)return;o={type:i,name:`${e} (${s}, ${n})`,nodes:l.map((e=>({nodeId:e})))};break}default:return}e.consume(),this.#r.dispatchEventToListeners("PopulateNodes",{payload:o}),this.#a.setSidebarMinimized(!1)}onMouseOver(e){const t=e.composedPath().find((e=>e.dataset&&e.dataset.backendNodeId));if(!t)return;const i=Number(t.dataset.backendNodeId);this.#r.dispatchEventToListeners("RequestNodeHighlight",i)}async render(e){if(!e||!("backgroundColors"in e)||!("textColors"in e))return;this.#m=e;const{elementCount:t,backgroundColors:i,textColors:o,textColorContrastIssues:s,fillColors:r,borderColors:a,globalStyleStats:l,mediaQueries:d,unusedDeclarations:c,fontInfo:h}=this.#m,u=this.sortColorsByLuminance(i),v=this.sortColorsByLuminance(o),p=this.sortColorsByLuminance(r),m=this.sortColorsByLuminance(a);this.#g=n.Fragment.Fragment.build`
    <div class="vbox overview-completed-view">
      <div $="summary" class="results-section horizontally-padded summary">
        <h1>${_(R.overviewSummary)}</h1>

        <ul>
          <li>
            <div class="label">${_(R.elements)}</div>
            <div class="value">${this.#n.format(t)}</div>
          </li>
          <li>
            <div class="label">${_(R.externalStylesheets)}</div>
            <div class="value">${this.#n.format(l.externalSheets)}</div>
          </li>
          <li>
            <div class="label">${_(R.inlineStyleElements)}</div>
            <div class="value">${this.#n.format(l.inlineStyles)}</div>
          </li>
          <li>
            <div class="label">${_(R.styleRules)}</div>
            <div class="value">${this.#n.format(l.styleRules)}</div>
          </li>
          <li>
            <div class="label">${_(R.mediaQueries)}</div>
            <div class="value">${this.#n.format(d.size)}</div>
          </li>
          <li>
            <div class="label">${_(R.typeSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.type)}</div>
          </li>
          <li>
            <div class="label">${_(R.idSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.id)}</div>
          </li>
          <li>
            <div class="label">${_(R.classSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.class)}</div>
          </li>
          <li>
            <div class="label">${_(R.universalSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.universal)}</div>
          </li>
          <li>
            <div class="label">${_(R.attributeSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.attribute)}</div>
          </li>
          <li>
            <div class="label">${_(R.nonsimpleSelectors)}</div>
            <div class="value">${this.#n.format(l.stats.nonSimple)}</div>
          </li>
        </ul>
      </div>

      <div $="colors" class="results-section horizontally-padded colors">
        <h1>${_(R.colors)}</h1>
        <h2>${_(R.backgroundColorsS,{PH1:u.length})}</h2>
        <ul>
          ${u.map(this.colorsToFragment.bind(this,"background"))}
        </ul>

        <h2>${_(R.textColorsS,{PH1:v.length})}</h2>
        <ul>
          ${v.map(this.colorsToFragment.bind(this,"text"))}
        </ul>

        ${s.size>0?this.contrastIssuesToFragment(s):""}

        <h2>${_(R.fillColorsS,{PH1:p.length})}</h2>
        <ul>
          ${p.map(this.colorsToFragment.bind(this,"fill"))}
        </ul>

        <h2>${_(R.borderColorsS,{PH1:m.length})}</h2>
        <ul>
          ${m.map(this.colorsToFragment.bind(this,"border"))}
        </ul>
      </div>

      <div $="font-info" class="results-section font-info">
        <h1>${_(R.fontInfo)}</h1>
        ${h.size>0?this.fontInfoToFragment(h):n.Fragment.Fragment.build`<div>${_(R.thereAreNoFonts)}</div>`}
      </div>

      <div $="unused-declarations" class="results-section unused-declarations">
        <h1>${_(R.unusedDeclarations)}</h1>
        ${c.size>0?this.groupToFragment(c,"unused-declarations","declaration"):n.Fragment.Fragment.build`<div class="horizontally-padded">${_(R.thereAreNoUnusedDeclarations)}</div>`}
      </div>

      <div $="media-queries" class="results-section media-queries">
        <h1>${_(R.mediaQueries)}</h1>
        ${d.size>0?this.groupToFragment(d,"media-queries","text"):n.Fragment.Fragment.build`<div class="horizontally-padded">${_(R.thereAreNoMediaQueries)}</div>`}
      </div>
    </div>`,this.#l.element.appendChild(this.#g.element())}createElementsView(e){const{payload:t}=e.data;let i="",o="";switch(t.type){case"contrast":{const{section:e,key:s}=t;i=`${e}-${s}`,o=_(R.contrastIssues);break}case"color":{const{section:e,color:s}=t;i=`${e}-${s}`,o=`${s.toUpperCase()} (${e})`;break}case"unused-declarations":{const{declaration:e}=t;i=`${e}`,o=`${e}`;break}case"media-queries":{const{text:e}=t;i=`${e}`,o=`${e}`;break}case"font-info":{const{name:e}=t;i=`${e}`,o=`${e}`;break}}let s=this.#p.get(i);if(!s){if(!this.#u||!this.#h)throw new Error("Unable to initialize CSS Overview, missing models");s=new z(this.#r,this.#u,this.#h,this.#v),s.populateNodes(t.nodes),this.#p.set(i,s)}this.#d.appendTab(i,o,s,!0)}fontInfoToFragment(e){const t=Array.from(e.entries());return n.Fragment.Fragment.build`
  ${t.map((([e,t])=>n.Fragment.Fragment.build`<section class="font-family"><h2>${e}</h2> ${this.fontMetricsToFragment(e,t)}</section>`))}
  `}fontMetricsToFragment(e,t){const i=Array.from(t.entries());return n.Fragment.Fragment.build`
  <div class="font-metric">
  ${i.map((([t,i])=>{const o=`${e}/${t}`;return n.Fragment.Fragment.build`
  <div>
  <h3>${t}</h3>
  ${this.groupToFragment(i,"font-info","value",o)}
  </div>`}))}
  </div>`}groupToFragment(e,t,i,o=""){const s=Array.from(e.entries()).sort(((e,t)=>{const i=e[1];return t[1].length-i.length})),r=s.reduce(((e,t)=>e+t[1].length),0);return n.Fragment.Fragment.build`<ul>
    ${s.map((([e,s])=>{const a=100*s.length/r,l=_(R.nOccurrences,{n:s.length});return n.Fragment.Fragment.build`<li>
        <div class="title">${e}</div>
        <button data-type="${t}" data-path="${o}" data-${i}="${e}">
          <div class="details">${l}</div>
          <div class="bar-container">
            <div class="bar" style="width: ${a}%;"></div>
          </div>
        </button>
      </li>`}))}
    </ul>`}contrastIssuesToFragment(e){return n.Fragment.Fragment.build`
  <h2>${_(R.contrastIssuesS,{PH1:e.size})}</h2>
  <ul>
  ${[...e.entries()].map((([e,t])=>this.contrastIssueToFragment(e,t)))}
  </ul>
  `}contrastIssueToFragment(t,i){console.assert(i.length>0);let s=i[0];for(const e of i)Math.abs(e.contrastRatio)<Math.abs(s.contrastRatio)&&(s=e);const r=s.textColor.asString(e.Color.Format.HEXA),a=s.backgroundColor.asString(e.Color.Format.HEXA),l=o.Runtime.experiments.isEnabled("APCA"),d=n.Fragment.Fragment.build`<li>
      <button
        title="${_(R.textColorSOverSBackgroundResults,{PH1:r,PH2:a,PH3:i.length})}"
        data-type="contrast" data-key="${t}" data-section="contrast" class="block" $="color">
        Text
      </button>
      <div class="block-title">
        <div class="contrast-warning hidden" $="aa"><span class="threshold-label">${_(R.aa)}</span></div>
        <div class="contrast-warning hidden" $="aaa"><span class="threshold-label">${_(R.aaa)}</span></div>
        <div class="contrast-warning hidden" $="apca"><span class="threshold-label">${_(R.apca)}</span></div>
      </div>
    </li>`;if(l){const e=d.$("apca");s.thresholdsViolated.apca?e.appendChild(n.Icon.Icon.create("smallicon-no")):e.appendChild(n.Icon.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden")}else{const e=d.$("aa");s.thresholdsViolated.aa?e.appendChild(n.Icon.Icon.create("smallicon-no")):e.appendChild(n.Icon.Icon.create("smallicon-checkmark-square"));const t=d.$("aaa");s.thresholdsViolated.aaa?t.appendChild(n.Icon.Icon.create("smallicon-no")):t.appendChild(n.Icon.Icon.create("smallicon-checkmark-square")),e.classList.remove("hidden"),t.classList.remove("hidden")}const c=d.$("color");return c.style.backgroundColor=a,c.style.color=r,c.style.border=N(s.backgroundColor),d}colorsToFragment(t,i){const o=n.Fragment.Fragment.build`<li>
      <button data-type="color" data-color="${i}" data-section="${t}" class="block" $="color"></button>
      <div class="block-title">${i}</div>
    </li>`,s=o.$("color");s.style.backgroundColor=i;const r=e.Color.Color.parse(i);if(r)return s.style.border=N(r),o}sortColorsByLuminance(t){return Array.from(t.keys()).sort(((t,i)=>{const o=e.Color.Color.parse(t),s=e.Color.Color.parse(i);return o&&s?e.ColorUtils.luminance(s.rgba())-e.ColorUtils.luminance(o.rgba()):0}))}setOverviewData(e){this.render(e)}static pushedNodes=new Set}class D extends(e.ObjectWrapper.eventMixin(n.Widget.VBox)){#w;constructor(){super(),this.#w=new n.TabbedPane.TabbedPane,this.#w.show(this.element),this.#w.addEventListener(n.TabbedPane.Events.TabClosed,(()=>{this.dispatchEventToListeners("TabClosed",this.#w.tabIds().length)}))}appendTab(e,t,i,o){this.#w.hasTab(e)||this.#w.appendTab(e,t,i,void 0,void 0,o),this.#w.selectTab(e)}closeTabs(){this.#w.closeTabs(this.#w.tabIds())}}class z extends n.Widget.Widget{#r;#u;#h;#v;#f;#b;constructor(e,t,i,o){super(),this.#r=e,this.#u=t,this.#h=i,this.#v=o,this.#f=[{id:"nodeId",title:_(R.element),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"declaration",title:_(R.declaration),sortable:!0,weight:50,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"sourceURL",title:_(R.source),sortable:!1,weight:100,titleDOMFragment:void 0,sort:void 0,align:void 0,width:void 0,fixedWidth:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},{id:"contrastRatio",title:_(R.contrastRatio),sortable:!0,weight:25,titleDOMFragment:void 0,sort:void 0,align:void 0,width:"150px",fixedWidth:!0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}],this.#b=new l.SortableDataGrid.SortableDataGrid({displayName:_(R.cssOverviewElements),columns:this.#f,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this.#b.element.classList.add("element-grid"),this.#b.element.addEventListener("mouseover",this.onMouseOver.bind(this)),this.#b.setStriped(!0),this.#b.addEventListener(l.DataGrid.Events.SortingChanged,this.sortMediaQueryDataGrid.bind(this)),this.#b.asWidget().show(this.element)}sortMediaQueryDataGrid(){const e=this.#b.sortColumnId();if(!e)return;const t=l.SortableDataGrid.SortableDataGrid.StringComparator.bind(null,e);this.#b.sortNodes(t,!this.#b.isSortOrderAscending())}onMouseOver(e){const t=e.composedPath().find((e=>e.dataset&&e.dataset.backendNodeId));if(!t)return;const i=Number(t.dataset.backendNodeId);this.#r.dispatchEventToListeners("RequestNodeHighlight",i)}async populateNodes(e){if(this.#b.rootNode().removeChildren(),!e.length)return;const[t]=e,i=new Set;let o;if("nodeId"in t&&t.nodeId&&i.add("nodeId"),"declaration"in t&&t.declaration&&i.add("declaration"),"sourceURL"in t&&t.sourceURL&&i.add("sourceURL"),"contrastRatio"in t&&t.contrastRatio&&i.add("contrastRatio"),"nodeId"in t&&i.has("nodeId")){const t=e.reduce(((e,t)=>{const i=t.nodeId;return P.pushedNodes.has(i)?e:(P.pushedNodes.add(i),e.add(i))}),new Set);o=await this.#u.pushNodesByBackendIdsToFrontend(t)}for(const t of e){let e;if("nodeId"in t&&i.has("nodeId")){if(!o)continue;if(e=o.get(t.nodeId),!e)continue}const s=new W(t,e,this.#v,this.#h);s.selectable=!1,this.#b.insertChild(s)}this.#b.setColumnsVisiblity(i),this.#b.renderInline(),this.#b.wasShown()}}class W extends l.SortableDataGrid.SortableDataGridNode{#v;#h;#S;constructor(e,t,i,o){super(e),this.#S=t,this.#v=i,this.#h=o}createCell(t){const i=this.#S;if("nodeId"===t){const o=this.createTD(t);if(o.textContent="...",!i)throw new Error("Node entry is missing a related frontend node.");return e.Linkifier.Linkifier.linkify(i).then((e=>{o.textContent="",e.dataset.backendNodeId=i.backendNodeId().toString(),o.appendChild(e);const t=document.createElement("button");t.classList.add("show-element"),n.Tooltip.Tooltip.install(t,_(R.showElement)),t.tabIndex=0,t.onclick=()=>this.data.node.scrollIntoView(),o.appendChild(t)})),o}if("sourceURL"===t){const e=this.createTD(t);if(this.data.range){const t=this.linkifyRuleLocation(this.#h,this.#v,this.data.styleSheetId,a.TextRange.TextRange.fromObject(this.data.range));t&&""!==t.textContent?e.appendChild(t):e.textContent="(unable to link)"}else e.textContent="(unable to link to inlined styles)";return e}if("contrastRatio"===t){const e=this.createTD(t),i=o.Runtime.experiments.isEnabled("APCA"),s=r.NumberUtilities.floor(this.data.contrastRatio,2),a=i?s+"%":s,l=N(this.data.backgroundColor),d=this.data.textColor.asString(),c=this.data.backgroundColor.asString(),h=n.Fragment.Fragment.build`
        <div class="contrast-container-in-grid" $="container">
          <span class="contrast-preview" style="border: ${l};
          color: ${d};
          background-color: ${c};">Aa</span>
          <span>${a}</span>
        </div>
      `,u=h.$("container");return i?(u.append(n.Fragment.Fragment.build`<span>${_(R.apca)}</span>`.element()),this.data.thresholdsViolated.apca?u.appendChild(n.Icon.Icon.create("smallicon-no")):u.appendChild(n.Icon.Icon.create("smallicon-checkmark-square"))):(u.append(n.Fragment.Fragment.build`<span>${_(R.aa)}</span>`.element()),this.data.thresholdsViolated.aa?u.appendChild(n.Icon.Icon.create("smallicon-no")):u.appendChild(n.Icon.Icon.create("smallicon-checkmark-square")),u.append(n.Fragment.Fragment.build`<span>${_(R.aaa)}</span>`.element()),this.data.thresholdsViolated.aaa?u.appendChild(n.Icon.Icon.create("smallicon-no")):u.appendChild(n.Icon.Icon.create("smallicon-checkmark-square"))),e.appendChild(h.element()),e}return super.createCell(t)}linkifyRuleLocation(e,i,o,s){const n=e.styleSheetHeaderForId(o);if(!n)return;const r=n.lineNumberInSource(s.startLine),a=n.columnNumberInSource(s.startLine,s.startColumn),l=new t.CSSModel.CSSLocation(n,r,a);return i.linkifyCSSLocation(l)}}var B=Object.freeze({__proto__:null,CSSOverviewCompletedView:P,DetailsView:D,ElementDetailsView:z,ElementNode:W});const U=new CSSStyleSheet;let q;U.replaceSync(".css-overview-panel{overflow:hidden}\n/*# sourceURL=cssOverview.css */\n");class H extends n.Panel.Panel{#r;#C;#y;#x;#k;#I;#$;#T;#M;#A;#E;#F;#L;#O;#R;#V;#_;constructor(){super("css_overview"),this.element.classList.add("css-overview-panel"),this.#r=new u,this.#C=new c.CSSOverviewStartView.CSSOverviewStartView,this.#C.addEventListener("overviewstartrequested",(()=>this.#r.dispatchEventToListeners("RequestOverviewStart"))),this.#y=new I(this.#r),this.#x=new P(this.#r),t.TargetManager.TargetManager.instance().observeTargets(this),this.#r.addEventListener("RequestOverviewStart",(e=>{h.userMetrics.actionTaken(h.UserMetrics.Action.CaptureCssOverviewClicked),this.startOverview()}),this),this.#r.addEventListener("RequestOverviewCancel",this.cancelOverview,this),this.#r.addEventListener("OverviewCompleted",this.overviewCompleted,this),this.#r.addEventListener("Reset",this.reset,this),this.#r.addEventListener("RequestNodeHighlight",this.requestNodeHighlight,this),this.reset()}static instance(){return q||(q=new H),q}targetAdded(e){if(this.#I)return;this.#I=e,this.#x.initializeModels(e);const[i]=t.TargetManager.TargetManager.instance().models(b);this.#k=i}targetRemoved(){}getModel(){if(!this.#k)throw new Error("Did not retrieve model information yet.");return this.#k}reset(){this.#$=new Map,this.#T=new Map,this.#M=new Map,this.#A=new Map,this.#E=new Map,this.#F=new Map,this.#L=new Map,this.#O=0,this.#R=!1,this.#V={styleRules:0,inlineStyles:0,externalSheets:0,stats:{type:0,class:0,id:0,universal:0,attribute:0,nonSimple:0}},this.#_=new Map,this.renderInitialView()}requestNodeHighlight(e){this.getModel().highlightNode(e.data)}renderInitialView(){this.#y.hideWidget(),this.#x.hideWidget(),this.contentElement.append(this.#C),this.#C.show()}renderOverviewStartedView(){this.#C.hide(),this.#x.hideWidget(),this.#y.show(this.contentElement)}renderOverviewCompletedView(){this.#C.hide(),this.#y.hideWidget(),this.#x.show(this.contentElement),this.#x.setOverviewData({backgroundColors:this.#$,textColors:this.#T,textColorContrastIssues:this.#_,fillColors:this.#M,borderColors:this.#A,globalStyleStats:this.#V,fontInfo:this.#E,elementCount:this.#O,mediaQueries:this.#F,unusedDeclarations:this.#L})}async startOverview(){this.renderOverviewStartedView();const e=this.getModel(),[t,{elementCount:i,backgroundColors:o,textColors:s,textColorContrastIssues:n,fillColors:r,borderColors:a,fontInfo:l,unusedDeclarations:d},c]=await Promise.all([e.getGlobalStylesheetStats(),e.getNodeStyleStats(),e.getMediaQueries()]);i&&(this.#O=i),t&&(this.#V=t),c&&(this.#F=c),o&&(this.#$=o),s&&(this.#T=s),n&&(this.#_=n),r&&(this.#M=r),a&&(this.#A=a),l&&(this.#E=l),d&&(this.#L=d),this.#r.dispatchEventToListeners("OverviewCompleted")}getStyleValue(e,t){const i=e.filter((e=>e.name===t));if(i.length)return i[0].value}cancelOverview(){this.#R=!0}overviewCompleted(){this.renderOverviewCompletedView()}wasShown(){super.wasShown(),this.registerCSSFiles([U])}}var G=Object.freeze({__proto__:null,CSSOverviewPanel:H});export{B as CSSOverviewCompletedView,v as CSSOverviewController,S as CSSOverviewModel,G as CSSOverviewPanel,$ as CSSOverviewProcessingView,O as CSSOverviewSidebarPanel,f as CSSOverviewUnusedDeclarations};
