import*as e from"../../core/common/common.js";import*as t from"../../core/host/host.js";import*as n from"../../core/i18n/i18n.js";import*as r from"../../core/platform/platform.js";import*as s from"../text_utils/text_utils.js";let o;class i extends e.ObjectWrapper.ObjectWrapper{saveCallbacks;constructor(){super(),this.saveCallbacks=new Map,t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.SavedURL,this.savedURL,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.CanceledSaveURL,this.canceledSavedURL,this),t.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(t.InspectorFrontendHostAPI.Events.AppendedToURL,this.appendedToURL,this)}static instance(e={forceNew:null}){const{forceNew:t}=e;return o&&!t||(o=new i),o}save(e,n,r){const s=new Promise((t=>this.saveCallbacks.set(e,t)));return t.InspectorFrontendHost.InspectorFrontendHostInstance.save(e,n,r),s}savedURL(e){const{url:t,fileSystemPath:n}=e.data,r=this.saveCallbacks.get(t);this.saveCallbacks.delete(t),r&&r({fileSystemPath:n})}canceledSavedURL({data:e}){const t=this.saveCallbacks.get(e);this.saveCallbacks.delete(e),t&&t(null)}append(e,n){t.InspectorFrontendHost.InspectorFrontendHostInstance.append(e,n)}close(e){t.InspectorFrontendHost.InspectorFrontendHostInstance.close(e)}appendedToURL({data:e}){this.dispatchEventToListeners(a.AppendedToURL,e)}}var a;(a||(a={})).AppendedToURL="AppendedToURL";var c,l=Object.freeze({__proto__:null,FileManager:i,get Events(){return a}});!function(e){e.Debugger="debugger",e.Formatter="formatter",e.Network="network",e.FileSystem="filesystem",e.ContentScripts="contentscripts",e.Service="service"}(c||(c={}));let h;class d extends e.ObjectWrapper.ObjectWrapper{projectsInternal;hasResourceContentTrackingExtensionsInternal;constructor(){super(),this.projectsInternal=new Map,this.hasResourceContentTrackingExtensionsInternal=!1}static instance(e={forceNew:null}){const{forceNew:t}=e;return h&&!t||(h=new d),h}static removeInstance(){h=void 0}uiSourceCode(e,t){const n=this.projectsInternal.get(e);return n?n.uiSourceCodeForURL(t):null}uiSourceCodeForURL(e){for(const t of this.projectsInternal.values()){const n=t.uiSourceCodeForURL(e);if(n)return n}return null}uiSourceCodesForProjectType(e){const t=[];for(const n of this.projectsInternal.values())n.type()===e&&t.push(...n.uiSourceCodes());return t}addProject(e){console.assert(!this.projectsInternal.has(e.id()),`A project with id ${e.id()} already exists!`),this.projectsInternal.set(e.id(),e),this.dispatchEventToListeners(u.ProjectAdded,e)}removeProject(e){this.projectsInternal.delete(e.id()),this.dispatchEventToListeners(u.ProjectRemoved,e)}project(e){return this.projectsInternal.get(e)||null}projects(){return[...this.projectsInternal.values()]}projectsForType(e){return this.projects().filter((function(t){return t.type()===e}))}uiSourceCodes(){const e=[];for(const t of this.projectsInternal.values())e.push(...t.uiSourceCodes());return e}setHasResourceContentTrackingExtensions(e){this.hasResourceContentTrackingExtensionsInternal=e}hasResourceContentTrackingExtensions(){return this.hasResourceContentTrackingExtensionsInternal}}var u;!function(e){e.UISourceCodeAdded="UISourceCodeAdded",e.UISourceCodeRemoved="UISourceCodeRemoved",e.UISourceCodeRenamed="UISourceCodeRenamed",e.WorkingCopyChanged="WorkingCopyChanged",e.WorkingCopyCommitted="WorkingCopyCommitted",e.WorkingCopyCommittedByUser="WorkingCopyCommittedByUser",e.ProjectAdded="ProjectAdded",e.ProjectRemoved="ProjectRemoved"}(u||(u={}));var p=Object.freeze({__proto__:null,Project:class{rename(e,t,n){}excludeFolder(e){}deleteFile(e){}remove(){}indexContent(e){}},get projectTypes(){return c},ProjectStore:class{workspaceInternal;idInternal;typeInternal;displayNameInternal;uiSourceCodesMap;uiSourceCodesList;project;constructor(e,t,n,r){this.workspaceInternal=e,this.idInternal=t,this.typeInternal=n,this.displayNameInternal=r,this.uiSourceCodesMap=new Map,this.uiSourceCodesList=[],this.project=this}id(){return this.idInternal}type(){return this.typeInternal}displayName(){return this.displayNameInternal}workspace(){return this.workspaceInternal}createUISourceCode(e,t){return new g(this.project,e,t)}addUISourceCode(e){const t=e.url();return!this.uiSourceCodeForURL(t)&&(this.uiSourceCodesMap.set(t,{uiSourceCode:e,index:this.uiSourceCodesList.length}),this.uiSourceCodesList.push(e),this.workspaceInternal.dispatchEventToListeners(u.UISourceCodeAdded,e),!0)}removeUISourceCode(e){if(!this.uiSourceCodeForURL(e))return;const t=this.uiSourceCodesMap.get(e);if(!t)return;const n=this.uiSourceCodesList[this.uiSourceCodesList.length-1];this.uiSourceCodesList[t.index]=n;const r=this.uiSourceCodesMap.get(n.url());r&&(r.index=t.index),this.uiSourceCodesList.splice(this.uiSourceCodesList.length-1,1),this.uiSourceCodesMap.delete(e),this.workspaceInternal.dispatchEventToListeners(u.UISourceCodeRemoved,t.uiSourceCode)}removeProject(){this.workspaceInternal.removeProject(this.project),this.uiSourceCodesMap=new Map,this.uiSourceCodesList=[]}uiSourceCodeForURL(e){const t=this.uiSourceCodesMap.get(e);return t?t.uiSourceCode:null}uiSourceCodes(){return this.uiSourceCodesList}renameUISourceCode(e,t){const n=e.url(),r=e.parentURL()?e.parentURL()+"/"+t:t,s=this.uiSourceCodesMap.get(n);this.uiSourceCodesMap.set(r,s),this.uiSourceCodesMap.delete(n)}},WorkspaceImpl:d,get Events(){return u}});const C={index:"(index)",thisFileWasChangedExternally:"This file was changed externally. Would you like to reload it?"},m=n.i18n.registerUIStrings("models/workspace/UISourceCode.ts",C),I=n.i18n.getLocalizedString.bind(void 0,m);class g extends e.ObjectWrapper.ObjectWrapper{projectInternal;urlInternal;originInternal;parentURLInternal;nameInternal;contentTypeInternal;requestContentPromise;decorations=new Map;hasCommitsInternal;messagesInternal;contentLoadedInternal;contentInternal;forceLoadOnCheckContentInternal;checkingContent;lastAcceptedContent;workingCopyInternal;workingCopyGetter;disableEditInternal;contentEncodedInternal;constructor(t,n,r){super(),this.projectInternal=t,this.urlInternal=n;const s=e.ParsedURL.ParsedURL.fromString(n);s?(this.originInternal=s.securityOrigin(),this.parentURLInternal=this.originInternal+s.folderPathComponents,this.nameInternal=s.lastPathComponent,s.queryParams&&(this.nameInternal+="?"+s.queryParams)):(this.originInternal="",this.parentURLInternal="",this.nameInternal=n),this.contentTypeInternal=r,this.requestContentPromise=null,this.hasCommitsInternal=!1,this.messagesInternal=null,this.contentLoadedInternal=!1,this.contentInternal=null,this.forceLoadOnCheckContentInternal=!1,this.checkingContent=!1,this.lastAcceptedContent=null,this.workingCopyInternal=null,this.workingCopyGetter=null,this.disableEditInternal=!1}requestMetadata(){return this.projectInternal.requestMetadata(this)}name(){return this.nameInternal}mimeType(){return this.projectInternal.mimeType(this)}url(){return this.urlInternal}parentURL(){return this.parentURLInternal}origin(){return this.originInternal}fullDisplayName(){return this.projectInternal.fullDisplayName(this)}displayName(e){if(!this.nameInternal)return I(C.index);let t=this.nameInternal;try{t=this.project().type()===c.FileSystem?unescape(t):decodeURI(t)}catch(e){}return e?t:r.StringUtilities.trimEndWithMaxLength(t,100)}canRename(){return this.projectInternal.canRename()}rename(e){let t;const n=new Promise((e=>{t=e}));return this.projectInternal.rename(this,e,function(e,n,r,s){e&&this.updateName(n,r,s);t(e)}.bind(this)),n}remove(){this.projectInternal.deleteFile(this)}updateName(e,t,n){const r=this.urlInternal;this.urlInternal=this.urlInternal.substring(0,this.urlInternal.length-this.nameInternal.length)+e,this.nameInternal=e,t&&(this.urlInternal=t),n&&(this.contentTypeInternal=n),this.dispatchEventToListeners(y.TitleChanged,this),this.project().workspace().dispatchEventToListeners(u.UISourceCodeRenamed,{oldURL:r,uiSourceCode:this})}contentURL(){return this.url()}contentType(){return this.contentTypeInternal}async contentEncoded(){return await this.requestContent(),this.contentEncodedInternal||!1}project(){return this.projectInternal}requestContent(){return this.requestContentPromise?this.requestContentPromise:this.contentLoadedInternal?Promise.resolve(this.contentInternal):(this.requestContentPromise=this.requestContentImpl(),this.requestContentPromise)}async requestContentImpl(){try{const e=await this.projectInternal.requestFileContent(this);this.contentLoadedInternal||(this.contentLoadedInternal=!0,this.contentInternal=e,this.contentEncodedInternal=e.isEncoded)}catch(e){this.contentLoadedInternal=!0,this.contentInternal={content:null,error:e?String(e):"",isEncoded:!1}}return this.contentInternal}async checkContentUpdated(){if(!this.contentLoadedInternal&&!this.forceLoadOnCheckContentInternal)return;if(!this.projectInternal.canSetFileContent()||this.checkingContent)return;this.checkingContent=!0;const t=await this.projectInternal.requestFileContent(this);if("error"in t)return;if(this.checkingContent=!1,null===t.content){const e=this.workingCopy();return this.contentCommitted("",!1),void this.setWorkingCopy(e)}if(this.lastAcceptedContent===t.content)return;if(this.contentInternal&&"content"in this.contentInternal&&this.contentInternal.content===t.content)return void(this.lastAcceptedContent=null);if(!this.isDirty()||this.workingCopyInternal===t.content)return void this.contentCommitted(t.content,!1);await e.Revealer.reveal(this),await new Promise((e=>setTimeout(e,0)));window.confirm(I(C.thisFileWasChangedExternally))?this.contentCommitted(t.content,!1):this.lastAcceptedContent=t.content}forceLoadOnCheckContent(){this.forceLoadOnCheckContentInternal=!0}commitContent(e){this.projectInternal.canSetFileContent()&&this.projectInternal.setFileContent(this,e,!1),this.contentCommitted(e,!0)}contentCommitted(e,t){this.lastAcceptedContent=null,this.contentInternal={content:e,isEncoded:!1},this.contentLoadedInternal=!0,this.requestContentPromise=null,this.hasCommitsInternal=!0,this.innerResetWorkingCopy();const n={uiSourceCode:this,content:e,encoded:this.contentEncodedInternal};this.dispatchEventToListeners(y.WorkingCopyCommitted,n),this.projectInternal.workspace().dispatchEventToListeners(u.WorkingCopyCommitted,n),t&&this.projectInternal.workspace().dispatchEventToListeners(u.WorkingCopyCommittedByUser,n)}addRevision(e){this.commitContent(e)}hasCommits(){return this.hasCommitsInternal}workingCopy(){return this.workingCopyGetter&&(this.workingCopyInternal=this.workingCopyGetter(),this.workingCopyGetter=null),this.isDirty()?this.workingCopyInternal:this.contentInternal&&"content"in this.contentInternal&&this.contentInternal.content||""}resetWorkingCopy(){this.innerResetWorkingCopy(),this.workingCopyChanged()}innerResetWorkingCopy(){this.workingCopyInternal=null,this.workingCopyGetter=null}setWorkingCopy(e){this.workingCopyInternal=e,this.workingCopyGetter=null,this.workingCopyChanged()}setContent(e,t){this.contentEncodedInternal=t,this.projectInternal.canSetFileContent()&&this.projectInternal.setFileContent(this,e,t),this.contentCommitted(e,!0)}setWorkingCopyGetter(e){this.workingCopyGetter=e,this.workingCopyChanged()}workingCopyChanged(){this.removeAllMessages(),this.dispatchEventToListeners(y.WorkingCopyChanged,this),this.projectInternal.workspace().dispatchEventToListeners(u.WorkingCopyChanged,{uiSourceCode:this})}removeWorkingCopyGetter(){this.workingCopyGetter&&(this.workingCopyInternal=this.workingCopyGetter(),this.workingCopyGetter=null)}commitWorkingCopy(){this.isDirty()&&this.commitContent(this.workingCopy())}isDirty(){return null!==this.workingCopyInternal||null!==this.workingCopyGetter}extension(){return e.ParsedURL.ParsedURL.extractExtension(this.nameInternal)}content(){return this.contentInternal&&"content"in this.contentInternal&&this.contentInternal.content||""}loadError(){return this.contentInternal&&"error"in this.contentInternal&&this.contentInternal.error||null}searchInContent(e,t,n){const r=this.content();return r?Promise.resolve(s.TextUtils.performSearchInContent(r,e,t,n)):this.projectInternal.searchInFileContent(this,e,t,n)}contentLoaded(){return this.contentLoadedInternal}uiLocation(e,t){return new k(this,e,t)}messages(){return this.messagesInternal?new Set(this.messagesInternal):new Set}addLineMessage(e,t,n,r,o){const i=s.TextRange.TextRange.createFromLocation(n,r||0),a=new S(e,t,o,i);return this.addMessage(a),a}addMessage(e){this.messagesInternal||(this.messagesInternal=new Set),this.messagesInternal.add(e),this.dispatchEventToListeners(y.MessageAdded,e)}removeMessage(e){this.messagesInternal&&this.messagesInternal.delete(e)&&this.dispatchEventToListeners(y.MessageRemoved,e)}removeAllMessages(){if(this.messagesInternal){for(const e of this.messagesInternal)this.dispatchEventToListeners(y.MessageRemoved,e);this.messagesInternal=null}}setDecorationData(e,t){t!==this.decorations.get(e)&&(this.decorations.set(e,t),this.dispatchEventToListeners(y.DecorationChanged,e))}getDecorationData(e){return this.decorations.get(e)}disableEdit(){this.disableEditInternal=!0}editDisabled(){return this.disableEditInternal}}var y;!function(e){e.WorkingCopyChanged="WorkingCopyChanged",e.WorkingCopyCommitted="WorkingCopyCommitted",e.TitleChanged="TitleChanged",e.MessageAdded="MessageAdded",e.MessageRemoved="MessageRemoved",e.DecorationChanged="DecorationChanged"}(y||(y={}));class k{uiSourceCode;lineNumber;columnNumber;constructor(e,t,n){this.uiSourceCode=e,this.lineNumber=t,this.columnNumber=n}linkText(e,t){let n=this.uiSourceCode.displayName(e);return"application/wasm"===this.uiSourceCode.mimeType()?"number"==typeof this.columnNumber&&(n+=`:0x${this.columnNumber.toString(16)}`):(n+=":"+(this.lineNumber+1),t&&"number"==typeof this.columnNumber&&(n+=":"+(this.columnNumber+1))),n}id(){return"number"==typeof this.columnNumber?this.uiSourceCode.project().id()+":"+this.uiSourceCode.url()+":"+this.lineNumber+":"+this.columnNumber:this.lineId()}lineId(){return this.uiSourceCode.project().id()+":"+this.uiSourceCode.url()+":"+this.lineNumber}toUIString(){return this.uiSourceCode.url()+":"+(this.lineNumber+1)}static comparator(e,t){return e.compareTo(t)}compareTo(e){return this.uiSourceCode.url()!==e.uiSourceCode.url()?this.uiSourceCode.url()>e.uiSourceCode.url()?1:-1:this.lineNumber!==e.lineNumber?this.lineNumber-e.lineNumber:this.columnNumber===e.columnNumber?0:"number"!=typeof this.columnNumber?-1:"number"!=typeof e.columnNumber?1:this.columnNumber-e.columnNumber}}class S{levelInternal;textInternal;range;clickHandlerInternal;constructor(e,t,n,r){this.levelInternal=e,this.textInternal=t,this.range=r??new s.TextRange.TextRange(0,0,0,0),this.clickHandlerInternal=n}level(){return this.levelInternal}text(){return this.textInternal}clickHandler(){return this.clickHandlerInternal}lineNumber(){return this.range.startLine}columnNumber(){return this.range.startColumn}isEqual(e){return this.text()===e.text()&&this.level()===e.level()&&this.range.equal(e.range)}}!function(e){let t;!function(e){e.Error="Error",e.Issue="Issue",e.Warning="Warning"}(t=e.Level||(e.Level={}))}(S||(S={}));var v=Object.freeze({__proto__:null,UISourceCode:g,get Events(){return y},UILocation:k,get Message(){return S},LineMarker:class{rangeInternal;typeInternal;dataInternal;constructor(e,t,n){this.rangeInternal=e,this.typeInternal=t,this.dataInternal=n}range(){return this.rangeInternal}type(){return this.typeInternal}data(){return this.dataInternal}},UISourceCodeMetadata:class{modificationTime;contentSize;constructor(e,t){this.modificationTime=e,this.contentSize=t}}});export{l as FileManager,v as UISourceCode,p as Workspace};
