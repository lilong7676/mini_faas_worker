import*as e from"../../core/common/common.js";import*as t from"../../core/i18n/i18n.js";import*as n from"../../core/platform/platform.js";import*as a from"../../core/root/root.js";import*as r from"../../core/sdk/sdk.js";const s={threadS:"Thread {PH1}"},i=t.i18n.registerUIStrings("models/timeline_model/TimelineJSProfile.ts",s),o=t.i18n.getLocalizedString.bind(void 0,i);class l{static generateTracingEventsFromCpuProfile(e,t){const n=e.idleNode,a=e.programNode||null,s=e.gcNode,i=e.samples||[],o=e.timestamps,l=[],d=new Map;d.set(a,[]);for(let a=0;a<i.length;++a){let c=e.nodeByIndex(a);if(!c){console.error(`Node with unknown id ${i[a]} at index ${a}`);continue}if(c===s||c===n)continue;let h=d.get(c);if(!h){h=new Array(c.depth+1),d.set(c,h);for(let e=0;c.parent;c=c.parent)h[e++]=c}const m=new r.TracingModel.Event(r.TracingModel.DevToolsTimelineEventCategory,p.JSSample,r.TracingModel.Phase.Instant,o[a],t);m.args.data={stackTrace:h},l.push(m)}return l}static generateJSFrameEvents(e,t){const n=[],a=[],s=[];let i=0,o=!1;const{showAllEvents:d,showRuntimeCallStats:c,showNativeFunctions:h}=t;function m(e,t){if(s.length){const n=s[s.length-1];e<n&&(console.error(`Child stack is shallower (${e}) than the parent stack (${n}) at ${t}`),e=n)}a.length<e&&(console.error(`Trying to truncate higher than the current stack size at ${t}`),e=a.length);for(let e=0;e<a.length;++e)a[e].setEndTime(t);a.length=e}function g(e){const t=e.name===p.JSSample?e.args.data.stackTrace.slice().reverse():a.map((e=>e.args.data));!function(e){if(d)return;let t=null,n=0;for(let r=0;r<e.length;++r){const s=e[r],i=s.url,o=i&&i.startsWith("native ");if(!h&&o)continue;const d=l.isNativeRuntimeFrame(s);if(d&&(a=s.functionName,!c||!Boolean(l.nativeGroup(a))))continue;const m=d?l.nativeGroup(s.functionName):null;t&&t===m||(t=m,e[n++]=s)}var a;e.length=n}(t);const i=e.endTime||e.startTime,o=Math.min(t.length,a.length);let u;for(u=s[s.length-1]||0;u<o;++u){const e=t[u],n=a[u].args.data;if(T=n,(g=e).scriptId!==T.scriptId||g.functionName!==T.functionName||g.lineNumber!==T.lineNumber)break;a[u].setEndTime(Math.max(a[u].endTime,i))}var g,T;for(m(u,e.startTime);u<t.length;++u){const s=t[u],o=new r.TracingModel.Event(r.TracingModel.DevToolsTimelineEventCategory,p.JSFrame,r.TracingModel.Phase.Complete,e.startTime,e.thread);o.ordinal=e.ordinal,o.addArgs({data:s}),o.setEndTime(i),a.push(o),n.push(o)}}const T=e.find(r.TracingModel.TracingModel.isTopLevelEvent),f=T?T.startTime:0;return u.forEachEvent(e,(function(e){o&&(m(s.pop(),e.startTime),o=!1),e.ordinal=++i,g(e),s.push(a.length)}),(function(e){m(s.pop(),e.endTime)}),(function(e,t){if(e.ordinal=++i,t&&function(e){switch(e.name){case p.RunMicrotasks:case p.FunctionCall:case p.EvaluateScript:case p.EvaluateModule:case p.EventDispatch:case p.V8Execute:return!0}return!1}(t)||o)g(e);else if(e.name===p.JSSample&&0===a.length){o=!0;const t=a.length;g(e),s.push(t)}}),f),n}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static nativeGroup(e){return e.startsWith("Parse")?l.NativeGroups.Parse:e.startsWith("Compile")||e.startsWith("Recompile")?l.NativeGroups.Compile:null}static buildTraceProfileFromCpuProfile(e,t,n,a){const i=[];if(n&&f("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),a||(a=o(s.threadS,{PH1:t})),f(r.TracingModel.MetadataEvent.ThreadName,{name:a},0,0,"M","__metadata"),!e)return i;const l=new Map,d=e.nodes;for(let e=0;e<d.length;++e)l.set(d[e].id,d[e]);let c=null,h=null,m=e.startTime,u=0;const p=e.samples,g=e.timeDeltas;for(let e=0;e<p.length;++e){u=m,m+=g[e];const t=l.get(p[e]).callFrame.functionName;"(idle)"!==t?(c||(c=f("MessageLoop::RunTask",{},u,0,"X","toplevel")),"(program)"===t?h&&(h.dur=u-h.ts,h=null):h||(h=f("FunctionCall",{data:{sessionId:"1"}},u))):T()}return T(),f("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"I"),i;function T(){c&&(c.dur=u-c.ts),h&&(h.dur=u-h.ts),c=null,h=null}function f(e,n,a,r,s,o){const l={cat:o||"disabled-by-default-devtools.timeline",name:e,ph:s||"X",pid:1,tid:t,ts:a,args:n};return r&&(l.dur=r),i.push(l),l}}}!function(e){let t;!function(e){e.Compile="Compile",e.Parse="Parse"}(t=e.NativeGroups||(e.NativeGroups={}))}(l||(l={}));var d=Object.freeze({__proto__:null,get TimelineJSProfileProcessor(){return l}});const c={threadS:"Thread {PH1}",workerS:"`Worker` — {PH1}",dedicatedWorker:"Dedicated `Worker`",workerSS:"`Worker`: {PH1} — {PH2}"},h=t.i18n.registerUIStrings("models/timeline_model/TimelineModel.ts",c),m=t.i18n.getLocalizedString.bind(void 0,h);class u{isGenericTraceInternal;tracksInternal;namedTracks;inspectedTargetEventsInternal;timeMarkerEventsInternal;sessionId;mainFrameNodeId;pageFrames;cpuProfilesInternal;workerIdByThread;requestsFromBrowser;mainFrame;minimumRecordTimeInternal;maximumRecordTimeInternal;totalBlockingTimeInternal;estimatedTotalBlockingTime;asyncEventTracker;invalidationTracker;layoutInvalidate;lastScheduleStyleRecalculation;paintImageEventByPixelRefId;lastPaintForLayer;lastRecalculateStylesEvent;currentScriptEvent;eventStack;knownInputEvents;browserFrameTracking;persistentIds;legacyCurrentPage;currentTaskLayoutAndRecalcEvents;tracingModelInternal;mainFrameLayerTreeId;constructor(){this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=0,this.estimatedTotalBlockingTime=0,this.reset(),this.resetProcessingState(),this.currentTaskLayoutAndRecalcEvents=[],this.tracingModelInternal=null}static forEachEvent(e,t,n,a,s,i,o){s=s||0,i=i||1/0;const l=[];for(let d=u.topLevelEventEndingAfter(e,s);d<e.length;++d){const c=e[d];if((c.endTime||c.startTime)<s)continue;if(c.startTime>=i)break;if(r.TracingModel.TracingModel.isAsyncPhase(c.phase)||r.TracingModel.TracingModel.isFlowPhase(c.phase))continue;let h=l[l.length-1];for(;h&&void 0!==h.endTime&&h.endTime<=c.startTime;)l.pop(),n(h),h=l[l.length-1];o&&!o(c)||(c.duration?(t(c),l.push(c)):a&&a(c,l[l.length-1]||null))}for(;l.length;){const e=l.pop();e&&n(e)}}static topLevelEventEndingAfter(e,t){let a=n.ArrayUtilities.upperBound(e,t,((e,t)=>e-t.startTime))-1;for(;a>0&&!r.TracingModel.TracingModel.isTopLevelEvent(e[a]);)a--;return Math.max(a,0)}isMarkerEvent(e){switch(e.name){case p.TimeStamp:return!0;case p.MarkFirstPaint:case p.MarkFCP:return Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId&&Boolean(e.args.data);case p.MarkDOMContent:case p.MarkLoad:case p.MarkLCPCandidate:case p.MarkLCPInvalidate:return Boolean(e.args.data.isMainFrame);default:return!1}}isInteractiveTimeEvent(e){return e.name===p.InteractiveTime}isLayoutShiftEvent(e){return e.name===p.LayoutShift}isUserTimingEvent(e){return e.categoriesString===u.Category.UserTiming}isParseHTMLEvent(e){return e.name===p.ParseHTML}isLCPCandidateEvent(e){return e.name===p.MarkLCPCandidate&&Boolean(e.args.data.isMainFrame)}isLCPInvalidateEvent(e){return e.name===p.MarkLCPInvalidate&&Boolean(e.args.data.isMainFrame)}isFCPEvent(e){return e.name===p.MarkFCP&&Boolean(this.mainFrame)&&e.args.frame===this.mainFrame.frameId}isLongRunningTask(e){return e.name===p.Task&&S.forEvent(e).warning===u.WarningType.LongTask}isNavigationStartEvent(e){return e.name===p.NavigationStart}isMainFrameNavigationStartEvent(e){return this.isNavigationStartEvent(e)&&e.args.data.isLoadingMainFrame&&e.args.data.documentLoaderURL}static globalEventId(e,t){const n=e.args.data||e.args.beginData,a=n&&n[t];return a?`${e.thread.process().id()}.${a}`:""}static eventFrameId(e){const t=e.args.data||e.args.beginData;return t&&t.frame||null}cpuProfiles(){return this.cpuProfilesInternal}totalBlockingTime(){return-1===this.totalBlockingTimeInternal?{time:this.estimatedTotalBlockingTime,estimated:!0}:{time:this.totalBlockingTimeInternal,estimated:!1}}targetByEvent(e){const t=this.workerIdByThread.get(e.thread),n=r.TargetManager.TargetManager.instance().mainTarget();return t?r.TargetManager.TargetManager.instance().targetById(t):n}navStartTimes(){return this.tracingModelInternal?this.tracingModelInternal.navStartTimes():new Map}setEvents(e){this.reset(),this.resetProcessingState(),this.tracingModelInternal=e,this.minimumRecordTimeInternal=e.minimumRecordTime(),this.maximumRecordTimeInternal=e.maximumRecordTime();const t=[];for(const n of e.sortedProcesses())if("Renderer"===n.name())for(const e of n.sortedThreads()){const n=e.removeEventsByName(p.LayoutShift);t.push(...n)}if(this.processSyncBrowserEvents(e),this.browserFrameTracking)this.processThreadsForBrowserFrames(e);else{const t=this.processMetadataEvents(e);this.isGenericTraceInternal=!t,t?this.processMetadataAndThreads(e,t):this.processGenericTrace(e)}this.inspectedTargetEventsInternal.sort(r.TracingModel.Event.compareStartTime),this.processAsyncBrowserEvents(e),this.buildGPUEvents(e),this.buildLoadingEvents(e,t),this.resetProcessingState()}processGenericTrace(e){let t=r.TracingModel.TracingModel.browserMainThread(e);!t&&e.sortedProcesses().length&&(t=e.sortedProcesses()[0].sortedThreads()[0]);for(const n of e.sortedProcesses())for(const a of n.sortedThreads())this.processThreadEvents(e,[{from:0,to:1/0}],a,a===t,!1,!0,null)}processMetadataAndThreads(e,t){let n=0;for(let a=0,r=t.page.length;a<r;a++){const s=t.page[a],i=s.thread.process(),o=a+1<r?t.page[a+1].startTime:1/0;if(n!==o){this.legacyCurrentPage=s.args.data&&s.args.data.page;for(const a of i.sortedThreads()){let r=null;if(a.name()===u.WorkerThreadName||a.name()===u.WorkerThreadNameLegacy){const e=t.workers.find((e=>{if(e.args.data.workerThreadId!==a.id())return!1;if(e.args.data.sessionId===this.sessionId)return!0;const t=u.eventFrameId(e);return!!t&&Boolean(this.pageFrames.get(t))}));if(!e)continue;const n=e.args.data.workerId;n&&this.workerIdByThread.set(a,n),r=e.args.data.url||""}this.processThreadEvents(e,[{from:n,to:o}],a,a===s.thread,Boolean(r),!0,r)}n=o}}}processThreadsForBrowserFrames(e){const t=new Map;for(const e of this.pageFrames.values())for(let n=0;n<e.processes.length;n++){const a=e.processes[n].processId;let r=t.get(a);r||(r=[],t.set(a,r));const s=n===e.processes.length-1?e.deletedTime||1/0:e.processes[n+1].time;r.push({from:e.processes[n].time,to:s,main:!e.parent,url:e.processes[n].url})}const n=e.devToolsMetadataEvents();for(const a of e.sortedProcesses()){const r=t.get(a.id());if(!r)continue;r.sort(((e,t)=>e.from-t.from||e.to-t.to));const s=[];let i=null,o=null,l=!1;for(const e of r){const t=s[s.length-1];!t||e.from>t.to?s.push({from:e.from,to:e.to}):t.to=e.to,e.main&&(l=!0),e.url&&(e.main&&(o=e.url),i=e.url)}for(const t of a.sortedThreads())if(t.name()===u.RendererMainThreadName)this.processThreadEvents(e,s,t,!0,!1,l,l?o:i);else if(t.name()===u.WorkerThreadName||t.name()===u.WorkerThreadNameLegacy){const r=n.find((e=>{if(e.name!==u.DevToolsMetadataEvent.TracingSessionIdForWorker)return!1;if(e.thread.process()!==a)return!1;if(e.args.data.workerThreadId!==t.id())return!1;const n=u.eventFrameId(e);return!!n&&Boolean(this.pageFrames.get(n))}));if(!r)continue;this.workerIdByThread.set(t,r.args.data.workerId||""),this.processThreadEvents(e,s,t,!1,!0,!1,r.args.data.url||"")}else this.processThreadEvents(e,s,t,!1,!1,!1,null)}}processMetadataEvents(t){const n=t.devToolsMetadataEvents(),a=[],s=[];for(const e of n)if(e.name===u.DevToolsMetadataEvent.TracingStartedInPage){a.push(e),e.args.data&&e.args.data.persistentIds&&(this.persistentIds=!0);(e.args.data&&e.args.data.frames||[]).forEach((t=>this.addPageFrame(e,t))),this.mainFrame=this.rootFrames()[0]}else e.name===u.DevToolsMetadataEvent.TracingSessionIdForWorker?s.push(e):e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser&&(console.assert(!this.mainFrameNodeId,"Multiple sessions in trace"),this.mainFrameNodeId=e.args.frameTreeNodeId);if(!a.length)return null;const i=a[0].args.sessionId||a[0].args.data.sessionId;this.sessionId=i;const o=new Set;const l={page:a.filter((function(e){let t=e.args;t.data&&(t=t.data);const n=t.sessionId;return n===i||(o.add(n),!1)})).sort(r.TracingModel.Event.compareStartTime),workers:s.sort(r.TracingModel.Event.compareStartTime)};return o.size&&e.Console.Console.instance().error("Timeline recording was started in more than one page simultaneously. Session id mismatch: "+this.sessionId+" and "+[...o]+"."),l}processSyncBrowserEvents(e){const t=r.TracingModel.TracingModel.browserMainThread(e);t&&t.events().forEach(this.processBrowserEvent,this)}processAsyncBrowserEvents(e){const t=r.TracingModel.TracingModel.browserMainThread(e);t&&this.processAsyncEvents(t,[{from:0,to:1/0}])}buildGPUEvents(e){const t=e.getThreadByName("GPU Process","CrGpuMain");if(!t)return;const n=p.GPUTask,a=this.ensureNamedTrack(g.GPU);a.thread=t,a.events=t.events().filter((e=>e.name===n))}buildLoadingEvents(e,t){const n=e.getThreadByName("Renderer","CrRendererMain");if(!n)return;const a=this.ensureNamedTrack(g.Experience);a.thread=n,a.events=t;for(const e of a.events)if(e.categoriesString="experience",e.name===p.LayoutShift){const t=e.args.data||e.args.beginData||{},n=S.forEvent(e);if(t.impacted_nodes)for(let e=0;e<t.impacted_nodes.length;++e)n.backendNodeIds.push(t.impacted_nodes[e].node_id)}}resetProcessingState(){this.asyncEventTracker=new F,this.invalidationTracker=new I,this.layoutInvalidate={},this.lastScheduleStyleRecalculation={},this.paintImageEventByPixelRefId={},this.lastPaintForLayer={},this.lastRecalculateStylesEvent=null,this.currentScriptEvent=null,this.eventStack=[],this.knownInputEvents=new Set,this.browserFrameTracking=!1,this.persistentIds=!1,this.legacyCurrentPage=null}extractCpuProfile(t,n){const a=n.events();let s,i=null,o=a[a.length-1];if(o&&o.name===p.CpuProfile){const e=o.args.data;s=e&&e.cpuProfile,i=this.targetByEvent(o)}if(!s){if(o=a.find((e=>e.name===p.Profile)),!o)return null;i=this.targetByEvent(o);const n=t.profileGroup(o);if(!n)return e.Console.Console.instance().error("Invalid CPU profile format."),null;s={startTime:1e3*o.startTime,endTime:0,nodes:[],samples:[],timeDeltas:[],lines:[]};for(const t of n.children){const n=t.args.data;"startTime"in n&&(s.startTime=1e3*t.startTime),"endTime"in n&&(s.endTime=1e3*t.startTime);const a=n.cpuProfile||{},r=a.samples||[],i=n.lines||Array(r.length).fill(0);if(s.nodes.push(...a.nodes||[]),s.lines.push(...i),s.samples&&s.samples.push(...r),s.timeDeltas&&s.timeDeltas.push(...n.timeDeltas||[]),s.samples&&s.timeDeltas&&s.samples.length!==s.timeDeltas.length)return e.Console.Console.instance().error("Failed to parse CPU profile."),null}if(!s.endTime&&s.timeDeltas){const e=s.timeDeltas;s.endTime=e.reduce(((e,t)=>e+t),s.startTime)}}try{const e=s,t=new r.CPUProfileDataModel.CPUProfileDataModel(e,i);return this.cpuProfilesInternal.push(t),t}catch(t){e.Console.Console.instance().error("Failed to parse CPU profile.")}return null}injectJSFrameEvents(t,s){const i=this.extractCpuProfile(t,s);let o=s.events();const d=i?l.generateTracingEventsFromCpuProfile(i,s):null;if(d&&d.length&&(o=n.ArrayUtilities.mergeOrdered(o,d,r.TracingModel.Event.orderedCompareStartTime)),d||o.some((e=>e.name===p.JSSample))){const t=l.generateJSFrameEvents(o,{showAllEvents:a.Runtime.experiments.isEnabled("timelineShowAllEvents"),showRuntimeCallStats:a.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats"),showNativeFunctions:e.Settings.Settings.instance().moduleSetting("showNativeFunctionsInJSProfile").get()});t&&t.length&&(o=n.ArrayUtilities.mergeOrdered(t,o,r.TracingModel.Event.orderedCompareStartTime))}return o}processThreadEvents(e,t,a,s,i,o,l){const d=new T;d.name=a.name()||m(c.threadS,{PH1:a.id()}),d.type=g.Other,d.thread=a,s?(d.type=g.MainThread,d.url=l||"",d.forMainFrame=o):i?(d.type=g.Worker,d.url=l||"",d.name=d.url?m(c.workerS,{PH1:d.url}):m(c.dedicatedWorker)):a.name().startsWith("CompositorTileWorker")&&(d.type=g.Raster),this.tracksInternal.push(d);const h=this.injectJSFrameEvents(e,a);this.eventStack=[];const u=this.eventStack;if(i){const e=h.find((e=>e.name===p.Profile));if(e){const t=this.targetByEvent(e);t&&(d.name=m(c.workerSS,{PH1:t.name(),PH2:d.url}))}}for(const e of t){let t=n.ArrayUtilities.lowerBound(h,e.from,((e,t)=>e-t.startTime));for(;t<h.length;t++){const n=h[t];if(n.startTime>=e.to)break;this.isInteractiveTimeEvent(n)&&-1===this.totalBlockingTimeInternal&&(this.totalBlockingTimeInternal=n.args.args.total_blocking_time_ms);const a=n.name===p.Task&&n.duration&&n.duration>50;s&&a&&n.duration&&(this.estimatedTotalBlockingTime+=n.duration-50);let i=u[u.length-1];for(;i&&void 0!==i.endTime&&i.endTime<=n.startTime;)u.pop(),i=u[u.length-1];if(this.processEvent(n)){if(!r.TracingModel.TracingModel.isAsyncPhase(n.phase)&&n.duration){if(u.length){const e=u[u.length-1];e&&(e.selfTime-=n.duration,e.selfTime<0&&this.fixNegativeDuration(e,n))}n.selfTime=n.duration,u.length||d.tasks.push(n),u.push(n)}this.isMarkerEvent(n)&&this.timeMarkerEventsInternal.push(n),d.events.push(n),this.inspectedTargetEventsInternal.push(n)}}}this.processAsyncEvents(a,t)}fixNegativeDuration(e,t){e.selfTime<-.001&&console.error(`Children are longer than parent at ${e.startTime} (${(t.startTime-this.minimumRecordTime()).toFixed(3)} by ${(-e.selfTime).toFixed(3)}`),e.selfTime=0}processAsyncEvents(e,t){const a=e.asyncEvents(),s=new Map;function i(e){return s.has(e)||s.set(e,[]),s.get(e)}for(const e of t){let t=n.ArrayUtilities.lowerBound(a,e.from,(function(e,t){return e-t.startTime}));for(;t<a.length;++t){const n=a[t];if(n.startTime>=e.to)break;if(n.hasCategory(u.Category.Console))i(g.Console).push(n);else if(n.hasCategory(u.Category.UserTiming))i(g.Timings).push(n);else if(n.name!==p.Animation)if(n.hasCategory(u.Category.LatencyInfo)||n.name===p.ImplSideFling){const e=n.steps[n.steps.length-1];if(!e)throw new Error("AsyncEvent.steps access is out of bounds.");if(e.phase!==r.TracingModel.Phase.AsyncEnd)continue;const t=e.args.data;if(n.causedFrame=Boolean(t&&t.INPUT_EVENT_LATENCY_RENDERER_SWAP_COMPONENT),n.hasCategory(u.Category.LatencyInfo)){if(e.id&&!this.knownInputEvents.has(e.id))continue;if(n.name===p.InputLatencyMouseMove&&!n.causedFrame)continue;if(t.is_coalesced)continue;const a=t.INPUT_EVENT_LATENCY_RENDERER_MAIN_COMPONENT;if(a){const e=a.time/1e3;S.forEvent(n.steps[0]).timeWaitingForMainThread=e-n.steps[0].startTime}}i(g.Input).push(n)}else;else i(g.Animation).push(n)}}for(const[t,a]of s){const s=this.ensureNamedTrack(t);s.thread=e,s.asyncEvents=n.ArrayUtilities.mergeOrdered(s.asyncEvents,a,r.TracingModel.Event.compareStartTime)}}processEvent(e){const t=this.eventStack;if(!t.length){if(this.currentTaskLayoutAndRecalcEvents&&this.currentTaskLayoutAndRecalcEvents.length){const e=this.currentTaskLayoutAndRecalcEvents.reduce(((e,t)=>void 0===t.duration?e:e+t.duration),0);if(e>u.Thresholds.ForcedLayout)for(const e of this.currentTaskLayoutAndRecalcEvents){S.forEvent(e).warning=e.name===p.Layout?u.WarningType.ForcedLayout:u.WarningType.ForcedStyle}}this.currentTaskLayoutAndRecalcEvents=[]}this.currentScriptEvent&&void 0!==this.currentScriptEvent.endTime&&e.startTime>this.currentScriptEvent.endTime&&(this.currentScriptEvent=null);const n=e.args.data||e.args.beginData||{},a=S.forEvent(e);n.stackTrace&&(a.stackTrace=n.stackTrace.map((t=>{if(e.name!==p.JSSample){const e={...t};return--e.lineNumber,--e.columnNumber,e}return t})));let r=u.eventFrameId(e);const s=t[t.length-1];switch(!r&&s&&(r=S.forEvent(s).frameId),a.frameId=r||this.mainFrame&&this.mainFrame.frameId||"",this.asyncEventTracker.processEvent(e),this.isMarkerEvent(e)&&this.ensureNamedTrack(g.Timings),e.name){case p.ResourceSendRequest:case p.WebSocketCreate:a.setInitiator(t[t.length-1]||null),a.url=n.url;break;case p.ScheduleStyleRecalculation:this.lastScheduleStyleRecalculation[n.frame]=e;break;case p.UpdateLayoutTree:case p.RecalculateStyles:this.invalidationTracker.didRecalcStyle(e),e.args.beginData&&a.setInitiator(this.lastScheduleStyleRecalculation[e.args.beginData.frame]),this.lastRecalculateStylesEvent=e,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break;case p.ScheduleStyleInvalidationTracking:case p.StyleRecalcInvalidationTracking:case p.StyleInvalidatorInvalidationTracking:case p.LayoutInvalidationTracking:this.invalidationTracker.addInvalidation(new y(e,a));break;case p.InvalidateLayout:{let t=e;const a=n.frame;!this.layoutInvalidate[a]&&this.lastRecalculateStylesEvent&&void 0!==this.lastRecalculateStylesEvent.endTime&&this.lastRecalculateStylesEvent.endTime>e.startTime&&(t=S.forEvent(this.lastRecalculateStylesEvent).initiator()),this.layoutInvalidate[a]=t;break}case p.Layout:{this.invalidationTracker.didLayout(e);const t=e.args.beginData.frame;if(a.setInitiator(this.layoutInvalidate[t]),e.args.endData)if(e.args.endData.layoutRoots)for(let t=0;t<e.args.endData.layoutRoots.length;++t)a.backendNodeIds.push(e.args.endData.layoutRoots[t].nodeId);else a.backendNodeIds.push(e.args.endData.rootNode);this.layoutInvalidate[t]=null,this.currentScriptEvent&&this.currentTaskLayoutAndRecalcEvents.push(e);break}case p.Task:void 0!==e.duration&&e.duration>u.Thresholds.LongTask&&(a.warning=u.WarningType.LongTask);break;case p.EventDispatch:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(a.warning=u.WarningType.LongHandler);break;case p.TimerFire:case p.FireAnimationFrame:void 0!==e.duration&&e.duration>u.Thresholds.RecurringHandler&&(a.warning=u.WarningType.LongRecurringHandler);break;case p.FunctionCall:"string"==typeof n.scriptName&&(n.url=n.scriptName),"number"==typeof n.scriptLine&&(n.lineNumber=n.scriptLine);case p.EvaluateScript:case p.CompileScript:case p.CacheScript:"number"==typeof n.lineNumber&&--n.lineNumber,"number"==typeof n.columnNumber&&--n.columnNumber;case p.RunMicrotasks:this.currentScriptEvent||(this.currentScriptEvent=e);break;case p.SetLayerTreeId:{if(this.sessionId&&n.sessionId&&this.sessionId===n.sessionId){this.mainFrameLayerTreeId=n.layerTreeId;break}const t=u.eventFrameId(e),a=t?this.pageFrames.get(t):null;if(!a||a.parent)return!1;this.mainFrameLayerTreeId=n.layerTreeId;break}case p.Paint:{if(this.invalidationTracker.didPaint=!0,"nodeId"in n&&a.backendNodeIds.push(n.nodeId),!n.layerId)break;const t=n.layerId;this.lastPaintForLayer[t]=e;break}case p.DisplayItemListSnapshot:case p.PictureSnapshot:{const t=this.findAncestorEvent(p.UpdateLayer);if(!t||t.args.layerTreeId!==this.mainFrameLayerTreeId)break;const n=this.lastPaintForLayer[t.args.layerId];n&&(S.forEvent(n).picture=e);break}case p.ScrollLayer:a.backendNodeIds.push(n.nodeId);break;case p.PaintImage:a.backendNodeIds.push(n.nodeId),a.url=n.url;break;case p.DecodeImage:case p.ResizeImage:{let e=this.findAncestorEvent(p.PaintImage);if(!e){const t=this.findAncestorEvent(p.DecodeLazyPixelRef);e=t&&this.paintImageEventByPixelRefId[t.args.LazyPixelRef]}if(!e)break;const t=S.forEvent(e);a.backendNodeIds.push(t.backendNodeIds[0]),a.url=t.url;break}case p.DrawLazyPixelRef:{const t=this.findAncestorEvent(p.PaintImage);if(!t)break;this.paintImageEventByPixelRefId[e.args.LazyPixelRef]=t;const n=S.forEvent(t);a.backendNodeIds.push(n.backendNodeIds[0]),a.url=n.url;break}case p.FrameStartedLoading:if(a.frameId!==e.args.frame)return!1;break;case p.MarkLCPCandidate:a.backendNodeIds.push(n.nodeId);break;case p.MarkDOMContent:case p.MarkLoad:{const t=u.eventFrameId(e);if(!t||!this.pageFrames.has(t))return!1;break}case p.CommitLoad:{if(this.browserFrameTracking)break;const t=u.eventFrameId(e),a=Boolean(n.isMainFrame),r=t?this.pageFrames.get(t):null;if(r)r.update(e.startTime,n);else if(this.persistentIds){if(a)return!1;if(!this.addPageFrame(e,n))return!1}else if(n.page&&n.page!==this.legacyCurrentPage)return!1;if(a&&t){const e=this.pageFrames.get(t);e&&(this.mainFrame=e)}break}case p.FireIdleCallback:void 0!==e.duration&&e.duration>n.allottedMilliseconds+u.Thresholds.IdleCallbackAddon&&(a.warning=u.WarningType.IdleDeadlineExceeded)}return!0}processBrowserEvent(e){if(e.name!==p.LatencyInfoFlow)if(e.name!==p.ResourceWillSendRequest){if(e.hasCategory(r.TracingModel.DevToolsMetadataEventCategory)&&e.args.data){const t=e.args.data;if(e.name===u.DevToolsMetadataEvent.TracingStartedInBrowser){if(!t.persistentIds)return;this.browserFrameTracking=!0,this.mainFrameNodeId=t.frameTreeNodeId;return void(t.frames||[]).forEach((e=>{const t=e.parent&&this.pageFrames.get(e.parent);if(e.parent&&!t)return;let n=this.pageFrames.get(e.frame);n||(n=new f(e),this.pageFrames.set(n.frameId,n),t?t.addChild(n):this.mainFrame=n),n.update(this.minimumRecordTimeInternal,e)}))}if(e.name===u.DevToolsMetadataEvent.FrameCommittedInBrowser&&this.browserFrameTracking){let n=this.pageFrames.get(t.frame);if(!n){const e=t.parent&&this.pageFrames.get(t.parent);if(!e)return;n=new f(t),this.pageFrames.set(n.frameId,n),e.addChild(n)}return void n.update(e.startTime,t)}if(e.name===u.DevToolsMetadataEvent.ProcessReadyInBrowser&&this.browserFrameTracking){const e=this.pageFrames.get(t.frame);return void(e&&e.processReady(t.processPseudoId,t.processId))}if(e.name===u.DevToolsMetadataEvent.FrameDeletedInBrowser&&this.browserFrameTracking){const n=this.pageFrames.get(t.frame);return void(n&&(n.deletedTime=e.startTime))}}}else{const t=e.args?.data?.requestId;"string"==typeof t&&this.requestsFromBrowser.set(t,e)}else{const t=e.args.frameTreeNodeId;"number"==typeof t&&t===this.mainFrameNodeId&&e.bind_id&&this.knownInputEvents.add(e.bind_id)}}ensureNamedTrack(e){let t=this.namedTracks.get(e);return t||(t=new T,t.type=e,this.tracksInternal.push(t),this.namedTracks.set(e,t),t)}findAncestorEvent(e){for(let t=this.eventStack.length-1;t>=0;--t){const n=this.eventStack[t];if(n.name===e)return n}return null}addPageFrame(e,t){const n=t.parent&&this.pageFrames.get(t.parent);if(t.parent&&!n)return!1;const a=new f(t);return this.pageFrames.set(a.frameId,a),a.update(e.startTime,t),n&&n.addChild(a),!0}reset(){this.isGenericTraceInternal=!1,this.tracksInternal=[],this.namedTracks=new Map,this.inspectedTargetEventsInternal=[],this.timeMarkerEventsInternal=[],this.sessionId=null,this.mainFrameNodeId=null,this.cpuProfilesInternal=[],this.workerIdByThread=new WeakMap,this.pageFrames=new Map,this.requestsFromBrowser=new Map,this.minimumRecordTimeInternal=0,this.maximumRecordTimeInternal=0,this.totalBlockingTimeInternal=-1,this.estimatedTotalBlockingTime=0}isGenericTrace(){return this.isGenericTraceInternal}tracingModel(){return this.tracingModelInternal}minimumRecordTime(){return this.minimumRecordTimeInternal}maximumRecordTime(){return this.maximumRecordTimeInternal}inspectedTargetEvents(){return this.inspectedTargetEventsInternal}tracks(){return this.tracksInternal}isEmpty(){return 0===this.minimumRecordTime()&&0===this.maximumRecordTime()}timeMarkerEvents(){return this.timeMarkerEventsInternal}rootFrames(){return Array.from(this.pageFrames.values()).filter((e=>!e.parent))}pageURL(){return this.mainFrame&&this.mainFrame.url||""}pageFrameById(e){return e&&this.pageFrames.get(e)||null}networkRequests(){if(this.isGenericTrace())return[];const e=new Map,t=[],n=[],a=new Set([p.ResourceWillSendRequest,p.ResourceSendRequest,p.ResourceReceiveResponse,p.ResourceReceivedData,p.ResourceFinish,p.ResourceMarkAsCached]),r=this.inspectedTargetEvents();for(let e=0;e<r.length;++e){const t=r[e];if(!a.has(t.name))continue;const n=u.globalEventId(t,"requestId"),i=t.args?.data?.requestId;if(t.name===p.ResourceSendRequest&&i&&this.requestsFromBrowser.has(i)){const e=this.requestsFromBrowser.get(i);e&&s(e,n)}s(t,n)}function s(a,r){let s=e.get(r);s?s.addEvent(a):(s=new v(a),e.set(r,s),s.startTime?t.push(s):n.push(s))}return n.concat(t)}}var p,g;!function(e){e.Task="RunTask",e.Program="Program",e.EventDispatch="EventDispatch",e.GPUTask="GPUTask",e.Animation="Animation",e.RequestMainThreadFrame="RequestMainThreadFrame",e.BeginFrame="BeginFrame",e.NeedsBeginFrameChanged="NeedsBeginFrameChanged",e.BeginMainThreadFrame="BeginMainThreadFrame",e.ActivateLayerTree="ActivateLayerTree",e.DrawFrame="DrawFrame",e.DroppedFrame="DroppedFrame",e.HitTest="HitTest",e.ScheduleStyleRecalculation="ScheduleStyleRecalculation",e.RecalculateStyles="RecalculateStyles",e.UpdateLayoutTree="UpdateLayoutTree",e.InvalidateLayout="InvalidateLayout",e.Layout="Layout",e.LayoutShift="LayoutShift",e.UpdateLayer="UpdateLayer",e.UpdateLayerTree="UpdateLayerTree",e.PaintSetup="PaintSetup",e.Paint="Paint",e.PaintImage="PaintImage",e.Rasterize="Rasterize",e.RasterTask="RasterTask",e.ScrollLayer="ScrollLayer",e.CompositeLayers="CompositeLayers",e.ComputeIntersections="IntersectionObserverController::computeIntersections",e.InteractiveTime="InteractiveTime",e.ScheduleStyleInvalidationTracking="ScheduleStyleInvalidationTracking",e.StyleRecalcInvalidationTracking="StyleRecalcInvalidationTracking",e.StyleInvalidatorInvalidationTracking="StyleInvalidatorInvalidationTracking",e.LayoutInvalidationTracking="LayoutInvalidationTracking",e.ParseHTML="ParseHTML",e.ParseAuthorStyleSheet="ParseAuthorStyleSheet",e.TimerInstall="TimerInstall",e.TimerRemove="TimerRemove",e.TimerFire="TimerFire",e.XHRReadyStateChange="XHRReadyStateChange",e.XHRLoad="XHRLoad",e.CompileScript="v8.compile",e.CompileCode="V8.CompileCode",e.OptimizeCode="V8.OptimizeCode",e.EvaluateScript="EvaluateScript",e.CacheScript="v8.produceCache",e.CompileModule="v8.compileModule",e.EvaluateModule="v8.evaluateModule",e.CacheModule="v8.produceModuleCache",e.WasmStreamFromResponseCallback="v8.wasm.streamFromResponseCallback",e.WasmCompiledModule="v8.wasm.compiledModule",e.WasmCachedModule="v8.wasm.cachedModule",e.WasmModuleCacheHit="v8.wasm.moduleCacheHit",e.WasmModuleCacheInvalid="v8.wasm.moduleCacheInvalid",e.FrameStartedLoading="FrameStartedLoading",e.CommitLoad="CommitLoad",e.MarkLoad="MarkLoad",e.MarkDOMContent="MarkDOMContent",e.MarkFirstPaint="firstPaint",e.MarkFCP="firstContentfulPaint",e.MarkLCPCandidate="largestContentfulPaint::Candidate",e.MarkLCPInvalidate="largestContentfulPaint::Invalidate",e.NavigationStart="navigationStart",e.TimeStamp="TimeStamp",e.ConsoleTime="ConsoleTime",e.UserTiming="UserTiming",e.ResourceWillSendRequest="ResourceWillSendRequest",e.ResourceSendRequest="ResourceSendRequest",e.ResourceReceiveResponse="ResourceReceiveResponse",e.ResourceReceivedData="ResourceReceivedData",e.ResourceFinish="ResourceFinish",e.ResourceMarkAsCached="ResourceMarkAsCached",e.RunMicrotasks="RunMicrotasks",e.FunctionCall="FunctionCall",e.GCEvent="GCEvent",e.MajorGC="MajorGC",e.MinorGC="MinorGC",e.JSFrame="JSFrame",e.JSSample="JSSample",e.V8Sample="V8Sample",e.JitCodeAdded="JitCodeAdded",e.JitCodeMoved="JitCodeMoved",e.StreamingCompileScript="v8.parseOnBackground",e.StreamingCompileScriptWaiting="v8.parseOnBackgroundWaiting",e.StreamingCompileScriptParsing="v8.parseOnBackgroundParsing",e.V8Execute="V8.Execute",e.UpdateCounters="UpdateCounters",e.RequestAnimationFrame="RequestAnimationFrame",e.CancelAnimationFrame="CancelAnimationFrame",e.FireAnimationFrame="FireAnimationFrame",e.RequestIdleCallback="RequestIdleCallback",e.CancelIdleCallback="CancelIdleCallback",e.FireIdleCallback="FireIdleCallback",e.WebSocketCreate="WebSocketCreate",e.WebSocketSendHandshakeRequest="WebSocketSendHandshakeRequest",e.WebSocketReceiveHandshakeResponse="WebSocketReceiveHandshakeResponse",e.WebSocketDestroy="WebSocketDestroy",e.EmbedderCallback="EmbedderCallback",e.SetLayerTreeId="SetLayerTreeId",e.TracingStartedInPage="TracingStartedInPage",e.TracingSessionIdForWorker="TracingSessionIdForWorker",e.DecodeImage="Decode Image",e.ResizeImage="Resize Image",e.DrawLazyPixelRef="Draw LazyPixelRef",e.DecodeLazyPixelRef="Decode LazyPixelRef",e.LazyPixelRef="LazyPixelRef",e.LayerTreeHostImplSnapshot="cc::LayerTreeHostImpl",e.PictureSnapshot="cc::Picture",e.DisplayItemListSnapshot="cc::DisplayItemList",e.LatencyInfo="LatencyInfo",e.LatencyInfoFlow="LatencyInfo.Flow",e.InputLatencyMouseMove="InputLatency::MouseMove",e.InputLatencyMouseWheel="InputLatency::MouseWheel",e.ImplSideFling="InputHandlerProxy::HandleGestureFling::started",e.GCCollectGarbage="BlinkGC.AtomicPhase",e.CryptoDoEncrypt="DoEncrypt",e.CryptoDoEncryptReply="DoEncryptReply",e.CryptoDoDecrypt="DoDecrypt",e.CryptoDoDecryptReply="DoDecryptReply",e.CryptoDoDigest="DoDigest",e.CryptoDoDigestReply="DoDigestReply",e.CryptoDoSign="DoSign",e.CryptoDoSignReply="DoSignReply",e.CryptoDoVerify="DoVerify",e.CryptoDoVerifyReply="DoVerifyReply",e.CpuProfile="CpuProfile",e.Profile="Profile",e.AsyncTask="AsyncTask"}(p||(p={})),function(e){let t;e.Category={Console:"blink.console",UserTiming:"blink.user_timing",LatencyInfo:"latencyInfo",Loading:"loading"},function(e){e.LongTask="LongTask",e.ForcedStyle="ForcedStyle",e.ForcedLayout="ForcedLayout",e.IdleDeadlineExceeded="IdleDeadlineExceeded",e.LongHandler="LongHandler",e.LongRecurringHandler="LongRecurringHandler",e.V8Deopt="V8Deopt"}(t=e.WarningType||(e.WarningType={})),e.WorkerThreadName="DedicatedWorker thread",e.WorkerThreadNameLegacy="DedicatedWorker Thread",e.RendererMainThreadName="CrRendererMain",e.BrowserMainThreadName="CrBrowserMain",e.DevToolsMetadataEvent={TracingStartedInBrowser:"TracingStartedInBrowser",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",FrameCommittedInBrowser:"FrameCommittedInBrowser",ProcessReadyInBrowser:"ProcessReadyInBrowser",FrameDeletedInBrowser:"FrameDeletedInBrowser"},e.Thresholds={LongTask:50,Handler:150,RecurringHandler:50,ForcedLayout:30,IdleCallbackAddon:5}}(u||(u={}));class T{name;type;forMainFrame;url;events;asyncEvents;tasks;syncEventsInternal;thread;constructor(){this.name="",this.type=g.Other,this.forMainFrame=!1,this.url="",this.events=[],this.asyncEvents=[],this.tasks=[],this.syncEventsInternal=null,this.thread=null}syncEvents(){if(this.events.length)return this.events;if(this.syncEventsInternal)return this.syncEventsInternal;const e=[];function t(){const t=e[e.length-1];if(void 0!==t){const e=t.endTime;if(void 0!==e)return e}throw new Error("End time does not exist on event.")}this.syncEventsInternal=[];for(const n of this.asyncEvents){const a=n.startTime;let s=n.endTime;for(void 0===s&&(s=a);e.length&&a>=t();)e.pop();if(e.length&&s>t()){this.syncEventsInternal=[];break}const i=new r.TracingModel.Event(n.categoriesString,n.name,r.TracingModel.Phase.Complete,a,n.thread);i.setEndTime(s),i.addArgs(n.args),this.syncEventsInternal.push(i),e.push(i)}return this.syncEventsInternal}}!function(e){e.MainThread="MainThread",e.Worker="Worker",e.Input="Input",e.Animation="Animation",e.Timings="Timings",e.Console="Console",e.Raster="Raster",e.GPU="GPU",e.Experience="Experience",e.Other="Other"}(g||(g={}));class f{frameId;url;name;children;parent;processes;deletedTime;ownerNode;constructor(e){this.frameId=e.frame,this.url=e.url||"",this.name=e.name,this.children=[],this.parent=null,this.processes=[],this.deletedTime=null,this.ownerNode=null}update(e,t){this.url=t.url||"",this.name=t.name,t.processId?this.processes.push({time:e,processId:t.processId,processPseudoId:"",url:t.url||""}):this.processes.push({time:e,processId:-1,processPseudoId:t.processPseudoId,url:t.url||""})}processReady(e,t){for(const n of this.processes)n.processPseudoId===e&&(n.processPseudoId="",n.processId=t)}addChild(e){this.children.push(e),e.parent=this}}class v{startTime;endTime;encodedDataLength;decodedBodyLength;children;timing;mimeType;url;requestMethod;transferSize;maybeDiskCached;memoryCachedInternal;priority;finishTime;responseTime;fromServiceWorker;hasCachedResource;constructor(e){const t=e.name===p.ResourceSendRequest||e.name===p.ResourceWillSendRequest;this.startTime=t?e.startTime:0,this.endTime=1/0,this.encodedDataLength=0,this.decodedBodyLength=0,this.children=[],this.transferSize=0,this.maybeDiskCached=!1,this.memoryCachedInternal=!1,this.addEvent(e)}addEvent(e){this.children.push(e),this.startTime=Math.min(this.startTime,e.startTime);const t=e.args.data;t.mimeType&&(this.mimeType=t.mimeType),"priority"in t&&(this.priority=t.priority),e.name===p.ResourceFinish&&(this.endTime=e.startTime),t.finishTime&&(this.finishTime=1e3*t.finishTime),this.responseTime||e.name!==p.ResourceReceiveResponse&&e.name!==p.ResourceReceivedData||(this.responseTime=e.startTime);const n=t.encodedDataLength||0;e.name===p.ResourceMarkAsCached&&(this.memoryCachedInternal=!0),e.name===p.ResourceReceiveResponse&&(t.fromCache&&(this.maybeDiskCached=!0),t.fromServiceWorker&&(this.fromServiceWorker=!0),t.hasCachedResource&&(this.hasCachedResource=!0),this.encodedDataLength=n),e.name===p.ResourceReceivedData&&(this.encodedDataLength+=n),e.name===p.ResourceFinish&&n&&(this.encodedDataLength=n,this.transferSize=n);const a=t.decodedBodyLength;e.name===p.ResourceFinish&&a&&(this.decodedBodyLength=a),this.url||(this.url=t.url),this.requestMethod||(this.requestMethod=t.requestMethod),this.timing||(this.timing=t.timing),t.fromServiceWorker&&(this.fromServiceWorker=!0)}cached(){return Boolean(this.memoryCachedInternal)||Boolean(this.maybeDiskCached)&&!this.transferSize&&!this.fromServiceWorker}memoryCached(){return this.memoryCachedInternal}getSendReceiveTiming(){if(this.cached()||!this.timing)return{sendStartTime:this.startTime,headersEndTime:this.startTime};const e=1e3*this.timing.requestTime;return{sendStartTime:e+this.timing.sendStart,headersEndTime:e+this.timing.receiveHeadersEnd}}getStartTime(){return Math.min(this.startTime,!this.cached()&&this.timing&&1e3*this.timing.requestTime||1/0)}beginTime(){return Math.min(this.getStartTime(),!this.cached()&&this.timing&&1e3*this.timing.pushStart||1/0)}}class y{type;startTime;tracingEvent;frame;nodeId;nodeName;invalidationSet;invalidatedSelectorId;changedId;changedClass;changedAttribute;changedPseudo;selectorPart;extraData;invalidationList;cause;linkedRecalcStyleEvent;linkedLayoutEvent;constructor(e,t){this.type=e.name,this.startTime=e.startTime,this.tracingEvent=e;const n=e.args.data;this.frame=n.frame,this.nodeId=n.nodeId,this.nodeName=n.nodeName,this.invalidationSet=n.invalidationSet,this.invalidatedSelectorId=n.invalidatedSelectorId,this.changedId=n.changedId,this.changedClass=n.changedClass,this.changedAttribute=n.changedAttribute,this.changedPseudo=n.changedPseudo,this.selectorPart=n.selectorPart,this.extraData=n.extraData,this.invalidationList=n.invalidationList,this.cause={reason:n.reason,stackTrace:t.stackTrace},this.linkedRecalcStyleEvent=!1,this.linkedLayoutEvent=!1,!this.cause.reason&&this.cause.stackTrace&&this.type===p.LayoutInvalidationTracking&&(this.cause.reason="Layout forced")}}class I{lastRecalcStyle;lastPaintWithLayer;didPaint;invalidations;invalidationsByNodeId;constructor(){this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1,this.initializePerFrameState(),this.invalidations={},this.invalidationsByNodeId={}}static invalidationEventsFor(e){return R.get(e)||null}addInvalidation(e){if(this.startNewFrameIfNeeded(),!e.nodeId)return console.error("Invalidation lacks node information."),void console.error(e);if(e.type===p.StyleRecalcInvalidationTracking&&"StyleInvalidator"===e.cause.reason)return;if(e.type===p.ScheduleStyleInvalidationTracking||e.type===p.StyleInvalidatorInvalidationTracking||e.type===p.StyleRecalcInvalidationTracking){e.startTime&&this.lastRecalcStyle&&void 0!==this.lastRecalcStyle.endTime&&e.startTime>=this.lastRecalcStyle.startTime&&e.startTime<=this.lastRecalcStyle.endTime&&this.associateWithLastRecalcStyleEvent(e)}this.invalidations[e.type]?this.invalidations[e.type].push(e):this.invalidations[e.type]=[e],e.nodeId&&(this.invalidationsByNodeId[e.nodeId]?this.invalidationsByNodeId[e.nodeId].push(e):this.invalidationsByNodeId[e.nodeId]=[e])}didRecalcStyle(e){this.lastRecalcStyle=e;const t=[p.ScheduleStyleInvalidationTracking,p.StyleInvalidatorInvalidationTracking,p.StyleRecalcInvalidationTracking];for(const e of this.invalidationsOfTypes(t))this.associateWithLastRecalcStyleEvent(e)}associateWithLastRecalcStyleEvent(e){if(e.linkedRecalcStyleEvent)return;if(!this.lastRecalcStyle)throw new Error("Last recalculate style event not set.");const t=this.lastRecalcStyle.args.beginData.frame;e.type===p.StyleInvalidatorInvalidationTracking?this.addSyntheticStyleRecalcInvalidations(this.lastRecalcStyle,t,e):e.type===p.ScheduleStyleInvalidationTracking||this.addInvalidationToEvent(this.lastRecalcStyle,t,e),e.linkedRecalcStyleEvent=!0}addSyntheticStyleRecalcInvalidations(e,t,n){if(n.invalidationList){if(!n.nodeId)return console.error("Invalidation lacks node information."),void console.error(n);for(let e=0;e<n.invalidationList.length;e++){const a=n.invalidationList[e].id;let r;const s=this.invalidationsByNodeId[n.nodeId]||[];for(let e=0;e<s.length;e++){const n=s[e];n.frame===t&&n.invalidationSet===a&&n.type===p.ScheduleStyleInvalidationTracking&&(r=n)}r?this.addSyntheticStyleRecalcInvalidation(r.tracingEvent,n):console.error("Failed to lookup the event that scheduled a style invalidator invalidation.")}}else this.addSyntheticStyleRecalcInvalidation(n.tracingEvent,n)}addSyntheticStyleRecalcInvalidation(e,t){const n=S.forEvent(e),a=new y(e,n);a.type=p.StyleRecalcInvalidationTracking,t.cause.reason&&(a.cause.reason=t.cause.reason),t.selectorPart&&(a.selectorPart=t.selectorPart),this.addInvalidation(a),a.linkedRecalcStyleEvent||this.associateWithLastRecalcStyleEvent(a)}didLayout(e){const t=e.args.beginData.frame;for(const n of this.invalidationsOfTypes([p.LayoutInvalidationTracking]))n.linkedLayoutEvent||(this.addInvalidationToEvent(e,t,n),n.linkedLayoutEvent=!0)}addInvalidationToEvent(e,t,n){if(t!==n.frame)return;const a=R.get(e);a?a.push(n):R.set(e,[n])}invalidationsOfTypes(e){const t=this.invalidations;return e||(e=Object.keys(t)),function*(){if(e)for(let n=0;n<e.length;++n){const a=t[e[n]]||[];for(let e=0;e<a.length;++e)yield a[e]}}()}startNewFrameIfNeeded(){this.didPaint&&this.initializePerFrameState()}initializePerFrameState(){this.invalidations={},this.invalidationsByNodeId={},this.lastRecalcStyle=null,this.lastPaintWithLayer=null,this.didPaint=!1}}class F{initiatorByType;constructor(){if(F.initialize(),this.initiatorByType=new Map,F.asyncEvents)for(const e of F.asyncEvents.keys())this.initiatorByType.set(e,new Map)}static initialize(){if(F.asyncEvents)return;const e=new Map;e.set(p.TimerInstall,{causes:[p.TimerFire],joinBy:"timerId"}),e.set(p.ResourceSendRequest,{causes:[p.ResourceMarkAsCached,p.ResourceReceiveResponse,p.ResourceReceivedData,p.ResourceFinish],joinBy:"requestId"}),e.set(p.RequestAnimationFrame,{causes:[p.FireAnimationFrame],joinBy:"id"}),e.set(p.RequestIdleCallback,{causes:[p.FireIdleCallback],joinBy:"id"}),e.set(p.WebSocketCreate,{causes:[p.WebSocketSendHandshakeRequest,p.WebSocketReceiveHandshakeResponse,p.WebSocketDestroy],joinBy:"identifier"}),F.asyncEvents=e,F.typeToInitiator=new Map;for(const t of e){const e=t[1].causes;for(const n of e)F.typeToInitiator.set(n,t[0])}}processEvent(e){if(!F.typeToInitiator||!F.asyncEvents)return;let t=F.typeToInitiator.get(e.name);const n=!t;t||(t=e.name);const a=F.asyncEvents.get(t);if(!a)return;const r=u.globalEventId(e,a.joinBy);if(!r)return;const s=this.initiatorByType.get(t);if(s){if(n)return void s.set(r,e);const t=s.get(r),a=S.forEvent(e);a.setInitiator(t||null),!a.frameId&&t&&(a.frameId=u.eventFrameId(t))}}static asyncEvents=null;static typeToInitiator=null}class S{warning;previewElement;url;backendNodeIds;stackTrace;picture;initiatorInternal;frameId;timeWaitingForMainThread;constructor(){this.warning=null,this.previewElement=null,this.url=null,this.backendNodeIds=[],this.stackTrace=null,this.picture=null,this.initiatorInternal=null,this.frameId=null}setInitiator(e){if(this.initiatorInternal=e,!e||this.url)return;const t=S.forEvent(e).url;t&&(this.url=t)}initiator(){return this.initiatorInternal}topFrame(){const e=this.stackTraceForSelfOrInitiator();return e&&e[0]||null}stackTraceForSelfOrInitiator(){return this.stackTrace||this.initiatorInternal&&S.forEvent(this.initiatorInternal).stackTrace}static forEvent(e){let t=k.get(e);return t||(t=new S,k.set(e,t)),t}}const k=new WeakMap,R=new WeakMap;var C=Object.freeze({__proto__:null,get TimelineModelImpl(){return u},get RecordType(){return p},Track:T,get TrackType(){return g},PageFrame:f,NetworkRequest:v,InvalidationTrackingEvent:y,InvalidationTracker:I,TimelineAsyncEventTracker:F,TimelineData:S});class E{accept(e){return!0}}class P extends E{visibleTypes;constructor(e){super(),this.visibleTypes=new Set(e)}accept(e){return this.visibleTypes.has(P.eventType(e))}static eventType(e){return e.hasCategory(u.Category.Console)?p.ConsoleTime:e.hasCategory(u.Category.UserTiming)?p.UserTiming:e.hasCategory(u.Category.LatencyInfo)?p.LatencyInfo:e.name}}var M=Object.freeze({__proto__:null,TimelineModelFilter:E,TimelineVisibleEventsFilter:P,TimelineInvisibleEventsFilter:class extends E{invisibleTypes;constructor(e){super(),this.invisibleTypes=new Set(e)}accept(e){return!this.invisibleTypes.has(P.eventType(e))}},ExclusiveNameFilter:class extends E{excludeNames;constructor(e){super(),this.excludeNames=new Set(e)}accept(e){return!this.excludeNames.has(e.name)}}});class w extends r.LayerTreeBase.LayerTreeBase{tileById;paintProfilerModel;constructor(e){super(e),this.tileById=new Map,this.paintProfilerModel=e&&e.model(r.PaintProfiler.PaintProfilerModel)}async setLayers(e,t,n){const a=new Set;if(e)this.extractNodeIdsToResolve(a,{},e);else if(t)for(let e=0;e<t.length;++e)this.extractNodeIdsToResolve(a,{},t[e]);await this.resolveBackendNodeIds(a);const r=this.layersById;if(this.layersById=new Map,this.setContentRoot(null),e){const t=this.innerSetLayers(r,e);this.setRoot(t)}else if(t){const e=t.map(this.innerSetLayers.bind(this,r)),n=this.contentRoot();if(!n)throw new Error("Content root is not set.");this.setRoot(n);for(let t=0;t<e.length;++t)e[t].id()!==n.id()&&n.addChild(e[t])}this.setPaints(n)}setTiles(e){this.tileById=new Map;for(const t of e)this.tileById.set(t.id,t)}pictureForRasterTile(t){const n=this.tileById.get("cc::Tile/"+t);if(!n)return e.Console.Console.instance().error(`Tile ${t} is missing`),Promise.resolve(null);const a=this.layerById(n.layer_id);return a?a.pictureForRect(n.content_rect):(e.Console.Console.instance().error(`Layer ${n.layer_id} for tile ${t} is not found`),Promise.resolve(null))}setPaints(e){for(let t=0;t<e.length;++t){const n=this.layersById.get(e[t].layerId());n&&n.addPaintEvent(e[t])}}innerSetLayers(e,t){let n=e.get(t.layer_id);n?n.reset(t):n=new L(this.paintProfilerModel,t),this.layersById.set(t.layer_id,n),t.owner_node&&n.setNode(this.backendNodeIdToNode().get(t.owner_node)||null),!this.contentRoot()&&n.drawsContent()&&this.setContentRoot(n);for(let a=0;t.children&&a<t.children.length;++a)n.addChild(this.innerSetLayers(e,t.children[a]));return n}extractNodeIdsToResolve(e,t,n){const a=n.owner_node;a&&!this.backendNodeIdToNode().has(a)&&e.add(a);for(let a=0;n.children&&a<n.children.length;++a)this.extractNodeIdsToResolve(e,t,n.children[a])}}class L{parentLayerId;parentInternal;layerId;nodeInternal;offsetXInternal;offsetYInternal;widthInternal;heightInternal;childrenInternal;quadInternal;scrollRectsInternal;gpuMemoryUsageInternal;paints;compositingReasonIds;drawsContentInternal;paintProfilerModel;constructor(e,t){this.parentLayerId=null,this.parentInternal=null,this.layerId="",this.nodeInternal=null,this.offsetXInternal=-1,this.offsetYInternal=-1,this.widthInternal=-1,this.heightInternal=-1,this.childrenInternal=[],this.quadInternal=[],this.scrollRectsInternal=[],this.gpuMemoryUsageInternal=-1,this.paints=[],this.compositingReasonIds=[],this.drawsContentInternal=!1,this.paintProfilerModel=e,this.reset(t)}reset(e){this.nodeInternal=null,this.layerId=String(e.layer_id),this.offsetXInternal=e.position[0],this.offsetYInternal=e.position[1],this.widthInternal=e.bounds.width,this.heightInternal=e.bounds.height,this.childrenInternal=[],this.parentLayerId=null,this.parentInternal=null,this.quadInternal=e.layer_quad||[],this.createScrollRects(e),this.compositingReasonIds=e.compositing_reason_ids||e.debug_info&&e.debug_info.compositing_reason_ids||[],this.drawsContentInternal=Boolean(e.draws_content),this.gpuMemoryUsageInternal=e.gpu_memory_usage,this.paints=[]}id(){return this.layerId}parentId(){return this.parentLayerId}parent(){return this.parentInternal}isRoot(){return!this.parentId()}children(){return this.childrenInternal}addChild(e){const t=e;t.parentInternal&&console.assert(!1,"Child already has a parent"),this.childrenInternal.push(t),t.parentInternal=this,t.parentLayerId=this.layerId}setNode(e){this.nodeInternal=e}node(){return this.nodeInternal}nodeForSelfOrAncestor(){let e=this;for(;e;e=e.parent())if(e.node())return e.node();return null}offsetX(){return this.offsetXInternal}offsetY(){return this.offsetYInternal}width(){return this.widthInternal}height(){return this.heightInternal}transform(){return null}quad(){return this.quadInternal}anchorPoint(){return[.5,.5,0]}invisible(){return!1}paintCount(){return 0}lastPaintRect(){return null}scrollRects(){return this.scrollRectsInternal}stickyPositionConstraint(){return null}gpuMemoryUsage(){return this.gpuMemoryUsageInternal}snapshots(){return this.paints.map((e=>e.snapshotPromise().then((e=>{if(!e)return null;return{rect:{x:e.rect[0],y:e.rect[1],width:e.rect[2],height:e.rect[3]},snapshot:e.snapshot}}))))}pictureForRect(e){return Promise.all(this.paints.map((e=>e.picturePromise()))).then((n=>{const a=n.filter((n=>{return n&&(a=n.rect,r=e,t(a[0],a[0]+a[2],r[0],r[0]+r[2])&&t(a[1],a[1]+a[3],r[1],r[1]+r[3]));var a,r})).map((e=>({x:e.rect[0],y:e.rect[1],picture:e.serializedPicture})));if(!a.length||!this.paintProfilerModel)return null;const r=a.reduce(((e,t)=>Math.min(e,t.x)),1/0),s=a.reduce(((e,t)=>Math.min(e,t.y)),1/0),i={x:e[0]-r,y:e[1]-s,width:e[2],height:e[3]};return this.paintProfilerModel.loadSnapshotFromFragments(a).then((e=>e?{rect:i,snapshot:e}:null))}));function t(e,t,n,a){return console.assert(e<=t&&n<=a,"segments should be specified as ordered pairs"),t>n&&e<a}}scrollRectsFromParams(e,t){return{rect:{x:e[0],y:e[1],width:e[2],height:e[3]},type:t}}createScrollRects(e){const t=[];e.non_fast_scrollable_region&&t.push(this.scrollRectsFromParams(e.non_fast_scrollable_region,"NonFastScrollable")),e.touch_event_handler_region&&t.push(this.scrollRectsFromParams(e.touch_event_handler_region,"TouchEventHandler")),e.wheel_event_handler_region&&t.push(this.scrollRectsFromParams(e.wheel_event_handler_region,"WheelEventHandler")),e.scroll_event_handler_region&&t.push(this.scrollRectsFromParams(e.scroll_event_handler_region,"RepaintsOnScroll")),this.scrollRectsInternal=t}addPaintEvent(e){this.paints.push(e)}requestCompositingReasonIds(){return Promise.resolve(this.compositingReasonIds)}drawsContent(){return this.drawsContentInternal}}var b=Object.freeze({__proto__:null,TracingLayerTree:w,TracingLayer:L});const N={twoFlingsAtTheSameTimeSVsS:"Two flings at the same time? {PH1} vs {PH2}",twoTouchesAtTheSameTimeSVsS:"Two touches at the same time? {PH1} vs {PH2}"},B=t.i18n.registerUIStrings("models/timeline_model/TimelineIRModel.ts",N),D=t.i18n.getLocalizedString.bind(void 0,B),A=new WeakMap;class _{segments;drags;cssAnimations;responses;scrolls;constructor(){this.reset()}static phaseForEvent(e){return A.get(e)}populate(t,n){if(this.reset(),!t)return;this.processInputLatencies(t),n&&this.processAnimations(n);const a=new e.SegmentedRange.SegmentedRange;a.appendRange(this.drags),a.appendRange(this.cssAnimations),a.appendRange(this.scrolls),a.appendRange(this.responses),this.segments=a.segments()}processInputLatencies(t){const n=x,a=W,r=_._mergeThresholdsMs;let s,i,o,l,d,c,h;for(let u=0;u<t.length;++u){const p=t[u];u>0&&t[u].startTime<t[u-1].startTime&&console.assert(!1,"Unordered input events");switch(this.inputEventType(p.name)){case n.ScrollBegin:this.scrolls.append(this.segmentForEvent(p,a.Scroll)),s=p;break;case n.ScrollEnd:s?this.scrolls.append(this.segmentForEventRange(s,p,a.Scroll)):this.scrolls.append(this.segmentForEvent(p,a.Scroll)),s=null;break;case n.ScrollUpdate:o=null,this.scrolls.append(this.segmentForEvent(p,a.Scroll));break;case n.FlingStart:if(i){e.Console.Console.instance().error(D(N.twoFlingsAtTheSameTimeSVsS,{PH1:i.startTime,PH2:p.startTime}));break}i=p;break;case n.FlingCancel:if(!i)break;this.scrolls.append(this.segmentForEventRange(i,p,a.Fling)),i=null;break;case n.ImplSideFling:this.scrolls.append(this.segmentForEvent(p,a.Fling));break;case n.ShowPress:case n.Tap:case n.KeyDown:case n.KeyDownRaw:case n.KeyUp:case n.Char:case n.Click:case n.ContextMenu:this.responses.append(this.segmentForEvent(p,a.Response));break;case n.TouchStart:if(o){e.Console.Console.instance().error(D(N.twoTouchesAtTheSameTimeSVsS,{PH1:o.startTime,PH2:p.startTime}));break}o=p,this.setPhaseForEvent(p,a.Response),l=null;break;case n.TouchCancel:o=null;break;case n.TouchMove:l?this.drags.append(this.segmentForEvent(p,a.Drag)):o&&(l=p,this.responses.append(this.segmentForEventRange(o,p,a.Response)));break;case n.TouchEnd:o=null;break;case n.MouseDown:c=p,h=null;break;case n.MouseMove:c&&!h&&c.startTime+r.mouse>p.startTime?(this.responses.append(this.segmentForEvent(c,a.Response)),this.responses.append(this.segmentForEvent(p,a.Response))):c&&this.drags.append(this.segmentForEvent(p,a.Drag)),h=p;break;case n.MouseUp:this.responses.append(this.segmentForEvent(p,a.Response)),c=null;break;case n.MouseWheel:d&&m(r.mouse,d,p)?this.scrolls.append(this.segmentForEventRange(d,p,a.Scroll)):this.scrolls.append(this.segmentForEvent(p,a.Scroll)),d=p}}function m(e,t,n){return void 0!==t.endTime&&(t.endTime<n.startTime&&n.startTime<t.endTime+e)}}processAnimations(e){for(let t=0;t<e.length;++t)this.cssAnimations.append(this.segmentForEvent(e[t],W.Animation))}segmentForEvent(t,n){return this.setPhaseForEvent(t,n),new e.SegmentedRange.Segment(t.startTime,void 0!==t.endTime?t.endTime:Number.MAX_SAFE_INTEGER,n)}segmentForEventRange(t,n,a){return this.setPhaseForEvent(t,a),this.setPhaseForEvent(n,a),new e.SegmentedRange.Segment(t.startTime,void 0!==t.endTime?t.endTime:Number.MAX_SAFE_INTEGER,a)}setPhaseForEvent(e,t){A.set(e.steps[0],t)}interactionRecords(){return this.segments}reset(){const t=_._mergeThresholdsMs;function n(e,t,n){return t.end+e>=n.begin&&t.data===n.data?t:null}this.segments=[],this.drags=new e.SegmentedRange.SegmentedRange(n.bind(null,t.mouse)),this.cssAnimations=new e.SegmentedRange.SegmentedRange(n.bind(null,t.animation)),this.responses=new e.SegmentedRange.SegmentedRange(n.bind(null,0)),this.scrolls=new e.SegmentedRange.SegmentedRange(n.bind(null,t.animation))}inputEventType(e){const t="InputLatency::";if(!e.startsWith(t)){const t=e;return t===x.ImplSideFling?t:(console.error("Unrecognized input latency event: "+e),null)}return e.substr(t.length)}}var W,x;!function(e){e.Idle="Idle",e.Response="Response",e.Scroll="Scroll",e.Fling="Fling",e.Drag="Drag",e.Animation="Animation",e.Uncategorized="Uncategorized"}(W||(W={})),function(e){e.Char="Char",e.Click="GestureClick",e.ContextMenu="ContextMenu",e.FlingCancel="GestureFlingCancel",e.FlingStart="GestureFlingStart",e.ImplSideFling="InputHandlerProxy::HandleGestureFling::started",e.KeyDown="KeyDown",e.KeyDownRaw="RawKeyDown",e.KeyUp="KeyUp",e.LatencyScrollUpdate="ScrollUpdate",e.MouseDown="MouseDown",e.MouseMove="MouseMove",e.MouseUp="MouseUp",e.MouseWheel="MouseWheel",e.PinchBegin="GesturePinchBegin",e.PinchEnd="GesturePinchEnd",e.PinchUpdate="GesturePinchUpdate",e.ScrollBegin="GestureScrollBegin",e.ScrollEnd="GestureScrollEnd",e.ScrollUpdate="GestureScrollUpdate",e.ScrollUpdateRenderer="ScrollUpdate",e.ShowPress="GestureShowPress",e.Tap="GestureTap",e.TapCancel="GestureTapCancel",e.TapDown="GestureTapDown",e.TouchCancel="TouchCancel",e.TouchEnd="TouchEnd",e.TouchMove="TouchMove",e.TouchStart="TouchStart"}(x||(x={})),function(e){e._mergeThresholdsMs={animation:1,mouse:40},e._eventIRPhase=Symbol("eventIRPhase")}(_||(_={}));var U=Object.freeze({__proto__:null,get TimelineIRModel(){return _},get Phases(){return W},get InputEvents(){return x}});class G{categoryMapper;frames;frameById;beginFrameQueue;minimumRecordTime;lastFrame;mainFrameCommitted;mainFrameRequested;lastLayerTree;framePendingActivation;currentTaskTimeByCategory;target;framePendingCommit;lastBeginFrame;lastDroppedFrame;lastNeedsBeginFrame;lastTaskBeginTime;layerTreeId;currentProcessMainThread;constructor(e){this.categoryMapper=e,this.reset()}getFrames(){return this.frames}getFramesWithinWindow(e,t){const a=n.ArrayUtilities.lowerBound(this.frames,e||0,((e,t)=>e-t.endTime)),r=n.ArrayUtilities.lowerBound(this.frames,t||1/0,((e,t)=>e-t.startTime));return this.frames.slice(a,r)}hasRasterTile(e){const t=e.args.tileData;if(!t)return!1;const n=t.sourceFrameNumber,a=n&&this.frameById[n];return!(!a||!a.layerTree)}rasterTilePromise(e){if(!this.target)return Promise.resolve(null);const t=e.args.tileData,n=t.sourceFrameNumber,a=t.tileId&&t.tileId.id_ref,r=n&&this.frameById[n];return r&&r.layerTree&&a?r.layerTree.layerTreePromise().then((e=>e&&e.pictureForRasterTile(a))):Promise.resolve(null)}reset(){this.minimumRecordTime=1/0,this.frames=[],this.frameById={},this.beginFrameQueue=new $,this.lastFrame=null,this.lastLayerTree=null,this.mainFrameCommitted=!1,this.mainFrameRequested=!1,this.framePendingCommit=null,this.lastBeginFrame=null,this.lastDroppedFrame=null,this.lastNeedsBeginFrame=null,this.framePendingActivation=null,this.lastTaskBeginTime=null,this.target=null,this.layerTreeId=null,this.currentTaskTimeByCategory={}}handleBeginFrame(e,t){this.lastFrame||this.startFrame(e),this.lastBeginFrame=e,this.beginFrameQueue.addFrameIfNotExists(t,e,!1)}handleDroppedFrame(e,t){this.lastFrame||this.startFrame(e),this.beginFrameQueue.addFrameIfNotExists(t,e,!0),this.beginFrameQueue.setDropped(t,!0)}handleDrawFrame(e,t){if(this.lastFrame){if(this.mainFrameCommitted||!this.mainFrameRequested){if(this.lastNeedsBeginFrame){(this.framePendingActivation?this.framePendingActivation.triggerTime:this.lastBeginFrame||this.lastNeedsBeginFrame)>this.lastFrame.startTime&&(this.lastFrame.idle=!0,this.lastBeginFrame=null),this.lastNeedsBeginFrame=null}const e=this.beginFrameQueue.processPendingBeginFramesOnDrawFrame(t);for(const t of e){const e=this.lastFrame.idle;this.startFrame(t.startTime),e&&this.framePendingActivation&&this.commitPendingFrame(),t.isDropped&&(this.lastFrame.dropped=!0)}}this.mainFrameCommitted=!1}else this.startFrame(e)}handleActivateLayerTree(){this.lastFrame&&this.framePendingActivation&&!this.lastNeedsBeginFrame&&this.commitPendingFrame()}handleRequestMainThreadFrame(){this.lastFrame&&(this.mainFrameRequested=!0)}handleCompositeLayers(){this.framePendingCommit&&(this.framePendingActivation=this.framePendingCommit,this.framePendingCommit=null,this.mainFrameRequested=!1,this.mainFrameCommitted=!0)}handleLayerTreeSnapshot(e){this.lastLayerTree=e}handleNeedFrameChanged(e,t){t&&(this.lastNeedsBeginFrame=e)}startFrame(e){this.lastFrame&&this.flushFrame(this.lastFrame,e),this.lastFrame=new H(e,e-this.minimumRecordTime)}flushFrame(e,t){e.setLayerTree(this.lastLayerTree),e.setEndTime(t),this.lastLayerTree&&this.lastLayerTree.setPaints(e.paints);const n=this.frames[this.frames.length-1];this.frames.length&&n&&(e.startTime!==n.endTime||e.startTime>e.endTime)&&console.assert(!1,`Inconsistent frame time for frame ${this.frames.length} (${e.startTime} - ${e.endTime})`),this.frames.push(e),"number"==typeof e.mainFrameId&&(this.frameById[e.mainFrameId]=e)}commitPendingFrame(){this.framePendingActivation&&this.lastFrame&&(this.lastFrame.addTimeForCategories(this.framePendingActivation.timeByCategory),this.lastFrame.paints=this.framePendingActivation.paints,this.lastFrame.mainFrameId=this.framePendingActivation.mainFrameId,this.framePendingActivation=null)}addTraceEvents(e,t,n){this.target=e;let a=0;this.currentProcessMainThread=n.length&&n[0].thread||null;for(let e=0;e<t.length;++e){for(;a+1<n.length&&n[a+1].time<=t[e].startTime;)this.currentProcessMainThread=n[++a].thread;this.addTraceEvent(t[e])}this.currentProcessMainThread=null}addTraceEvent(e){if(e.startTime&&e.startTime<this.minimumRecordTime&&(this.minimumRecordTime=e.startTime),e.name===p.SetLayerTreeId)this.layerTreeId=e.args.layerTreeId||e.args.data.layerTreeId;else if(e.id&&e.phase===r.TracingModel.Phase.SnapshotObject&&e.name===p.LayerTreeHostImplSnapshot&&Number(e.id)===this.layerTreeId&&this.target){const t=e;this.handleLayerTreeSnapshot(new q(this.target,t))}else this.processCompositorEvents(e),e.thread===this.currentProcessMainThread?this.addMainThreadTraceEvent(e):this.lastFrame&&e.selfTime&&!r.TracingModel.TracingModel.isTopLevelEvent(e)&&this.lastFrame.addTimeForCategory(this.categoryMapper(e),e.selfTime)}processCompositorEvents(e){if(e.args.layerTreeId!==this.layerTreeId)return;const t=e.startTime;e.name===p.BeginFrame?this.handleBeginFrame(t,e.args.frameSeqId):e.name===p.DrawFrame?this.handleDrawFrame(t,e.args.frameSeqId):e.name===p.ActivateLayerTree?this.handleActivateLayerTree():e.name===p.RequestMainThreadFrame?this.handleRequestMainThreadFrame():e.name===p.NeedsBeginFrameChanged?this.handleNeedFrameChanged(t,e.args.data&&e.args.data.needsBeginFrame):e.name===p.DroppedFrame&&this.handleDroppedFrame(t,e.args.frameSeqId)}addMainThreadTraceEvent(e){r.TracingModel.TracingModel.isTopLevelEvent(e)&&(this.currentTaskTimeByCategory={},this.lastTaskBeginTime=e.startTime),!this.framePendingCommit&&G.mainFrameMarkers.indexOf(e.name)>=0&&(this.framePendingCommit=new O(this.lastTaskBeginTime||e.startTime,this.currentTaskTimeByCategory)),this.framePendingCommit?(this.addTimeForCategory(this.framePendingCommit.timeByCategory,e),e.name===p.BeginMainThreadFrame&&e.args.data&&e.args.data.frameId&&(this.framePendingCommit.mainFrameId=e.args.data.frameId),e.name===p.Paint&&e.args.data.layerId&&S.forEvent(e).picture&&this.target&&this.framePendingCommit.paints.push(new z(e,this.target)),e.name===p.CompositeLayers&&e.args.layerTreeId===this.layerTreeId&&this.handleCompositeLayers()):this.addTimeForCategory(this.currentTaskTimeByCategory,e)}addTimeForCategory(e,t){if(!t.selfTime)return;const n=this.categoryMapper(t);e[n]=(e[n]||0)+t.selfTime}static mainFrameMarkers=[p.ScheduleStyleRecalculation,p.InvalidateLayout,p.BeginMainThreadFrame,p.ScrollLayer]}class q{target;snapshot;paintsInternal;constructor(e,t){this.target=e,this.snapshot=t}async layerTreePromise(){const e=await this.snapshot.objectPromise();if(!e)return null;const t=e.device_viewport_size,n=e.active_tiles,a=e.active_tree.root_layer,r=e.active_tree.layers,s=new w(this.target);return s.setViewportSize(t),s.setTiles(n),await s.setLayers(a,r,this.paintsInternal||[]),s}paints(){return this.paintsInternal||[]}setPaints(e){this.paintsInternal=e}}class H{startTime;startTimeOffset;endTime;duration;timeByCategory;cpuTime;idle;dropped;layerTree;paints;mainFrameId;constructor(e,t){this.startTime=e,this.startTimeOffset=t,this.endTime=this.startTime,this.duration=0,this.timeByCategory={},this.cpuTime=0,this.idle=!1,this.dropped=!1,this.layerTree=null,this.paints=[],this.mainFrameId=void 0}hasWarnings(){return!1}setEndTime(e){this.endTime=e,this.duration=this.endTime-this.startTime}setLayerTree(e){this.layerTree=e}addTimeForCategories(e){for(const t in e)this.addTimeForCategory(t,e[t])}addTimeForCategory(e,t){this.timeByCategory[e]=(this.timeByCategory[e]||0)+t,this.cpuTime+=t}}class z{eventInternal;target;constructor(e,t){this.eventInternal=e,this.target=t}layerId(){return this.eventInternal.args.data.layerId}event(){return this.eventInternal}picturePromise(){const e=S.forEvent(this.eventInternal).picture;return e?e.objectPromise().then((e=>{if(!e)return null;const t=e.params&&e.params.layer_rect,n=e.skp64;return t&&n?{rect:t,serializedPicture:n}:null})):Promise.resolve(null)}async snapshotPromise(){const e=this.target&&this.target.model(r.PaintProfiler.PaintProfilerModel),t=await this.picturePromise();if(!t||!e)return null;const n=await e.loadSnapshot(t.serializedPicture);return n?{rect:t.rect,snapshot:n}:null}}class O{timeByCategory;paints;mainFrameId;triggerTime;constructor(e,t){this.timeByCategory=t,this.paints=[],this.mainFrameId=void 0,this.triggerTime=e}}class j{seqId;startTime;isDropped;constructor(e,t,n){this.seqId=e,this.startTime=t,this.isDropped=n}}class ${queueFrames;mapFrames;constructor(){this.queueFrames=[],this.mapFrames={}}addFrameIfNotExists(e,t,n){e in this.mapFrames||(this.mapFrames[e]=new j(e,t,n),this.queueFrames.push(e))}setDropped(e,t){e in this.mapFrames&&(this.mapFrames[e].isDropped=t)}processPendingBeginFramesOnDrawFrame(e){const t=[];if(e in this.mapFrames){for(;this.queueFrames[0]!==e;){const e=this.queueFrames[0];this.mapFrames[e].isDropped&&t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}t.push(this.mapFrames[e]),delete this.mapFrames[e],this.queueFrames.shift()}return t}}var J=Object.freeze({__proto__:null,TimelineFrameModel:G,TracingFrameLayerTree:q,TimelineFrame:H,LayerPaintEvent:z,PendingFrame:O,TimelineFrameBeginFrameQueue:$});class V{totalTime;selfTime;id;event;parent;groupId;isGroupNodeInternal;depth;constructor(e,t){this.totalTime=0,this.selfTime=0,this.id=e,this.event=t,this.groupId="",this.isGroupNodeInternal=!1,this.depth=0}isGroupNode(){return this.isGroupNodeInternal}hasChildren(){throw"Not implemented"}setHasChildren(e){throw"Not implemented"}children(){throw"Not implemented"}searchTree(e,t){t=t||[],this.event&&e(this.event)&&t.push(this);for(const n of this.children().values())n.searchTree(e,t);return t}}class X extends V{root;hasChildrenInternal;childrenInternal;parent;constructor(e,t,n){super(e,t),this.root=n&&n.root,this.hasChildrenInternal=!1,this.childrenInternal=null,this.parent=n}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){return this.childrenInternal||this.buildChildren()}buildChildren(){const e=[];for(let t=this;t.parent&&!t.isGroupNode();t=t.parent)e.push(t);e.reverse();const t=new Map,n=this,a=this.root;if(!a)return this.childrenInternal=t,this.childrenInternal;const r=a.startTime,s=a.endTime,i=a.doNotAggregate?function(t){++d,c===e.length&&d<=e.length+2&&m(t,0);--d}:void 0,o=a.doNotAggregate?void 0:Z,l=a.getEventGroupIdCallback();let d=0,c=0,h=null;function m(a,r){if(d===e.length+2){if(!h)return;return h.setHasChildren(!0),void(h.selfTime-=r)}let s,i="";o?(s=o(a),i=l?l(a):"",i&&(s+="/"+i)):s=Symbol("uniqueId");let c=t.get(s);c||(c=new X(s,a,n),c.groupId=i,t.set(s,c)),c.selfTime+=r,c.totalTime+=r,h=c}return u.forEachEvent(a.events,(function(t){if(++d,d>e.length+2)return;if(!function(t){if(c===e.length)return!0;if(c!==d-1)return!1;if(!t.endTime)return!1;if(!o)return t===e[c].event&&++c,!1;let n=o(t);const a=l?l(t):"";a&&(n+="/"+a);n===e[c].id&&++c;return!1}(t))return;const n=(void 0!==t.endTime?Math.min(t.endTime,s):s)-Math.max(r,t.startTime);n<0&&console.error("Negative event duration");m(t,n)}),(function(e){--d,c>d&&(c=d)}),i,r,s,a.filter),this.childrenInternal=t,t}getRoot(){return this.root}}class K extends V{childrenInternal;isGroupNodeInternal;constructor(e,t,n){super(e,n),this.childrenInternal=new Map,this.parent=t,this.isGroupNodeInternal=!0}addChild(e,t,n){this.childrenInternal.set(e.id,e),this.selfTime+=t,this.totalTime+=n,e.parent=this}hasChildren(){return!0}children(){return this.childrenInternal}}class Q extends V{parent;root;depth;cachedChildren;hasChildrenInternal;constructor(e,t,n,a,r){super(t,n),this.parent=r,this.root=e,this.depth=(r.depth||0)+1,this.cachedChildren=null,this.hasChildrenInternal=a}hasChildren(){return this.hasChildrenInternal}setHasChildren(e){this.hasChildrenInternal=e}children(){if(this.cachedChildren)return this.cachedChildren;const e=[0],t=[],n=[],a=new Map,r=this.root.startTime,s=this.root.endTime;let i=r;const o=this;return u.forEachEvent(this.root.events,(function(a){const i=(void 0!==a.endTime?Math.min(a.endTime,s):s)-Math.max(a.startTime,r);i<0&&console.assert(!1,"Negative duration of an event");e[e.length-1]-=i,e.push(i);const o=Z(a);t.push(o),n.push(a)}),(function(r){const l=e.pop(),d=t.pop();let c;for(n.pop(),c=o;c.depth>1;c=c.parent)if(c.id!==t[t.length+1-c.depth])return;if(c.id!==d||t.length<o.depth)return;const h=t[t.length-o.depth];if(c=a.get(h),!c){const e=n[n.length-o.depth],t=n.length>o.depth;c=new Q(o.root,h,e,t,o),a.set(h,c)}const m=void 0!==r.endTime?Math.min(r.endTime,s):s,u=m-Math.max(r.startTime,i);c.selfTime+=l||0,c.totalTime+=u,i=m}),void 0,r,s,this.root.filter),this.cachedChildren=this.root.filterChildren(a),this.cachedChildren}searchTree(e,t){return t=t||[],this.event&&e(this.event)&&t.push(this),t}}function Y(e){return e.name===p.JSFrame?e.args.data||null:S.forEvent(e).topFrame()}function Z(e){if(e.name===p.TimeStamp)return`${e.name}:${e.args.data.message}`;if(e.name!==p.JSFrame)return e.name;const t=e.args.data,n=t.scriptId||t.url||"",a=t.functionName;return`f:${l.isNativeRuntimeFrame(t)?l.nativeGroup(a)||a:`${a}:${t.lineNumber}:${t.columnNumber}`}@${n}`}var ee=Object.freeze({__proto__:null,Node:V,TopDownNode:X,TopDownRootNode:class extends X{events;filter;startTime;endTime;eventGroupIdCallback;doNotAggregate;totalTime;selfTime;constructor(e,t,n,a,r,s){super("",null,null),this.root=this,this.events=e,this.filter=e=>t.every((t=>t.accept(e))),this.startTime=n,this.endTime=a,this.eventGroupIdCallback=s,this.doNotAggregate=r,this.totalTime=a-n,this.selfTime=this.totalTime}children(){return this.childrenInternal||this.grouppedTopNodes()}grouppedTopNodes(){const e=super.children();for(const t of e.values())this.selfTime-=t.totalTime;if(!this.eventGroupIdCallback)return e;const t=new Map;for(const n of e.values()){const e=this.eventGroupIdCallback(n.event);let a=t.get(e);a||(a=new K(e,this,n.event),t.set(e,a)),a.addChild(n,n.selfTime,n.totalTime)}return this.childrenInternal=t,t}getEventGroupIdCallback(){return this.eventGroupIdCallback}},BottomUpRootNode:class extends V{childrenInternal;events;textFilter;filter;startTime;endTime;eventGroupIdCallback;totalTime;constructor(e,t,n,a,r,s){super("",null),this.childrenInternal=null,this.events=e,this.textFilter=t,this.filter=e=>n.every((t=>t.accept(e))),this.startTime=a,this.endTime=r,this.eventGroupIdCallback=s,this.totalTime=r-a}hasChildren(){return!0}filterChildren(e){for(const[t,n]of e)n.event&&!this.textFilter.accept(n.event)&&e.delete(t);return e}children(){return this.childrenInternal||(this.childrenInternal=this.filterChildren(this.grouppedTopNodes())),this.childrenInternal}ungrouppedTopNodes(){const e=this,t=this.startTime,n=this.endTime,a=new Map,r=[n-t],s=[],i=new Map;u.forEachEvent(this.events,(function(e){const a=(void 0!==e.endTime?Math.min(e.endTime,n):n)-Math.max(e.startTime,t);r[r.length-1]-=a,r.push(a);const o=Z(e),l=!i.has(o);l&&i.set(o,a);s.push(l)}),(function(t){const n=Z(t);let o=a.get(n);o||(o=new Q(e,n,t,!1,e),a.set(n,o));o.selfTime+=r.pop()||0,s.pop()&&(o.totalTime+=i.get(n)||0,i.delete(n));s.length&&o.setHasChildren(!0)}),void 0,t,n,this.filter),this.selfTime=r.pop()||0;for(const e of a)e[1].selfTime<=0&&a.delete(e[0]);return a}grouppedTopNodes(){const e=this.ungrouppedTopNodes();if(!this.eventGroupIdCallback)return e;const t=new Map;for(const n of e.values()){const e=this.eventGroupIdCallback(n.event);let a=t.get(e);a||(a=new K(e,this,n.event),t.set(e,a)),a.addChild(n,n.selfTime,n.selfTime)}return t}},GroupNode:K,BottomUpNode:Q,eventURL:function(e){const t=e.args.data||e.args.beginData;if(t&&t.url)return t.url;let n=Y(e);for(;n;){const e=n.url;if(e)return e;n=n.parent}return null},eventStackFrame:Y,_eventId:Z});export{J as TimelineFrameModel,U as TimelineIRModel,d as TimelineJSProfile,C as TimelineModel,M as TimelineModelFilter,ee as TimelineProfileTree,b as TracingLayerTree};
