import*as e from"../../core/sdk/sdk.js";import*as t from"../../ui/legacy/legacy.js";import*as n from"../../core/common/common.js";import*as s from"../../core/host/host.js";import*as i from"../../core/platform/platform.js";import*as r from"../../core/root/root.js";import*as o from"../logs/logs.js";import*as a from"../../ui/legacy/components/utils/utils.js";import*as c from"../../ui/legacy/theme_support/theme_support.js";import*as d from"../bindings/bindings.js";import*as u from"../har/har.js";import*as l from"../workspace/workspace.js";self.injectedExtensionAPI=function(e,t,n,s,i,r){const o=new Set(s),a=window.chrome||{};if(Object.getOwnPropertyDescriptor(a,"devtools"))return;let c=!1;function d(e,t){this._type=e,this._listeners=[],this._customDispatch=t}function u(){this.onRequestFinished=new E("network-request-finished",(function(e){const t=e.arguments[1];t.__proto__=new x(e.arguments[0]),this._fire(t)})),b(this,"network","onFinished","onRequestFinished"),this.onNavigated=new E("inspected-url-changed")}function l(e){this._id=e}function h(){const e={elements:new T,sources:new P};function t(t){return e[t]}for(const n in e)Object.defineProperty(this,n,{get:t.bind(null,n),enumerable:!0});this.applyStyleSheet=function(e){F.sendRequest({command:"applyStyleSheet",styleSheet:e})}}function p(e){this._id=e,e&&(this.onShown=new E("view-shown-"+e,(function(e){const t=e.arguments[0];"number"==typeof t?this._fire(window.parent.frames[t]):this._fire()})),this.onHidden=new E("view-hidden,"+e))}function g(e){p.call(this,null),this._hostPanelName=e,this.onSelectionChanged=new E("panel-objectSelected-"+e)}function m(){this._plugins=new Map}function f(e){return function(...t){const n={__proto__:e.prototype};e.apply(n,t),function(e,t){for(const n in t){if("_"===n.charAt(0))continue;let s=null;for(let e=t;e&&!s;e=e.__proto__)s=Object.getOwnPropertyDescriptor(e,n);s&&("function"==typeof s.value?e[n]=s.value.bind(t):"function"==typeof s.get?e.__defineGetter__(n,s.get.bind(t)):Object.defineProperty(e,n,s))}}(this,n)}}function b(e,t,n,s){let i=!1;e.__defineGetter__(n,(function(){return i||(console.warn(t+"."+n+" is deprecated. Use "+t+"."+s+" instead"),i=!0),e[s]}))}function w(e){const t=e[e.length-1];return"function"==typeof t?t:void 0}d.prototype={addListener:function(e){if("function"!=typeof e)throw"addListener: callback is not a function";0===this._listeners.length&&F.sendRequest({command:"subscribe",type:this._type}),this._listeners.push(e),F.registerHandler("notify-"+this._type,this._dispatch.bind(this))},removeListener:function(e){const t=this._listeners;for(let n=0;n<t.length;++n)if(t[n]===e){t.splice(n,1);break}0===this._listeners.length&&F.sendRequest({command:"unsubscribe",type:this._type})},_fire:function(...e){const t=this._listeners.slice();for(let e=0;e<t.length;++e)t[e].apply(null,Array.from(arguments))},_dispatch:function(e){this._customDispatch?this._customDispatch.call(this,e):this._fire.apply(this,e.arguments)}},u.prototype={getHAR:function(e){F.sendRequest({command:"getHAR"},e&&function(t){const n=t,s=n&&n.entries||[];for(let e=0;e<s.length;++e)s[e].__proto__=new x(s[e]._requestId),delete s[e]._requestId;e&&e(n)})},addRequestHeaders:function(e){F.sendRequest({command:"addRequestHeaders",headers:e,extensionId:window.location.hostname})}},l.prototype={getContent:function(e){F.sendRequest({command:"getRequestContent",id:this._id},e&&function(t){const{content:n,encoding:s}=t;e&&e(n,s)})}},h.prototype={create:function(e,t,n,s){const i="extension-panel-"+F.nextObjectId();F.sendRequest({command:"createPanel",id:i,title:e,page:n},s&&(()=>s.call(this,new I(i))))},setOpenResourceHandler:function(e){const t=F.hasHandler("open-resource");e?F.registerHandler("open-resource",(function(t){c=!0;try{const{resource:n,lineNumber:s}=t;e.call(null,new v(n),s)}finally{c=!1}})):F.unregisterHandler("open-resource"),t===!e&&F.sendRequest({command:"setOpenResourceHandler",handlerPresent:Boolean(e)})},openResource:function(e,t,n,s){const i=w(arguments),r="number"==typeof n?n:0;F.sendRequest({command:"openResource",url:e,lineNumber:t,columnNumber:r},i)},get SearchAction(){return{CancelSearch:"cancelSearch",PerformSearch:"performSearch",NextSearchResult:"nextSearchResult",PreviousSearchResult:"previousSearchResult"}}},g.prototype={createSidebarPane:function(e,t){const n="extension-sidebar-"+F.nextObjectId();F.sendRequest({command:"createSidebarPane",panel:this._hostPanelName,id:n,title:e},t&&function(){t&&t(new _(n))})},__proto__:p.prototype},m.prototype={registerLanguageExtensionPlugin:async function(e,t,n){if(this._plugins.has(e))throw new Error(`Tried to register plugin '${t}' twice`);const s=new MessageChannel,i=s.port1;this._plugins.set(e,i),i.onmessage=({data:t})=>{const{requestId:n}=t;console.time(`${n}: ${t.method}`),function(t){switch(t.method){case"addRawModule":return e.addRawModule(t.parameters.rawModuleId,t.parameters.symbolsURL,t.parameters.rawModule);case"removeRawModule":return e.removeRawModule(t.parameters.rawModuleId);case"sourceLocationToRawLocation":return e.sourceLocationToRawLocation(t.parameters.sourceLocation);case"rawLocationToSourceLocation":return e.rawLocationToSourceLocation(t.parameters.rawLocation);case"getScopeInfo":return e.getScopeInfo(t.parameters.type);case"listVariablesInScope":return e.listVariablesInScope(t.parameters.rawLocation);case"getTypeInfo":return e.getTypeInfo(t.parameters.expression,t.parameters.context);case"getFormatter":return e.getFormatter(t.parameters.expressionOrField,t.parameters.context);case"getInspectableAddress":return"getInspectableAddress"in e?e.getInspectableAddress(t.parameters.field):Promise.resolve({js:""});case"getFunctionInfo":return e.getFunctionInfo(t.parameters.rawLocation);case"getInlinedFunctionRanges":return e.getInlinedFunctionRanges(t.parameters.rawLocation);case"getInlinedCalleesRanges":return e.getInlinedCalleesRanges(t.parameters.rawLocation);case"getMappedLines":return"getMappedLines"in e?e.getMappedLines(t.parameters.rawModuleId,t.parameters.sourceFileURL):Promise.resolve(void 0)}throw new Error(`Unknown language plugin method ${t.method}`)}(t).then((e=>i.postMessage({requestId:n,result:e}))).catch((e=>i.postMessage({requestId:n,error:{message:e.message}}))).finally((()=>console.timeEnd(`${n}: ${t.method}`)))},await new Promise((e=>{F.sendRequest({command:"registerLanguageExtensionPlugin",pluginName:t,port:s.port2,supportedScriptTypes:n},(()=>e()),[s.port2])}))},unregisterLanguageExtensionPlugin:async function(e){const t=this._plugins.get(e);if(!t)throw new Error("Tried to unregister a plugin that was not previously registered");this._plugins.delete(e),t.postMessage({event:"unregisteredLanguageExtensionPlugin"}),t.close()}};const R=f(m),y=f(C),E=f(d),I=f(A),_=f(L),S=f(g),x=f(l),v=f(j),O=f(k);class T extends S{constructor(){super("elements")}}class P extends S{constructor(){super("sources")}}function A(e){p.call(this,e),this.onSearch=new E("panel-search-"+e)}function L(e){p.call(this,e)}function C(e){this._id=e,this.onClicked=new E("button-clicked-"+e)}function q(){}function k(e){this._id=e}function H(e){this.onRecordingStarted=new E("trace-recording-started-"+e,(function(e){const t=e.arguments[0];this._fire(new O(t))})),this.onRecordingStopped=new E("trace-recording-stopped-"+e)}function N(){this.onResourceAdded=new E("resource-added",(function(e){this._fire(new v(e.arguments[0]))})),this.onResourceContentCommitted=new E("resource-content-committed",(function(e){this._fire(new v(e.arguments[0]),e.arguments[1])}))}function j(e){this._url=e.url,this._type=e.type}A.prototype={createStatusBarButton:function(e,t,n){const s="button-"+F.nextObjectId();return F.sendRequest({command:"createToolbarButton",panel:this._id,id:s,icon:e,tooltip:t,disabled:Boolean(n)}),new y(s)},show:function(){c&&F.sendRequest({command:"showPanel",id:this._id})},__proto__:p.prototype},L.prototype={setHeight:function(e){F.sendRequest({command:"setSidebarHeight",id:this._id,height:e})},setExpression:function(e,t,n,s){F.sendRequest({command:"setSidebarContent",id:this._id,expression:e,rootTitle:t,evaluateOnPage:!0,evaluateOptions:"object"==typeof n?n:{}},w(arguments))},setObject:function(e,t,n){F.sendRequest({command:"setSidebarContent",id:this._id,expression:e,rootTitle:t},n)},setPage:function(e){F.sendRequest({command:"setSidebarPage",id:this._id,page:e})},__proto__:p.prototype},C.prototype={update:function(e,t,n){F.sendRequest({command:"updateButton",id:this._id,icon:e,tooltip:t,disabled:Boolean(n)})}},q.prototype={addTraceProvider:function(e,t){const n="extension-trace-provider-"+F.nextObjectId();return F.sendRequest({command:"addTraceProvider",id:n,categoryName:e,categoryTooltip:t}),new H(n)}},k.prototype={complete:function(e,t){F.sendRequest({command:"completeTra.eSession",id:this._id,url:e||"",timeOffset:t||0})}},N.prototype={reload:function(e){let t=null;"object"==typeof e?t=e:"string"==typeof e&&(t={userAgent:e},console.warn("Passing userAgent as string parameter to inspectedWindow.reload() is deprecated. Use inspectedWindow.reload({ userAgent: value}) instead.")),F.sendRequest({command:"Reload",options:t})},eval:function(e,t){const n=w(arguments);function s(e){const{isError:t,isException:s,value:i}=e;t||s?n&&n(void 0,e):n&&n(i)}return F.sendRequest({command:"evaluateOnInspectedPage",expression:e,evaluateOptions:"object"==typeof t?t:void 0},n&&s),null},getResources:function(e){function t(e){return new v(e)}F.sendRequest({command:"getPageResources"},e&&function(n){e&&e(n.map(t))})}},j.prototype={get url(){return this._url},get type(){return this._type},getContent:function(e){F.sendRequest({command:"getResourceContent",url:this._url},e&&function(t){const{content:n,encoding:s}=t;e&&e(n,s)})},setContent:function(e,t,n){F.sendRequest({command:"setResourceContent",url:this._url,content:e,commit:t},n)}};let M=[],D=null;function B(){D=null,F.sendRequest({command:"_forwardKeyboardEvent",entries:M}),M=[]}function U(){this._callbacks={},this._handlers={},this._lastRequestId=0,this._lastObjectId=0,this.registerHandler("callback",this._onCallback.bind(this));const e=new MessageChannel;this._port=e.port1,this._port.addEventListener("message",this._onMessage.bind(this),!1),this._port.start(),window.parent.postMessage("registerExtension","*",[e.port2])}document.addEventListener("keydown",(function(e){const t=document.activeElement;if(t){if(("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName)&&!(e.ctrlKey||e.altKey||e.metaKey))return}let n=0;e.shiftKey&&(n|=1),e.ctrlKey&&(n|=2),e.altKey&&(n|=4),e.metaKey&&(n|=8);const s=255&e.keyCode|n<<8;if(!o.has(s))return;e.preventDefault();const i={eventType:e.type,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,shiftKey:e.shiftKey,keyIdentifier:e.keyIdentifier,key:e.key,code:e.code,location:e.location,keyCode:e.keyCode};M.push(i),D||(D=setTimeout(B,0))}),!1),U.prototype={sendRequest:function(e,t,n){"function"==typeof t&&(e.requestId=this._registerCallback(t)),this._port.postMessage(e,n)},hasHandler:function(e){return Boolean(this._handlers[e])},registerHandler:function(e,t){this._handlers[e]=t},unregisterHandler:function(e){delete this._handlers[e]},nextObjectId:function(){return r.toString()+"_"+ ++this._lastObjectId},_registerCallback:function(e){const t=++this._lastRequestId;return this._callbacks[t]=e,t},_onCallback:function(e){if(e.requestId in this._callbacks){const t=this._callbacks[e.requestId];delete this._callbacks[e.requestId],t(e.result)}},_onMessage:function(e){const t=e.data,n=this._handlers[t.command];n&&n.call(this,t)}};const F=new U,W=new function(){this.inspectedWindow=new N,this.panels=new h,this.network=new u,this.timeline=new q,this.languageServices=new R,b(this,"webInspector","resources","network")};if(Object.defineProperty(a,"devtools",{value:{},enumerable:!0}),a.devtools.inspectedWindow={},Object.defineProperty(a.devtools.inspectedWindow,"tabId",{get:function(){return t}}),a.devtools.inspectedWindow.__proto__=W.inspectedWindow,a.devtools.network=W.network,a.devtools.panels=W.panels,a.devtools.panels.themeName=n,a.devtools.languageServices=W.languageServices,!1!==e.exposeExperimentalAPIs){a.experimental=a.experimental||{},a.experimental.devtools=a.experimental.devtools||{};const e=Object.getOwnPropertyNames(W);for(let t=0;t<e.length;++t){const n=Object.getOwnPropertyDescriptor(W,e[t]);n&&Object.defineProperty(a.experimental.devtools,e[t],n)}a.experimental.devtools.inspectedWindow=a.devtools.inspectedWindow}e.exposeWebInspectorNamespace&&(window.webInspector=W),i(F,W)},self.buildExtensionAPIInjectedScript=function(e,t,n,s,i){const r=[e,t||null,n,s].map((e=>JSON.stringify(e))).join(",");return i||(i=()=>{}),"(function(injectedScriptId){ ("+self.injectedExtensionAPI.toString()+")("+r+","+i+", injectedScriptId);})"};var h=Object.freeze({__proto__:null});class p extends t.Widget.Widget{server;id;iframe;frameIndex;constructor(e,t,n,s){super(),this.setHideOnDetach(),this.element.className="vbox flex-auto",this.element.tabIndex=-1,this.server=e,this.id=t,this.iframe=document.createElement("iframe"),this.iframe.addEventListener("load",this.onLoad.bind(this),!1),this.iframe.src=n,this.iframe.className=s,this.setDefaultFocusedElement(this.element),this.element.appendChild(this.iframe)}wasShown(){super.wasShown(),"number"==typeof this.frameIndex&&this.server.notifyViewShown(this.id,this.frameIndex)}willHide(){"number"==typeof this.frameIndex&&this.server.notifyViewHidden(this.id)}onLoad(){const e=window.frames;this.frameIndex=Array.prototype.indexOf.call(e,this.iframe.contentWindow),this.isShowing()&&this.server.notifyViewShown(this.id,this.frameIndex)}}class g extends t.Widget.VBox{server;id;constructor(e,t){super(),this.server=e,this.id=t}wasShown(){this.server.notifyViewShown(this.id)}willHide(){this.server.notifyViewHidden(this.id)}}var m=Object.freeze({__proto__:null,ExtensionView:p,ExtensionNotifierView:g});class f extends t.Panel.Panel{server;id;panelToolbar;searchableViewInternal;constructor(e,n,s,i){super(n),this.server=e,this.id=s,this.setHideOnDetach(),this.panelToolbar=new t.Toolbar.Toolbar("hidden",this.element),this.searchableViewInternal=new t.SearchableView.SearchableView(this,null),this.searchableViewInternal.show(this.element);new p(e,this.id,i,"extension").show(this.searchableViewInternal.element)}addToolbarItem(e){this.panelToolbar.element.classList.remove("hidden"),this.panelToolbar.appendToolbarItem(e)}searchCanceled(){this.server.notifySearchAction(this.id,"cancelSearch"),this.searchableViewInternal.updateSearchMatchesCount(0)}searchableView(){return this.searchableViewInternal}performSearch(e,t,n){const s=e.query;this.server.notifySearchAction(this.id,"performSearch",s)}jumpToNextSearchResult(){this.server.notifySearchAction(this.id,"nextSearchResult")}jumpToPreviousSearchResult(){this.server.notifySearchAction(this.id,"previousSearchResult")}supportsCaseSensitiveSearch(){return!1}supportsRegexSearch(){return!1}}class b{id;toolbarButtonInternal;constructor(e,n,s,i,r){this.id=n,this.toolbarButtonInternal=new t.Toolbar.ToolbarButton("",""),this.toolbarButtonInternal.addEventListener(t.Toolbar.ToolbarButton.Events.Click,e.notifyButtonClicked.bind(e,this.id)),this.update(s,i,r)}update(e,t,n){"string"==typeof e&&this.toolbarButtonInternal.setBackgroundImage(e),"string"==typeof t&&this.toolbarButtonInternal.setTitle(t),"boolean"==typeof n&&this.toolbarButtonInternal.setEnabled(!n)}toolbarButton(){return this.toolbarButtonInternal}}class w extends t.View.SimpleView{panelNameInternal;server;idInternal;extensionView;objectPropertiesView;constructor(e,t,n,s){super(n),this.element.classList.add("fill"),this.panelNameInternal=t,this.server=e,this.idInternal=s}id(){return this.idInternal}panelName(){return this.panelNameInternal}setObject(t,n,s){this.createObjectPropertiesView(),this.setObjectInternal(e.RemoteObject.RemoteObject.fromLocalObject(t),n,s)}setExpression(e,t,n,s,i){this.createObjectPropertiesView(),this.server.evaluate(e,!0,!1,n,s,this.onEvaluate.bind(this,t,i))}setPage(e){this.objectPropertiesView&&(this.objectPropertiesView.detach(),delete this.objectPropertiesView),this.extensionView&&this.extensionView.detach(!0),this.extensionView=new p(this.server,this.idInternal,e,"extension fill"),this.extensionView.show(this.element),this.element.style.height||this.setHeight("150px")}setHeight(e){this.element.style.height=e}onEvaluate(e,t,n,s,i){n?t(n.toString()):s?this.setObjectInternal(s,e,t):t()}createObjectPropertiesView(){this.objectPropertiesView||(this.extensionView&&(this.extensionView.detach(!0),delete this.extensionView),this.objectPropertiesView=new g(this.server,this.idInternal),this.objectPropertiesView.show(this.element))}setObjectInternal(e,n,s){const i=this.objectPropertiesView;i?(i.element.removeChildren(),t.UIUtils.Renderer.render(e,{title:n,editable:!1}).then((e=>{if(!e)return void s();const t=e.tree&&e.tree.firstChild();t&&t.expand(),i.element.appendChild(e.node),s()}))):s("operation cancelled")}}var R=Object.freeze({__proto__:null,ExtensionPanel:f,ExtensionButton:b,ExtensionSidebarPane:w});class y{extensionOrigin;id;categoryName;categoryTooltip;constructor(e,t,n,s){this.extensionOrigin=e,this.id=t,this.categoryName=n,this.categoryTooltip=s}start(e){const t=String(++E);O.instance().startTraceRecording(this.id,t,e)}stop(){O.instance().stopTraceRecording(this.id)}shortDisplayName(){return this.categoryName}longDisplayName(){return this.categoryTooltip}persistentIdentifier(){return`${this.extensionOrigin}/${this.categoryName}`}}let E=0;var I=Object.freeze({__proto__:null,ExtensionTraceProvider:y});class _ extends d.DebuggerLanguagePlugins.DebuggerLanguagePlugin{supportedScriptTypes;port;nextRequestId;pendingRequests;constructor(e,t,n){super(e),this.supportedScriptTypes=t,this.port=n,this.port.onmessage=this.onResponse.bind(this),this.nextRequestId=0,this.pendingRequests=new Map}sendRequest(e,t){return new Promise(((n,s)=>{const i=this.nextRequestId++;this.pendingRequests.set(i,{resolve:n,reject:s}),this.port.postMessage({requestId:i,method:e,parameters:t})}))}onResponse({data:e}){if("event"in e){const{event:t}=e;switch(t){case"unregisteredLanguageExtensionPlugin":{for(const{reject:e}of this.pendingRequests.values())e(new Error("Language extension endpoint disconnected"));this.pendingRequests.clear(),this.port.close();const{pluginManager:e}=d.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();e&&e.removePlugin(this);break}}return}const{requestId:t,result:n,error:s}=e;if(!this.pendingRequests.has(t))return void console.error(`No pending request ${t}`);const{resolve:i,reject:r}=this.pendingRequests.get(t);this.pendingRequests.delete(t),s?r(new Error(s.message)):i(n)}handleScript(e){const t=e.scriptLanguage();return null!==t&&null!==e.debugSymbols&&t===this.supportedScriptTypes.language&&this.supportedScriptTypes.symbol_types.includes(e.debugSymbols.type)}addRawModule(e,t,n){return this.sendRequest("addRawModule",{rawModuleId:e,symbolsURL:t,rawModule:n})}removeRawModule(e){return this.sendRequest("removeRawModule",{rawModuleId:e})}sourceLocationToRawLocation(e){return this.sendRequest("sourceLocationToRawLocation",{sourceLocation:e})}rawLocationToSourceLocation(e){return this.sendRequest("rawLocationToSourceLocation",{rawLocation:e})}getScopeInfo(e){return this.sendRequest("getScopeInfo",{type:e})}listVariablesInScope(e){return this.sendRequest("listVariablesInScope",{rawLocation:e})}getFunctionInfo(e){return this.sendRequest("getFunctionInfo",{rawLocation:e})}getInlinedFunctionRanges(e){return this.sendRequest("getInlinedFunctionRanges",{rawLocation:e})}getInlinedCalleesRanges(e){return this.sendRequest("getInlinedCalleesRanges",{rawLocation:e})}getTypeInfo(e,t){return this.sendRequest("getTypeInfo",{expression:e,context:t})}getFormatter(e,t){return this.sendRequest("getFormatter",{expressionOrField:e,context:t})}getInspectableAddress(e){return this.sendRequest("getInspectableAddress",{field:e})}async getMappedLines(e,t){return this.sendRequest("getMappedLines",{rawModuleId:e,sourceFileURL:t})}dispose(){}}const S=new WeakMap,x=["chrome://newtab","chrome://new-tab-page"].map((e=>new URL(e).origin));let v;class O extends n.ObjectWrapper.ObjectWrapper{clientObjects;handlers;subscribers;subscriptionStartHandlers;subscriptionStopHandlers;extraHeaders;requests;requestIds;lastRequestId;registeredExtensions;status;sidebarPanesInternal;traceProvidersInternal;traceSessions;extensionsEnabled;inspectedTabId;extensionAPITestHook;constructor(){super(),this.clientObjects=new Map,this.handlers=new Map,this.subscribers=new Map,this.subscriptionStartHandlers=new Map,this.subscriptionStopHandlers=new Map,this.extraHeaders=new Map,this.requests=new Map,this.requestIds=new Map,this.lastRequestId=0,this.registeredExtensions=new Map,this.status=new A,this.sidebarPanesInternal=[],this.traceProvidersInternal=[],this.traceSessions=new Map,this.extensionsEnabled=!0,this.registerHandler("addRequestHeaders",this.onAddRequestHeaders.bind(this)),this.registerHandler("addTraceProvider",this.onAddTraceProvider.bind(this)),this.registerHandler("applyStyleSheet",this.onApplyStyleSheet.bind(this)),this.registerHandler("completeTra.eSession",this.onCompleteTraceSession.bind(this)),this.registerHandler("createPanel",this.onCreatePanel.bind(this)),this.registerHandler("createSidebarPane",this.onCreateSidebarPane.bind(this)),this.registerHandler("createToolbarButton",this.onCreateToolbarButton.bind(this)),this.registerHandler("evaluateOnInspectedPage",this.onEvaluateOnInspectedPage.bind(this)),this.registerHandler("_forwardKeyboardEvent",this.onForwardKeyboardEvent.bind(this)),this.registerHandler("getHAR",this.onGetHAR.bind(this)),this.registerHandler("getPageResources",this.onGetPageResources.bind(this)),this.registerHandler("getRequestContent",this.onGetRequestContent.bind(this)),this.registerHandler("getResourceContent",this.onGetResourceContent.bind(this)),this.registerHandler("Reload",this.onReload.bind(this)),this.registerHandler("setOpenResourceHandler",this.onSetOpenResourceHandler.bind(this)),this.registerHandler("setResourceContent",this.onSetResourceContent.bind(this)),this.registerHandler("setSidebarHeight",this.onSetSidebarHeight.bind(this)),this.registerHandler("setSidebarContent",this.onSetSidebarContent.bind(this)),this.registerHandler("setSidebarPage",this.onSetSidebarPage.bind(this)),this.registerHandler("showPanel",this.onShowPanel.bind(this)),this.registerHandler("subscribe",this.onSubscribe.bind(this)),this.registerHandler("openResource",this.onOpenResource.bind(this)),this.registerHandler("unsubscribe",this.onUnsubscribe.bind(this)),this.registerHandler("updateButton",this.onUpdateButton.bind(this)),this.registerHandler("registerLanguageExtensionPlugin",this.registerLanguageExtensionEndpoint.bind(this)),window.addEventListener("message",this.onWindowMessage.bind(this),!1);const e=window.DevToolsAPI&&window.DevToolsAPI.getInspectedTabId&&window.DevToolsAPI.getInspectedTabId();e&&this.setInspectedTabId({data:e}),s.InspectorFrontendHost.InspectorFrontendHostInstance.events.addEventListener(s.InspectorFrontendHostAPI.Events.SetInspectedTabId,this.setInspectedTabId,this),this.initExtensions()}static instance(e={forceNew:null}){const{forceNew:t}=e;return v&&!t||(v=new O),v}initializeExtensions(){null!==this.inspectedTabId&&s.InspectorFrontendHost.InspectorFrontendHostInstance.setAddExtensionCallback(this.addExtension.bind(this))}hasExtensions(){return Boolean(this.registeredExtensions.size)}notifySearchAction(e,t,n){this.postNotification("panel-search-"+e,t,n)}notifyViewShown(e,t){this.postNotification("view-shown-"+e,t)}notifyViewHidden(e){this.postNotification("view-hidden,"+e)}notifyButtonClicked(e){this.postNotification("button-clicked-"+e)}registerLanguageExtensionEndpoint(e,t){if("registerLanguageExtensionPlugin"!==e.command)return this.status.E_BADARG("command","expected subscribe");const{pluginManager:n}=d.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance();if(!n)return this.status.E_FAILED("WebAssembly DWARF support needs to be enabled to use this extension");const{pluginName:s,port:i,supportedScriptTypes:{language:r,symbol_types:o}}=e,a=Array.isArray(o)&&o.every((e=>"string"==typeof e))?o:[],c=new _(s,{language:r,symbol_types:a},i);return n.addPlugin(c),this.status.OK()}inspectedURLChanged(t){if(!this.canInspectURL(t.data.inspectedURL()))return void this.disableExtensions();if(t.data!==e.TargetManager.TargetManager.instance().mainTarget())return;this.requests=new Map;const n=t.data.inspectedURL();this.postNotification("inspected-url-changed",n)}startTraceRecording(e,t,n){this.traceSessions.set(t,n),this.postNotification("trace-recording-started-"+e,t)}stopTraceRecording(e){this.postNotification("trace-recording-stopped-"+e)}hasSubscribers(e){return this.subscribers.has(e)}postNotification(e,...t){if(!this.extensionsEnabled)return;const n=this.subscribers.get(e);if(!n)return;const s={command:"notify-"+e,arguments:Array.prototype.slice.call(arguments,1)};for(const e of n)e.postMessage(s)}onSubscribe(e,t){if("subscribe"!==e.command)return this.status.E_BADARG("command","expected subscribe");const n=this.subscribers.get(e.type);if(n)n.add(t);else{this.subscribers.set(e.type,new Set([t]));const n=this.subscriptionStartHandlers.get(e.type);n&&n()}}onUnsubscribe(e,t){if("unsubscribe"!==e.command)return this.status.E_BADARG("command","expected unsubscribe");const n=this.subscribers.get(e.type);if(n&&(n.delete(t),!n.size)){this.subscribers.delete(e.type);const t=this.subscriptionStopHandlers.get(e.type);t&&t()}}onAddRequestHeaders(t){if("addRequestHeaders"!==t.command)return this.status.E_BADARG("command","expected addRequestHeaders");const n=t.extensionId;if("string"!=typeof n)return this.status.E_BADARGTYPE("extensionId",typeof n,"string");let s=this.extraHeaders.get(n);s||(s=new Map,this.extraHeaders.set(n,s));for(const e in t.headers)s.set(e,t.headers[e]);const i={};for(const e of this.extraHeaders.values())for(const[t,n]of e)"__proto__"!==t&&"string"==typeof n&&(i[t]=n);e.NetworkManager.MultitargetNetworkManager.instance().setExtraHTTPHeaders(i)}onApplyStyleSheet(e){if("applyStyleSheet"!==e.command)return this.status.E_BADARG("command","expected applyStyleSheet");if(!r.Runtime.experiments.isEnabled("applyCustomStylesheet"))return;const t=document.createElement("style");t.textContent=e.styleSheet,document.head.appendChild(t),c.ThemeSupport.instance().addCustomStylesheet(e.styleSheet);for(let e=document.body;e;e=e.traverseNextNode(document.body))e instanceof ShadowRoot&&c.ThemeSupport.instance().injectCustomStyleSheets(e)}getExtensionOrigin(e){const t=S.get(e);if(!t)throw new Error("Received a message from an unregistered extension");return t}onCreatePanel(e,n){if("createPanel"!==e.command)return this.status.E_BADARG("command","expected createPanel");const s=e.id;if(this.clientObjects.has(s)||t.InspectorView.InspectorView.instance().hasPanel(s))return this.status.E_EXISTS(s);const i=this.expandResourcePath(this.getExtensionOrigin(n),e.page);let r=this.getExtensionOrigin(n)+e.title;r=r.replace(/\s/g,"");const o=new P(r,e.title,new f(this,r,s,i));return this.clientObjects.set(s,o),t.InspectorView.InspectorView.instance().addPanel(o),this.status.OK()}onShowPanel(e){if("showPanel"!==e.command)return this.status.E_BADARG("command","expected showPanel");let n=e.id;const s=this.clientObjects.get(e.id);s&&s instanceof P&&(n=s.viewId()),t.InspectorView.InspectorView.instance().showPanel(n)}onCreateToolbarButton(e,t){if("createToolbarButton"!==e.command)return this.status.E_BADARG("command","expected createToolbarButton");const n=this.clientObjects.get(e.panel);if(!(n&&n instanceof P))return this.status.E_NOTFOUND(e.panel);const s=new b(this,e.id,this.expandResourcePath(this.getExtensionOrigin(t),e.icon),e.tooltip,e.disabled);return this.clientObjects.set(e.id,s),n.widget().then((function(e){e.addToolbarItem(s.toolbarButton())})),this.status.OK()}onUpdateButton(e,t){if("updateButton"!==e.command)return this.status.E_BADARG("command","expected updateButton");const n=this.clientObjects.get(e.id);return n&&n instanceof b?(n.update(e.icon&&this.expandResourcePath(this.getExtensionOrigin(t),e.icon),e.tooltip,e.disabled),this.status.OK()):this.status.E_NOTFOUND(e.id)}onCompleteTraceSession(e){if("completeTra.eSession"!==e.command)return this.status.E_BADARG("command","expected completeTra.eSession");const t=this.traceSessions.get(e.id);if(!t)return this.status.E_NOTFOUND(e.id);this.traceSessions.delete(e.id),t.complete(e.url,e.timeOffset)}onCreateSidebarPane(e){if("createSidebarPane"!==e.command)return this.status.E_BADARG("command","expected createSidebarPane");const t=e.id,n=new w(this,e.panel,e.title,t);return this.sidebarPanesInternal.push(n),this.clientObjects.set(t,n),this.dispatchEventToListeners(T.SidebarPaneAdded,n),this.status.OK()}sidebarPanes(){return this.sidebarPanesInternal}onSetSidebarHeight(e){if("setSidebarHeight"!==e.command)return this.status.E_BADARG("command","expected setSidebarHeight");const t=this.clientObjects.get(e.id);return t&&t instanceof w?(t.setHeight(e.height),this.status.OK()):this.status.E_NOTFOUND(e.id)}onSetSidebarContent(e,t){if("setSidebarContent"!==e.command)return this.status.E_BADARG("command","expected setSidebarContent");const{requestId:n,id:s,rootTitle:i,expression:r,evaluateOptions:o,evaluateOnPage:a}=e,c=this.clientObjects.get(s);if(!(c&&c instanceof w))return this.status.E_NOTFOUND(e.id);function d(e){const s=e?this.status.E_FAILED(e):this.status.OK();this.dispatchCallback(n,t,s)}a?c.setExpression(r,i,o,this.getExtensionOrigin(t),d.bind(this)):c.setObject(e.expression,e.rootTitle,d.bind(this))}onSetSidebarPage(e,t){if("setSidebarPage"!==e.command)return this.status.E_BADARG("command","expected setSidebarPage");const n=this.clientObjects.get(e.id);if(!(n&&n instanceof w))return this.status.E_NOTFOUND(e.id);n.setPage(this.expandResourcePath(this.getExtensionOrigin(t),e.page))}onOpenResource(e){if("openResource"!==e.command)return this.status.E_BADARG("command","expected openResource");const t=l.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e.url);if(t)return n.Revealer.reveal(t.uiLocation(e.lineNumber,e.columnNumber)),this.status.OK();const s=d.ResourceUtils.resourceForURL(e.url);if(s)return n.Revealer.reveal(s),this.status.OK();const i=o.NetworkLog.NetworkLog.instance().requestForURL(e.url);return i?(n.Revealer.reveal(i),this.status.OK()):this.status.E_NOTFOUND(e.url)}onSetOpenResourceHandler(e,t){if("setOpenResourceHandler"!==e.command)return this.status.E_BADARG("command","expected setOpenResourceHandler");const n=this.registeredExtensions.get(this.getExtensionOrigin(t));if(!n)throw new Error("Received a message from an unregistered extension");const{name:s}=n;e.handlerPresent?a.Linkifier.Linkifier.registerLinkHandler(s,this.handleOpenURL.bind(this,t)):a.Linkifier.Linkifier.unregisterLinkHandler(s)}handleOpenURL(e,t,n){e.postMessage({command:"open-resource",resource:this.makeResource(t),lineNumber:n+1})}onReload(t){if("Reload"!==t.command)return this.status.E_BADARG("command","expected Reload");const n=t.options||{};let s;return e.NetworkManager.MultitargetNetworkManager.instance().setUserAgentOverride("string"==typeof n.userAgent?n.userAgent:"",null),n.injectedScript&&(s="(function(){"+n.injectedScript+"})()"),e.ResourceTreeModel.ResourceTreeModel.reloadAllPages(Boolean(n.ignoreCache),s),this.status.OK()}onEvaluateOnInspectedPage(e,t){if("evaluateOnInspectedPage"!==e.command)return this.status.E_BADARG("command","expected evaluateOnInspectedPage");const{requestId:n,expression:s,evaluateOptions:i}=e;return this.evaluate(s,!0,!0,i,this.getExtensionOrigin(t),function(e,s,i){let r;r=e||!s?this.status.E_PROTOCOLERROR(e?.toString()):i?{isException:!0,value:s.description}:{value:s.value},this.dispatchCallback(n,t,r)}.bind(this))}async onGetHAR(e){if("getHAR"!==e.command)return this.status.E_BADARG("command","expected getHAR");const t=o.NetworkLog.NetworkLog.instance().requests(),n=await u.Log.Log.build(t);for(let e=0;e<n.entries.length;++e)n.entries[e]._requestId=this.requestId(t[e]);return n}makeResource(e){return{url:e.contentURL(),type:e.contentType().name()}}onGetPageResources(){const t=new Map;function n(e){return t.has(e.contentURL())||t.set(e.contentURL(),this.makeResource(e)),!1}let s=l.Workspace.WorkspaceImpl.instance().uiSourceCodesForProjectType(l.Workspace.projectTypes.Network);s=s.concat(l.Workspace.WorkspaceImpl.instance().uiSourceCodesForProjectType(l.Workspace.projectTypes.ContentScripts)),s.forEach(n.bind(this));for(const t of e.TargetManager.TargetManager.instance().models(e.ResourceTreeModel.ResourceTreeModel))t.forAllResources(n.bind(this));return[...t.values()]}async getResourceContent(e,t,n){const{content:s}=await e.requestContent(),i=await e.contentEncoded();this.dispatchCallback(t.requestId,n,{encoding:i?"base64":"",content:s})}onGetRequestContent(e,t){if("getRequestContent"!==e.command)return this.status.E_BADARG("command","expected getRequestContent");const n=this.requestById(e.id);if(!n)return this.status.E_NOTFOUND(e.id);this.getResourceContent(n,e,t)}onGetResourceContent(e,t){if("getResourceContent"!==e.command)return this.status.E_BADARG("command","expected getResourceContent");const n=e.url,s=l.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(n)||d.ResourceUtils.resourceForURL(n);if(!s)return this.status.E_NOTFOUND(n);this.getResourceContent(s,e,t)}onSetResourceContent(t,n){if("setResourceContent"!==t.command)return this.status.E_BADARG("command","expected setResourceContent");const{url:s,requestId:i,content:r,commit:o}=t;const a=l.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(s);if(!a||!a.contentType().isDocumentOrScriptOrStyleSheet()){return e.ResourceTreeModel.ResourceTreeModel.resourceForURL(s)?this.status.E_NOTSUPPORTED("Resource is not editable"):this.status.E_NOTFOUND(s)}a.setWorkingCopy(r),o&&a.commitWorkingCopy(),function(e){const t=e?this.status.E_FAILED(e):this.status.OK();this.dispatchCallback(i,n,t)}.call(this,null)}requestId(e){const t=this.requestIds.get(e);if(void 0===t){const t=++this.lastRequestId;return this.requestIds.set(e,t),this.requests.set(t,e),t}return t}requestById(e){return this.requests.get(e)}onAddTraceProvider(e,t){if("addTraceProvider"!==e.command)return this.status.E_BADARG("command","expected addTraceProvider");const n=new y(this.getExtensionOrigin(t),e.id,e.categoryName,e.categoryTooltip);this.clientObjects.set(e.id,n),this.traceProvidersInternal.push(n),this.dispatchEventToListeners(T.TraceProviderAdded,n)}traceProviders(){return this.traceProvidersInternal}onForwardKeyboardEvent(e){if("_forwardKeyboardEvent"!==e.command)return this.status.E_BADARG("command","expected _forwardKeyboardEvent");e.entries.forEach((function(e){const t=new window.KeyboardEvent(e.eventType,{key:e.key,code:e.code,keyCode:e.keyCode,location:e.location,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey});t.__keyCode=function(e){let t=e.keyCode;t||e.key===i.KeyboardUtilities.ESCAPE_KEY&&(t=27);return t||0}(e),document.dispatchEvent(t)}))}dispatchCallback(e,t,n){e&&t.postMessage({command:"callback",requestId:e,result:n})}initExtensions(){this.registerAutosubscriptionHandler("resource-added",l.Workspace.WorkspaceImpl.instance(),l.Workspace.Events.UISourceCodeAdded,this.notifyResourceAdded),this.registerAutosubscriptionTargetManagerHandler("network-request-finished",e.NetworkManager.NetworkManager,e.NetworkManager.Events.RequestFinished,this.notifyRequestFinished),this.registerSubscriptionHandler("panel-objectSelected-elements",function(){t.Context.Context.instance().addFlavorChangeListener(e.DOMModel.DOMNode,this.notifyElementsSelectionChanged,this)}.bind(this),function(){t.Context.Context.instance().removeFlavorChangeListener(e.DOMModel.DOMNode,this.notifyElementsSelectionChanged,this)}.bind(this)),this.registerResourceContentCommittedHandler(this.notifyUISourceCodeContentCommitted),e.TargetManager.TargetManager.instance().addEventListener(e.TargetManager.Events.InspectedURLChanged,this.inspectedURLChanged,this)}notifyResourceAdded(e){const t=e.data;this.postNotification("resource-added",this.makeResource(t))}notifyUISourceCodeContentCommitted(e){const{uiSourceCode:t,content:n}=e.data;this.postNotification("resource-content-committed",this.makeResource(t),n)}async notifyRequestFinished(e){const t=e.data,n=await u.Log.Entry.build(t);this.postNotification("network-request-finished",this.requestId(t),n)}notifyElementsSelectionChanged(){this.postNotification("panel-objectSelected-elements")}sourceSelectionChanged(e,t){this.postNotification("panel-objectSelected-sources",{startLine:t.startLine,startColumn:t.startColumn,endLine:t.endLine,endColumn:t.endColumn,url:e})}setInspectedTabId(e){const t=this.inspectedTabId;this.inspectedTabId=e.data,null===t&&this.initializeExtensions()}addExtension(n){const i=n.startPage,r=e.TargetManager.TargetManager.instance().mainTarget()?.inspectedURL()??"";if(""===r||this.canInspectURL(r)||this.disableExtensions(),this.extensionsEnabled){try{const e=new URL(i).origin;if(!this.registeredExtensions.get(e)){const i=self.buildExtensionAPIInjectedScript(n,this.inspectedTabId,c.ThemeSupport.instance().themeName(),t.ShortcutRegistry.ShortcutRegistry.instance().globalShortcutKeys(),O.instance().extensionAPITestHook);s.InspectorFrontendHost.InspectorFrontendHostInstance.setInjectedScriptForOrigin(e,i);const r=n.name||`Extension ${e}`;this.registeredExtensions.set(e,{name:r})}const r=document.createElement("iframe");r.src=i,r.dataset.devtoolsExtension=n.name,r.style.display="none",document.body.appendChild(r)}catch(e){return console.error("Failed to initialize extension "+i+":"+e),!1}return!0}}registerExtension(e,t){this.registeredExtensions.has(e)?(S.set(t,e),t.addEventListener("message",this.onmessage.bind(this),!1),t.start()):e!==window.location.origin&&console.error("Ignoring unauthorized client request from "+e)}onWindowMessage(e){"registerExtension"===e.data&&this.registerExtension(e.origin,e.ports[0])}async onmessage(e){const t=e.data;let n;const s=this.handlers.get(t.command);n=s?this.extensionsEnabled?await s(t,e.target):this.status.E_FAILED("Permission denied"):this.status.E_NOTSUPPORTED(t.command),n&&t.requestId&&this.dispatchCallback(t.requestId,e.target,n)}registerHandler(e,t){console.assert(Boolean(e)),this.handlers.set(e,t)}registerSubscriptionHandler(e,t,n){this.subscriptionStartHandlers.set(e,t),this.subscriptionStopHandlers.set(e,n)}registerAutosubscriptionHandler(e,t,n,s){this.registerSubscriptionHandler(e,(()=>t.addEventListener(n,s,this)),(()=>t.removeEventListener(n,s,this)))}registerAutosubscriptionTargetManagerHandler(t,n,s,i){this.registerSubscriptionHandler(t,(()=>e.TargetManager.TargetManager.instance().addModelListener(n,s,i,this)),(()=>e.TargetManager.TargetManager.instance().removeModelListener(n,s,i,this)))}registerResourceContentCommittedHandler(e){this.registerSubscriptionHandler("resource-content-committed",function(){l.Workspace.WorkspaceImpl.instance().addEventListener(l.Workspace.Events.WorkingCopyCommittedByUser,e,this),l.Workspace.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!0)}.bind(this),function(){l.Workspace.WorkspaceImpl.instance().setHasResourceContentTrackingExtensions(!1),l.Workspace.WorkspaceImpl.instance().removeEventListener(l.Workspace.Events.WorkingCopyCommittedByUser,e,this)}.bind(this))}expandResourcePath(e,t){return e+this.normalizePath(t)}normalizePath(e){const t=e.split("/"),n=[];for(let e=0;e<t.length;++e)"."!==t[e]&&""!==t[e]&&(".."===t[e]?n.pop():n.push(t[e]));return"/"+n.join("/")}evaluate(t,n,s,i,r,o){let a,c,d;if((i=i||{}).frameURL)c=function(t){let n=null;return e.ResourceTreeModel.ResourceTreeModel.frames().some((function(e){return n=e.url===t?e:null,n})),n}(i.frameURL);else{const t=e.TargetManager.TargetManager.instance().mainTarget(),n=t&&t.model(e.ResourceTreeModel.ResourceTreeModel);c=n&&n.mainFrame}if(!c)return i.frameURL?console.warn("evaluate: there is no frame with URL "+i.frameURL):console.warn("evaluate: the main frame is not yet available"),this.status.E_NOTFOUND(i.frameURL||"<top>");if(!this.canInspectURL(c.url))return this.status.E_FAILED("Permission denied");i.useContentScriptContext?d=r:i.scriptExecutionContext&&(d=i.scriptExecutionContext);const u=c.resourceTreeModel().target().model(e.RuntimeModel.RuntimeModel),l=u?u.executionContexts():[];if(d){for(let e=0;e<l.length;++e){const t=l[e];t.frameId!==c.id||t.origin!==d||t.isDefault||(a=t)}if(!a)return console.warn("The JavaScript context "+d+" was not found in the frame "+c.url),this.status.E_NOTFOUND(d)}else{for(let e=0;e<l.length;++e){const t=l[e];t.frameId===c.id&&t.isDefault&&(a=t)}if(!a)return this.status.E_FAILED(c.url+" has no execution context")}if(!this.canInspectURL(a.origin))return this.status.E_FAILED("Permission denied");a.evaluate({expression:t,objectGroup:"extension",includeCommandLineAPI:n,silent:!0,returnByValue:s,generatePreview:!1},!1,!1).then((function(e){if("error"in e)return void o(e.error,null,!1);o(null,e.object||null,Boolean(e.exceptionDetails))}))}canInspectURL(e){let t;try{t=new URL(e)}catch(e){return!1}return!!x.includes(t.origin)||"chrome:"!==t.protocol&&"devtools:"!==t.protocol&&(!t.protocol.startsWith("http")||"chrome.google.com"!==t.hostname||!t.pathname.startsWith("/webstore"))}disableExtensions(){this.extensionsEnabled=!1}}var T;!function(e){e.SidebarPaneAdded="SidebarPaneAdded",e.TraceProviderAdded="TraceProviderAdded"}(T||(T={}));class P extends t.View.SimpleView{name;panel;constructor(e,t,n){super(t),this.name=e,this.panel=n}viewId(){return this.name}widget(){return Promise.resolve(this.panel)}}class A{OK;E_EXISTS;E_BADARG;E_BADARGTYPE;E_NOTFOUND;E_NOTSUPPORTED;E_PROTOCOLERROR;E_FAILED;constructor(){function e(e,t){const n=Array.prototype.slice.call(arguments,2),s={code:e,description:t,details:n};return"OK"!==e&&(s.isError=!0,console.error("Extension server error: "+i.StringUtilities.vsprintf(t,n))),s}this.OK=e.bind(null,"OK","OK"),this.E_EXISTS=e.bind(null,"E_EXISTS","Object already exists: %s"),this.E_BADARG=e.bind(null,"E_BADARG","Invalid argument %s: %s"),this.E_BADARGTYPE=e.bind(null,"E_BADARGTYPE","Invalid type for argument %s: got %s, expected %s"),this.E_NOTFOUND=e.bind(null,"E_NOTFOUND","Object not found: %s"),this.E_NOTSUPPORTED=e.bind(null,"E_NOTSUPPORTED","Object does not support requested operation: %s"),this.E_PROTOCOLERROR=e.bind(null,"E_PROTOCOLERROR","Inspector protocol error: %s"),this.E_FAILED=e.bind(null,"E_FAILED","Operation failed: %s")}}var L=Object.freeze({__proto__:null,ExtensionServer:O,get Events(){return T},ExtensionStatus:A});export{h as ExtensionAPI,R as ExtensionPanel,L as ExtensionServer,I as ExtensionTraceProvider,m as ExtensionView};
