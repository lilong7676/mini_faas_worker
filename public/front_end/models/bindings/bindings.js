import*as e from"../../core/common/common.js";import*as t from"../../core/sdk/sdk.js";import*as o from"../workspace/workspace.js";import*as r from"../../core/platform/platform.js";import*as s from"../../core/root/root.js";import*as i from"../text_utils/text_utils.js";import*as n from"../../core/i18n/i18n.js";const a={unknownErrorLoadingFile:"Unknown error loading file"},c=n.i18n.registerUIStrings("models/bindings/ContentProviderBasedProject.ts",a),u=n.i18n.getLocalizedString.bind(void 0,c);class d extends o.Workspace.ProjectStore{#e;#t;#o;constructor(e,t,o,r,s){super(e,t,o,r),this.#e=new Map,this.#t=s,this.#o=new WeakMap,e.addProject(this)}async requestFileContent(e){const t=this.#e.get(e.url());try{const[e,o]=await Promise.all([t.requestContent(),t.contentEncoded()]);return{content:e.content,isEncoded:o,error:"error"in e&&e.error||""}}catch(e){return{content:null,isEncoded:!1,error:e?String(e):u(a.unknownErrorLoadingFile)}}}isServiceProject(){return this.#t}async requestMetadata(e){const{metadata:t}=this.#o.get(e);return t}canSetFileContent(){return!1}async setFileContent(e,t,o){}fullDisplayName(e){let t=e.parentURL().replace(/^(?:https?|file)\:\/\//,"");try{t=decodeURI(t)}catch(e){}return t+"/"+e.displayName(!0)}mimeType(e){const{mimeType:t}=this.#o.get(e);return t}canRename(){return!1}rename(e,t,o){const r=e.url();this.performRename(r,t,function(t,s){if(t&&s){const t=r.split("/");t[t.length-1]=s;const o=t.join("/"),i=this.#e.get(r);this.#e.set(o,i),this.#e.delete(r),this.renameUISourceCode(e,s)}o(t,s)}.bind(this))}excludeFolder(e){}canExcludeFolder(e){return!1}async createFile(e,t,o,r){return null}canCreateFile(){return!1}deleteFile(e){}remove(){}performRename(e,t,o){o(!1)}searchInFileContent(e,t,o,r){return this.#e.get(e.url()).searchInContent(t,o,r)}async findFilesMatchingSearchRequest(e,t,o){const r=[];return o.setTotalWork(t.length),await Promise.all(t.map(async function(t){const s=this.#e.get(t);let i=!0;for(const t of e.queries().slice()){if(!(await s.searchInContent(t,!e.ignoreCase(),e.isRegex())).length){i=!1;break}}i&&r.push(t);o.incrementWorked(1)}.bind(this))),o.done(),r}indexContent(e){Promise.resolve().then(e.done.bind(e))}addUISourceCodeWithProvider(e,t,o,r){this.#e.set(e.url(),t),this.#o.set(e,{mimeType:r,metadata:o}),this.addUISourceCode(e)}addContentProvider(e,t,o){const r=this.createUISourceCode(e,t.contentType());return this.addUISourceCodeWithProvider(r,t,null,o),r}removeFile(e){this.#e.delete(e),this.removeUISourceCode(e)}reset(){this.#e.clear(),this.removeProject(),this.workspace().addProject(this)}dispose(){this.#e.clear(),this.removeProject()}}var l=Object.freeze({__proto__:null,ContentProviderBasedProject:d});let h;class p{#r;#s;#i;constructor(o){this.#r=o,t.TargetManager.TargetManager.instance().addModelListener(t.DebuggerModel.DebuggerModel,t.DebuggerModel.Events.GlobalObjectCleared,this.clearCacheIfNeeded.bind(this),this),e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this.patternChanged.bind(this)),e.Settings.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this.patternChanged.bind(this)),this.#s=new Set,this.#i=new Map,t.TargetManager.TargetManager.instance().observeModels(t.DebuggerModel.DebuggerModel,this)}static instance(e={forceNew:null,debuggerWorkspaceBinding:null}){const{forceNew:t,debuggerWorkspaceBinding:o}=e;if(!h||t){if(!o)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);h=new p(o)}return h}addChangeListener(e){this.#s.add(e)}removeChangeListener(e){this.#s.delete(e)}modelAdded(e){this.setIgnoreListPatterns(e);const o=e.sourceMapManager();o.addEventListener(t.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),o.addEventListener(t.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}modelRemoved(e){this.clearCacheIfNeeded();const o=e.sourceMapManager();o.removeEventListener(t.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),o.removeEventListener(t.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)}clearCacheIfNeeded(){this.#i.size>1024&&this.#i.clear()}getSkipStackFramesPatternSetting(){return e.Settings.Settings.instance().moduleSetting("skipStackFramesPattern")}setIgnoreListPatterns(e){const t=this.getSkipStackFramesPatternSetting().getAsArray(),o=[];for(const e of t)!e.disabled&&e.pattern&&o.push(e.pattern);return e.setBlackboxPatterns(o)}isIgnoreListedUISourceCode(t){if(t.project().type()===o.Workspace.projectTypes.ContentScripts&&e.Settings.Settings.instance().moduleSetting("skipContentScripts").get())return!0;const r=this.uiSourceCodeURL(t);return!!r&&this.isIgnoreListedURL(r)}isIgnoreListedURL(t,o){if(this.#i.has(t))return Boolean(this.#i.get(t));if(o&&e.Settings.Settings.instance().moduleSetting("skipContentScripts").get())return!0;const r=this.getSkipStackFramesPatternSetting().asRegExp(),s=r&&r.test(t)||!1;return this.#i.set(t,s),s}sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;this.updateScriptRanges(t,o)}sourceMapDetached(e){const t=e.data.client;this.updateScriptRanges(t,null)}async updateScriptRanges(e,t){let o=!1;if(p.instance().isIgnoreListedURL(e.sourceURL,e.isContentScript())||(o=!!t&&t.sourceURLs().some((e=>this.isIgnoreListedURL(e)))),!o)return g.get(e)&&await e.setBlackboxedRanges([])&&g.delete(e),void await this.#r.updateLocations(e);if(!t)return;const r=t.mappings(),s=[];if(r.length>0){let e=!1;0===r[0].lineNumber&&0===r[0].columnNumber||(s.push({lineNumber:0,columnNumber:0}),e=!0);for(const t of r)t.sourceURL&&e!==this.isIgnoreListedURL(t.sourceURL)&&(s.push({lineNumber:t.lineNumber,columnNumber:t.columnNumber}),e=!e)}!function(e,t){if(e.length!==t.length)return!1;for(let o=0;o<e.length;++o)if(e[o].lineNumber!==t[o].lineNumber||e[o].columnNumber!==t[o].columnNumber)return!1;return!0}(g.get(e)||[],s)&&await e.setBlackboxedRanges(s)&&g.set(e,s),this.#r.updateLocations(e)}uiSourceCodeURL(e){return e.project().type()===o.Workspace.projectTypes.Debugger?null:e.url()}canIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);return!!t&&Boolean(this.urlToRegExpString(t))}ignoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.ignoreListURL(t)}unIgnoreListUISourceCode(e){const t=this.uiSourceCodeURL(e);t&&this.unIgnoreListURL(t)}ignoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!0)}unIgnoreListContentScripts(){e.Settings.Settings.instance().moduleSetting("skipContentScripts").set(!1)}ignoreListURL(e){const t=this.getSkipStackFramesPatternSetting().getAsArray(),o=this.urlToRegExpString(e);if(!o)return;let r=!1;for(let e=0;e<t.length;++e){const s=t[e];if(s.pattern===o){s.disabled=!1,r=!0;break}}r||t.push({pattern:o,disabled:void 0}),this.getSkipStackFramesPatternSetting().setAsArray(t)}unIgnoreListURL(e){let t=this.getSkipStackFramesPatternSetting().getAsArray();const o=p.instance().urlToRegExpString(e);if(o){t=t.filter((function(e){return e.pattern!==o}));for(let o=0;o<t.length;++o){const r=t[o];if(!r.disabled)try{new RegExp(r.pattern).test(e)&&(r.disabled=!0)}catch(e){}}this.getSkipStackFramesPatternSetting().setAsArray(t)}}async patternChanged(){this.#i.clear();const e=[];for(const o of t.TargetManager.TargetManager.instance().models(t.DebuggerModel.DebuggerModel)){e.push(this.setIgnoreListPatterns(o));const t=o.sourceMapManager();for(const r of o.scripts())e.push(this.updateScriptRanges(r,t.sourceMapForClient(r)))}await Promise.all(e);const o=Array.from(this.#s);for(const e of o)e();this.patternChangeFinishedForTests()}patternChangeFinishedForTests(){}urlToRegExpString(t){const o=new e.ParsedURL.ParsedURL(t);if(o.isAboutBlank()||o.isDataURL())return"";if(!o.isValid)return"^"+r.StringUtilities.escapeForRegExp(t)+"$";let s=o.lastPathComponent;if(s?s="/"+s:o.folderPathComponents&&(s=o.folderPathComponents+"/"),s||(s=o.host),!s)return"";const i=o.scheme;let n="";return i&&"http"!==i&&"https"!==i&&(n="^"+i+"://","chrome-extension"===i&&(n+=o.host+"\\b"),n+=".*"),n+r.StringUtilities.escapeForRegExp(s)+(t.endsWith(s)?"$":"\\b")}}const g=new WeakMap;var m=Object.freeze({__proto__:null,IgnoreListManager:p});const b=new WeakMap,f=new WeakMap;let S;class M extends e.ObjectWrapper.ObjectWrapper{constructor(){super()}static instance({forceNew:e}={forceNew:!1}){return S&&!e||(S=new M),S}}var L;!function(e){e.FrameAttributionAdded="FrameAttributionAdded",e.FrameAttributionRemoved="FrameAttributionRemoved"}(L||(L={}));class v{static resolveFrame(e,o){const r=v.targetForUISourceCode(e),s=r&&r.model(t.ResourceTreeModel.ResourceTreeModel);return s?s.frameForId(o):null}static setInitialFrameAttribution(e,t){if(!t)return;const o=v.resolveFrame(e,t);if(!o)return;const r=new Map;r.set(t,{frame:o,count:1}),b.set(e,r)}static cloneInitialFrameAttribution(e,t){const o=b.get(e);if(!o)return;const r=new Map;for(const e of o.keys()){const t=o.get(e);void 0!==t&&r.set(e,{frame:t.frame,count:t.count})}b.set(t,r)}static addFrameAttribution(e,t){const o=v.resolveFrame(e,t);if(!o)return;const r=b.get(e);if(!r)return;const s=r.get(t)||{frame:o,count:0};if(s.count+=1,r.set(t,s),1!==s.count)return;const i={uiSourceCode:e,frame:o};M.instance().dispatchEventToListeners(L.FrameAttributionAdded,i)}static removeFrameAttribution(e,t){const o=b.get(e);if(!o)return;const r=o.get(t);if(console.assert(Boolean(r),"Failed to remove frame attribution for url: "+e.url()),!r)return;if(r.count-=1,r.count>0)return;o.delete(t);const s={uiSourceCode:e,frame:r.frame};M.instance().dispatchEventToListeners(L.FrameAttributionRemoved,s)}static targetForUISourceCode(e){return f.get(e.project())||null}static setTargetForProject(e,t){f.set(e,t)}static getTargetForProject(e){return f.get(e)||null}static framesForUISourceCode(e){const o=v.targetForUISourceCode(e),r=o&&o.model(t.ResourceTreeModel.ResourceTreeModel),s=b.get(e);if(!r||!s)return[];return Array.from(s.keys()).map((e=>r.frameForId(e))).filter((e=>Boolean(e)))}}var C=Object.freeze({__proto__:null,NetworkProjectManager:M,get Events(){return L},NetworkProject:v});class I{#n;#a;#c;#r;#u;#d;#l;#h;#p;#g;#m;constructor(e,r,s){this.#n=e,this.#a=this.#n.sourceMapManager(),this.#c=r,this.#r=s;const i=e.target();this.#u=new d(r,"jsSourceMaps::"+i.id(),o.Workspace.projectTypes.Network,"",!1),this.#d=new d(r,"jsSourceMaps:extensions:"+i.id(),o.Workspace.projectTypes.ContentScripts,"",!1),v.setTargetForProject(this.#u,i),v.setTargetForProject(this.#d,i),this.#l=new Map,this.#h=new Map,this.#p=new Map,this.#g=new d(r,"jsSourceMaps:stub:"+i.id(),o.Workspace.projectTypes.Service,"",!0),this.#m=[this.#a.addEventListener(t.SourceMapManager.Events.SourceMapWillAttach,this.sourceMapWillAttach,this),this.#a.addEventListener(t.SourceMapManager.Events.SourceMapFailedToAttach,this.sourceMapFailedToAttach,this),this.#a.addEventListener(t.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#a.addEventListener(t.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this),this.#c.addEventListener(o.Workspace.Events.UISourceCodeAdded,(e=>{this.onUiSourceCodeAdded(e)}),this)]}onUiSourceCodeAdded(e){const t=e.data;if(t.contentType().isDocument())for(const e of this.#n.scriptsForSourceURL(t.url()))this.#r.updateLocations(e)}addStubUISourceCode(t){const o=this.#g.addContentProvider(t.sourceURL+":sourcemap",i.StaticContentProvider.StaticContentProvider.fromString(t.sourceURL,e.ResourceType.resourceTypes.Script,"\n\n\n\n\n// Please wait a bit.\n// Compiled script is not shown while source map is being loaded!"),"text/javascript");this.#p.set(t,o)}async removeStubUISourceCode(e){const t=this.#p.get(e);this.#p.delete(e),t&&this.#g.removeFile(t.url()),await this.#r.updateLocations(e)}static uiSourceCodeOrigin(e){const t=w.get(e);return t?t.getReferringSourceMaps().map((e=>e.compiledURL())):[]}getLocationRangesForSameSourceLocation(e){const t=e.debuggerModel,o=e.script();if(!o)return[];const r=this.#a.sourceMapForClient(o);if(!r)return[];const s=r.findEntry(e.lineNumber,e.columnNumber);if(!s||!s.sourceURL)return[];return r.findReverseRanges(s.sourceURL,s.sourceLineNumber,s.sourceColumnNumber).map((function(e){return{start:t.createRawLocation(o,e.startLine,e.startColumn),end:t.createRawLocation(o,e.endLine,e.endColumn)}}))}uiSourceCodeForURL(e,t){return t?this.#d.uiSourceCodeForURL(e):this.#u.uiSourceCodeForURL(e)}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const r=e.lineNumber-t.lineOffset;let s=e.columnNumber;r||(s-=t.columnOffset);const i=this.#p.get(t);if(i)return new o.UISourceCode.UILocation(i,r,s);const n=this.#a.sourceMapForClient(t);if(!n)return null;const a=n.findEntry(r,s);if(!a||!a.sourceURL)return null;const c=t.isContentScript()?this.#d.uiSourceCodeForURL(a.sourceURL):this.#u.uiSourceCodeForURL(a.sourceURL);return c?c.uiLocation(a.sourceLineNumber,a.sourceColumnNumber):null}uiLocationToRawLocations(e,t,o){const r=w.get(e);if(!r)return[];const s=[];for(const i of r.getReferringSourceMaps()){const r=i.sourceLineMapping(e.url(),t,o);if(r)for(const e of this.#a.clientsForSourceMap(i))s.push(this.#n.createRawLocation(e,r.lineNumber+e.lineOffset,r.lineNumber?r.columnNumber:r.columnNumber+e.columnOffset))}return s}async sourceMapWillAttach(e){const t=e.data.client;this.addStubUISourceCode(t),await this.#r.updateLocations(t)}async sourceMapFailedToAttach(e){const t=e.data.client;await this.removeStubUISourceCode(t)}async sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap;await this.removeStubUISourceCode(t),p.instance().isIgnoreListedURL(t.sourceURL,t.isContentScript())||await this.populateSourceMapSources(t,o),this.sourceMapAttachedForTest(o)}async sourceMapDetached(e){const t=e.data.client,o=e.data.sourceMap,r=t.isContentScript()?this.#h:this.#l;for(const e of o.sourceURLs()){const s=r.get(e);s&&(s.removeSourceMap(o,t.frameId),s.getUiSourceCode()||r.delete(e))}await this.#r.updateLocations(t)}sourceMapForScript(e){return this.#a.sourceMapForClient(e)}scriptsForUISourceCode(e){const t=w.get(e);if(!t)return[];const o=[];for(const e of t.getReferringSourceMaps())this.#a.clientsForSourceMap(e).forEach((e=>o.push(e)));return o}sourceMapAttachedForTest(e){}async populateSourceMapSources(e,t){const o=e.isContentScript()?this.#d:this.#u,r=e.isContentScript()?this.#h:this.#l;for(const s of t.sourceURLs()){let i=r.get(s);i||(i=new y(o,s),r.set(s,i)),i.addSourceMap(t,e.frameId)}await this.#r.updateLocations(e)}static uiLineHasMapping(e,t){const o=w.get(e);if(!o)return!0;for(const r of o.getReferringSourceMaps())if(r.sourceLineMapping(e.url(),t,0))return!0;return!1}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#u.dispose(),this.#d.dispose(),this.#g.dispose()}}const w=new WeakMap;class y{#b;#f;referringSourceMaps;#S;uiSourceCode;constructor(e,t){this.#b=e,this.#f=t,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t){const r=this.referringSourceMaps[this.referringSourceMaps.length-1],s=this.#b.createUISourceCode(this.#f,e.ResourceType.resourceTypes.SourceMapScript);w.set(s,this);const i=r.sourceContentProvider(this.#f,e.ResourceType.resourceTypes.SourceMapScript),n=e.ResourceType.ResourceType.mimeFromURL(this.#f)||"text/javascript",a=r.embeddedContentByURL(this.#f),c="string"==typeof a?new o.UISourceCode.UISourceCodeMetadata(null,a.length):null;this.uiSourceCode?(v.cloneInitialFrameAttribution(this.uiSourceCode,s),this.#b.removeFile(this.uiSourceCode.url())):v.setInitialFrameAttribution(s,t),this.uiSourceCode=s,this.#b.addUISourceCodeWithProvider(this.uiSourceCode,i,c,n)}addSourceMap(e,t){this.uiSourceCode&&v.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const o=this.uiSourceCode;v.removeFrameAttribution(o,t);const r=this.referringSourceMaps.lastIndexOf(e);-1!==r&&this.referringSourceMaps.splice(r,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t):(this.#b.removeFile(o.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}}var R=Object.freeze({__proto__:null,CompilerScriptMapping:I});const k={errorInDebuggerLanguagePlugin:"Error in debugger language plugin: {PH1}",loadingDebugSymbolsForVia:"[{PH1}] Loading debug symbols for {PH2} (via {PH3})...",loadingDebugSymbolsFor:"[{PH1}] Loading debug symbols for {PH2}...",loadedDebugSymbolsForButDidnt:"[{PH1}] Loaded debug symbols for {PH2}, but didn't find any source files",loadedDebugSymbolsForFound:"[{PH1}] Loaded debug symbols for {PH2}, found {PH3} source file(s)",failedToLoadDebugSymbolsFor:"[{PH1}] Failed to load debug symbols for {PH2} ({PH3})",failedToLoadDebugSymbolsForFunction:'Missing debug symbols for function "{PH1}"',symbolFileNotFound:'Symbol file "{PH1}" not found'},T=n.i18n.registerUIStrings("models/bindings/DebuggerLanguagePlugins.ts",k),F=n.i18n.getLocalizedString.bind(void 0,T);class U{typeInfo;members;typeMap;constructor(e,t,o){this.typeInfo=e,this.members=t,this.typeMap=o}static create(e){if(0===e.length)return null;const t=new Map;for(const o of e)t.set(o.typeId,new U(o,[],t));for(const o of t.values())o.members=o.typeInfo.members.map((({typeId:o})=>{const r=t.get(o);if(!r)throw new Error(`Incomplete type information for type ${e[0].typeNames[0]||"<anonymous>"}`);return r}));return t.get(e[0].typeId)||null}}function P(e){return`${e.sourceURL}@${e.hash}`}function j(e){const{script:t}=e;return{rawModuleId:P(t),codeOffset:e.location().columnNumber-(t.codeOffset()||0),inlineFrameIndex:e.inlineFrameIndex}}class N extends t.RemoteObject.RemoteObjectImpl{inspectableAddress;callFrame;constructor(e,t,o,r,s,i,n,a,c,u,d){super(e.debuggerModel.runtimeModel(),t,o,r,s,n,a,c,u,d),this.inspectableAddress=i,this.callFrame=e}}async function E(e,o,r,s){const i=j(e);let n;try{n=await o.getTypeInfo(r,i)}catch(t){B.throwLocal(e,t.message)}if(!n)return new t.RemoteObject.LocalJSONObject(void 0);const{base:a,typeInfos:c}=n,u=U.create(c);if(!u)return new t.RemoteObject.LocalJSONObject(void 0);if(u.typeInfo.hasValue&&!u.typeInfo.canExpand&&a)return D(e,o,u,a,[],s);const d=await O.getInspectableAddress(e,o,a,[],s);return new O(e,o,u,a,[],s,d)}async function D(e,t,o,r,s,i){const n=j(e);let a=await t.getFormatter({base:r,field:s},n);a||(a={js:""});const c=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:a.js,objectGroup:i.objectGroup,includeCommandLineAPI:i.includeCommandLineAPI,silent:i.silent,returnByValue:i.returnByValue,generatePreview:i.generatePreview,throwOnSideEffect:i.throwOnSideEffect,timeout:i.timeout}),u=c.getError();if(u)throw new Error(u);const{result:d,exceptionDetails:l}=c;if(l)throw new B(e.debuggerModel.runtimeModel().createRemoteObject(d),l);const h=new A(e,o,t,d,null,i,void 0),p=await async function(e){const{tag:t,value:o,inspectableAddress:r,description:s}=await e.findProperties("tag","value","inspectableAddress","description");if(!t||!o)return null;const{className:i,symbol:n}=await t.findProperties("className","symbol");if(!i||!n)return null;const a=i.value;if("string"!=typeof a||void 0===n.objectId)return null;const c=s?.value;"string"==typeof c&&(o.description=c);return o.formatterTag={symbol:n.objectId,className:a},o.inspectableAddress=r?r.value:void 0,o}(h),g=p||h;return void 0===g.value&&"undefined"!==g.type&&(g.description=o.typeInfo.typeNames[0]),g}class A extends N{#M;#L;formatterTag;#v;constructor(e,t,o,r,s,i,n){super(e,r.objectId,r.type,r.subtype,r.value,n,r.unserializableValue,r.description,r.preview,r.customPreview,r.className),this.#M=o,this.#L=t,this.formatterTag=s,this.#v=i}async findProperties(...e){const t={};for(const o of(await this.getOwnProperties(!1)).properties||[])e.indexOf(o.name)>=0&&o.value&&(t[o.name]=o.value);return t}async createRemoteObject(e){const t=await this.getEvalBaseFromObject(e);if(!t)return new A(this.callFrame,this.#L,this.#M,e,this.formatterTag,this.#v,void 0);const o=this.#L.typeMap.get(t.rootType.typeId);if(!o)throw new Error("Unknown typeId in eval base");if(t.rootType.hasValue&&!t.rootType.canExpand&&t)return D(this.callFrame,this.#M,o,t,[],this.#v);const r=await O.getInspectableAddress(this.callFrame,this.#M,t,[],this.#v);return new O(this.callFrame,this.#M,o,t,[],this.#v,r)}async getEvalBaseFromObject(e){const{objectId:t}=e;if(!e||!this.formatterTag)return null;const{className:o,symbol:r}=this.formatterTag;if(o!==e.className)return null;const s=await this.debuggerModel().target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function(sym) { return this[sym]; }",objectId:t,arguments:[{objectId:r}]}),{result:i}=s;if(!i||"undefined"===i.type)return null;const n=new A(this.callFrame,this.#L,this.#M,i,null,this.#v,void 0),{payload:a,rootType:c}=await n.findProperties("payload","rootType");if(void 0===a||void 0===c)return null;const u=await async function(e,t){if(void 0!==t.value)return t.value;const o=await e.debuggerModel.target().runtimeAgent().invoke_callFunctionOn({functionDeclaration:"function() { return this; }",objectId:t.objectId,returnByValue:!0}),{result:r}=o;return r?r.value:void 0}(this.callFrame,a),{typeId:d}=await c.findProperties("typeId");if(void 0===u||void 0===d)return null;const l=this.#L.typeMap.get(d.value);return l?{payload:u,rootType:l.typeInfo}:null}}class B extends Error{exception;exceptionDetails;constructor(e,t){const{description:o}=t.exception||{};super(o||t.text),this.exception=e,this.exceptionDetails=t}static throwLocal(e,t){const o={type:"object",subtype:"error",description:t},r={text:"Uncaught",exceptionId:-1,columnNumber:0,lineNumber:0,exception:o},s=e.debuggerModel.runtimeModel().createRemoteObject(o);throw new B(s,r)}}class O extends N{#C;#M;#L;#I;#w;#v;constructor(e,t,o,r,s,i,n){const a=o.typeInfo.typeNames[0]||"<anonymous>",c="object";super(e,void 0,c,void 0,null,n,void 0,a,void 0,void 0,a),this.#C=c,this.#M=t,this.#L=o,this.#I=r,this.#w=s,this.hasChildrenInternal=!0,this.#v=i}get type(){return this.#C}async expandMember(e,t){const o=this.#w.concat(t);if(e.typeInfo.hasValue&&!e.typeInfo.canExpand&&this.#I)return D(this.callFrame,this.#M,e,this.#I,o,this.#v);const r=void 0!==this.inspectableAddress?this.inspectableAddress+t.offset:void 0;return new O(this.callFrame,this.#M,e,this.#I,o,this.#v,r)}static async getInspectableAddress(e,t,o,r,s){if(!o)return;const i=await t.getInspectableAddress({base:o,field:r});if(!i.js)return;const n=await e.debuggerModel.target().debuggerAgent().invoke_evaluateOnCallFrame({callFrameId:e.id,expression:i.js,objectGroup:s.objectGroup,includeCommandLineAPI:s.includeCommandLineAPI,silent:s.silent,returnByValue:!0,generatePreview:s.generatePreview,throwOnSideEffect:s.throwOnSideEffect,timeout:s.timeout}),a=n.getError();if(a)throw new Error(a);const{result:c,exceptionDetails:u}=n;if(u)throw new B(e.debuggerModel.runtimeModel().createRemoteObject(c),u);const d=c.value;if(Number.isSafeInteger(d)&&!(d<0))return d;console.error(`Inspectable address is not a positive, safe integer: ${d}`)}async doGetProperties(e,o,r){const{typeInfo:s}=this.#L;if(o||!s.canExpand)return{properties:[],internalProperties:[]};if(s.members.length>0){if(s.arraySize>0){const{typeId:e}=this.#L.typeInfo.members[0],o=[],r=this.#L.members[0];for(let i=0;i<s.arraySize;++i){const s=`${i}`,n={name:s,typeId:e,offset:r.typeInfo.size*i};o.push(new t.RemoteObject.RemoteObjectProperty(s,await this.expandMember(r,n),!1,!1,!0,!1))}return{properties:o,internalProperties:[]}}const e=Promise.all(this.#L.members.map((async(e,o)=>{const r=this.#L.typeInfo.members[o],s=await this.expandMember(e,r),i=r.name||"";return new t.RemoteObject.RemoteObjectProperty(i,s,!1,!1,!0,!1)})));return{properties:await e,internalProperties:[]}}return{properties:[],internalProperties:[]}}}class W extends t.RemoteObject.LocalJSONObject{constructor(e){super(e)}get description(){return this.type}get type(){return"namespace"}}class x extends t.RemoteObject.RemoteObjectImpl{variables;#y;#M;#R;constructor(e,t,o){super(e.debuggerModel.runtimeModel(),void 0,"object",void 0,null),this.variables=[],this.#y=e,this.#M=t,this.#R=o}async doGetProperties(e,o,r){if(o)return{properties:[],internalProperties:[]};const s=[],i={};function n(e,o){return new t.RemoteObject.RemoteObjectProperty(e,o,!1,!1,!0,!1)}for(const e of this.variables){let o;try{o=await E(this.#y,this.#M,e.name,{generatePreview:!1,includeCommandLineAPI:!0,objectGroup:"backtrace",returnByValue:!1,silent:!1})}catch(e){console.warn(e),o=new t.RemoteObject.LocalJSONObject(void 0)}if(e.nestedName&&e.nestedName.length>1){let t=i;for(let o=0;o<e.nestedName.length-1;o++){const r=e.nestedName[o];let s=t[r];s||(s=new W({}),t[r]=s),t=s.value}t[e.nestedName[e.nestedName.length-1]]=o}else s.push(n(e.name,o))}for(const e in i)s.push(n(e,i[e]));return{properties:s,internalProperties:[]}}}class H{#k;#T;#F;#U;#P;#j;#N;#E;constructor(e,t,o,r,s,i){this.#k=e,this.#T=t,this.#F=o,this.#U=r,this.#P=new x(e,s,i),this.#j=t,this.#N=null,this.#E=null}async getVariableValue(e){for(let t=0;t<this.#P.variables.length;++t){if(this.#P.variables[t].name!==e)continue;const o=await this.#P.getAllProperties(!1,!1);if(!o.properties)continue;const{value:r}=o.properties[t];if(r)return r}return null}callFrame(){return this.#k}type(){return this.#T}typeName(){return this.#F}name(){}startLocation(){return this.#N}endLocation(){return this.#E}object(){return this.#P}description(){return""}icon(){return this.#U}}class _{#c;#r;#D;#A;#B;constructor(e,o,r){this.#c=o,this.#r=r,this.#D=[],this.#A=new Map,e.observeModels(t.DebuggerModel.DebuggerModel,this),this.#B=new Map}async evaluateOnCallFrame(e,t){const{script:o}=e,{expression:r}=t,{plugin:s}=await this.rawModuleIdAndPluginForScript(o);if(!s)return null;const i=j(e);if(0===(await s.rawLocationToSourceLocation(i)).length)return null;try{return{object:await E(e,s,r,t),exceptionDetails:void 0}}catch(e){if(e instanceof B){const{exception:t,exceptionDetails:o}=e;return{object:t,exceptionDetails:o}}return{error:e.message}}}expandCallFrames(e){return Promise.all(e.map((async e=>{const t=await this.getFunctionInfo(e.script,e.location());if(t){const{frames:o,missingSymbolFiles:r}=t;if(o.length)return o.map((({name:t},o)=>e.createVirtualCallFrame(o,t)));if(r&&r.length)for(const t of r)e.addWarning(F(k.symbolFileNotFound,{PH1:t}));e.addWarning(F(k.failedToLoadDebugSymbolsForFunction,{PH1:e.functionName}))}return e}))).then((e=>e.flat()))}modelAdded(e){this.#A.set(e,new z(e,this.#c)),e.addEventListener(t.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addEventListener(t.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.setEvaluateOnCallFrameCallback(this.evaluateOnCallFrame.bind(this)),e.setExpandCallFramesCallback(this.expandCallFrames.bind(this))}modelRemoved(o){o.removeEventListener(t.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),o.removeEventListener(t.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),o.setEvaluateOnCallFrameCallback(null),o.setExpandCallFramesCallback(null);const r=this.#A.get(o);r&&(r.dispose(),this.#A.delete(o)),this.#B.forEach(((t,r)=>{const s=t.scripts.filter((e=>e.debuggerModel!==o));0===s.length?(t.plugin.removeRawModule(r).catch((t=>{e.Console.Console.instance().error(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message}))})),this.#B.delete(r)):t.scripts=s}))}globalObjectCleared(e){const t=e.data;this.modelRemoved(t),this.modelAdded(t)}addPlugin(e){this.#D.push(e);for(const e of this.#A.keys())for(const t of e.scripts())this.hasPluginForScript(t)||this.parsedScriptSource({data:t})}removePlugin(e){this.#D=this.#D.filter((t=>t!==e));const t=new Set;this.#B.forEach(((o,r)=>{o.plugin===e&&(o.scripts.forEach((e=>t.add(e))),this.#B.delete(r))}));for(const e of t){this.#A.get(e.debuggerModel).removeScript(e),this.parsedScriptSource({data:e})}}hasPluginForScript(e){const t=P(e),o=this.#B.get(t);return void 0!==o&&o.scripts.includes(e)}async rawModuleIdAndPluginForScript(e){const t=P(e),o=this.#B.get(t);return o&&(await o.addRawModulePromise,o===this.#B.get(t))?{rawModuleId:t,plugin:o.plugin}:{rawModuleId:t,plugin:null}}uiSourceCodeForURL(e,t){const o=this.#A.get(e);return o?o.getProject().uiSourceCodeForURL(t):null}async rawLocationToUILocation(t){const o=t.script();if(!o)return null;const{rawModuleId:r,plugin:s}=await this.rawModuleIdAndPluginForScript(o);if(!s)return null;const i={rawModuleId:r,codeOffset:t.columnNumber-(o.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex};try{const e=await s.rawLocationToSourceLocation(i);for(const t of e){const e=this.uiSourceCodeForURL(o.debuggerModel,t.sourceFileURL);if(e)return e.uiLocation(t.lineNumber,t.columnNumber>=0?t.columnNumber:void 0)}}catch(t){e.Console.Console.instance().error(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message}))}return null}uiLocationToRawLocationRanges(o,r,s=-1){const i=[];return this.scriptsForUISourceCode(o).forEach((e=>{const n=P(e),a=this.#B.get(n);if(!a)return;const{plugin:c}=a;i.push(async function(e,i,n){const a={rawModuleId:e,sourceFileURL:o.url(),lineNumber:r,columnNumber:s},c=await i.sourceLocationToRawLocation(a);if(!c)return[];return c.map((e=>({start:new t.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.startOffset)+(n.codeOffset()||0)),end:new t.DebuggerModel.Location(n.debuggerModel,n.scriptId,0,Number(e.endOffset)+(n.codeOffset()||0))})))}(n,c,e))})),0===i.length?Promise.resolve(null):Promise.all(i).then((e=>e.flat())).catch((t=>(e.Console.Console.instance().error(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message})),null)))}async uiLocationToRawLocations(e,t,o){const r=await this.uiLocationToRawLocationRanges(e,t,o);return r?r.map((({start:e})=>e)):null}scriptsForUISourceCode(e){for(const t of this.#A.values()){const o=t.uiSourceCodeToScripts.get(e);if(o)return o}return[]}parsedScriptSource(t){const o=t.data;if(o.sourceURL)for(const t of this.#D){if(!t.handleScript(o))return;const r=P(o);let s=this.#B.get(r);if(s)s.scripts.push(o);else{const i=(async()=>{const i=e.Console.Console.instance(),n=o.sourceURL,a=o.debugSymbols&&o.debugSymbols.externalURL||"";a?i.log(F(k.loadingDebugSymbolsForVia,{PH1:t.name,PH2:n,PH3:a})):i.log(F(k.loadingDebugSymbolsFor,{PH1:t.name,PH2:n}));try{const e=!a&&n.startsWith("wasm://")?await o.getWasmBytecode():void 0,c=await t.addRawModule(r,a,{url:n,code:e});return s!==this.#B.get(r)?[]:(0===c.length?i.warn(F(k.loadedDebugSymbolsForButDidnt,{PH1:t.name,PH2:n})):i.log(F(k.loadedDebugSymbolsForFound,{PH1:t.name,PH2:n,PH3:c.length})),c)}catch(e){return i.error(F(k.failedToLoadDebugSymbolsFor,{PH1:t.name,PH2:n,PH3:e.message})),this.#B.delete(r),[]}})();s={rawModuleId:r,plugin:t,scripts:[o],addRawModulePromise:i},this.#B.set(r,s)}return void s.addRawModulePromise.then((e=>{if(o.debuggerModel.scriptForId(o.scriptId)===o){const t=this.#A.get(o.debuggerModel);t&&(t.addSourceFiles(o,e),this.#r.updateLocations(o))}}))}}async resolveScopeChain(t){const o=t.script,{rawModuleId:r,plugin:s}=await this.rawModuleIdAndPluginForScript(o);if(!s)return null;const i={rawModuleId:r,codeOffset:t.location().columnNumber-(o.codeOffset()||0),inlineFrameIndex:t.inlineFrameIndex};try{if(0===(await s.rawLocationToSourceLocation(i)).length)return null;const e=new Map,o=await s.listVariablesInScope(i);for(const r of o||[]){let o=e.get(r.scope);if(!o){const{type:n,typeName:a,icon:c}=await s.getScopeInfo(r.scope);o=new H(t,n,a,c,s,i),e.set(r.scope,o)}o.object().variables.push(r)}return Array.from(e.values())}catch(t){return e.Console.Console.instance().error(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message})),null}}async getFunctionInfo(t,o){const{rawModuleId:r,plugin:s}=await this.rawModuleIdAndPluginForScript(t);if(!s)return null;const i={rawModuleId:r,codeOffset:o.columnNumber-(t.codeOffset()||0),inlineFrameIndex:0};try{return await s.getFunctionInfo(i)}catch(t){return e.Console.Console.instance().warn(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message})),{frames:[]}}}async getInlinedFunctionRanges(o){const r=o.script();if(!r)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(r);if(!i)return[];const n={rawModuleId:s,codeOffset:o.columnNumber-(r.codeOffset()||0)};try{return(await i.getInlinedFunctionRanges(n)).map((e=>({start:new t.DebuggerModel.Location(r.debuggerModel,r.scriptId,0,Number(e.startOffset)+(r.codeOffset()||0)),end:new t.DebuggerModel.Location(r.debuggerModel,r.scriptId,0,Number(e.endOffset)+(r.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getInlinedCalleesRanges(o){const r=o.script();if(!r)return[];const{rawModuleId:s,plugin:i}=await this.rawModuleIdAndPluginForScript(r);if(!i)return[];const n={rawModuleId:s,codeOffset:o.columnNumber-(r.codeOffset()||0)};try{return(await i.getInlinedCalleesRanges(n)).map((e=>({start:new t.DebuggerModel.Location(r.debuggerModel,r.scriptId,0,Number(e.startOffset)+(r.codeOffset()||0)),end:new t.DebuggerModel.Location(r.debuggerModel,r.scriptId,0,Number(e.endOffset)+(r.codeOffset()||0))})))}catch(t){return e.Console.Console.instance().warn(F(k.errorInDebuggerLanguagePlugin,{PH1:t.message})),[]}}async getMappedLines(e){const t=await Promise.all(this.scriptsForUISourceCode(e).map((e=>this.rawModuleIdAndPluginForScript(e))));let o;for(const{rawModuleId:r,plugin:s}of t){if(!s)continue;const t=await s.getMappedLines(r,e.url());void 0!==t&&(void 0===o?o=new Set(t):t.forEach((e=>o.add(e))))}return o}}class z{#n;project;uiSourceCodeToScripts;constructor(e,t){this.#n=e,this.project=new d(t,"language_plugins::"+e.target().id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.project,e.target()),this.uiSourceCodeToScripts=new Map}addSourceFiles(o,r){const s=o.createPageResourceLoadInitiator();for(const i of r){let r=this.project.uiSourceCodeForURL(i);if(r){const e=this.uiSourceCodeToScripts.get(r);e.includes(o)||e.push(o)}else{r=this.project.createUISourceCode(i,e.ResourceType.resourceTypes.SourceMapScript),v.setInitialFrameAttribution(r,o.frameId),this.uiSourceCodeToScripts.set(r,[o]);const n=new t.CompilerSourceMappingContentProvider.CompilerSourceMappingContentProvider(i,e.ResourceType.resourceTypes.SourceMapScript,s),a=e.ResourceType.ResourceType.mimeFromURL(i)||"text/javascript";this.project.addUISourceCodeWithProvider(r,n,null,a)}}}removeScript(e){this.uiSourceCodeToScripts.forEach(((t,o)=>{0===(t=t.filter((t=>t!==e))).length?(this.uiSourceCodeToScripts.delete(o),this.project.removeUISourceCode(o.url())):this.uiSourceCodeToScripts.set(o,t)}))}dispose(){this.project.dispose()}getProject(){return this.project}}var V=Object.freeze({__proto__:null,ValueNode:N,SourceScope:H,DebuggerLanguagePluginManager:_,DebuggerLanguagePlugin:class{name;constructor(e){this.name=e}handleScript(e){throw new Error("Not implemented yet")}dispose(){}async addRawModule(e,t,o){throw new Error("Not implemented yet")}async sourceLocationToRawLocation(e){throw new Error("Not implemented yet")}async rawLocationToSourceLocation(e){throw new Error("Not implemented yet")}async getScopeInfo(e){throw new Error("Not implemented yet")}async listVariablesInScope(e){throw new Error("Not implemented yet")}removeRawModule(e){throw new Error("Not implemented yet")}getTypeInfo(e,t){throw new Error("Not implemented yet")}getFormatter(e,t){throw new Error("Not implemented yet")}getInspectableAddress(e){throw new Error("Not implemented yet")}async getFunctionInfo(e){throw new Error("Not implemented yet")}async getInlinedFunctionRanges(e){throw new Error("Not implemented yet")}async getInlinedCalleesRanges(e){throw new Error("Not implemented yet")}async getMappedLines(e,t){throw new Error("Not implemented yet")}}});const G=new WeakMap,q=new WeakMap;class ${#n;#r;#b;#m;#O;constructor(e,r,s){this.#n=e,this.#r=s,this.#b=new d(r,"debugger:"+e.target().id(),o.Workspace.projectTypes.Debugger,"",!0),this.#m=[e.addEventListener(t.DebuggerModel.Events.GlobalObjectCleared,this.debuggerReset,this),e.addEventListener(t.DebuggerModel.Events.ParsedScriptSource,this.parsedScriptSource,this),e.addEventListener(t.DebuggerModel.Events.DiscardedAnonymousScriptSource,this.discardedScriptSource,this)],this.#O=new WeakMap}static scriptForUISourceCode(e){const t=G.get(e);return t?t.values().next().value:null}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=q.get(t);if(!o)return null;const{lineNumber:r,columnNumber:s=0}=e;return o.uiLocation(r,s)}uiLocationToRawLocations(e,t,o){const r=this.#O.get(e);return r?[this.#n.createRawLocation(r,t,o)]:[]}parsedScriptSource(t){const o=t.data,r=e.ParsedURL.ParsedURL.extractName(o.sourceURL),s="debugger:///VM"+o.scriptId+(r?" "+r:""),i=this.#b.createUISourceCode(s,e.ResourceType.resourceTypes.Script);this.#O.set(i,o);const n=G.get(i);n?n.add(o):G.set(i,new Set([o])),q.set(o,i),this.#b.addUISourceCodeWithProvider(i,o,null,"text/javascript"),this.#r.updateLocations(o)}discardedScriptSource(e){const t=e.data,o=q.get(t);if(!o)return;q.delete(t),this.#O.delete(o);const r=G.get(o);r&&(r.delete(t),r.size||G.delete(o)),this.#b.removeUISourceCode(o.url())}debuggerReset(){this.#b.reset()}dispose(){e.EventTarget.removeEventListeners(this.#m),this.debuggerReset(),this.#b.dispose()}}var J=Object.freeze({__proto__:null,DefaultScriptMapping:$});class K{#W;#x;#H;constructor(e,t){this.#W=e,this.#x=t,this.#x.add(this),this.#H=null}async update(){this.#W&&(this.#H?await this.#H.then((()=>this.update())):(this.#H=this.#W(this),await this.#H,this.#H=null))}async uiLocation(){throw"Not implemented"}dispose(){this.#x.delete(this),this.#W=null}async isIgnoreListed(){throw"Not implemented"}}class Q{#_;constructor(){this.#_=new Set}add(e){this.#_.add(e)}delete(e){this.#_.delete(e)}disposeAll(){for(const e of this.#_)e.dispose()}}var X=Object.freeze({__proto__:null,LiveLocationWithPool:K,LiveLocationPool:Q});class Y{#a;#b;#m;#z;constructor(e,r,s){this.#a=r,this.#b=new d(s,"cssSourceMaps:"+e.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.#b,e),this.#z=new Map,this.#m=[this.#a.addEventListener(t.SourceMapManager.Events.SourceMapAttached,this.sourceMapAttached,this),this.#a.addEventListener(t.SourceMapManager.Events.SourceMapDetached,this.sourceMapDetached,this)]}sourceMapAttachedForTest(e){}async sourceMapAttached(e){const t=e.data.client,o=e.data.sourceMap,r=this.#b,s=this.#z;for(const e of o.sourceURLs()){let i=s.get(e);i||(i=new ee(r,e),s.set(e,i)),i.addSourceMap(o,t.frameId)}await le.instance().updateLocations(t),this.sourceMapAttachedForTest(o)}async sourceMapDetached(e){const t=e.data.client,o=e.data.sourceMap,r=this.#z;for(const e of o.sourceURLs()){const s=r.get(e);s&&(s.removeSourceMap(o,t.frameId),s.getUiSourceCode()||r.delete(e))}await le.instance().updateLocations(t)}rawLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this.#a.sourceMapForClient(t);if(!o)return null;let{lineNumber:r,columnNumber:s}=e;o.mapsOrigin()&&t.isInline&&(r-=t.startLine,0===r&&(s-=t.startColumn));const i=o.findEntry(r,s);if(!i||!i.sourceURL)return null;const n=this.#b.uiSourceCodeForURL(i.sourceURL);return n?n.uiLocation(i.sourceLineNumber,i.sourceColumnNumber):null}uiLocationToRawLocations(e){const{uiSourceCode:o,lineNumber:r,columnNumber:s=0}=e,i=Z.get(o);if(!i)return[];const n=[];for(const e of i.getReferringSourceMaps()){const i=e.findReverseEntries(o.url(),r,s);for(const o of this.#a.clientsForSourceMap(e))n.push(...i.map((e=>new t.CSSModel.CSSLocation(o,e.lineNumber,e.columnNumber))))}return n}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#b.dispose()}}const Z=new WeakMap;class ee{#b;#f;referringSourceMaps;#S;uiSourceCode;constructor(e,t){this.#b=e,this.#f=t,this.referringSourceMaps=[],this.uiSourceCode=null}recreateUISourceCodeIfNeeded(t){const r=this.referringSourceMaps[this.referringSourceMaps.length-1],s=r.sourceContentProvider(this.#f,e.ResourceType.resourceTypes.SourceMapStyleSheet),i=this.#b.createUISourceCode(this.#f,s.contentType());Z.set(i,this);const n=e.ResourceType.ResourceType.mimeFromURL(this.#f)||s.contentType().canonicalMimeType(),a=r.embeddedContentByURL(this.#f),c="string"==typeof a?new o.UISourceCode.UISourceCodeMetadata(null,a.length):null;this.uiSourceCode?(v.cloneInitialFrameAttribution(this.uiSourceCode,i),this.#b.removeFile(this.uiSourceCode.url())):v.setInitialFrameAttribution(i,t),this.uiSourceCode=i,this.#b.addUISourceCodeWithProvider(this.uiSourceCode,s,c,n)}addSourceMap(e,t){this.uiSourceCode&&v.addFrameAttribution(this.uiSourceCode,t),this.referringSourceMaps.push(e),this.recreateUISourceCodeIfNeeded(t)}removeSourceMap(e,t){const o=this.uiSourceCode;v.removeFrameAttribution(o,t);const r=this.referringSourceMaps.lastIndexOf(e);-1!==r&&this.referringSourceMaps.splice(r,1),this.referringSourceMaps.length?this.recreateUISourceCodeIfNeeded(t):(this.#b.removeFile(o.url()),this.uiSourceCode=null)}getReferringSourceMaps(){return this.referringSourceMaps}getUiSourceCode(){return this.uiSourceCode}}var te=Object.freeze({__proto__:null,SASSSourceMapping:Y});function oe(e){for(const o of t.TargetManager.TargetManager.instance().models(t.ResourceTreeModel.ResourceTreeModel)){const t=o.resourceForURL(e);if(t)return t}return null}function re(e,o,r){const s=e.model(t.ResourceTreeModel.ResourceTreeModel);if(!s)return null;const i=s.frameForId(o);return i?se(i.resourceForURL(r)):null}function se(e){return!e||"number"!=typeof e.contentSize()&&!e.lastModified()?null:new o.UISourceCode.UISourceCodeMetadata(e.lastModified(),e.contentSize())}var ie=Object.freeze({__proto__:null,resourceForURL:oe,displayNameForURL:function(s){if(!s)return"";const i=oe(s);if(i)return i.displayName;const n=o.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(s);if(n)return n.displayName();const a=t.TargetManager.TargetManager.instance().mainTarget(),c=a&&a.inspectedURL();if(!c)return r.StringUtilities.trimURL(s,"");const u=e.ParsedURL.ParsedURL.fromString(c);if(!u)return s;const d=u.lastPathComponent,l=c.indexOf(d);if(-1!==l&&l+d.length===c.length){const e=c.substring(0,l);if(s.startsWith(e))return s.substring(l)}const h=r.StringUtilities.trimURL(s,u.host);return"/"===h?u.host+"/":h},metadataForURL:re,resourceMetadata:se});const ne=new WeakMap;class ae{#V;#b;#G;#m;constructor(e,r){this.#V=e;const s=this.#V.target();this.#b=new d(r,"css:"+s.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.#b,s),this.#G=new Map,this.#m=[this.#V.addEventListener(t.CSSModel.Events.StyleSheetAdded,this.styleSheetAdded,this),this.#V.addEventListener(t.CSSModel.Events.StyleSheetRemoved,this.styleSheetRemoved,this),this.#V.addEventListener(t.CSSModel.Events.StyleSheetChanged,this.styleSheetChanged,this)]}rawLocationToUILocation(e){const t=e.header();if(!t||!this.acceptsHeader(t))return null;const o=this.#G.get(t.resourceURL());if(!o)return null;let r=e.lineNumber,s=e.columnNumber;if(t.isInline&&t.hasSourceURL){r-=t.lineNumberInSource(0);const e=t.columnNumberInSource(r,0);void 0===e?s=e:s-=e}return o.getUiSourceCode().uiLocation(r,s)}uiLocationToRawLocations(e){const o=ne.get(e.uiSourceCode);if(!o)return[];const r=[];for(const s of o.getHeaders()){let o=e.lineNumber,i=e.columnNumber;s.isInline&&s.hasSourceURL&&(i=s.columnNumberInSource(o,e.columnNumber||0),o=s.lineNumberInSource(o)),r.push(new t.CSSModel.CSSLocation(s,o,i))}return r}acceptsHeader(e){return!e.isConstructedByNew()&&(!(e.isInline&&!e.hasSourceURL&&"inspector"!==e.origin)&&!!e.resourceURL())}styleSheetAdded(e){const t=e.data;if(!this.acceptsHeader(t))return;const o=t.resourceURL();let r=this.#G.get(o);r?r.addHeader(t):(r=new ce(this.#V,this.#b,t),this.#G.set(o,r))}styleSheetRemoved(e){const t=e.data;if(!this.acceptsHeader(t))return;const o=t.resourceURL(),r=this.#G.get(o);r&&(1===r.getHeaders().size?(r.dispose(),this.#G.delete(o)):r.removeHeader(t))}styleSheetChanged(e){const t=this.#V.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!this.acceptsHeader(t))return;const o=this.#G.get(t.resourceURL());o&&o.styleSheetChanged(t)}dispose(){for(const e of this.#G.values())e.dispose();this.#G.clear(),e.EventTarget.removeEventListeners(this.#m),this.#b.removeProject()}}class ce{#V;#b;headers;uiSourceCode;#m;#q;#$;#J;#K;constructor(t,r,s){this.#V=t,this.#b=r,this.headers=new Set([s]);const i=t.target(),n=s.resourceURL(),a=re(i,s.frameId,n);this.uiSourceCode=this.#b.createUISourceCode(n,s.contentType()),ne.set(this.uiSourceCode,this),v.setInitialFrameAttribution(this.uiSourceCode,s.frameId),this.#b.addUISourceCodeWithProvider(this.uiSourceCode,this,a,"text/css"),this.#m=[this.uiSourceCode.addEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.uiSourceCode.addEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)],this.#q=new e.Throttler.Throttler(ce.updateTimeout),this.#$=!1}addHeader(e){this.headers.add(e),v.addFrameAttribution(this.uiSourceCode,e.frameId)}removeHeader(e){this.headers.delete(e),v.removeFrameAttribution(this.uiSourceCode,e.frameId)}styleSheetChanged(e){if(console.assert(this.headers.has(e)),this.#K||!this.headers.has(e))return;const t=this.mirrorContent.bind(this,e,!0);this.#q.schedule(t,!1)}workingCopyCommitted(){if(this.#J)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!0);this.#q.schedule(e,!0)}workingCopyChanged(){if(this.#J)return;const e=this.mirrorContent.bind(this,this.uiSourceCode,!1);this.#q.schedule(e,!1)}async mirrorContent(e,t){if(this.#$)return void this.styleFileSyncedForTest();let o=null;if(e===this.uiSourceCode)o=this.uiSourceCode.workingCopy();else{o=(await e.requestContent()).content}if(null===o||this.#$)return void this.styleFileSyncedForTest();e!==this.uiSourceCode&&(this.#J=!0,this.uiSourceCode.addRevision(o),this.#J=!1),this.#K=!0;const r=[];for(const s of this.headers)s!==e&&r.push(this.#V.setStyleSheetText(s.id,o,t));await Promise.all(r),this.#K=!1,this.styleFileSyncedForTest()}styleFileSyncedForTest(){}dispose(){this.#$||(this.#$=!0,this.#b.removeFile(this.uiSourceCode.url()),e.EventTarget.removeEventListeners(this.#m))}contentURL(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentURL()}contentType(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentType()}contentEncoded(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().contentEncoded()}requestContent(){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().requestContent()}searchInContent(e,t,o){return console.assert(this.headers.size>0),this.headers.values().next().value.originalContentProvider().searchInContent(e,t,o)}static updateTimeout=200;getHeaders(){return this.headers}getUiSourceCode(){return this.uiSourceCode}}var ue=Object.freeze({__proto__:null,StylesSourceMapping:ae,StyleFile:ce});let de;class le{#c;#Q;#X;#Y;constructor(e,o){this.#c=o,this.#Q=new Map,this.#X=[],e.observeModels(t.CSSModel.CSSModel,this),this.#Y=new Set}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:r}=e;if(!de||t){if(!o||!r)throw new Error(`Unable to create CSSWorkspaceBinding: targetManager and workspace must be provided: ${(new Error).stack}`);de=new le(o,r)}return de}static removeInstance(){de=void 0}get modelToInfo(){return this.#Q}getCSSModelInfo(e){return this.#Q.get(e)}modelAdded(e){this.#Q.set(e,new he(e,this.#c))}modelRemoved(e){this.getCSSModelInfo(e).dispose(),this.#Q.delete(e)}async pendingLiveLocationChangesPromise(){await Promise.all(this.#Y)}recordLiveLocationChange(e){e.then((()=>{this.#Y.delete(e)})),this.#Y.add(e)}async updateLocations(e){const t=this.getCSSModelInfo(e.cssModel()).updateLocations(e);this.recordLiveLocationChange(t),await t}createLiveLocation(e,t,o){const r=this.getCSSModelInfo(e.cssModel()).createLiveLocation(e,t,o);return this.recordLiveLocationChange(r),r}propertyUILocation(e,o){const r=e.ownerStyle;if(!r||r.type!==t.CSSStyleDeclaration.Type.Regular||!r.styleSheetId)return null;const s=r.cssModel().styleSheetHeaderForId(r.styleSheetId);if(!s)return null;const i=o?e.nameRange():e.valueRange();if(!i)return null;const n=i.startLine,a=i.startColumn,c=new t.CSSModel.CSSLocation(s,s.lineNumberInSource(n),s.columnNumberInSource(n,a));return this.rawLocationToUILocation(c)}rawLocationToUILocation(e){for(let t=this.#X.length-1;t>=0;--t){const o=this.#X[t].rawLocationToUILocation(e);if(o)return o}return this.getCSSModelInfo(e.cssModel()).rawLocationToUILocation(e)}uiLocationToRawLocations(e){for(let t=this.#X.length-1;t>=0;--t){const o=this.#X[t].uiLocationToRawLocations(e);if(o.length)return o}const t=[];for(const o of this.#Q.values())t.push(...o.uiLocationToRawLocations(e));return t}addSourceMapping(e){this.#X.push(e)}}class he{#m;#Z;#ee;#_;#te;constructor(e,o){this.#m=[e.addEventListener(t.CSSModel.Events.StyleSheetAdded,(e=>{this.styleSheetAdded(e)}),this),e.addEventListener(t.CSSModel.Events.StyleSheetRemoved,(e=>{this.styleSheetRemoved(e)}),this)],this.#Z=new ae(e,o);const s=e.sourceMapManager();this.#ee=new Y(e.target(),s,o),this.#_=new r.MapUtilities.Multimap,this.#te=new r.MapUtilities.Multimap}get locations(){return this.#_}async createLiveLocation(e,t,o){const r=new pe(e,this,t,o),s=e.header();return s?(r.setHeader(s),this.#_.set(s,r),await r.update()):this.#te.set(e.url,r),r}disposeLocation(e){const t=e.header();t?this.#_.delete(t,e):this.#te.delete(e.url,e)}updateLocations(e){const t=[];for(const o of this.#_.get(e))t.push(o.update());return Promise.all(t)}async styleSheetAdded(e){const t=e.data;if(!t.sourceURL)return;const o=[];for(const e of this.#te.get(t.sourceURL))e.setHeader(t),this.#_.set(t,e),o.push(e.update());await Promise.all(o),this.#te.deleteAll(t.sourceURL)}async styleSheetRemoved(e){const t=e.data,o=[];for(const e of this.#_.get(t))e.setHeader(t),this.#te.set(e.url,e),o.push(e.update());await Promise.all(o),this.#_.deleteAll(t)}rawLocationToUILocation(e){let t=null;return t=t||this.#ee.rawLocationToUILocation(e),t=t||this.#Z.rawLocationToUILocation(e),t=t||Me.instance().cssLocationToUILocation(e),t}uiLocationToRawLocations(e){let t=this.#ee.uiLocationToRawLocations(e);return t.length?t:(t=this.#Z.uiLocationToRawLocations(e),t.length?t:Me.instance().uiLocationToCSSLocations(e))}dispose(){e.EventTarget.removeEventListeners(this.#m),this.#Z.dispose(),this.#ee.dispose()}}class pe extends K{url;#oe;#re;#se;headerInternal;constructor(e,t,o,r){super(o,r),this.url=e.url,this.#oe=e.lineNumber,this.#re=e.columnNumber,this.#se=t,this.headerInternal=null}header(){return this.headerInternal}setHeader(e){this.headerInternal=e}async uiLocation(){if(!this.headerInternal)return null;const e=new t.CSSModel.CSSLocation(this.headerInternal,this.#oe,this.#re);return le.instance().rawLocationToUILocation(e)}dispose(){super.dispose(),this.#se.disposeLocation(this)}async isIgnoreListed(){return!1}}var ge=Object.freeze({__proto__:null,CSSWorkspaceBinding:le,ModelInfo:he,LiveLocation:pe});let me;const be=new WeakMap,fe=new WeakMap,Se=new WeakSet;class Me{#c;#Q;constructor(e,o){this.#c=o,this.#Q=new Map,e.observeModels(t.ResourceTreeModel.ResourceTreeModel,this)}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:r}=e;if(!me||t){if(!o||!r)throw new Error(`Unable to create ResourceMapping: targetManager and workspace must be provided: ${(new Error).stack}`);me=new Me(o,r)}return me}modelAdded(e){const t=new Le(this.#c,e);this.#Q.set(e,t)}modelRemoved(e){const t=this.#Q.get(e);t&&(t.dispose(),this.#Q.delete(e))}infoForTarget(e){const o=e.model(t.ResourceTreeModel.ResourceTreeModel);return o&&this.#Q.get(o)||null}cssLocationToUILocation(e){const t=e.header();if(!t)return null;const o=this.infoForTarget(e.cssModel().target());if(!o)return null;const r=o.getProject().uiSourceCodeForURL(e.url);if(!r)return null;const s=be.get(t)||i.TextRange.TextRange.createFromLocation(t.startLine,t.startColumn),n=e.lineNumber+s.startLine-t.startLine;let a=e.columnNumber;return e.lineNumber===t.startLine&&(a+=s.startColumn-t.startColumn),r.uiLocation(n,a)}jsLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this.infoForTarget(e.debuggerModel.target());if(!o)return null;const r=o.getProject().uiSourceCodeForURL(t.sourceURL);if(!r)return null;const s=fe.get(t)||i.TextRange.TextRange.createFromLocation(t.lineOffset,t.columnOffset),n=e.lineNumber+s.startLine-t.lineOffset;let a=e.columnNumber;return e.lineNumber===t.lineOffset&&(a+=s.startColumn-t.columnOffset),r.uiLocation(n,a)}uiLocationToJSLocations(e,o,r){if(!Se.has(e))return[];const s=v.targetForUISourceCode(e);if(!s)return[];const i=s.model(t.DebuggerModel.DebuggerModel);if(!i)return[];const n=i.createRawLocationByURL(e.url(),o,r);if(n){const e=n.script();if(e&&e.containsLocation(o,r))return[n]}return[]}uiLocationToCSSLocations(e){if(!Se.has(e.uiSourceCode))return[];const o=v.targetForUISourceCode(e.uiSourceCode);if(!o)return[];const r=o.model(t.CSSModel.CSSModel);return r?r.createRawLocationsByURL(e.uiSourceCode.url(),e.lineNumber,e.columnNumber):[]}resetForTest(e){const o=e.model(t.ResourceTreeModel.ResourceTreeModel),r=o?this.#Q.get(o):null;r&&r.resetForTest()}}class Le{project;#z;#V;#m;constructor(e,r){const s=r.target();this.project=new d(e,"resources:"+s.id(),o.Workspace.projectTypes.Network,"",!1),v.setTargetForProject(this.project,s),this.#z=new Map;const i=s.model(t.CSSModel.CSSModel);console.assert(Boolean(i)),this.#V=i,this.#m=[r.addEventListener(t.ResourceTreeModel.Events.ResourceAdded,this.resourceAdded,this),r.addEventListener(t.ResourceTreeModel.Events.FrameWillNavigate,this.frameWillNavigate,this),r.addEventListener(t.ResourceTreeModel.Events.FrameDetached,this.frameDetached,this),this.#V.addEventListener(t.CSSModel.Events.StyleSheetChanged,(e=>{this.styleSheetChanged(e)}),this)]}async styleSheetChanged(e){const t=this.#V.styleSheetHeaderForId(e.data.styleSheetId);if(!t||!t.isInline||t.isInline&&t.isMutable)return;const o=this.#z.get(t.resourceURL());o&&await o.styleSheetChanged(t,e.data.edit||null)}acceptsResource(t){const o=t.resourceType();return(o===e.ResourceType.resourceTypes.Image||o===e.ResourceType.resourceTypes.Font||o===e.ResourceType.resourceTypes.Document||o===e.ResourceType.resourceTypes.Manifest)&&(!(o===e.ResourceType.resourceTypes.Image&&t.mimeType&&!t.mimeType.startsWith("image"))&&(!(o===e.ResourceType.resourceTypes.Font&&t.mimeType&&!t.mimeType.includes("font"))&&(o!==e.ResourceType.resourceTypes.Image&&o!==e.ResourceType.resourceTypes.Font||!t.contentURL().startsWith("data:"))))}resourceAdded(e){const t=e.data;if(!this.acceptsResource(t))return;let o=this.#z.get(t.url);o?o.addResource(t):(o=new ve(this.project,t),this.#z.set(t.url,o))}removeFrameResources(e){for(const t of e.resources()){if(!this.acceptsResource(t))continue;const e=this.#z.get(t.url);e&&(1===e.resources.size?(e.dispose(),this.#z.delete(t.url)):e.removeResource(t))}}frameWillNavigate(e){this.removeFrameResources(e.data)}frameDetached(e){this.removeFrameResources(e.data.frame)}resetForTest(){for(const e of this.#z.values())e.dispose();this.#z.clear()}dispose(){e.EventTarget.removeEventListeners(this.#m);for(const e of this.#z.values())e.dispose();this.#z.clear(),this.project.removeProject()}getProject(){return this.project}}class ve{resources;#b;#ie;#ne;constructor(e,t){this.resources=new Set([t]),this.#b=e,this.#ie=this.#b.createUISourceCode(t.url,t.contentType()),Se.add(this.#ie),t.frameId&&v.setInitialFrameAttribution(this.#ie,t.frameId),this.#b.addUISourceCodeWithProvider(this.#ie,this,se(t),t.mimeType),this.#ne=[]}inlineStyles(){const e=v.targetForUISourceCode(this.#ie),o=[];if(!e)return o;const r=e.model(t.CSSModel.CSSModel);if(r)for(const e of r.getStyleSheetIdsForURL(this.#ie.url())){const t=r.styleSheetHeaderForId(e);t&&o.push(t)}return o}inlineScripts(){const e=v.targetForUISourceCode(this.#ie);if(!e)return[];const o=e.model(t.DebuggerModel.DebuggerModel);return o?o.scriptsForSourceURL(this.#ie.url()):[]}async styleSheetChanged(e,t){if(this.#ne.push({stylesheet:e,edit:t}),this.#ne.length>1)return;const{content:o}=await this.#ie.requestContent();null!==o&&await this.innerStyleSheetChanged(o),this.#ne=[]}async innerStyleSheetChanged(e){const t=this.inlineScripts(),o=this.inlineStyles();let r=new i.Text.Text(e);for(const e of this.#ne){const s=e.edit;if(!s)continue;const n=e.stylesheet,a=be.get(n)||i.TextRange.TextRange.createFromLocation(n.startLine,n.startColumn),c=s.oldRange.relativeFrom(a.startLine,a.startColumn),u=s.newRange.relativeFrom(a.startLine,a.startColumn);r=new i.Text.Text(r.replaceRange(c,s.newText));const d=[];for(const e of t){const t=fe.get(e)||i.TextRange.TextRange.createFromLocation(e.lineOffset,e.columnOffset);t.follows(c)&&(fe.set(e,t.rebaseAfterTextEdit(c,u)),d.push(Ue.instance().updateLocations(e)))}for(const e of o){const t=be.get(e)||i.TextRange.TextRange.createFromLocation(e.startLine,e.startColumn);t.follows(c)&&(be.set(e,t.rebaseAfterTextEdit(c,u)),d.push(le.instance().updateLocations(e)))}await Promise.all(d)}this.#ie.addRevision(r.value())}addResource(e){this.resources.add(e),e.frameId&&v.addFrameAttribution(this.#ie,e.frameId)}removeResource(e){this.resources.delete(e),e.frameId&&v.removeFrameAttribution(this.#ie,e.frameId)}dispose(){this.#b.removeFile(this.#ie.url())}firstResource(){return console.assert(this.resources.size>0),this.resources.values().next().value}contentURL(){return this.firstResource().contentURL()}contentType(){return this.firstResource().contentType()}contentEncoded(){return this.firstResource().contentEncoded()}requestContent(){return this.firstResource().requestContent()}searchInContent(e,t,o){return this.firstResource().searchInContent(e,t,o)}}var Ce=Object.freeze({__proto__:null,ResourceMapping:Me});const Ie={liveEditFailed:"`LiveEdit` failed: {PH1}",liveEditCompileFailed:"`LiveEdit` compile failed: {PH1}"},we=n.i18n.registerUIStrings("models/bindings/ResourceScriptMapping.ts",Ie),ye=n.i18n.getLocalizedString.bind(void 0,we);class Re{debuggerModel;#c;debuggerWorkspaceBinding;#ae;#ce;#ue;#m;constructor(e,o,r){this.debuggerModel=e,this.#c=o,this.debuggerWorkspaceBinding=r,this.#ae=new Map,this.#ce=new Map,this.#ue=new Set;const s=e.runtimeModel();this.#m=[this.debuggerModel.addEventListener(t.DebuggerModel.Events.ParsedScriptSource,(e=>{this.parsedScriptSource(e)}),this),this.debuggerModel.addEventListener(t.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),s.addEventListener(t.RuntimeModel.Events.ExecutionContextDestroyed,this.executionContextDestroyed,this)]}project(e){const t=(e.isContentScript()?"js:extensions:":"js::")+this.debuggerModel.target().id()+":"+e.frameId;let r=this.#ce.get(t);if(!r){const s=e.isContentScript()?o.Workspace.projectTypes.ContentScripts:o.Workspace.projectTypes.Network;r=new d(this.#c,t,s,"",!1),v.setTargetForProject(r,this.debuggerModel.target()),this.#ce.set(t,r)}return r}rawLocationToUILocation(e){const t=e.script();if(!t)return null;const o=this.project(t).uiSourceCodeForURL(t.sourceURL);if(!o)return null;const r=this.#ae.get(o);if(!r)return null;if(r.hasDivergedFromVM()&&!r.isMergingToVM()||r.isDivergingFromVM())return null;if(!r.hasScripts([t]))return null;const{lineNumber:s,columnNumber:i=0}=e;return o.uiLocation(s,i)}uiLocationToRawLocations(e,t,o){const r=this.#ae.get(e);if(!r)return[];const{script:s}=r;return s?[this.debuggerModel.createRawLocation(s,t,o)]:[]}acceptsScript(t){if(!t.sourceURL||t.isLiveEdit()||t.isInlineScript()&&!t.hasSourceURL)return!1;if(t.isContentScript()&&!t.hasSourceURL){if(!new e.ParsedURL.ParsedURL(t.sourceURL).isValid)return!1}return!0}async parsedScriptSource(e){const t=e.data;if(!this.acceptsScript(t))return;this.#ue.add(t);const o=t.originalContentProvider(),r=t.sourceURL,s=this.project(t),i=s.uiSourceCodeForURL(r);if(i){const e=this.#ae.get(i);e&&e.script&&await this.removeScript(e.script)}const n=s.createUISourceCode(r,o.contentType());v.setInitialFrameAttribution(n,t.frameId);const a=re(this.debuggerModel.target(),t.frameId,r),c=new ke(this,n,[t]);this.#ae.set(n,c);const u=t.isWasm()?"application/wasm":"text/javascript";s.addUISourceCodeWithProvider(n,o,a,u),await this.debuggerWorkspaceBinding.updateLocations(t)}scriptFile(e){return this.#ae.get(e)||null}async removeScript(e){if(!this.#ue.has(e))return;this.#ue.delete(e);const t=this.project(e),o=t.uiSourceCodeForURL(e.sourceURL),r=this.#ae.get(o);r&&r.dispose(),this.#ae.delete(o),t.removeFile(e.sourceURL),await this.debuggerWorkspaceBinding.updateLocations(e)}executionContextDestroyed(e){const t=e.data,o=this.debuggerModel.scriptsForExecutionContext(t);for(const e of o)this.removeScript(e)}globalObjectCleared(){const e=Array.from(this.#ue);for(const t of e)this.removeScript(t)}resetForTest(){const e=Array.from(this.#ue);for(const t of e)this.removeScript(t)}dispose(){e.EventTarget.removeEventListeners(this.#m);const t=Array.from(this.#ue);for(const e of t)this.removeScript(e);for(const e of this.#ce.values())e.removeProject();this.#ce.clear()}}class ke extends e.ObjectWrapper.ObjectWrapper{#de;#le;scriptInternal;#he;#pe;#ge;#me;constructor(e,t,r){super(),console.assert(r.length>0),this.#de=e,this.#le=t,this.#le.contentType().isScript()&&(this.scriptInternal=r[r.length-1]),this.#le.addEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#le.addEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}hasScripts(e){return Boolean(this.scriptInternal)&&this.scriptInternal===e[0]}isDiverged(){if(this.#le.isDirty())return!0;if(!this.scriptInternal)return!1;if(void 0===this.#he||null===this.#he)return!1;const e=this.#le.workingCopy();if(!e)return!1;if(!e.startsWith(this.#he.trimRight()))return!0;const o=this.#le.workingCopy().substr(this.#he.length);return Boolean(o.length)&&!o.match(t.Script.sourceURLRegex)}workingCopyChanged(){this.update()}workingCopyCommitted(){if(this.#le.project().canSetFileContent())return;if(!this.scriptInternal)return;const e=this.#de.debuggerModel,t=Ae.instance().breakpointLocationsForUISourceCode(this.#le).map((e=>e.breakpoint)),o=this.#le.workingCopy();e.setScriptSource(this.scriptInternal.scriptId,o,((e,r)=>{this.scriptSourceWasSet(o,t,e,r)}))}async scriptSourceWasSet(t,r,s,i){if(s||i||(this.#he=t),await this.update(),!s&&!i)return void await Promise.all(r.map((e=>e.refreshInDebugger())));if(!i)return void e.Console.Console.instance().addMessage(ye(Ie.liveEditFailed,{PH1:String(s)}),e.Console.MessageLevel.Warning);const n=ye(Ie.liveEditCompileFailed,{PH1:i.text});this.#le.addLineMessage(o.UISourceCode.Message.Level.Error,n,i.lineNumber,i.columnNumber)}async update(){this.isDiverged()&&!this.#ge?await this.divergeFromVM():!this.isDiverged()&&this.#ge&&await this.mergeToVM()}async divergeFromVM(){this.scriptInternal&&(this.#pe=!0,await this.#de.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#pe=void 0,this.#ge=!0,this.dispatchEventToListeners("DidDivergeFromVM"))}async mergeToVM(){this.scriptInternal&&(this.#ge=void 0,this.#me=!0,await this.#de.debuggerWorkspaceBinding.updateLocations(this.scriptInternal),this.#me=void 0,this.dispatchEventToListeners("DidMergeToVM"))}hasDivergedFromVM(){return Boolean(this.#ge)}isDivergingFromVM(){return Boolean(this.#pe)}isMergingToVM(){return Boolean(this.#me)}checkMapping(){this.scriptInternal&&void 0===this.#he?this.scriptInternal.requestContent().then((e=>{this.#he=e.content,this.update().then((()=>this.mappingCheckedForTest()))})):this.mappingCheckedForTest()}mappingCheckedForTest(){}dispose(){this.#le.removeEventListener(o.UISourceCode.Events.WorkingCopyChanged,this.workingCopyChanged,this),this.#le.removeEventListener(o.UISourceCode.Events.WorkingCopyCommitted,this.workingCopyCommitted,this)}addSourceMapURL(e){this.scriptInternal&&this.scriptInternal.debuggerModel.setSourceMapURL(this.scriptInternal,e)}hasSourceMapURL(){return void 0!==this.scriptInternal&&Boolean(this.scriptInternal.sourceMapURL)}get script(){return this.scriptInternal||null}get uiSourceCode(){return this.#le}}var Te=Object.freeze({__proto__:null,ResourceScriptMapping:Re,ResourceScriptFile:ke});let Fe;class Ue{workspace;#X;#A;#Y;pluginManager;constructor(e,o){this.workspace=o,this.#X=[],this.#A=new Map,e.addModelListener(t.DebuggerModel.DebuggerModel,t.DebuggerModel.Events.GlobalObjectCleared,this.globalObjectCleared,this),e.addModelListener(t.DebuggerModel.DebuggerModel,t.DebuggerModel.Events.DebuggerResumed,this.debuggerResumed,this),e.observeModels(t.DebuggerModel.DebuggerModel,this),this.#Y=new Set,this.pluginManager=s.Runtime.experiments.isEnabled("wasmDWARFDebugging")?new _(e,o,this):null}static instance(e={forceNew:null,targetManager:null,workspace:null}){const{forceNew:t,targetManager:o,workspace:r}=e;if(!Fe||t){if(!o||!r)throw new Error(`Unable to create DebuggerWorkspaceBinding: targetManager and workspace must be provided: ${(new Error).stack}`);Fe=new Ue(o,r)}return Fe}static removeInstance(){Fe=void 0}addSourceMapping(e){this.#X.push(e)}async computeAutoStepRanges(e,o){function r(e,t){const{start:o,end:r}=t;return o.scriptId===e.scriptId&&(!(e.lineNumber<o.lineNumber||e.lineNumber>r.lineNumber)&&(!(e.lineNumber===o.lineNumber&&e.columnNumber<o.columnNumber)&&!(e.lineNumber===r.lineNumber&&e.columnNumber>=r.columnNumber)))}const s=o.location();if(!s)return[];const i=this.pluginManager;let n=[];if(i){if(e===t.DebuggerModel.StepMode.StepOut)return await i.getInlinedFunctionRanges(s);const o=await i.rawLocationToUILocation(s);if(o)return n=await i.uiLocationToRawLocationRanges(o.uiSourceCode,o.lineNumber,o.columnNumber)||[],n=n.filter((e=>r(s,e))),e===t.DebuggerModel.StepMode.StepOver&&(n=n.concat(await i.getInlinedCalleesRanges(s))),n}const a=this.#A.get(s.debuggerModel)?.compilerMapping;return a?(n=a.getLocationRangesForSameSourceLocation(s),n=n.filter((e=>r(s,e))),n):[]}modelAdded(e){this.#A.set(e,new Pe(e,this)),e.setComputeAutoStepRangesCallback(this.computeAutoStepRanges.bind(this))}modelRemoved(e){e.setComputeAutoStepRangesCallback(null);const t=this.#A.get(e);t&&(t.dispose(),this.#A.delete(e))}async pendingLiveLocationChangesPromise(){await Promise.all(this.#Y)}recordLiveLocationChange(e){e.then((()=>{this.#Y.delete(e)})),this.#Y.add(e)}async updateLocations(e){const t=this.#A.get(e.debuggerModel);if(t){const o=t.updateLocations(e);this.recordLiveLocationChange(o),await o}}async createLiveLocation(e,t,o){const r=this.#A.get(e.debuggerModel);if(!r)return null;const s=r.createLiveLocation(e,t,o);return this.recordLiveLocationChange(s),s}async createStackTraceTopFrameLiveLocation(e,t,o){console.assert(e.length>0);const r=Ne.createStackTraceTopFrameLocation(e,this,t,o);return this.recordLiveLocationChange(r),r}async createCallFrameLiveLocation(e,t,o){if(!e.script())return null;const r=e.debuggerModel,s=this.createLiveLocation(e,t,o);this.recordLiveLocationChange(s);const i=await s;return i?(this.registerCallFrameLiveLocation(r,i),i):null}async rawLocationToUILocation(e){for(const t of this.#X){const o=t.rawLocationToUILocation(e);if(o)return o}if(this.pluginManager){const t=await this.pluginManager.rawLocationToUILocation(e);if(t)return t}const t=this.#A.get(e.debuggerModel);return t?t.rawLocationToUILocation(e):null}uiSourceCodeForSourceMapSourceURL(e,t,o){const r=this.#A.get(e);return r?r.compilerMapping.uiSourceCodeForURL(t,o):null}async uiLocationToRawLocations(e,t,o){for(const r of this.#X){const s=r.uiLocationToRawLocations(e,t,o);if(s.length)return s}const r=await(this.pluginManager?.uiLocationToRawLocations(e,t,o));if(r)return r;for(const r of this.#A.values()){const s=r.uiLocationToRawLocations(e,t,o);if(s.length)return s}return[]}uiLocationToRawLocationsForUnformattedJavaScript(e,t,o){console.assert(e.contentType().isScript());const r=[];for(const s of this.#A.values())r.push(...s.uiLocationToRawLocations(e,t,o));return r}async normalizeUILocation(e){const t=await this.uiLocationToRawLocations(e.uiSourceCode,e.lineNumber,e.columnNumber);for(const e of t){const t=await this.rawLocationToUILocation(e);if(t)return t}return e}scriptFile(e,t){const o=this.#A.get(t);return o?o.getResourceMapping().scriptFile(e):null}scriptsForUISourceCode(e){const t=new Set;this.pluginManager&&this.pluginManager.scriptsForUISourceCode(e).forEach((e=>t.add(e)));for(const o of this.#A.values()){const r=o.getResourceMapping().scriptFile(e);r&&r.script&&t.add(r.script),o.compilerMapping.scriptsForUISourceCode(e).forEach((e=>t.add(e)))}return[...t]}scriptsForResource(e){const t=new Set;for(const o of this.#A.values()){const r=o.getResourceMapping().scriptFile(e);r&&r.script&&t.add(r.script)}return[...t]}supportsConditionalBreakpoints(e){if(!this.pluginManager)return!0;return this.pluginManager.scriptsForUISourceCode(e).every((e=>e.isJavaScript()))}sourceMapForScript(e){const t=this.#A.get(e.debuggerModel);return t?t.compilerMapping.sourceMapForScript(e):null}globalObjectCleared(e){this.reset(e.data)}reset(e){const t=this.#A.get(e);if(t){for(const e of t.callFrameLocations.values())this.removeLiveLocation(e);t.callFrameLocations.clear()}}resetForTest(e){const o=e.model(t.DebuggerModel.DebuggerModel),r=this.#A.get(o);r&&r.getResourceMapping().resetForTest()}registerCallFrameLiveLocation(e,t){const o=this.#A.get(e);if(o){o.callFrameLocations.add(t)}}removeLiveLocation(e){const t=this.#A.get(e.rawLocation.debuggerModel);t&&t.disposeLocation(e)}debuggerResumed(e){this.reset(e.data)}}class Pe{#n;#r;callFrameLocations;#be;resourceMapping;compilerMapping;#_;constructor(e,t){this.#n=e,this.#r=t,this.callFrameLocations=new Set;const o=t.workspace;this.#be=new $(e,o,t),this.resourceMapping=new Re(e,o,t),this.compilerMapping=new I(e,o,t),this.#_=new r.MapUtilities.Multimap,e.setBeforePausedCallback(this.beforePaused.bind(this))}async createLiveLocation(e,t,o){console.assert(""!==e.scriptId);const r=e.scriptId,s=new je(r,e,this.#r,t,o);return this.#_.set(r,s),await s.update(),s}disposeLocation(e){this.#_.delete(e.scriptId,e)}async updateLocations(e){const t=[];for(const o of this.#_.get(e.scriptId))t.push(o.update());await Promise.all(t)}rawLocationToUILocation(e){let t=this.compilerMapping.rawLocationToUILocation(e);return t=t||this.resourceMapping.rawLocationToUILocation(e),t=t||Me.instance().jsLocationToUILocation(e),t=t||this.#be.rawLocationToUILocation(e),t}uiLocationToRawLocations(e,t,o=0){let r=this.compilerMapping.uiLocationToRawLocations(e,t,o);return r=r.length?r:this.resourceMapping.uiLocationToRawLocations(e,t,o),r=r.length?r:Me.instance().uiLocationToJSLocations(e,t,o),r=r.length?r:this.#be.uiLocationToRawLocations(e,t,o),r}beforePaused(e){return Boolean(e.callFrames[0])}dispose(){this.#n.setBeforePausedCallback(null),this.compilerMapping.dispose(),this.resourceMapping.dispose(),this.#be.dispose()}getResourceMapping(){return this.resourceMapping}}class je extends K{scriptId;rawLocation;#fe;constructor(e,t,o,r,s){super(r,s),this.scriptId=e,this.rawLocation=t,this.#fe=o}async uiLocation(){const e=this.rawLocation;return this.#fe.rawLocationToUILocation(e)}dispose(){super.dispose(),this.#fe.removeLiveLocation(this)}async isIgnoreListed(){const e=await this.uiLocation();return!!e&&p.instance().isIgnoreListedUISourceCode(e.uiSourceCode)}}class Ne extends K{#Se;#Me;#_;constructor(e,t){super(e,t),this.#Se=!0,this.#Me=null,this.#_=null}static async createStackTraceTopFrameLocation(e,t,o,r){const s=new Ne(o,r),i=e.map((e=>t.createLiveLocation(e,s.scheduleUpdate.bind(s),r)));return s.#_=(await Promise.all(i)).filter((e=>Boolean(e))),await s.updateLocation(),s}async uiLocation(){return this.#Me?this.#Me.uiLocation():null}async isIgnoreListed(){return!!this.#Me&&this.#Me.isIgnoreListed()}dispose(){if(super.dispose(),this.#_)for(const e of this.#_)e.dispose();this.#_=null,this.#Me=null}async scheduleUpdate(){this.#Se||(this.#Se=!0,queueMicrotask((()=>{this.updateLocation()})))}async updateLocation(){if(this.#Se=!1,this.#_&&0!==this.#_.length){this.#Me=this.#_[0];for(const e of this.#_)if(!await e.isIgnoreListed()){this.#Me=e;break}this.update()}}}var Ee=Object.freeze({__proto__:null,DebuggerWorkspaceBinding:Ue,Location:je});let De;class Ae extends e.ObjectWrapper.ObjectWrapper{storage;#c;targetManager;debuggerWorkspaceBinding;#Le;#ve;constructor(e,t,r){super(),this.storage=new xe,this.#c=t,this.targetManager=e,this.debuggerWorkspaceBinding=r,this.#Le=new Map,this.#ve=new Map,this.#c.addEventListener(o.Workspace.Events.UISourceCodeAdded,this.uiSourceCodeAdded,this),this.#c.addEventListener(o.Workspace.Events.UISourceCodeRemoved,this.uiSourceCodeRemoved,this),this.#c.addEventListener(o.Workspace.Events.ProjectRemoved,this.projectRemoved,this)}static instance(e={forceNew:null,targetManager:null,workspace:null,debuggerWorkspaceBinding:null}){const{forceNew:t,targetManager:o,workspace:r,debuggerWorkspaceBinding:s}=e;if(!De||t){if(!o||!r||!s)throw new Error(`Unable to create settings: targetManager, workspace, and debuggerWorkspaceBinding must be provided: ${(new Error).stack}`);De=new Ae(o,r,s)}return De}static breakpointStorageId(e,t,o){return e?`${e}:${t}`+("number"==typeof o?`:${o}`:""):""}async copyBreakpoints(e,t){const o=this.storage.breakpointItems(e);for(const e of o)await this.setBreakpoint(t,e.lineNumber,e.columnNumber,e.condition,e.enabled)}restoreBreakpoints(e){const t=e.url();if(!t)return;this.storage.mute();const o=this.storage.breakpointItems(t);for(const t of o)this.innerSetBreakpoint(e,t.lineNumber,t.columnNumber,t.condition,t.enabled);this.storage.unmute()}uiSourceCodeAdded(e){const t=e.data;this.restoreBreakpoints(t)}uiSourceCodeRemoved(e){const t=e.data;this.removeUISourceCode(t)}projectRemoved(e){const t=e.data;for(const e of t.uiSourceCodes())this.removeUISourceCode(e)}removeUISourceCode(e){this.breakpointLocationsForUISourceCode(e).forEach((t=>t.breakpoint.removeUISourceCode(e)))}async setBreakpoint(t,r,s,i,n){let a=new o.UISourceCode.UILocation(t,r,s);const c=await this.debuggerWorkspaceBinding.normalizeUILocation(a);return c.id()!==a.id()&&(e.Revealer.reveal(c),a=c),this.innerSetBreakpoint(a.uiSourceCode,a.lineNumber,a.columnNumber,i,n)}innerSetBreakpoint(e,t,o,r,s){const i=Ae.breakpointStorageId(e.url(),t,o);let n=this.#ve.get(i);return n?(n.updateState(r,s),n.addUISourceCode(e),n.updateBreakpoint(),n):(n=new Oe(this,e,e.url(),t,o,r,s),this.#ve.set(i,n),n)}findBreakpoint(e){const t=this.#Le.get(e.uiSourceCode);return t&&t.get(e.id())||null}async possibleBreakpoints(e,t){const{pluginManager:r}=this.debuggerWorkspaceBinding;if(r){const o=await r.uiLocationToRawLocations(e,t.startLine);if(o){const e=[];for(const t of o){const o=await this.debuggerWorkspaceBinding.rawLocationToUILocation(t);o&&e.push(o)}return e}}const s=Ue.instance().uiLocationToRawLocations(e,t.startLine,t.startColumn),i=Ue.instance().uiLocationToRawLocations(e,t.endLine,t.endColumn),[n,a]=await Promise.all([s,i]),c=new Map;for(const e of a)c.set(e.debuggerModel,e);let u=null,d=null;for(const e of n){const t=c.get(e.debuggerModel);if(t){u=e,d=t;break}}return u&&d?u.debuggerModel.getPossibleBreakpoints(u,d,!1).then(async function(t){const r=t.map((e=>this.debuggerWorkspaceBinding.rawLocationToUILocation(e))),s=(await Promise.all(r)).filter((t=>t&&t.uiSourceCode===e));if(!s.length)return[];s.sort(o.UISourceCode.UILocation.comparator);let i=s[0];const n=[i];for(const e of s)e.id()!==i.id()&&(n.push(e),i=e);return n}.bind(this)):[]}breakpointLocationsForUISourceCode(e){const t=this.#Le.get(e);return t?Array.from(t.values()):[]}allBreakpointLocations(){const e=[];for(const t of this.#Le.values())e.push(...t.values());return e}removeBreakpoint(e,t){t&&this.storage.removeBreakpoint(e),this.#ve.delete(e.breakpointStorageId())}uiLocationAdded(e,t){let o=this.#Le.get(t.uiSourceCode);o||(o=new Map,this.#Le.set(t.uiSourceCode,o));const r={breakpoint:e,uiLocation:t};o.set(t.id(),r),this.dispatchEventToListeners(Be.BreakpointAdded,r)}uiLocationRemoved(e,t){const o=this.#Le.get(t.uiSourceCode);if(!o)return;o.get(t.id())&&(o.delete(t.id()),0===o.size&&this.#Le.delete(t.uiSourceCode),this.dispatchEventToListeners(Be.BreakpointRemoved,{breakpoint:e,uiLocation:t}))}}var Be;!function(e){e.BreakpointAdded="breakpoint-added",e.BreakpointRemoved="breakpoint-removed"}(Be||(Be={}));class Oe{breakpointManager;urlInternal;#Ce;#Ie;#we;uiSourceCodes;#ye;#Re;isRemoved;currentState;#ke;constructor(e,o,r,s,i,n,a){this.breakpointManager=e,this.urlInternal=r,this.#Ce=s,this.#Ie=i,this.#we=new Set,this.uiSourceCodes=new Set,this.currentState=null,this.#ke=new Map,this.updateState(n,a),this.addUISourceCode(o),this.breakpointManager.targetManager.observeModels(t.DebuggerModel.DebuggerModel,this)}async refreshInDebugger(){if(!this.isRemoved){const e=Array.from(this.#ke.values());await Promise.all(e.map((e=>e.refreshBreakpoint())))}}modelAdded(e){const t=this.breakpointManager.debuggerWorkspaceBinding;this.#ke.set(e,new We(e,this,t))}modelRemoved(e){const t=this.#ke.get(e);this.#ke.delete(e),t&&(t.cleanUpAfterDebuggerIsGone(),t.removeEventListeners())}addUISourceCode(e){this.uiSourceCodes.has(e)||(this.uiSourceCodes.add(e),this.bound()||this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e)))}clearUISourceCodes(){this.bound()||this.removeAllUnboundLocations(),this.uiSourceCodes.clear()}removeUISourceCode(e){if(this.uiSourceCodes.has(e)&&(this.uiSourceCodes.delete(e),this.bound()||this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))),this.bound()){for(const t of this.#we)t.uiSourceCode===e&&(this.#we.delete(t),this.breakpointManager.uiLocationRemoved(this,t));this.bound()||this.isRemoved||this.addAllUnboundLocations()}}url(){return this.urlInternal}lineNumber(){return this.#Ce}columnNumber(){return this.#Ie}uiLocationAdded(e){this.isRemoved||(this.bound()||this.removeAllUnboundLocations(),this.#we.add(e),this.breakpointManager.uiLocationAdded(this,e))}uiLocationRemoved(e){this.#we.has(e)&&(this.#we.delete(e),this.breakpointManager.uiLocationRemoved(this,e),this.bound()||this.isRemoved||this.addAllUnboundLocations())}enabled(){return this.#Re}bound(){return 0!==this.#we.size}hasBoundScript(){for(const e of this.uiSourceCodes)if(e.project().type()===o.Workspace.projectTypes.Network)return!0;return!1}setEnabled(e){this.updateState(this.#ye,e)}condition(){return this.#ye}setCondition(e){this.updateState(e,this.#Re)}updateState(e,t){this.#Re===t&&this.#ye===e||(this.#Re=t,this.#ye=e,this.breakpointManager.storage.updateBreakpoint(this),this.updateBreakpoint())}updateBreakpoint(){this.bound()||(this.removeAllUnboundLocations(),this.isRemoved||this.addAllUnboundLocations());for(const e of this.#ke.values())e.scheduleUpdateInDebugger()}remove(e){this.isRemoved=!0;const o=!e;for(const e of this.#ke.values())e.scheduleUpdateInDebugger(),e.removeEventListeners();this.breakpointManager.removeBreakpoint(this,o),this.breakpointManager.targetManager.unobserveModels(t.DebuggerModel.DebuggerModel,this),this.clearUISourceCodes()}breakpointStorageId(){return Ae.breakpointStorageId(this.urlInternal,this.#Ce,this.#Ie)}resetLocations(){this.clearUISourceCodes();for(const e of this.#ke.values())e.resetLocations()}defaultUILocation(e){return e.uiLocation(this.#Ce,this.#Ie)}removeAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationRemoved(this,this.defaultUILocation(e))}addAllUnboundLocations(){for(const e of this.uiSourceCodes)this.breakpointManager.uiLocationAdded(this,this.defaultUILocation(e))}getUiSourceCodes(){return this.uiSourceCodes}getIsRemoved(){return this.isRemoved}}class We{#n;#Te;#r;#Fe;#we;#Ue;#Pe;#je;#Ne;#Ee;constructor(e,o,r){this.#n=e,this.#Te=o,this.#r=r,this.#Fe=new Q,this.#we=new Map,this.#n.addEventListener(t.DebuggerModel.Events.DebuggerWasDisabled,this.cleanUpAfterDebuggerIsGone,this),this.#n.addEventListener(t.DebuggerModel.Events.DebuggerWasEnabled,this.scheduleUpdateInDebugger,this),this.#Ue=!1,this.#Pe=!1,this.#je=!1,this.#Ne=null,this.#Ee=[],this.#n.debuggerEnabled()&&this.scheduleUpdateInDebugger()}resetLocations(){for(const e of this.#we.values())this.#Te.uiLocationRemoved(e);this.#we.clear(),this.#Fe.disposeAll()}scheduleUpdateInDebugger(){this.#Pe?this.#Ue=!0:(this.#Pe=!0,this.updateInDebugger().then((()=>{this.#Pe=!1,this.#Ue&&(this.#Ue=!1,this.scheduleUpdateInDebugger())})))}scriptDiverged(){for(const e of this.#Te.getUiSourceCodes()){const t=this.#r.scriptFile(e,this.#n);if(t&&t.hasDivergedFromVM())return!0}return!1}async updateInDebugger(){if(this.#n.target().isDisposed())return void this.cleanUpAfterDebuggerIsGone();const e=this.#Te.lineNumber(),t=this.#Te.columnNumber(),o=this.#Te.condition();let r=null;if(!this.#Te.getIsRemoved()&&this.#Te.enabled()&&!this.scriptDiverged()){let s=[];for(const o of this.#Te.getUiSourceCodes()){if(s=(await Ue.instance().uiLocationToRawLocations(o,e,t)).filter((e=>e.debuggerModel===this.#n)),s.length)break}if(s.length&&s.every((e=>e.script()))){const e=s.map((e=>{const t=e.script();return{url:t.sourceURL,scriptId:t.scriptId,scriptHash:t.hash,lineNumber:e.lineNumber,columnNumber:e.columnNumber}}));r=new Oe.State(e,o)}else if(this.#Te.currentState)r=new Oe.State(this.#Te.currentState.positions,o);else{const s={url:this.#Te.url(),scriptId:"",scriptHash:"",lineNumber:e,columnNumber:t};r=new Oe.State([s],o)}}if(this.#Ee.length&&Oe.State.equals(r,this.#Ne))return;if(this.#Te.currentState=r,this.#Ee.length)return void await this.refreshBreakpoint();if(!r)return;const s=await Promise.all(r.positions.map((e=>e.url?this.#n.setBreakpointByURL(e.url,e.lineNumber,e.columnNumber,o):this.#n.setBreakpointInAnonymousScript(e.scriptId,e.scriptHash,e.lineNumber,e.columnNumber,o)))),i=[];let n=[],a=!1;for(const e of s)e.breakpointId?(i.push(e.breakpointId),n=n.concat(e.locations)):this.#n.debuggerEnabled()&&!this.#n.isReadyToPause()&&(a=!0);i.length||!a?(this.#Ne=r,this.#je?this.#je=!1:i.length?(this.#Ee=i,this.#Ee.forEach((e=>this.#n.addBreakpointListener(e,this.breakpointResolved,this))),await Promise.all(n.map((e=>this.addResolvedLocation(e))))):this.#Te.remove(!0)):this.scheduleUpdateInDebugger()}async refreshBreakpoint(){this.#Ee.length&&(this.resetLocations(),await Promise.all(this.#Ee.map((e=>this.#n.removeBreakpoint(e)))),this.didRemoveFromDebugger(),this.#Ne=null,this.scheduleUpdateInDebugger())}didRemoveFromDebugger(){this.#je?this.#je=!1:(this.resetLocations(),this.#Ee.forEach((e=>this.#n.removeBreakpointListener(e,this.breakpointResolved,this))),this.#Ee=[])}async breakpointResolved({data:e}){await this.addResolvedLocation(e)}async locationUpdated(e){const t=this.#we.get(e),o=await e.uiLocation();t&&this.#Te.uiLocationRemoved(t),o?(this.#we.set(e,o),this.#Te.uiLocationAdded(o)):this.#we.delete(e)}async addResolvedLocation(e){const t=await this.#r.rawLocationToUILocation(e);if(!t)return;const o=this.#Te.breakpointManager.findBreakpoint(t);o&&o.breakpoint!==this.#Te?this.#Te.remove(!1):await this.#r.createLiveLocation(e,this.locationUpdated.bind(this),this.#Fe)}cleanUpAfterDebuggerIsGone(){this.#Pe&&(this.#je=!0),this.resetLocations(),this.#Ne=null,this.#Ee.length&&this.didRemoveFromDebugger()}removeEventListeners(){this.#n.removeEventListener(t.DebuggerModel.Events.DebuggerWasDisabled,this.cleanUpAfterDebuggerIsGone,this),this.#n.removeEventListener(t.DebuggerModel.Events.DebuggerWasEnabled,this.scheduleUpdateInDebugger,this)}}!function(e){e.State=class{positions;condition;constructor(e,t){this.positions=e,this.condition=t}static equals(e,t){if(!e||!t)return!1;if(e.condition!==t.condition)return!1;if(e.positions.length!==t.positions.length)return!1;for(let o=0;o<e.positions.length;o++){const r=e.positions[o],s=t.positions[o];if(r.url!==s.url)return!1;if(r.scriptId!==s.scriptId)return!1;if(r.scriptHash!==s.scriptHash)return!1;if(r.lineNumber!==s.lineNumber)return!1;if(r.columnNumber!==s.columnNumber)return!1}return!0}}}(Oe||(Oe={}));class xe{#De;#Ae;#Be;constructor(){this.#De=e.Settings.Settings.instance().createLocalSetting("breakpoints",[]),this.#Ae=new Map;const t=this.#De.get();for(const e of t)this.#Ae.set(Ae.breakpointStorageId(e.url,e.lineNumber,e.columnNumber),e)}get setting(){return this.#De}mute(){this.#Be=!0}unmute(){this.#Be=void 0}breakpointItems(e){return Array.from(this.#Ae.values()).filter((t=>t.url===e))}updateBreakpoint(e){!this.#Be&&e.breakpointStorageId()&&(this.#Ae.set(e.breakpointStorageId(),new xe.Item(e)),this.save())}removeBreakpoint(e){this.#Be||(this.#Ae.delete(e.breakpointStorageId()),this.save())}save(){this.#De.set(Array.from(this.#Ae.values()))}}!function(e){e.Item=class{url;lineNumber;columnNumber;condition;enabled;constructor(e){this.url=e.url(),this.lineNumber=e.lineNumber(),this.columnNumber=e.columnNumber(),this.condition=e.condition(),this.enabled=e.enabled()}}}(xe||(xe={}));var He=Object.freeze({__proto__:null,BreakpointManager:Ae,get Events(){return Be},get Breakpoint(){return Oe},ModelBreakpoint:We});class _e{#Oe;#We;#xe;#He;#_e;#ze;#Ve;#Ge;#qe;#$e;#Je;#Ke;constructor(e,t,o){this.#Oe=e,this.#We=e.size,this.#xe=0,this.#_e=t,this.#ze=o,this.#Ve=new TextDecoder,this.#Ge=!1,this.#qe=null,this.#He=null}async read(e){if(this.#ze&&this.#ze(this),this.#Oe?.type.endsWith("gzip")){const e=this.decompressStream(this.#Oe.stream());this.#He=e.getReader()}else this.#Ke=new FileReader,this.#Ke.onload=this.onChunkLoaded.bind(this),this.#Ke.onerror=this.onError.bind(this);return this.#Je=e,this.loadChunk(),new Promise((e=>{this.#$e=e}))}cancel(){this.#Ge=!0}loadedSize(){return this.#xe}fileSize(){return this.#We}fileName(){return this.#Oe?this.#Oe.name:""}error(){return this.#qe}decompressStream(e){const t=new DecompressionStream("gzip");return e.pipeThrough(t)}onChunkLoaded(e){if(this.#Ge)return;if(e.target.readyState!==FileReader.DONE)return;if(!this.#Ke)return;const t=this.#Ke.result;this.#xe+=t.byteLength;const o=this.#xe===this.#We;this.decodeChunkBuffer(t,o)}async decodeChunkBuffer(e,t){if(!this.#Je)return;const o=this.#Ve.decode(e,{stream:!t});await this.#Je.write(o),this.#Ge||(this.#ze&&this.#ze(this),t?this.finishRead():this.loadChunk())}finishRead(){this.#Je&&(this.#Oe=null,this.#Ke=null,this.#Je.close(),this.#$e(!this.#qe))}async loadChunk(){if(this.#Je&&this.#Oe){if(this.#He){const{value:e,done:t}=await this.#He.read();if(t||!e)return this.finishRead();this.decodeChunkBuffer(e.buffer,!1)}if(this.#Ke){const e=this.#xe,t=Math.min(this.#We,e+this.#_e),o=this.#Oe.slice(e,t);this.#Ke.readAsArrayBuffer(o)}}}onError(e){const t=e.target;this.#qe=t.error,this.#$e(!1)}}var ze=Object.freeze({__proto__:null,ChunkedFileReader:_e,FileOutputStream:class{#Qe;#Xe;#Ye;constructor(){this.#Qe=[]}async open(e){this.#Ye=!1,this.#Qe=[],this.#Xe=e;const t=await o.FileManager.FileManager.instance().save(this.#Xe,"",!0);return t&&o.FileManager.FileManager.instance().addEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),Boolean(t)}write(e){return new Promise((t=>{this.#Qe.push(t),o.FileManager.FileManager.instance().append(this.#Xe,e)}))}async close(){this.#Ye=!0,this.#Qe.length||(o.FileManager.FileManager.instance().removeEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),o.FileManager.FileManager.instance().close(this.#Xe))}onAppendDone(e){if(e.data!==this.#Xe)return;const t=this.#Qe.shift();t&&t(),this.#Qe.length||this.#Ye&&(o.FileManager.FileManager.instance().removeEventListener(o.FileManager.Events.AppendedToURL,this.onAppendDone,this),o.FileManager.FileManager.instance().close(this.#Xe))}}});const Ve=new WeakMap;class Ge{#n;#Ze;#et;#x;constructor(e){this.#n=e,this.#Ze=new Map,this.#et=[],e.addEventListener(t.DebuggerModel.Events.ParsedScriptSource,(e=>{queueMicrotask((()=>{this.parsedScriptSource(e)}))})),e.addEventListener(t.DebuggerModel.Events.GlobalObjectCleared,this.debuggerReset,this),this.#x=new Q}consoleMessageAdded(e){const t=this.rawLocation(e);t?this.addConsoleMessageToScript(e,t):this.addPendingConsoleMessage(e)}rawLocation(e){if(e.scriptId)return this.#n.createRawLocationByScriptId(e.scriptId,e.line,e.column);const t=e.stackTrace&&e.stackTrace.callFrames?e.stackTrace.callFrames[0]:null;return t?this.#n.createRawLocationByScriptId(t.scriptId,t.lineNumber,t.columnNumber):e.url?this.#n.createRawLocationByURL(e.url,e.line,e.column):null}addConsoleMessageToScript(e,t){this.#et.push(new qe(e,t,this.#x))}addPendingConsoleMessage(e){if(!e.url)return;const t=this.#Ze.get(e.url);t?t.push(e):this.#Ze.set(e.url,[e])}parsedScriptSource(e){const t=e.data,o=this.#Ze.get(t.sourceURL);if(!o)return;const r=[];for(const e of o){const o=this.rawLocation(e);o&&t.scriptId===o.scriptId?this.addConsoleMessageToScript(e,o):r.push(e)}r.length?this.#Ze.set(t.sourceURL,r):this.#Ze.delete(t.sourceURL)}consoleCleared(){this.#Ze=new Map,this.debuggerReset()}debuggerReset(){for(const e of this.#et)e.dispose();this.#et=[],this.#x.disposeAll()}}class qe extends o.UISourceCode.Message{#ie;constructor(e,t,r){super("error"===e.level?o.UISourceCode.Message.Level.Error:o.UISourceCode.Message.Level.Warning,e.messageText),Ue.instance().createLiveLocation(t,this.updateLocation.bind(this),r)}async updateLocation(e){this.#ie&&this.#ie.removeMessage(this);const t=await e.uiLocation();t&&(this.range=i.TextRange.TextRange.createFromLocation(t.lineNumber,t.columnNumber||0),this.#ie=t.uiSourceCode,this.#ie.addMessage(this))}dispose(){this.#ie&&this.#ie.removeMessage(this)}}var $e=Object.freeze({__proto__:null,PresentationConsoleMessageManager:class{constructor(){t.TargetManager.TargetManager.instance().observeModels(t.DebuggerModel.DebuggerModel,this),t.ConsoleModel.ConsoleModel.instance().addEventListener(t.ConsoleModel.Events.ConsoleCleared,this.consoleCleared,this),t.ConsoleModel.ConsoleModel.instance().addEventListener(t.ConsoleModel.Events.MessageAdded,(e=>this.consoleMessageAdded(e.data))),t.ConsoleModel.ConsoleModel.instance().messages().forEach(this.consoleMessageAdded,this)}modelAdded(e){Ve.set(e,new Ge(e))}modelRemoved(e){const t=Ve.get(e);t&&t.consoleCleared()}consoleMessageAdded(e){const t=e.runtimeModel();if(!e.isErrorOrWarning()||!e.runtimeModel()||"violation"===e.source||!t)return;const o=Ve.get(t.debuggerModel());o&&o.consoleMessageAdded(e)}consoleCleared(){for(const e of t.TargetManager.TargetManager.instance().models(t.DebuggerModel.DebuggerModel)){const t=Ve.get(e);t&&t.consoleCleared()}}},PresentationConsoleMessageHelper:Ge,PresentationConsoleMessage:qe});class Je{#tt;constructor(){this.#tt=null}write(e){this.#tt&&e.unshift(this.#tt),this.#tt=new Blob(e,{type:"text/plain"})}read(){return this.readRange()}size(){return this.#tt?this.#tt.size:0}async readRange(t,o){if(!this.#tt)return e.Console.Console.instance().error("Attempt to read a temp file that was never written"),"";const r="number"==typeof t||"number"==typeof o?this.#tt.slice(t,o):this.#tt,s=new FileReader;try{await new Promise(((e,t)=>{s.onloadend=e,s.onerror=t,s.readAsText(r)}))}catch(t){e.Console.Console.instance().error("Failed to read from temp file: "+t.message)}return s.result}async copyToOutputStream(e,t){if(!this.#tt)return e.close(),null;const o=new _e(this.#tt,1e7,t);return o.read(e).then((e=>e?null:o.error()))}remove(){this.#tt=null}}var Ke=Object.freeze({__proto__:null,TempFile:Je,TempFileBackingStorage:class{#Oe;#ot;#rt;constructor(){this.#Oe=null,this.reset()}appendString(e){this.#ot.push(e),this.#rt+=e.length;this.#rt>10485760&&this.flush()}appendAccessibleString(e){if(this.flush(),!this.#Oe)return async()=>null;const t=this.#Oe.size();return this.#ot.push(e),this.flush(),this.#Oe.readRange.bind(this.#Oe,t,this.#Oe.size())}flush(){this.#ot.length&&(this.#Oe||(this.#Oe=new Je),this.#rt=0,this.#Oe.write(this.#ot.splice(0)))}finishWriting(){this.flush()}reset(){this.#Oe&&this.#Oe.remove(),this.#Oe=null,this.#ot=[],this.#rt=0}writeToStream(e){return this.#Oe?this.#Oe.copyToOutputStream(e):Promise.resolve(null)}}});export{He as BreakpointManager,ge as CSSWorkspaceBinding,R as CompilerScriptMapping,l as ContentProviderBasedProject,V as DebuggerLanguagePlugins,Ee as DebuggerWorkspaceBinding,J as DefaultScriptMapping,ze as FileUtils,m as IgnoreListManager,X as LiveLocation,C as NetworkProject,$e as PresentationConsoleMessageHelper,Ce as ResourceMapping,Te as ResourceScriptMapping,ie as ResourceUtils,te as SASSSourceMapping,ue as StylesSourceMapping,Ke as TempFile};
